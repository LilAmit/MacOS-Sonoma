<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>macOS Sonoma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sf': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Helvetica Neue', 'sans-serif'],
                        'mono': ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    colors: {
                        'macos': { 'bg': 'rgba(246,246,246,0.92)', 'dark': 'rgba(30,30,30,0.35)', 'accent': '#007AFF', 'red': '#FF5F57', 'yellow': '#FFBD2E', 'green': '#28C840', 'text': '#1d1d1f', 'secondary': '#86868b', 'border': 'rgba(0,0,0,0.12)', 'sidebar': 'rgba(236,236,236,0.5)' }
                    },
                    animation: {
                        'wallpaper': 'wallpaper 120s ease infinite',
                        'spotlight-in': 'spotlight-in 0.15s ease-out',
                        'spotlight-out': 'spotlight-out 0.15s ease-in forwards',
                        'window-open': 'window-open 0.25s cubic-bezier(0.25,0.46,0.45,0.94)',
                        'window-close': 'window-close 0.2s cubic-bezier(0.55,0.06,0.68,0.19) forwards',
                        'slide-in-right': 'slide-in-right 0.2s ease-out',
                        'slide-out-right': 'slide-out-right 0.2s ease-in forwards',
                        'fade-in': 'fade-in 0.3s ease-out',
                        'fade-out': 'fade-out 0.2s ease-in forwards',
                        'launchpad-in': 'launchpad-in 0.25s ease-out',
                        'launchpad-out': 'launchpad-out 0.2s ease-in forwards',
                        'bounce-dock': 'bounce-dock 0.8s ease-in-out',
                        'cursor-blink': 'blink 1s step-end infinite',
                        'toast-in': 'toast-in 0.3s ease-out',
                        'toast-out': 'toast-out 0.25s ease-in forwards',
                        'unlock': 'unlock 0.6s cubic-bezier(0.25,0.46,0.45,0.94) forwards',
                        'context-menu-in': 'context-menu-in 0.12s ease-out',
                        'context-menu-out': 'context-menu-out 0.1s ease-in forwards',
                        'menu-dropdown-in': 'menu-dropdown-in 0.12s ease-out',
                        'minimize': 'minimize 0.4s cubic-bezier(0.2,0,0.6,1) forwards',
                        'restore': 'restore 0.3s cubic-bezier(0.25,0.46,0.45,0.94)',
                        'mission-in': 'mission-in 0.4s cubic-bezier(0.25,0.46,0.45,0.94)',
                        'mission-out': 'mission-out 0.3s ease-in forwards',
                        'widgets-in': 'widgets-in 0.3s ease-out',
                        'widgets-out': 'widgets-out 0.25s ease-in forwards',
                        'snap-preview': 'snap-preview 0.2s ease-out',
                        'quicklook-in': 'quicklook-in 0.2s ease-out',
                        'quicklook-out': 'quicklook-out 0.15s ease-in forwards',
                        'app-switcher-in': 'app-switcher-in 0.15s ease-out',
                        'genie-minimize': 'genie-minimize 0.5s cubic-bezier(0.2,0,0.6,1) forwards',
                        'genie-restore': 'genie-restore 0.4s cubic-bezier(0.25,0.46,0.45,0.94)',
                        'lock-wake': 'lock-wake 0.8s ease-out',
                    },
                    keyframes: {
                        'wallpaper': { '0%': { backgroundPosition: '0% 50%' }, '25%': { backgroundPosition: '50% 0%' }, '50%': { backgroundPosition: '100% 50%' }, '75%': { backgroundPosition: '50% 100%' }, '100%': { backgroundPosition: '0% 50%' } },
                        'spotlight-in': { '0%': { transform: 'scale(0.96)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'spotlight-out': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.96)', opacity: 0 } },
                        'window-open': { '0%': { transform: 'scale(0.88)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'window-close': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.88)', opacity: 0 } },
                        'slide-in-right': { '0%': { transform: 'translateX(20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'slide-out-right': { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(20px)', opacity: 0 } },
                        'fade-in': { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        'fade-out': { '0%': { opacity: 1 }, '100%': { opacity: 0 } },
                        'launchpad-in': { '0%': { transform: 'scale(1.1)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'launchpad-out': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(1.1)', opacity: 0 } },
                        'bounce-dock': { '0%, 100%': { transform: 'translateY(0)' }, '25%': { transform: 'translateY(-20px)' }, '50%': { transform: 'translateY(-5px)' }, '75%': { transform: 'translateY(-12px)' } },
                        'blink': { '50%': { opacity: 0 } },
                        'toast-in': { '0%': { transform: 'translateX(100%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'toast-out': { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(100%)', opacity: 0 } },
                        'unlock': { '0%': { opacity: 1, transform: 'scale(1)' }, '100%': { opacity: 0, transform: 'scale(1.1)' } },
                        'context-menu-in': { '0%': { transform: 'scale(0.92)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'context-menu-out': { '0%': { transform: 'scale(1)', opacity: 0.8 }, '100%': { transform: 'scale(0.92)', opacity: 0 } },
                        'menu-dropdown-in': { '0%': { transform: 'translateY(-4px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        'minimize': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.4) translateY(50vh)', opacity: 0 } },
                        'restore': { '0%': { transform: 'scale(0.4) translateY(50vh)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'mission-in': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.82) translateY(-8vh)', opacity: 1 } },
                        'mission-out': { '0%': { transform: 'scale(0.82) translateY(-8vh)', opacity: 1 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'widgets-in': { '0%': { transform: 'translateX(100%)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'widgets-out': { '0%': { transform: 'translateX(0)', opacity: 1 }, '100%': { transform: 'translateX(100%)', opacity: 0 } },
                        'snap-preview': { '0%': { opacity: 0, transform: 'scale(0.95)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                        'quicklook-in': { '0%': { transform: 'scale(0.85)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'quicklook-out': { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.85)', opacity: 0 } },
                        'app-switcher-in': { '0%': { transform: 'scale(0.92) translateY(10px)', opacity: 0 }, '100%': { transform: 'scale(1) translateY(0)', opacity: 1 } },
                        'genie-minimize': { '0%': { transform: 'scale(1) translateY(0)', opacity: 1 }, '50%': { transform: 'scaleX(0.6) translateY(30vh)', opacity: 0.7 }, '100%': { transform: 'scaleX(0.15) translateY(80vh)', opacity: 0 } },
                        'genie-restore': { '0%': { transform: 'scaleX(0.15) translateY(80vh)', opacity: 0 }, '50%': { transform: 'scaleX(0.6) translateY(30vh)', opacity: 0.7 }, '100%': { transform: 'scale(1) translateY(0)', opacity: 1 } },
                        'lock-wake': { '0%': { filter: 'brightness(0)', transform: 'scaleY(0.01)' }, '30%': { filter: 'brightness(0.3)', transform: 'scaleY(1)' }, '100%': { filter: 'brightness(1)', transform: 'scaleY(1)' } },
                    }
                }
            }
        }
    </script>
    <style>
/* macOS Sonoma - Global Styles */
* {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
}

::selection {
    background: rgba(var(--accent-rgb, 0,122,255), 0.3);
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.35);
    border: 2px solid transparent;
    background-clip: padding-box;
}

/* Sonoma Dynamic Wallpaper */
.wallpaper-sonoma {
    background:
        radial-gradient(ellipse at 20% 80%, #1a0533 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, #0c1445 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, #1a1a3e 0%, transparent 60%),
        radial-gradient(ellipse at 30% 30%, #2d1b69 0%, transparent 40%),
        radial-gradient(ellipse at 70% 70%, #0d2137 0%, transparent 40%),
        linear-gradient(135deg,
            #0a0a1a 0%,
            #0f0f2e 10%,
            #1a1145 20%,
            #2b1667 30%,
            #3d1f8a 38%,
            #6929c4 45%,
            #8a3ffc 50%,
            #a56eff 55%,
            #d4bbff 60%,
            #e8d4ff 63%,
            #ffd6e0 66%,
            #ff9fb2 70%,
            #ff6b8a 74%,
            #f74f68 78%,
            #d63851 82%,
            #b22234 86%,
            #8c1a28 90%,
            #5c1018 95%,
            #1a0508 100%
        );
    background-size: 200% 200%;
}

/* Glass morphism effects */
.glass {
    background: rgba(246, 246, 246, 0.72);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
}

.glass-dark {
    background: rgba(30, 30, 30, 0.55);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
}

.glass-menu {
    background: rgba(246, 246, 246, 0.88);
    backdrop-filter: blur(50px) saturate(200%);
    -webkit-backdrop-filter: blur(50px) saturate(200%);
}

.glass-dock {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(30px) saturate(150%);
    -webkit-backdrop-filter: blur(30px) saturate(150%);
}

/* Window shadow */
.window-shadow {
    box-shadow:
        0 22px 70px 4px rgba(0,0,0,0.28),
        0 0 0 0.5px rgba(0,0,0,0.12);
}

.window-shadow-focused {
    box-shadow:
        0 22px 70px 4px rgba(0,0,0,0.35),
        0 0 0 0.5px rgba(0,0,0,0.18);
    transition: box-shadow 0.3s ease;
}

.window-shadow-unfocused {
    box-shadow:
        0 10px 40px rgba(0,0,0,0.12),
        0 0 0 0.5px rgba(0,0,0,0.06);
    transition: box-shadow 0.3s ease;
}

.window-shadow-dragging {
    box-shadow:
        0 35px 90px 8px rgba(0,0,0,0.4),
        0 0 0 0.5px rgba(0,0,0,0.15);
}

/* Smooth window maximize/unmaximize transition */
.window-transition {
    transition: top 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                height 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                border-radius 0.3s ease;
}

/* Dock item hover magnification */
.dock-item-base {
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: bottom center;
}

/* Input styles */
input, textarea {
    user-select: text;
}

[contenteditable] {
    user-select: text;
}

/* Safari iframe */
.safari-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
}

/* Terminal cursor */
.terminal-cursor {
    display: inline-block;
    width: 8px;
    height: 15px;
    background: #28cd41;
    animation: blink 1s step-end infinite;
    vertical-align: text-bottom;
}

@keyframes blink {
    50% { opacity: 0; }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Smooth transitions for toggle */
.toggle-switch {
    transition: background-color 0.25s ease;
}
.toggle-knob {
    transition: left 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* ===== Accent Color Variable ===== */
:root {
    --accent-color: #007AFF;
    --accent-rgb: 0,122,255;
}

/* Custom range input styling */
input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 20px;
    border-radius: 2px;
    background: transparent;
    outline: none;
    cursor: pointer;
    margin: 0;
    padding: 0;
    user-select: auto;
    -webkit-user-select: auto;
    touch-action: none;
}
input[type="range"]::-webkit-slider-runnable-track {
    height: 4px;
    border-radius: 2px;
    background: #d1d5db;
}
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 0.5px 1px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.15);
    cursor: pointer;
    border: 0.5px solid rgba(0,0,0,0.08);
    margin-top: -7px;
}
input[type="range"]::-moz-range-track {
    height: 4px;
    border-radius: 2px;
    background: #d1d5db;
}
input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 0.5px 1px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.15);
    cursor: pointer;
    border: 0.5px solid rgba(0,0,0,0.08);
}
.dark-mode input[type="range"]::-webkit-slider-runnable-track {
    background: #4a4a4a;
}
.dark-mode input[type="range"]::-moz-range-track {
    background: #4a4a4a;
}
.dark-mode input[type="range"]::-webkit-slider-thumb {
    background: #e5e5e7;
    box-shadow: 0 0.5px 1px rgba(0,0,0,0.4), 0 1px 3px rgba(0,0,0,0.3);
    border-color: rgba(255,255,255,0.1);
}
.dark-mode input[type="range"]::-moz-range-thumb {
    background: #e5e5e7;
    box-shadow: 0 0.5px 1px rgba(0,0,0,0.4), 0 1px 3px rgba(0,0,0,0.3);
    border-color: rgba(255,255,255,0.1);
}

/* ===== Dark Mode - Comprehensive ===== */

/* --- Glass effects --- */
.dark-mode .glass {
    background: rgba(40, 40, 40, 0.82);
    color: #e5e5e7;
}
.dark-mode .glass-menu {
    background: rgba(45, 45, 45, 0.92);
    color: #e5e5e7;
}
.dark-mode .glass-dock {
    background: rgba(30, 30, 30, 0.5);
}
.dark-mode .window-shadow-focused {
    box-shadow: 0 22px 70px 4px rgba(0,0,0,0.55), 0 0 0 0.5px rgba(255,255,255,0.08);
}
.dark-mode .window-shadow-unfocused {
    box-shadow: 0 10px 40px rgba(0,0,0,0.35), 0 0 0 0.5px rgba(255,255,255,0.04);
}

/* --- Background color overrides --- */
.dark-mode .bg-white { background-color: #1e1e1e !important; }
.dark-mode .bg-\[\#f5f5f5\] { background-color: #252525 !important; }
.dark-mode .bg-gray-50 { background-color: #252525 !important; }
.dark-mode .bg-gray-100 { background-color: #2d2d2d !important; }
.dark-mode .bg-gray-200 { background-color: #383838 !important; }
.dark-mode .bg-gray-300 { background-color: #4a4a4a !important; }
.dark-mode .bg-gray-50\/95 { background-color: rgba(37, 37, 37, 0.95) !important; }
.dark-mode .bg-gray-100\/50 { background-color: rgba(42, 42, 42, 0.5) !important; }
.dark-mode .bg-gray-100\/70 { background-color: rgba(42, 42, 42, 0.7) !important; }
.dark-mode .bg-white\/60 { background-color: rgba(55, 55, 55, 0.6) !important; }
.dark-mode .bg-white\/70 { background-color: rgba(55, 55, 55, 0.7) !important; }
.dark-mode .bg-white\/80 { background-color: rgba(60, 60, 60, 0.8) !important; }
.dark-mode .bg-black\/5 { background-color: rgba(255, 255, 255, 0.05) !important; }
.dark-mode .bg-black\/10 { background-color: rgba(255, 255, 255, 0.1) !important; }
.dark-mode .bg-black\/\[0\.04\] { background-color: rgba(255, 255, 255, 0.04) !important; }
.dark-mode .bg-black\/\[0\.05\] { background-color: rgba(255, 255, 255, 0.05) !important; }

/* --- Text color overrides --- */
.dark-mode .text-gray-900 { color: #f5f5f7 !important; }
.dark-mode .text-gray-800 { color: #e5e5e7 !important; }
.dark-mode .text-gray-700 { color: #d1d1d6 !important; }
.dark-mode .text-gray-600 { color: #aeaeb2 !important; }
.dark-mode .text-gray-500 { color: #98989d !important; }
.dark-mode .text-gray-400 { color: #8e8e93 !important; }
.dark-mode .text-gray-300 { color: #58585c !important; }

/* --- Border color overrides --- */
.dark-mode .border-black\/5 { border-color: rgba(255, 255, 255, 0.08) !important; }
.dark-mode .border-black\/10 { border-color: rgba(255, 255, 255, 0.12) !important; }
.dark-mode .border-black\/\[0\.04\] { border-color: rgba(255, 255, 255, 0.06) !important; }
.dark-mode .border-gray-300 { border-color: rgba(255, 255, 255, 0.15) !important; }

/* --- Hover state overrides --- */
.dark-mode .hover\:bg-black\/5:hover { background-color: rgba(255, 255, 255, 0.08) !important; }
.dark-mode .hover\:bg-black\/\[0\.03\]:hover,
.dark-mode .hover\:bg-black\/\[0\.02\]:hover { background-color: rgba(255, 255, 255, 0.06) !important; }
.dark-mode .hover\:bg-gray-200:hover { background-color: #3a3a3a !important; }
.dark-mode .hover\:bg-white\/80:hover { background-color: rgba(60, 60, 60, 0.8) !important; }
.dark-mode .hover\:bg-red-100:hover { background-color: rgba(239, 68, 68, 0.15) !important; }

/* --- Form elements --- */
.dark-mode input:not([type="range"]):not([type="checkbox"]),
.dark-mode textarea,
.dark-mode select {
    color: #e5e5e7 !important;
}
.dark-mode input::placeholder,
.dark-mode textarea::placeholder {
    color: #636366 !important;
}

/* --- Scrollbars --- */
.dark-mode ::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2) !important;
    border: 2px solid transparent;
    background-clip: padding-box;
}
.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3) !important;
    border: 2px solid transparent;
    background-clip: padding-box;
}

/* --- SVG icon fill overrides --- */
.dark-mode svg[fill="#333"],
.dark-mode path[fill="#333"] { fill: #d1d1d6 !important; }
.dark-mode svg[fill="#666"],
.dark-mode path[fill="#666"] { fill: #aaa !important; }
.dark-mode svg[fill="#999"],
.dark-mode path[fill="#999"] { fill: #8e8e93 !important; }
.dark-mode svg[fill="#c7c7cc"],
.dark-mode path[fill="#c7c7cc"] { fill: #636366 !important; }

/* --- Additional border overrides --- */
.dark-mode .border-gray-800 { border-color: #e5e5e7 !important; }
.dark-mode .border-white\/5 { border-color: rgba(255, 255, 255, 0.05) !important; }

/* --- Safari iframe loading bg --- */
.dark-mode .safari-iframe { background: #1e1e1e; }

/* --- Selection color in dark mode --- */
.dark-mode ::selection { background: rgba(var(--accent-rgb, 0,122,255), 0.4); }

/* ===== Reduce Motion ===== */
.reduce-motion * {
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
}

/* ===== Increase Contrast ===== */
.increase-contrast .glass {
    background: rgba(246, 246, 246, 0.95);
    border: 1px solid rgba(0,0,0,0.3) !important;
}
.increase-contrast .glass-dark {
    background: rgba(20, 20, 20, 0.85);
    border: 1px solid rgba(255,255,255,0.2) !important;
}
.increase-contrast .glass-menu {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(0,0,0,0.3) !important;
}

/* ===== Reduce Transparency ===== */
.reduce-transparency .glass {
    background: rgb(246, 246, 246);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}
.reduce-transparency .glass-dark {
    background: rgb(40, 40, 40);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}
.reduce-transparency .glass-menu {
    background: rgb(250, 250, 250);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}
.reduce-transparency .glass-dock {
    background: rgb(200, 200, 200);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* ===== Larger Text ===== */
.larger-text {
    font-size: 115%;
}
.larger-text .text-\[11px\] { font-size: 13px; }
.larger-text .text-\[12px\] { font-size: 14px; }
.larger-text .text-\[13px\] { font-size: 15px; }

/* ===== Dark Mode + Reduce Transparency ===== */
.dark-mode.reduce-transparency .glass {
    background: rgb(50, 50, 50);
    color: #e5e5e7;
}
.dark-mode.reduce-transparency .glass-menu {
    background: rgb(55, 55, 55);
    color: #e5e5e7;
}
.dark-mode.reduce-transparency .glass-dock {
    background: rgb(40, 40, 40);
}

/* ===== Dark Mode + Increase Contrast ===== */
.dark-mode.increase-contrast .glass {
    background: rgba(50, 50, 50, 0.98);
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: #e5e5e7;
}
.dark-mode.increase-contrast .glass-menu {
    background: rgba(55, 55, 55, 0.98);
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: #e5e5e7;
}

/* ===== Cursor Context Changes ===== */
button, [role="button"], .cursor-default { cursor: default; }
input:not([type="range"]):not([type="checkbox"]):not([type="radio"]), textarea, [contenteditable] { cursor: text !important; }
a, [href] { cursor: pointer; }
input[type="range"] { cursor: grab !important; }
input[type="range"]:active { cursor: grabbing !important; }

/* ===== Stage Manager ===== */
.animate-stage-slide-in {
    animation: stage-slide-in 0.3s ease-out;
}
@keyframes stage-slide-in {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

    </style>
</head>
<body class="overflow-hidden w-screen h-screen font-sf">
    <div id="root"></div>

<script type="text/babel">
// Global state store for macOS Sonoma
const { useState: _useState, useCallback: _useCallback, useEffect: _useEffect, useRef: _useRef, createContext: _createContext, useContext: _useContext, useMemo: _useMemo } = React;

// Wallpaper definitions
const WALLPAPERS = [
    // Local wallpapers
    { name: 'Sonoma', path: 'wallpapers/wallpaper1.jpg' },
    { name: 'Sequoia', path: 'wallpapers/wallpaper2.jpg' },
    { name: 'Ventura', path: 'wallpapers/wallpaper3.jpg' },
    { name: 'Monterey', path: 'wallpapers/wallpaper4.jpg' },
    { name: 'Big Sur', path: 'wallpapers/wallpaper5.jpg' },
    // Online wallpapers (standard resolution ~5K - loads much faster than 6K)
    { name: 'Sequoia', path: 'https://512pixels.net/downloads/macos-wallpapers/15-Sequoia-Light.jpg' },
    { name: 'Catalina Day', path: 'https://512pixels.net/downloads/macos-wallpapers/10-15-Day.jpg' },
    { name: 'Catalina Night', path: 'https://512pixels.net/downloads/macos-wallpapers/10-15-Night.jpg' },
    { name: 'Mojave Day', path: 'https://512pixels.net/downloads/macos-wallpapers/10-14-Day.jpg' },
    { name: 'Mojave Night', path: 'https://512pixels.net/downloads/macos-wallpapers/10-14-Night.jpg' },
    { name: 'High Sierra', path: 'https://512pixels.net/downloads/macos-wallpapers/10-13.jpg' },
    { name: 'Sierra', path: 'https://512pixels.net/downloads/macos-wallpapers/10-12.jpg' },
    { name: 'El Capitan', path: 'https://512pixels.net/downloads/macos-wallpapers/10-11.jpg' },
];

// Virtual File System
const VFS = {
    _fs: {},

    init() {
        const saved = localStorage.getItem('macos_vfs');
        if (saved) {
            try { this._fs = JSON.parse(saved); return; } catch(e) {}
        }
        // Default filesystem
        this._fs = {
            '/Users/user': { type: 'dir', children: ['Applications','Desktop','Documents','Downloads','Movies','Music','Pictures','Public'] },
            '/Users/user/Applications': { type: 'dir', children: [] },
            '/Users/user/Desktop': { type: 'dir', children: ['Projects','todo.txt'] },
            '/Users/user/Desktop/Projects': { type: 'dir', children: [] },
            '/Users/user/Documents': { type: 'dir', children: ['Work','Personal'] },
            '/Users/user/Documents/Work': { type: 'dir', children: [] },
            '/Users/user/Documents/Personal': { type: 'dir', children: [] },
            '/Users/user/Downloads': { type: 'dir', children: ['macOS-sonoma.dmg'] },
            '/Users/user/Movies': { type: 'dir', children: [] },
            '/Users/user/Music': { type: 'dir', children: [] },
            '/Users/user/Pictures': { type: 'dir', children: ['Photos Library','Screenshots'] },
            '/Users/user/Pictures/Photos Library': { type: 'dir', children: [] },
            '/Users/user/Pictures/Screenshots': { type: 'dir', children: [] },
            '/Users/user/Public': { type: 'dir', children: [] },
            // File metadata
            '/Users/user/Desktop/todo.txt': { type: 'file', icon: 'ðŸ“', size: '1 KB', content: 'My todo list:\n- Review pull requests\n- Update documentation\n- Ship v2.0\n- Set up CI/CD\n- Write tests' },
            '/Users/user/Downloads/macOS-sonoma.dmg': { type: 'file', icon: 'ðŸ’¿', size: '12.3 GB', content: '' },
        };
        this.save();
    },

    save() {
        localStorage.setItem('macos_vfs', JSON.stringify(this._fs));
    },

    ls(path) {
        const node = this._fs[path];
        if (!node || node.type !== 'dir') return [];
        return node.children.map(name => {
            const childPath = path + '/' + name;
            const child = this._fs[childPath];
            if (child && child.type === 'dir') return { name, type: 'folder', icon: 'ðŸ“', color: '#42A5F5' };
            if (child && child.type === 'app') return { name, type: 'app', icon: child.icon || 'ðŸ“¦', size: child.size, appType: child.appType };
            if (child) return { name, type: 'file', icon: child.icon || 'ðŸ“„', size: child.size || '0 KB' };
            // No metadata - guess type
            if (name.includes('.')) return { name, type: 'file', icon: 'ðŸ“„', size: '0 KB' };
            return { name, type: 'folder', icon: 'ðŸ“', color: '#64B5F6' };
        });
    },

    exists(path) {
        return !!this._fs[path];
    },

    isDir(path) {
        return this._fs[path] && this._fs[path].type === 'dir';
    },

    mkdir(path, name) {
        const dirPath = path + '/' + name;
        if (this._fs[dirPath]) return false;
        this._fs[dirPath] = { type: 'dir', children: [] };
        const parent = this._fs[path];
        if (parent && parent.type === 'dir' && !parent.children.includes(name)) {
            parent.children.push(name);
        }
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    touch(path, name, content = '', icon = 'ðŸ“„') {
        const filePath = path + '/' + name;
        const ext = name.split('.').pop().toLowerCase();
        const icons = { txt: 'ðŸ“', md: 'ðŸ“', pdf: 'ðŸ“„', doc: 'ðŸ“„', docx: 'ðŸ“„', xls: 'ðŸ“Š', xlsx: 'ðŸ“Š', png: 'ðŸ–¼ï¸', jpg: 'ðŸ–¼ï¸', jpeg: 'ðŸ–¼ï¸', gif: 'ðŸ–¼ï¸', zip: 'ðŸ“¦', dmg: 'ðŸ’¿', app: 'ðŸ“¦' };
        this._fs[filePath] = { type: 'file', icon: icons[ext] || icon, size: content.length > 0 ? (content.length > 1024 ? Math.floor(content.length/1024) + ' KB' : content.length + ' B') : '0 KB', content: content };
        const parent = this._fs[path];
        if (parent && parent.type === 'dir' && !parent.children.includes(name)) {
            parent.children.push(name);
        }
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    writeFile(path, content) {
        if (this._fs[path] && this._fs[path].type === 'file') {
            this._fs[path].content = content;
            this._fs[path].size = content.length > 1024 ? Math.floor(content.length/1024) + ' KB' : content.length + ' B';
            this.save();
            MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
            return true;
        }
        return false;
    },

    readFile(path) {
        if (this._fs[path] && this._fs[path].type === 'file') return this._fs[path].content || '';
        return null;
    },

    rm(path, name) {
        const fullPath = path + '/' + name;
        // Remove from parent
        const parent = this._fs[path];
        if (parent && parent.type === 'dir') {
            parent.children = parent.children.filter(c => c !== name);
        }
        // If directory, recursively delete children
        if (this._fs[fullPath] && this._fs[fullPath].type === 'dir') {
            const children = [...(this._fs[fullPath].children || [])];
            children.forEach(child => this.rm(fullPath, child));
        }
        delete this._fs[fullPath];
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    rename(path, oldName, newName) {
        const oldPath = path + '/' + oldName;
        const newPath = path + '/' + newName;
        if (!this._fs[oldPath] || this._fs[newPath]) return false;
        this._fs[newPath] = this._fs[oldPath];
        delete this._fs[oldPath];
        const parent = this._fs[path];
        if (parent && parent.type === 'dir') {
            parent.children = parent.children.map(c => c === oldName ? newName : c);
        }
        // If dir, update child paths
        if (this._fs[newPath].type === 'dir') {
            const updatePaths = (oldBase, newBase) => {
                Object.keys(this._fs).forEach(key => {
                    if (key.startsWith(oldBase + '/')) {
                        const newKey = newBase + key.slice(oldBase.length);
                        this._fs[newKey] = this._fs[key];
                        delete this._fs[key];
                    }
                });
            };
            updatePaths(oldPath, newPath);
        }
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    // Trash functionality
    getTrash() {
        const saved = localStorage.getItem('macos_trash');
        if (saved) { try { return JSON.parse(saved); } catch(e) {} }
        return [];
    },

    moveToTrash(parentPath, name) {
        const fullPath = parentPath + '/' + name;
        const item = this._fs[fullPath];
        if (!item) return false;
        const trash = this.getTrash();
        trash.push({
            name,
            originalPath: parentPath,
            type: item.type,
            icon: item.icon,
            size: item.size,
            content: item.content,
            children: item.children,
            deletedAt: Date.now(),
        });
        localStorage.setItem('macos_trash', JSON.stringify(trash));
        // Remove from filesystem
        this.rm(parentPath, name);
        return true;
    },

    restoreFromTrash(trashItem) {
        const trash = this.getTrash();
        const idx = trash.findIndex(t => t.name === trashItem.name && t.deletedAt === trashItem.deletedAt);
        if (idx === -1) return false;
        const item = trash[idx];
        // Ensure parent exists
        if (!this._fs[item.originalPath]) return false;
        // Restore to VFS
        const fullPath = item.originalPath + '/' + item.name;
        if (item.type === 'dir') {
            this._fs[fullPath] = { type: 'dir', children: item.children || [] };
        } else {
            this._fs[fullPath] = { type: item.type || 'file', icon: item.icon, size: item.size, content: item.content || '' };
        }
        const parent = this._fs[item.originalPath];
        if (parent && parent.type === 'dir' && !parent.children.includes(item.name)) {
            parent.children.push(item.name);
        }
        // Remove from trash
        trash.splice(idx, 1);
        localStorage.setItem('macos_trash', JSON.stringify(trash));
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    deleteFromTrash(trashItem) {
        const trash = this.getTrash();
        const filtered = trash.filter(t => !(t.name === trashItem.name && t.deletedAt === trashItem.deletedAt));
        localStorage.setItem('macos_trash', JSON.stringify(filtered));
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
    },

    emptyTrash() {
        localStorage.setItem('macos_trash', JSON.stringify([]));
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
    },

    // Move file/folder from one directory to another
    move(srcParent, name, destParent) {
        const srcPath = srcParent + '/' + name;
        const destPath = destParent + '/' + name;
        if (!this._fs[srcPath]) return false;
        if (destPath === srcPath) return false;
        // Don't move a folder into itself
        if (destPath.startsWith(srcPath + '/')) return false;
        // Check dest is a directory
        if (!this._fs[destParent] || this._fs[destParent].type !== 'dir') return false;
        // Handle name collision - append number
        let finalName = name;
        let finalDest = destPath;
        let counter = 1;
        while (this._fs[finalDest]) {
            const dot = name.lastIndexOf('.');
            if (dot > 0) {
                finalName = name.slice(0, dot) + ' ' + counter + name.slice(dot);
            } else {
                finalName = name + ' ' + counter;
            }
            finalDest = destParent + '/' + finalName;
            counter++;
        }
        // Move the entry
        this._fs[finalDest] = this._fs[srcPath];
        delete this._fs[srcPath];
        // Update source parent children
        const srcDir = this._fs[srcParent];
        if (srcDir && srcDir.type === 'dir') {
            srcDir.children = srcDir.children.filter(c => c !== name);
        }
        // Update dest parent children
        const destDir = this._fs[destParent];
        if (destDir && destDir.type === 'dir' && !destDir.children.includes(finalName)) {
            destDir.children.push(finalName);
        }
        // If directory, recursively update child paths
        if (this._fs[finalDest].type === 'dir') {
            const updatePaths = (oldBase, newBase) => {
                Object.keys(this._fs).forEach(key => {
                    if (key.startsWith(oldBase + '/')) {
                        const newKey = newBase + key.slice(oldBase.length);
                        this._fs[newKey] = this._fs[key];
                        delete this._fs[key];
                    }
                });
            };
            updatePaths(srcPath, finalDest);
        }
        this.save();
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        return true;
    },

    // Desktop shortcuts (app aliases on desktop)
    getDesktopApps() {
        const saved = localStorage.getItem('macos_desktop_apps');
        if (saved) { try { return JSON.parse(saved); } catch(e) {} }
        return [];
    },

    addDesktopApp(appType, appName) {
        const apps = this.getDesktopApps();
        if (!apps.find(a => a.type === appType)) {
            apps.push({ type: appType, name: appName });
            localStorage.setItem('macos_desktop_apps', JSON.stringify(apps));
            MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
        }
    },

    removeDesktopApp(appType) {
        let apps = this.getDesktopApps();
        apps = apps.filter(a => a.type !== appType);
        localStorage.setItem('macos_desktop_apps', JSON.stringify(apps));
        MacStore.setState(s => ({ vfsVersion: (s.vfsVersion || 0) + 1 }));
    },
};

// Init VFS
VFS.init();

// Simple global state manager
const MacStore = {
    _listeners: new Set(),
    _state: {
        locked: true,
        windows: [],
        zIndexCounter: 100,
        activeWindowId: null,
        openApps: new Set(['finder']),
        spotlightOpen: false,
        controlCenterOpen: false,
        notificationCenterOpen: false,
        contextMenu: null,
        darkMode: false,
        wallpaperIndex: 0,
        launchpadOpen: false,
        aboutMacOpen: false,
        activeDropdown: null,
        notifications: [],
        volume: 60,
        brightness: 80,
        wifiOn: true,
        bluetoothOn: true,
        focusOn: false,
        vfsVersion: 0,
        // Dock settings
        dockSize: 48,
        dockMagnification: true,
        dockAutoHide: false,
        dockPosition: 'bottom',
        showRecents: true,
        // Appearance
        accentColor: '#007AFF',
        // Display
        nightShift: false,
        // Accessibility
        reduceMotion: false,
        increaseContrast: false,
        reduceTransparency: false,
        largerText: false,
        // Battery
        showBatteryPercentage: true,
        // Notifications
        notifSounds: true,
        notifLockScreen: true,
        // Global drag state for cross-component file drag-and-drop
        fileDrag: null, // { name, sourcePath, type, sourceComponent }
        // Mission Control / Stage Manager / Widgets / Spaces
        missionControlOpen: false,
        stageManagerOn: false,
        widgetsOpen: false,
        appSwitcherOpen: false,
        appSwitcherIndex: 0,
        quickLookFile: null, // { name, icon, content, type, size }
        windowSnapPreview: null, // 'left' | 'right' | null
    },

    getState() {
        return this._state;
    },

    setState(updater) {
        if (typeof updater === 'function') {
            this._state = { ...this._state, ...updater(this._state) };
        } else {
            this._state = { ...this._state, ...updater };
        }
        this._listeners.forEach(l => l(this._state));
        // Auto-save relevant state to localStorage
        this._saveState();
    },

    _saveState() {
        const s = this._state;
        localStorage.setItem('macos_settings', JSON.stringify({
            wallpaperIndex: s.wallpaperIndex,
            darkMode: s.darkMode,
            volume: s.volume,
            brightness: s.brightness,
            wifiOn: s.wifiOn,
            bluetoothOn: s.bluetoothOn,
            focusOn: s.focusOn,
            dockSize: s.dockSize,
            dockMagnification: s.dockMagnification,
            dockAutoHide: s.dockAutoHide,
            dockPosition: s.dockPosition,
            showRecents: s.showRecents,
            accentColor: s.accentColor,
            nightShift: s.nightShift,
            reduceMotion: s.reduceMotion,
            increaseContrast: s.increaseContrast,
            reduceTransparency: s.reduceTransparency,
            largerText: s.largerText,
            showBatteryPercentage: s.showBatteryPercentage,
            notifSounds: s.notifSounds,
            notifLockScreen: s.notifLockScreen,
        }));
    },

    loadState() {
        const saved = localStorage.getItem('macos_settings');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this._state = { ...this._state, ...data };
            } catch(e) {}
        }
    },

    subscribe(listener) {
        this._listeners.add(listener);
        return () => this._listeners.delete(listener);
    },

    setWallpaper(index) {
        this.setState({ wallpaperIndex: index });
    },

    nextWallpaper() {
        this.setState(s => ({ wallpaperIndex: (s.wallpaperIndex + 1) % WALLPAPERS.length }));
    },

    // Window management
    openWindow(appType, title, width = 800, height = 500) {
        const state = this.getState();
        const existing = state.windows.find(w => w.appType === appType);
        if (existing) {
            if (existing.minimized) {
                this.restoreWindow(existing.id);
            } else {
                this.focusWindow(existing.id);
            }
            return existing.id;
        }

        const id = 'win-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        const newZ = state.zIndexCounter + 1;
        const x = Math.max(50, (window.innerWidth - width) / 2 + Math.random() * 40 - 20);
        const y = Math.max(30, (window.innerHeight - height) / 3 + Math.random() * 30 - 15);

        const win = {
            id, title, appType,
            appName: title,
            x, y, width, height,
            minimized: false,
            maximized: false,
            focused: true,
            zIndex: newZ,
            opening: true,
        };

        const newWindows = state.windows.map(w => ({...w, focused: false}));
        newWindows.push(win);

        const openApps = new Set(state.openApps);
        openApps.add(appType);

        this.setState({
            windows: newWindows,
            zIndexCounter: newZ,
            activeWindowId: id,
            openApps,
            launchpadOpen: false,
        });

        setTimeout(() => {
            this.setState(s => ({
                windows: s.windows.map(w => w.id === id ? {...w, opening: false} : w)
            }));
        }, 300);

        return id;
    },

    closeWindow(windowId) {
        const state = this.getState();
        this.setState(s => ({
            windows: s.windows.map(w => w.id === windowId ? {...w, closing: true} : w)
        }));

        setTimeout(() => {
            this.setState(s => {
                const windows = s.windows.filter(w => w.id !== windowId);
                const remaining = windows.filter(w => !w.minimized);
                const newActive = remaining.length > 0 ? remaining[remaining.length - 1].id : null;

                const openApps = new Set(['finder']);
                windows.forEach(w => openApps.add(w.appType));

                return {
                    windows: windows.map(w => w.id === newActive ? {...w, focused: true} : {...w, focused: false}),
                    activeWindowId: newActive,
                    openApps,
                };
            });
        }, 200);
    },

    focusWindow(windowId) {
        this.setState(s => {
            const newZ = s.zIndexCounter + 1;
            return {
                windows: s.windows.map(w => ({
                    ...w,
                    focused: w.id === windowId,
                    zIndex: w.id === windowId ? newZ : w.zIndex,
                })),
                zIndexCounter: newZ,
                activeWindowId: windowId,
            };
        });
    },

    minimizeWindow(windowId) {
        // Start genie minimize animation
        this.setState(s => ({
            windows: s.windows.map(w =>
                w.id === windowId ? {...w, minimizing: true, focused: false} : w
            )
        }));
        // After animation, actually minimize
        setTimeout(() => {
            this.setState(s => {
                const windows = s.windows.map(w =>
                    w.id === windowId ? {...w, minimized: true, minimizing: false} : w
                );
                const remaining = windows.filter(w => !w.minimized);
                const newActive = remaining.length > 0 ? remaining[remaining.length - 1].id : null;
                return {
                    windows: windows.map(w => w.id === newActive ? {...w, focused: true} : w),
                    activeWindowId: newActive,
                };
            });
        }, 500);
    },

    restoreWindow(windowId) {
        this.setState(s => {
            const newZ = s.zIndexCounter + 1;
            return {
                windows: s.windows.map(w => ({
                    ...w,
                    minimized: w.id === windowId ? false : w.minimized,
                    restoring: w.id === windowId ? true : false,
                    focused: w.id === windowId,
                    zIndex: w.id === windowId ? newZ : w.zIndex,
                })),
                zIndexCounter: newZ,
                activeWindowId: windowId,
            };
        });
        setTimeout(() => {
            this.setState(s => ({
                windows: s.windows.map(w => w.id === windowId ? {...w, restoring: false} : w)
            }));
        }, 300);
    },

    toggleMaximize(windowId) {
        this.setState(s => ({
            windows: s.windows.map(w =>
                w.id === windowId ? {...w, maximized: !w.maximized} : w
            )
        }));
    },

    updateWindow(windowId, updates) {
        this.setState(s => ({
            windows: s.windows.map(w =>
                w.id === windowId ? {...w, ...updates} : w
            )
        }));
    },

    unfocusAll() {
        this.setState(s => ({
            windows: s.windows.map(w => ({...w, focused: false})),
            activeWindowId: null,
        }));
    },

    addNotification(app, title, body) {
        const notif = { id: Date.now().toString(), app, title, body, time: new Date() };
        this.setState(s => ({
            notifications: [...s.notifications, notif]
        }));
        setTimeout(() => {
            this.setState(s => ({
                notifications: s.notifications.filter(n => n.id !== notif.id)
            }));
        }, 5000);
    },
};

// Load saved settings
MacStore.loadState();

// Hook to use store in components
function useStore(selector) {
    const [state, setState] = _useState(selector ? selector(MacStore.getState()) : MacStore.getState());
    _useEffect(() => {
        return MacStore.subscribe(s => {
            const next = selector ? selector(s) : s;
            setState(prev => {
                if (JSON.stringify(prev) !== JSON.stringify(next)) return next;
                return prev;
            });
        });
    }, []);
    return state;
}

// Hook for animated mount/unmount of overlays
function useAnimatedVisibility(isOpen, duration = 200) {
    const [visible, setVisible] = _useState(isOpen);
    const [closing, setClosing] = _useState(false);

    _useEffect(() => {
        if (isOpen) {
            setVisible(true);
            setClosing(false);
        } else if (visible) {
            setClosing(true);
            const timer = setTimeout(() => {
                setVisible(false);
                setClosing(false);
            }, duration);
            return () => clearTimeout(timer);
        }
    }, [isOpen]);

    return { shouldRender: visible, isClosing: closing };
}






window.MacStore = MacStore;
window.useStore = useStore;
window.WALLPAPERS = WALLPAPERS;
window.VFS = VFS;
</script>

<script type="text/babel">
// macOS App Icons - using real icon images
const MacIcons = {
    Finder: ({ size = 54 }) => (
        <img src="app icons/fidnericon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Finder"/>
    ),
    Safari: ({ size = 54 }) => (
        <img src="app icons/safariicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Safari"/>
    ),
    Messages: ({ size = 54 }) => (
        <img src="app icons/messagesicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Messages"/>
    ),
    Mail: ({ size = 54 }) => (
        <img src="app icons/mailicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Mail"/>
    ),
    Maps: ({ size = 54 }) => (
        <img src="app icons/mapsicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Maps"/>
    ),
    Photos: ({ size = 54 }) => (
        <img src="app icons/photosicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Photos"/>
    ),
    Notes: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <defs><linearGradient id="no1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#FFE066"/><stop offset="100%" stopColor="#FFD60A"/></linearGradient></defs>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="url(#no1)"/>
            <rect x="26" y="14" width="68" height="92" rx="6" fill="white"/>
            <line x1="34" y1="32" x2="86" y2="32" stroke="#E5E5EA" strokeWidth="1"/><line x1="34" y1="44" x2="86" y2="44" stroke="#E5E5EA" strokeWidth="1"/>
            <line x1="34" y1="56" x2="86" y2="56" stroke="#E5E5EA" strokeWidth="1"/><line x1="34" y1="68" x2="86" y2="68" stroke="#E5E5EA" strokeWidth="1"/>
            <line x1="34" y1="80" x2="70" y2="80" stroke="#E5E5EA" strokeWidth="1"/>
            <text x="34" y="28" fontSize="8" fill="#1d1d1f" fontWeight="700" fontFamily="Inter">Notes</text>
        </svg>
    ),
    Calculator: ({ size = 54 }) => (
        <img src="app icons/calculatoricon.jfif" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Calculator"/>
    ),
    Terminal: ({ size = 54 }) => (
        <img src="app icons/terminalicon.jfif" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Terminal"/>
    ),
    Settings: ({ size = 54 }) => (
        <img src="app icons/settingsicon.jpg" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Settings"/>
    ),
    Launchpad: ({ size = 54 }) => (
        <img src="app icons/launchpadicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Launchpad"/>
    ),
    Calendar: ({ size = 54 }) => (
        <img src="app icons/calendericon.jfif" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Calendar"/>
    ),
    Word: ({ size = 54 }) => (
        <img src="app icons/wordicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Word"/>
    ),
    Music: ({ size = 54 }) => (
        <img src="app icons/musicicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Music"/>
    ),
    AppStore: ({ size = 54 }) => (
        <img src="app icons/appstoreicon.png" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="App Store"/>
    ),
    Snake: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="#34C759"/>
            <rect x="20" y="50" width="14" height="14" rx="3" fill="white"/>
            <rect x="34" y="50" width="14" height="14" rx="3" fill="white" opacity="0.9"/>
            <rect x="48" y="50" width="14" height="14" rx="3" fill="white" opacity="0.8"/>
            <rect x="62" y="50" width="14" height="14" rx="3" fill="white" opacity="0.7"/>
            <rect x="62" y="64" width="14" height="14" rx="3" fill="white" opacity="0.6"/>
            <rect x="62" y="78" width="14" height="14" rx="3" fill="white" opacity="0.5"/>
            <circle cx="90" cy="35" r="7" fill="#FF3B30"/>
        </svg>
    ),
    Tetris: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="#00BCD4"/>
            <rect x="30" y="25" width="18" height="18" rx="2" fill="#FFD60A"/>
            <rect x="48" y="25" width="18" height="18" rx="2" fill="#FFD60A"/>
            <rect x="30" y="43" width="18" height="18" rx="2" fill="#FFD60A"/>
            <rect x="48" y="43" width="18" height="18" rx="2" fill="#FFD60A"/>
            <rect x="54" y="61" width="18" height="18" rx="2" fill="#AF52DE"/>
            <rect x="36" y="61" width="18" height="18" rx="2" fill="#AF52DE"/>
            <rect x="72" y="61" width="18" height="18" rx="2" fill="#AF52DE"/>
            <rect x="54" y="79" width="18" height="18" rx="2" fill="#AF52DE"/>
            <rect x="66" y="25" width="18" height="18" rx="2" fill="#FF3B30"/>
            <rect x="66" y="43" width="18" height="18" rx="2" fill="#FF3B30"/>
            <rect x="84" y="43" width="18" height="18" rx="2" fill="#FF3B30"/>
        </svg>
    ),
    Game2048: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="#EDA028"/>
            <rect x="18" y="35" width="26" height="26" rx="5" fill="white" opacity="0.9"/>
            <rect x="47" y="35" width="26" height="26" rx="5" fill="white" opacity="0.7"/>
            <rect x="76" y="35" width="26" height="26" rx="5" fill="white" opacity="0.5"/>
            <rect x="18" y="64" width="26" height="26" rx="5" fill="white" opacity="0.6"/>
            <rect x="47" y="64" width="26" height="26" rx="5" fill="white" opacity="0.8"/>
            <rect x="76" y="64" width="26" height="26" rx="5" fill="white"/>
            <text x="60" y="30" textAnchor="middle" fontSize="16" fill="white" fontWeight="800" fontFamily="Inter">2048</text>
        </svg>
    ),
    VSCode: ({ size = 54 }) => (
        <img src="app icons/vscodeicon.jfif" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="VS Code"/>
    ),
    Paint: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="#FF3B30"/>
            <circle cx="40" cy="45" r="8" fill="#FFD60A"/>
            <circle cx="60" cy="35" r="8" fill="#34C759"/>
            <circle cx="80" cy="45" r="8" fill="#007AFF"/>
            <circle cx="50" cy="62" r="8" fill="#AF52DE"/>
            <circle cx="70" cy="62" r="8" fill="#FF9500"/>
            <path d="M55 75L50 100Q60 105 65 100L60 75Z" fill="white" opacity="0.9"/>
            <rect x="53" y="70" width="14" height="10" rx="2" fill="#8B5E3C"/>
        </svg>
    ),
    AboutDev: ({ size = 54 }) => (
        <svg viewBox="0 0 120 120" width={size} height={size}>
            <defs>
                <linearGradient id="abd1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stopColor="#6366F1"/>
                    <stop offset="100%" stopColor="#8B5CF6"/>
                </linearGradient>
            </defs>
            <rect x="2" y="2" width="116" height="116" rx="26" fill="url(#abd1)"/>
            <circle cx="60" cy="42" r="16" fill="white" opacity="0.9"/>
            <ellipse cx="60" cy="82" rx="26" ry="18" fill="white" opacity="0.9"/>
            <text x="60" y="108" textAnchor="middle" fontSize="9" fill="white" opacity="0.7" fontFamily="Inter" fontWeight="600">DEV</text>
        </svg>
    ),
    Trash: ({ size = 54 }) => (
        <img src="app icons/trashicon.jpg" width={size} height={size} style={{ borderRadius: size * 0.22, objectFit: 'cover' }} draggable="false" alt="Trash"/>
    ),
};


window.MacIcons = MacIcons;
</script>

<script type="text/babel">
// macOS Traffic Light Buttons (Close, Minimize, Maximize)
const TrafficLights = ({ windowId, focused = true }) => {
    const [hovered, setHovered] = React.useState(false);

    return (
        <div className="flex gap-2 z-10" onMouseEnter={() => setHovered(true)} onMouseLeave={() => setHovered(false)}>
            {/* Close */}
            <button
                onClick={(e) => { e.stopPropagation(); MacStore.closeWindow(windowId); }}
                className="w-3 h-3 rounded-full flex items-center justify-center transition-all"
                style={{ background: focused ? '#FF5F57' : '#ccc', border: `0.5px solid ${focused ? '#E14942' : '#bbb'}` }}
            >
                {hovered && (
                    <svg viewBox="0 0 12 12" width="8" height="8">
                        <path d="M3.5 3.5l5 5M8.5 3.5l-5 5" stroke="#4d0000" strokeWidth="1.3" fill="none"/>
                    </svg>
                )}
            </button>
            {/* Minimize */}
            <button
                onClick={(e) => { e.stopPropagation(); MacStore.minimizeWindow(windowId); }}
                className="w-3 h-3 rounded-full flex items-center justify-center transition-all"
                style={{ background: focused ? '#FFBD2E' : '#ccc', border: `0.5px solid ${focused ? '#DFA123' : '#bbb'}` }}
            >
                {hovered && (
                    <svg viewBox="0 0 12 12" width="8" height="8">
                        <path d="M2.5 6h7" stroke="#995700" strokeWidth="1.3" fill="none"/>
                    </svg>
                )}
            </button>
            {/* Maximize */}
            <button
                onClick={(e) => { e.stopPropagation(); MacStore.toggleMaximize(windowId); }}
                className="w-3 h-3 rounded-full flex items-center justify-center transition-all"
                style={{ background: focused ? '#28C840' : '#ccc', border: `0.5px solid ${focused ? '#1DAD2B' : '#bbb'}` }}
            >
                {hovered && (
                    <svg viewBox="0 0 12 12" width="8" height="8">
                        <path d="M2 2l3.5 0 0-2M10 10l-3.5 0 0 2M2 10l3.5 0 0 2M10 2l-3.5 0 0-2" stroke="#006500" strokeWidth="1" fill="none" transform="scale(0.75) translate(2,2)"/>
                    </svg>
                )}
            </button>
        </div>
    );
};


window.TrafficLights = TrafficLights;
</script>

<script type="text/babel">
// Custom macOS-style slider with reliable dragging
const MacSlider = ({ min = 0, max = 100, value, onChange, className = '', accentColor }) => {
    const trackRef = React.useRef(null);
    const draggingRef = React.useRef(false);
    const onChangeRef = React.useRef(onChange);
    const propsRef = React.useRef({ min, max });
    const [, forceUpdate] = React.useState(0);

    // Keep refs in sync with latest props
    onChangeRef.current = onChange;
    propsRef.current = { min, max };

    const pct = Math.max(0, Math.min(100, ((value - min) / (max - min)) * 100));

    const calcValue = (clientX) => {
        const rect = trackRef.current.getBoundingClientRect();
        const ratio = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        const { min: mn, max: mx } = propsRef.current;
        return Math.round(mn + ratio * (mx - mn));
    };

    const onMouseDown = (e) => {
        if (e.button !== 0) return;
        e.preventDefault();
        e.stopPropagation();
        draggingRef.current = true;
        forceUpdate(n => n + 1);
        onChangeRef.current(calcValue(e.clientX));

        const onMove = (ev) => {
            ev.preventDefault();
            onChangeRef.current(calcValue(ev.clientX));
        };
        const onUp = () => {
            draggingRef.current = false;
            forceUpdate(n => n + 1);
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
    };

    const darkMode = document.documentElement.classList.contains('dark-mode');
    const trackBg = darkMode ? '#4a4a4a' : '#d1d5db';
    const fillColor = accentColor || 'var(--accent-color, #007AFF)';
    const thumbBg = darkMode ? '#e5e5e7' : 'white';
    const thumbShadow = darkMode
        ? '0 0.5px 1px rgba(0,0,0,0.4), 0 1px 3px rgba(0,0,0,0.3)'
        : '0 0.5px 1px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.15)';

    return (
        <div
            ref={trackRef}
            className={`relative cursor-pointer ${className}`}
            style={{ height: '20px', minWidth: '60px' }}
            onMouseDown={onMouseDown}
        >
            {/* Track background */}
            <div className="absolute left-0 right-0 top-1/2 -translate-y-1/2 rounded-full" style={{ height: '4px', background: trackBg }}/>
            {/* Track fill */}
            <div className="absolute left-0 top-1/2 -translate-y-1/2 rounded-full" style={{ height: '4px', width: pct + '%', background: fillColor }}/>
            {/* Thumb */}
            <div
                className="absolute top-1/2 -translate-y-1/2 rounded-full"
                style={{
                    width: '18px', height: '18px',
                    left: `calc(${pct}% - 9px)`,
                    background: thumbBg,
                    boxShadow: thumbShadow,
                    border: darkMode ? '0.5px solid rgba(255,255,255,0.1)' : '0.5px solid rgba(0,0,0,0.08)',
                    transition: draggingRef.current ? 'none' : 'left 0.1s ease',
                }}
            />
        </div>
    );
};


window.MacSlider = MacSlider;
</script>

<script type="text/babel">
// macOS Window Component with full drag, resize, snap, and genie effect
const Window = ({ windowData, children }) => {
    const [isDragging, setIsDragging] = React.useState(false);
    const [isResizing, setIsResizing] = React.useState(false);
    const dragState = React.useRef({ dragging: false, resizing: false, dir: '', startX: 0, startY: 0, winX: 0, winY: 0, winW: 0, winH: 0, winId: null });

    const { id, title, focused, zIndex, minimized, maximized, opening, closing, x, y, width, height } = windowData;
    const darkMode = useStore(s => s.darkMode);

    // Unified mouse handlers on window level - never lost even on fast moves
    React.useEffect(() => {
        const onMouseMove = (e) => {
            const ds = dragState.current;
            if (!ds.dragging && !ds.resizing) return;
            e.preventDefault();
            const dx = e.clientX - ds.startX;
            const dy = e.clientY - ds.startY;
            if (ds.dragging) {
                MacStore.updateWindow(ds.winId, {
                    x: ds.winX + dx,
                    y: Math.max(0, ds.winY + dy),
                });
                // Window snap zones
                if (e.clientX <= 3) MacStore.setState({ windowSnapPreview: 'left' });
                else if (e.clientX >= window.innerWidth - 3) MacStore.setState({ windowSnapPreview: 'right' });
                else MacStore.setState({ windowSnapPreview: null });
            }
            if (ds.resizing) {
                let newW = ds.winW, newH = ds.winH, newX = ds.winX, newY = ds.winY;
                if (ds.dir.includes('e')) newW = Math.max(300, ds.winW + dx);
                if (ds.dir.includes('w')) { newW = Math.max(300, ds.winW - dx); newX = ds.winX + (ds.winW - newW); }
                if (ds.dir.includes('s')) newH = Math.max(200, ds.winH + dy);
                if (ds.dir.includes('n')) { newH = Math.max(200, ds.winH - dy); newY = Math.max(0, ds.winY + (ds.winH - newH)); }
                MacStore.updateWindow(ds.winId, { x: newX, y: newY, width: newW, height: newH });
            }
        };
        const onMouseUp = () => {
            if (!dragState.current.dragging && !dragState.current.resizing) return;
            // Apply snap if preview is active
            if (dragState.current.dragging) {
                const snap = MacStore.getState().windowSnapPreview;
                if (snap === 'left') {
                    MacStore.updateWindow(dragState.current.winId, { x: 0, y: 25, width: Math.floor(window.innerWidth / 2), height: window.innerHeight - 25, maximized: false });
                } else if (snap === 'right') {
                    MacStore.updateWindow(dragState.current.winId, { x: Math.floor(window.innerWidth / 2), y: 25, width: Math.floor(window.innerWidth / 2), height: window.innerHeight - 25, maximized: false });
                }
                MacStore.setState({ windowSnapPreview: null });
            }
            dragState.current.dragging = false;
            dragState.current.resizing = false;
            setIsDragging(false);
            setIsResizing(false);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        };
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        return () => {
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
        };
    }, []);

    // Drag handlers
    const onDragStart = (e) => {
        if (e.target.closest('button')) return;
        e.preventDefault();
        // Un-snap: if window was snapped to half, restore original size on drag
        if (width === Math.floor(window.innerWidth / 2) && height === window.innerHeight - 25) {
            const origW = 800, origH = 500;
            dragState.current = { dragging: true, resizing: false, dir: '', startX: e.clientX, startY: e.clientY, winX: e.clientX - origW / 2, winY: y, winW: origW, winH: origH, winId: id };
            MacStore.updateWindow(id, { width: origW, height: origH, x: e.clientX - origW / 2 });
        } else {
            dragState.current = { dragging: true, resizing: false, dir: '', startX: e.clientX, startY: e.clientY, winX: x, winY: y, winW: width, winH: height, winId: id };
        }
        setIsDragging(true);
        document.body.style.cursor = 'move';
        document.body.style.userSelect = 'none';
    };

    const startResize = (dir) => (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragState.current = { dragging: false, resizing: true, dir, startX: e.clientX, startY: e.clientY, winX: x, winY: y, winW: width, winH: height, winId: id };
        setIsResizing(true);
        document.body.style.userSelect = 'none';
    };

    const { minimizing, restoring } = windowData;
    if (minimized && !minimizing) return null;

    const windowStyle = maximized
        ? { top: 0, left: 0, width: '100vw', height: 'calc(100vh - 25px)', zIndex, borderRadius: 0 }
        : { top: y, left: x, width, height, zIndex };

    const animClass = opening ? 'animate-window-open'
        : closing ? 'animate-window-close pointer-events-none'
        : minimizing ? 'animate-genie-minimize pointer-events-none'
        : restoring ? 'animate-genie-restore'
        : '';
    const shadowClass = isDragging ? 'window-shadow-dragging' : focused ? 'window-shadow-focused' : 'window-shadow-unfocused';
    const transitionClass = (!isDragging && !isResizing && !opening && !closing && !minimizing && !restoring) ? 'window-transition' : '';

    return (
        <div
            className={`absolute flex flex-col rounded-xl overflow-hidden border border-black/10 ${shadowClass} ${animClass} ${transitionClass}`}
            style={{ ...windowStyle, opacity: isDragging ? 0.88 : 1, transition: isDragging ? 'none' : undefined, transformOrigin: 'bottom center' }}
            onMouseDown={() => { if (!focused) MacStore.focusWindow(id); }}
        >
            {/* Translucent background */}
            <div className="absolute inset-0 glass pointer-events-none" style={{ zIndex: -1 }}/>

            {/* Title bar */}
            <div
                className={`flex items-center h-[38px] min-h-[38px] px-3 border-b relative cursor-default ${darkMode ? 'border-white/5' : 'border-black/5'}`}
                onMouseDown={onDragStart}
                onDoubleClick={() => MacStore.toggleMaximize(id)}
                style={{ background: darkMode
                    ? (focused ? 'rgba(56,56,56,0.98)' : 'rgba(48,48,48,0.95)')
                    : (focused ? 'rgba(236,236,236,0.95)' : 'rgba(230,230,230,0.95)') }}
            >
                <TrafficLights windowId={id} focused={focused} />
                <div className={`absolute left-0 right-0 text-center text-[13px] font-medium pointer-events-none select-none ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>
                    {title}
                </div>
            </div>

            {/* Window content */}
            <div className={`flex-1 overflow-hidden relative ${darkMode ? 'bg-[#1e1e1e] text-gray-200' : 'bg-white'}`}>
                {children}
            </div>

            {/* Resize handles */}
            {!maximized && (
                <>
                    <div className="absolute top-0 left-1.5 right-1.5 h-1 cursor-n-resize" onMouseDown={startResize('n')}/>
                    <div className="absolute bottom-0 left-1.5 right-1.5 h-1 cursor-s-resize" onMouseDown={startResize('s')}/>
                    <div className="absolute left-0 top-1.5 bottom-1.5 w-1 cursor-w-resize" onMouseDown={startResize('w')}/>
                    <div className="absolute right-0 top-1.5 bottom-1.5 w-1 cursor-e-resize" onMouseDown={startResize('e')}/>
                    <div className="absolute top-0 right-0 w-3 h-3 cursor-ne-resize" onMouseDown={startResize('ne')}/>
                    <div className="absolute top-0 left-0 w-3 h-3 cursor-nw-resize" onMouseDown={startResize('nw')}/>
                    <div className="absolute bottom-0 right-0 w-3 h-3 cursor-se-resize" onMouseDown={startResize('se')}/>
                    <div className="absolute bottom-0 left-0 w-3 h-3 cursor-sw-resize" onMouseDown={startResize('sw')}/>
                </>
            )}
        </div>
    );
};


window.Window = Window;
</script>

<script type="text/babel">
// Finder App - File browser with VFS, drag-and-drop, right-click context menu support
const FinderApp = () => {
    const [currentPath, setCurrentPath] = React.useState('/Users/user');
    const [selectedItem, setSelectedItem] = React.useState(null);
    const [activeSidebar, setActiveSidebar] = React.useState('Home');
    const [renaming, setRenaming] = React.useState(null);
    const [renameValue, setRenameValue] = React.useState('');
    const [dragOverItem, setDragOverItem] = React.useState(null);
    const [dragOverSidebar, setDragOverSidebar] = React.useState(null);
    const [draggingItem, setDraggingItem] = React.useState(null);
    const [dragGhost, setDragGhost] = React.useState(null);
    const vfsVersion = useStore(s => s.vfsVersion);
    const fileDrag = useStore(s => s.fileDrag);
    const dragRef = React.useRef({ startX: 0, startY: 0, name: null, moved: false, currentPath: '' });
    const containerRef = React.useRef(null);

    const sidebarItems = [
        { section: 'Favorites', items: [
            { name: 'Home', icon: 'ðŸ ', path: '/Users/user' },
            { name: 'Desktop', icon: 'ðŸ–¥ï¸', path: '/Users/user/Desktop' },
            { name: 'Documents', icon: 'ðŸ“„', path: '/Users/user/Documents' },
            { name: 'Downloads', icon: 'â¬‡ï¸', path: '/Users/user/Downloads' },
            { name: 'Applications', icon: 'ðŸ“±', path: '/Users/user/Applications' },
            { name: 'Pictures', icon: 'ðŸ–¼ï¸', path: '/Users/user/Pictures' },
        ]},
        { section: 'iCloud', items: [
            { name: 'iCloud Drive', icon: 'â˜ï¸', path: '/Users/user' },
        ]},
        { section: 'Locations', items: [
            { name: 'Macintosh HD', icon: 'ðŸ’»', path: '/Users/user' },
        ]},
        { section: 'Tags', items: [
            { name: 'Red', color: '#FF3B30' },
            { name: 'Orange', color: '#FF9500' },
            { name: 'Green', color: '#34C759' },
            { name: 'Blue', color: '#007AFF' },
            { name: 'Purple', color: '#AF52DE' },
        ]},
    ];

    const files = VFS.ls(currentPath);

    const navigateTo = (item) => {
        if (item.type === 'folder') {
            const newPath = currentPath + '/' + item.name;
            if (VFS.isDir(newPath)) { setCurrentPath(newPath); setSelectedItem(null); }
        }
    };

    const goBack = () => {
        const parts = currentPath.split('/');
        if (parts.length > 3) { parts.pop(); const np = parts.join('/'); if (VFS.isDir(np)) setCurrentPath(np); }
    };

    const createNewFolder = () => {
        let name = 'untitled folder'; let i = 1;
        while (VFS.exists(currentPath + '/' + name)) { name = 'untitled folder ' + i; i++; }
        VFS.mkdir(currentPath, name);
    };

    const createNewFile = () => {
        let name = 'untitled.txt'; let i = 1;
        while (VFS.exists(currentPath + '/' + name)) { name = 'untitled ' + i + '.txt'; i++; }
        VFS.touch(currentPath, name, '');
    };

    const moveToTrash = () => {
        if (selectedItem) {
            VFS.moveToTrash(currentPath, selectedItem);
            MacStore.addNotification('Finder', 'Moved to Trash', selectedItem + ' has been moved to the Trash.');
            setSelectedItem(null);
        }
    };

    const startRename = (name) => { setRenaming(name); setRenameValue(name); };

    const finishRename = () => {
        if (renaming && renameValue && renameValue !== renaming) VFS.rename(currentPath, renaming, renameValue);
        setRenaming(null);
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Delete' || e.key === 'Backspace') { if (selectedItem && !renaming) moveToTrash(); }
        if (e.key === 'Enter' && selectedItem && !renaming) startRename(selectedItem);
    };

    // Helper: find drop target from mouse position using elementFromPoint
    const findDropTarget = (clientX, clientY) => {
        const el = document.elementFromPoint(clientX, clientY);
        if (!el) return { folder: null, sidebar: null };

        // Check if over a folder in the file grid
        const folderEl = el.closest('[data-finder-folder]');
        if (folderEl) {
            return { folder: folderEl.getAttribute('data-finder-folder'), sidebar: null };
        }

        // Check if over a sidebar item
        const sidebarEl = el.closest('[data-sidebar-path]');
        if (sidebarEl) {
            return { folder: null, sidebar: sidebarEl.getAttribute('data-sidebar-path') };
        }

        return { folder: null, sidebar: null };
    };

    // --- Drag-and-drop for Finder files ---
    const handleFileMouseDown = (e, fileName) => {
        if (e.button !== 0 || renaming) return;
        dragRef.current = { startX: e.clientX, startY: e.clientY, name: fileName, moved: false, currentPath };

        const onMove = (ev) => {
            const dx = ev.clientX - dragRef.current.startX;
            const dy = ev.clientY - dragRef.current.startY;
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) dragRef.current.moved = true;
            if (!dragRef.current.moved) return;

            setDraggingItem(dragRef.current.name);
            setDragGhost({ x: ev.clientX, y: ev.clientY });

            // Set global drag state
            const state = MacStore.getState();
            if (!state.fileDrag || state.fileDrag.name !== dragRef.current.name) {
                MacStore.setState({ fileDrag: { name: dragRef.current.name, sourcePath: dragRef.current.currentPath, type: 'finder' } });
            }

            // Detect drop targets via elementFromPoint
            const { folder, sidebar } = findDropTarget(ev.clientX, ev.clientY);
            setDragOverItem(folder && folder !== dragRef.current.name ? folder : null);
            setDragOverSidebar(sidebar);
        };

        const onUp = (ev) => {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);

            if (dragRef.current.moved) {
                const dragName = dragRef.current.name;
                const srcPath = dragRef.current.currentPath;

                // Detect final drop target
                const { folder, sidebar } = findDropTarget(ev.clientX, ev.clientY);

                if (folder && folder !== dragName) {
                    // Dropped on a folder in the file grid
                    const destPath = srcPath + '/' + folder;
                    if (VFS.isDir(destPath)) {
                        VFS.move(srcPath, dragName, destPath);
                        MacStore.addNotification('Finder', 'Moved', dragName + ' â†’ ' + folder);
                    }
                } else if (sidebar && sidebar !== srcPath) {
                    // Dropped on a sidebar location
                    VFS.move(srcPath, dragName, sidebar);
                    MacStore.addNotification('Finder', 'Moved', dragName + ' â†’ ' + sidebar.split('/').pop());
                } else {
                    // Check if dropped outside Finder (onto desktop)
                    const el = document.elementFromPoint(ev.clientX, ev.clientY);
                    if (el && (el.id === 'desktop-bg' || (el.closest('#desktop-bg') && !el.closest('.glass-dock') && !el.closest('[data-finder-file]')))) {
                        if (srcPath !== '/Users/user/Desktop') {
                            VFS.move(srcPath, dragName, '/Users/user/Desktop');
                            MacStore.addNotification('Finder', 'Moved to Desktop', dragName);
                        }
                    }
                }
            }

            setDraggingItem(null);
            setDragGhost(null);
            setDragOverItem(null);
            setDragOverSidebar(null);
            MacStore.setState({ fileDrag: null });
            dragRef.current.moved = false;
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
    };

    // Handle drops from Desktop onto Finder
    React.useEffect(() => {
        if (!containerRef.current) return;
        const el = containerRef.current;

        const onMouseUp = (e) => {
            const drag = MacStore.getState().fileDrag;
            if (drag && drag.type === 'desktop' && drag.sourcePath) {
                const target = document.elementFromPoint(e.clientX, e.clientY);
                if (target && (el.contains(target) || target === el)) {
                    const folderEl = target.closest('[data-finder-folder]');
                    if (folderEl) {
                        const folderName = folderEl.getAttribute('data-finder-folder');
                        const destPath = currentPath + '/' + folderName;
                        if (VFS.isDir(destPath)) {
                            VFS.move(drag.sourcePath, drag.name, destPath);
                            MacStore.addNotification('Finder', 'Moved', drag.name + ' â†’ ' + folderName);
                        }
                    } else {
                        if (drag.sourcePath !== currentPath) {
                            VFS.move(drag.sourcePath, drag.name, currentPath);
                            MacStore.addNotification('Finder', 'Moved', drag.name + ' â†’ ' + currentPath.split('/').pop());
                        }
                    }
                }
            }
        };

        el.addEventListener('mouseup', onMouseUp);
        return () => el.removeEventListener('mouseup', onMouseUp);
    }, [currentPath]);

    return (
        <div ref={containerRef} className="flex h-full" onKeyDown={handleKeyDown} tabIndex={0}>
            <div className="w-[200px] min-w-[200px] bg-gray-100/50 border-r border-black/5 py-2 overflow-y-auto">
                {sidebarItems.map(section => (
                    <div key={section.section} className="mb-3">
                        <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider px-5 py-1">{section.section}</div>
                        {section.items.map(item => (
                            <div key={item.name}
                                data-sidebar-path={item.path || ''}
                                className={`flex items-center gap-2 px-5 py-[3px] mx-2 rounded-md text-[13px] cursor-default transition-colors
                                    ${activeSidebar === item.name ? 'bg-blue-500 text-white' : 'hover:bg-black/5'}
                                    ${dragOverSidebar === item.path ? 'bg-blue-400/30 ring-2 ring-blue-400/50' : ''}`}
                                onClick={() => { setActiveSidebar(item.name); if (item.path) setCurrentPath(item.path); }}>
                                {item.color ? <div className="w-3 h-3 rounded-full" style={{ background: item.color }}/> : <span className="text-sm">{item.icon}</span>}
                                <span>{item.name}</span>
                            </div>
                        ))}
                    </div>
                ))}
            </div>

            <div className="flex-1 flex flex-col">
                <div className="flex items-center gap-2 px-3 py-1.5 bg-gray-100/70 border-b border-black/5">
                    <button onClick={goBack} className="p-1.5 rounded-md hover:bg-black/5">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="#666"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <div className="flex-1"/>
                    <button onClick={createNewFolder} className="p-1.5 rounded-md hover:bg-black/5" title="New Folder">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm0 12H4V8h16v10zm-8-1h2v-3h3v-2h-3V9h-2v3H9v2h3v3z"/></svg>
                    </button>
                    <button onClick={createNewFile} className="p-1.5 rounded-md hover:bg-black/5" title="New File">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9H13z"/></svg>
                    </button>
                    {selectedItem && (
                        <button onClick={moveToTrash} className="p-1.5 rounded-md hover:bg-red-100 text-red-500" title="Move to Trash">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    )}
                </div>

                <div className="flex-1 p-3 overflow-auto grid gap-1" style={{ gridTemplateColumns: 'repeat(auto-fill, minmax(90px, 1fr))', alignContent: 'start' }}>
                    {files.map(file => {
                        const isDragging = draggingItem === file.name;
                        const isDropTarget = dragOverItem === file.name && file.type === 'folder';
                        const isExternalDropTarget = fileDrag && fileDrag.type === 'desktop' && dragOverItem === file.name && file.type === 'folder';

                        return (
                            <div key={file.name}
                                data-finder-file={file.name}
                                data-finder-path={currentPath}
                                data-file-type={file.type}
                                data-finder-folder={file.type === 'folder' ? file.name : undefined}
                                className={`flex flex-col items-center p-2 rounded-lg cursor-default gap-1 transition-all
                                    ${selectedItem === file.name ? 'bg-blue-500/15' : 'hover:bg-black/[0.03]'}
                                    ${isDragging ? 'opacity-40' : ''}
                                    ${isDropTarget || isExternalDropTarget ? 'bg-blue-400/20 ring-2 ring-blue-400/50 scale-105' : ''}`}
                                onClick={() => setSelectedItem(file.name)}
                                onMouseDown={(e) => handleFileMouseDown(e, file.name)}
                                onDoubleClick={() => {
                                    if (dragRef.current.moved) return;
                                    if (file.type === 'folder') navigateTo(file);
                                    else if (file.name.endsWith('.py')) {
                                        MacStore.setState({ pendingOpenFile: { path: currentPath, name: file.name } });
                                        MacStore.openWindow('vscode', 'VS Code', 950, 650);
                                    }
                                    else if (file.name.endsWith('.txt') || file.name.endsWith('.md') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                                        MacStore.setState({ pendingOpenFile: { path: currentPath, name: file.name } });
                                        MacStore.openWindow('word', 'Word', 900, 700);
                                    }
                                }}>
                                <div className="w-[54px] h-[54px] flex items-center justify-center text-4xl">
                                    {file.type === 'folder' ? (
                                        <svg viewBox="0 0 48 48" width="48" height="48">
                                            <path d="M6 8h14l4 4h18c1.1 0 2 .9 2 2v24c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2z" fill={file.color || '#64B5F6'}/>
                                            <rect x="4" y="14" width="40" height="24" rx="2" fill={file.color || '#42A5F5'} opacity="0.85"/>
                                        </svg>
                                    ) : <span>{file.icon}</span>}
                                </div>
                                <div className="text-[11px] text-center leading-tight max-w-[80px] break-words">
                                    {renaming === file.name ? (
                                        <input type="text" value={renameValue} onChange={(e) => setRenameValue(e.target.value)}
                                            onBlur={finishRename} onKeyDown={(e) => { if (e.key === 'Enter') finishRename(); if (e.key === 'Escape') setRenaming(null); }}
                                            className="w-full text-center bg-white border border-blue-500 rounded px-1 outline-none text-[11px]" autoFocus/>
                                    ) : file.name}
                                </div>
                            </div>
                        );
                    })}
                    {files.length === 0 && (
                        <div className="col-span-full text-center text-gray-400 text-[13px] py-12">This folder is empty</div>
                    )}
                </div>

                <div className="flex items-center gap-1 px-3 py-1 bg-gray-100/70 border-t border-black/5 text-[11px] text-gray-400">
                    <span>{files.length} items</span>
                    <span className="mx-2">Â·</span>
                    <span>{currentPath.replace('/Users/user', '~')}</span>
                </div>
            </div>

            {/* Drag ghost overlay */}
            {dragGhost && draggingItem && (
                <div className="fixed pointer-events-none z-[99999]"
                    style={{ left: dragGhost.x + 12, top: dragGhost.y - 12 }}>
                    <div className="bg-blue-500/80 text-white text-[11px] px-2 py-1 rounded-md shadow-lg whitespace-nowrap">
                        {draggingItem}
                    </div>
                </div>
            )}
        </div>
    );
};


window.FinderApp = FinderApp;
</script>

<script type="text/babel">
// Safari App - Real web browsing via iframe
const SafariApp = () => {
    const [url, setUrl] = React.useState('');
    const [displayUrl, setDisplayUrl] = React.useState('');
    const [currentUrl, setCurrentUrl] = React.useState('');
    const [isLoading, setIsLoading] = React.useState(false);
    const [showStartPage, setShowStartPage] = React.useState(true);
    const [tabs, setTabs] = React.useState([{ id: 1, title: 'Start Page', url: '' }]);
    const [activeTab, setActiveTab] = React.useState(1);
    const [iframeError, setIframeError] = React.useState(false);
    const iframeRef = React.useRef(null);

    const favorites = [
        { name: 'Google', url: 'https://www.google.com/webhp?igu=1', color: '#4285F4', letter: 'G' },
        { name: 'Wikipedia', url: 'https://en.m.wikipedia.org', color: '#666', letter: 'W' },
        { name: 'DuckDuckGo', url: 'https://duckduckgo.com', color: '#DE5833', letter: 'D' },
        { name: 'Hacker News', url: 'https://news.ycombinator.com', color: '#FF6600', letter: 'Y' },
        { name: 'Archive.org', url: 'https://archive.org', color: '#333', letter: 'A' },
        { name: 'OpenAI', url: 'https://openai.com', color: '#10A37F', letter: 'O' },
        { name: 'MDN Docs', url: 'https://developer.mozilla.org', color: '#000', letter: 'M' },
        { name: 'Bing', url: 'https://www.bing.com', color: '#008373', letter: 'B' },
    ];

    const navigate = (targetUrl) => {
        let finalUrl = targetUrl;
        if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
            if (finalUrl.includes('.') && !finalUrl.includes(' ')) {
                finalUrl = 'https://' + finalUrl;
            } else {
                // Use DuckDuckGo for search - it works in iframes
                finalUrl = 'https://duckduckgo.com/?q=' + encodeURIComponent(finalUrl);
            }
        }
        setCurrentUrl(finalUrl);
        setDisplayUrl(finalUrl.replace('https://', '').replace('http://', '').replace('www.', '').split('/')[0]);
        setShowStartPage(false);
        setIsLoading(true);
        setIframeError(false);

        // Update tab
        const domain = finalUrl.replace('https://', '').replace('http://','').replace('www.','').split('/')[0];
        setTabs(prev => prev.map(t =>
            t.id === activeTab ? { ...t, title: domain, url: finalUrl } : t
        ));
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            navigate(url);
        }
    };

    const addTab = () => {
        const newId = Date.now();
        setTabs(prev => [...prev, { id: newId, title: 'Start Page', url: '' }]);
        setActiveTab(newId);
        setShowStartPage(true);
        setCurrentUrl('');
        setDisplayUrl('');
        setUrl('');
        setIframeError(false);
    };

    const closeTab = (id, e) => {
        e.stopPropagation();
        if (tabs.length === 1) return;
        const newTabs = tabs.filter(t => t.id !== id);
        setTabs(newTabs);
        if (activeTab === id) {
            const tab = newTabs[newTabs.length - 1];
            setActiveTab(tab.id);
            setCurrentUrl(tab.url);
            setShowStartPage(!tab.url);
            setDisplayUrl(tab.url ? tab.url.replace('https://','').replace('http://','').replace('www.','').split('/')[0] : '');
        }
    };

    const goHome = () => {
        setShowStartPage(true);
        setCurrentUrl('');
        setDisplayUrl('');
        setUrl('');
        setIframeError(false);
        setTabs(prev => prev.map(t =>
            t.id === activeTab ? { ...t, title: 'Start Page', url: '' } : t
        ));
    };

    return (
        <div className="flex flex-col h-full bg-white">
            {/* Tab bar */}
            <div className="flex items-center gap-px px-2 bg-gray-100/95 border-b border-black/5 min-h-[32px]">
                {tabs.map(tab => (
                    <div
                        key={tab.id}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-t-lg text-[12px] cursor-default max-w-[200px] relative group
                            ${tab.id === activeTab ? 'bg-white' : 'bg-gray-200/60 hover:bg-gray-200/80'}`}
                        onClick={() => {
                            setActiveTab(tab.id);
                            setCurrentUrl(tab.url);
                            setShowStartPage(!tab.url);
                            setDisplayUrl(tab.url ? tab.url.replace('https://','').replace('http://','').replace('www.','').split('/')[0] : '');
                        }}
                    >
                        <span className="truncate">{tab.title}</span>
                        <button
                            onClick={(e) => closeTab(tab.id, e)}
                            className="w-4 h-4 rounded-full text-[14px] leading-[14px] text-center opacity-0 group-hover:opacity-100 hover:bg-black/10 flex-shrink-0"
                        >Ã—</button>
                    </div>
                ))}
                <button onClick={addTab} className="ml-1 w-6 h-6 flex items-center justify-center rounded hover:bg-black/5 text-gray-400 text-lg">+</button>
            </div>

            {/* URL bar & navigation */}
            <div className="flex items-center gap-2 px-3 py-1.5 bg-gray-50/95 border-b border-black/5">
                <div className="flex gap-1">
                    <button onClick={() => { if(iframeRef.current) try { iframeRef.current.contentWindow.history.back(); } catch(e) {} }}
                        className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="#666"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button onClick={() => { if(iframeRef.current) try { iframeRef.current.contentWindow.history.forward(); } catch(e) {} }}
                        className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="#ccc"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>

                <div className="flex-1 relative">
                    <div className={`flex items-center h-[30px] rounded-lg px-3 text-[13px] border transition-all
                        ${url !== undefined ? 'bg-white border-blue-500 shadow-[0_0_0_3px_rgba(0,122,255,0.1)]' : 'bg-black/5 border-transparent'}`}
                    >
                        {isLoading && (
                            <svg className="animate-spin w-3.5 h-3.5 mr-2 text-blue-500" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" opacity="0.2"/>
                                <path d="M12 2a10 10 0 019.95 9" stroke="currentColor" strokeWidth="3" strokeLinecap="round"/>
                            </svg>
                        )}
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#999" className="mr-1.5 flex-shrink-0">
                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                        </svg>
                        <input
                            type="text"
                            value={url}
                            onChange={(e) => setUrl(e.target.value)}
                            onKeyDown={handleKeyDown}
                            onFocus={() => setUrl(currentUrl || '')}
                            placeholder="Search or enter website name"
                            className="w-full bg-transparent outline-none text-[13px] text-center font-sf"
                        />
                    </div>
                </div>

                <button onClick={goHome}
                    className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5"
                    title="Start Page"
                >
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                </button>
                <button
                    onClick={() => { if(iframeRef.current) iframeRef.current.src = iframeRef.current.src; }}
                    className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5"
                >
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                </button>
            </div>

            {/* Content */}
            <div className="flex-1 relative overflow-hidden">
                {showStartPage ? (
                    <div className="p-12 max-w-[800px] mx-auto">
                        <h2 className="text-xl font-semibold mb-6 text-gray-800">Favorites</h2>
                        <div className="grid grid-cols-4 gap-6">
                            {favorites.map(fav => (
                                <div
                                    key={fav.name}
                                    className="flex flex-col items-center gap-2 cursor-default group"
                                    onClick={() => { setUrl(fav.url); navigate(fav.url); }}
                                >
                                    <div className="w-[52px] h-[52px] rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-md transition-transform group-hover:scale-105"
                                        style={{ background: fav.color }}>
                                        {fav.letter}
                                    </div>
                                    <span className="text-[11px] text-gray-500">{fav.name}</span>
                                </div>
                            ))}
                        </div>
                        <div className="mt-8 bg-blue-50 rounded-xl p-4 text-[13px] text-blue-700 border border-blue-100">
                            <strong>Tip:</strong> Type any search term and press Enter to search with DuckDuckGo, or enter a URL directly. Some websites may block iframe loading â€” try Wikipedia, DuckDuckGo, Hacker News, or Archive.org for best results.
                        </div>
                        <h2 className="text-xl font-semibold mt-8 mb-4 text-gray-800">Privacy Report</h2>
                        <div className="bg-gray-50 rounded-xl p-4 text-[13px] text-gray-500">
                            Safari has prevented 12 trackers from profiling you in the last 7 days.
                        </div>
                    </div>
                ) : (
                    <div className="w-full h-full relative">
                        <iframe
                            ref={iframeRef}
                            src={currentUrl}
                            className="w-full h-full border-none bg-white"
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-popups-to-escape-sandbox"
                            referrerPolicy="no-referrer"
                            onLoad={() => setIsLoading(false)}
                            title="Safari Browser"
                        />
                        {iframeError && (
                            <div className="absolute inset-0 flex items-center justify-center bg-white">
                                <div className="text-center p-8">
                                    <div className="text-[48px] mb-4">ðŸŒ</div>
                                    <h3 className="text-[18px] font-semibold mb-2">Cannot Open Page</h3>
                                    <p className="text-[13px] text-gray-500 mb-4 max-w-[300px]">
                                        This website cannot be displayed in Safari because it blocks embedded viewing.
                                    </p>
                                    <button onClick={goHome}
                                        className="px-4 py-2 bg-blue-500 text-white text-[13px] rounded-lg hover:bg-blue-600">
                                        Go to Start Page
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};


window.SafariApp = SafariApp;
</script>

<script type="text/babel">
// Calculator Button - defined outside to prevent remount on parent re-render
const CalcButton = ({ label, onClick, type = 'number', span = 1, activeOp }) => {
    const isActive = type === 'operator' && activeOp === label;
    const bgClass = type === 'number' ? 'bg-[#505050] hover:bg-[#6a6a6a] text-white'
        : type === 'operator' ? (isActive ? 'bg-white text-[#FF9500]' : 'bg-[#FF9500] hover:bg-[#FFa833] text-white')
        : 'bg-[#a5a5a5] hover:bg-[#b5b5b5] text-[#333]';

    return (
        <button
            onMouseDown={(e) => e.stopPropagation()}
            onClick={onClick}
            className={`${bgClass} flex items-center text-[22px] h-full rounded-none active:brightness-125 transition-all cursor-default
                ${span > 1 ? 'col-span-2 justify-start pl-7' : 'justify-center'}`}
            style={{ fontFamily: 'Inter, sans-serif' }}
        >
            {label}
        </button>
    );
};

// Calculator App - Fully functional with expression display
const CalculatorApp = () => {
    const [display, setDisplay] = React.useState('0');
    const [expression, setExpression] = React.useState('');
    const [firstOperand, setFirstOperand] = React.useState(null);
    const [operator, setOperator] = React.useState(null);
    const [waitingForSecond, setWaitingForSecond] = React.useState(false);
    const [activeOp, setActiveOp] = React.useState(null);

    const inputNumber = (num) => {
        if (waitingForSecond) {
            setDisplay(String(num));
            setExpression(prev => prev + ' ' + num);
            setWaitingForSecond(false);
            setActiveOp(null);
        } else {
            const newDisplay = display === '0' ? String(num) : display + num;
            setDisplay(newDisplay);
            if (expression === '' || expression === '0') {
                setExpression(String(num));
            } else if (operator && expression.endsWith(' ')) {
                setExpression(prev => prev + num);
            } else {
                setExpression(prev => prev + num);
            }
        }
    };

    const inputDecimal = () => {
        if (waitingForSecond) {
            setDisplay('0.');
            setExpression(prev => prev + ' 0.');
            setWaitingForSecond(false);
            return;
        }
        if (!display.includes('.')) {
            setDisplay(display + '.');
            setExpression(prev => prev + '.');
        }
    };

    const calculate = (a, b, op) => {
        switch(op) {
            case '+': return a + b;
            case 'âˆ’': return a - b;
            case 'Ã—': return a * b;
            case 'Ã·': return b !== 0 ? a / b : 'Error';
            default: return b;
        }
    };

    const inputOperator = (op) => {
        const current = parseFloat(display);
        if (firstOperand !== null && !waitingForSecond) {
            const result = calculate(firstOperand, current, operator);
            setDisplay(String(result));
            setFirstOperand(result);
            setExpression(String(result) + ' ' + op);
        } else {
            setFirstOperand(current);
            setExpression(current + ' ' + op);
        }
        setOperator(op);
        setWaitingForSecond(true);
        setActiveOp(op);
    };

    const inputEquals = () => {
        if (!operator || waitingForSecond) return;
        const second = parseFloat(display);
        const result = calculate(firstOperand, second, operator);
        setExpression(firstOperand + ' ' + operator + ' ' + second + ' =');
        setDisplay(String(result));
        setFirstOperand(null);
        setOperator(null);
        setWaitingForSecond(false);
        setActiveOp(null);
    };

    const clear = () => {
        setDisplay('0');
        setExpression('');
        setFirstOperand(null);
        setOperator(null);
        setWaitingForSecond(false);
        setActiveOp(null);
    };

    const toggleSign = () => {
        const val = String(-parseFloat(display));
        setDisplay(val);
    };
    const percent = () => {
        const val = String(parseFloat(display) / 100);
        setDisplay(val);
    };

    // Format display number
    let displayText = display;
    if (displayText !== 'Error' && !isNaN(displayText) && displayText.length > 12) {
        displayText = parseFloat(displayText).toPrecision(9);
    }
    const fontSize = displayText.length > 9 ? 'text-[32px]' : displayText.length > 7 ? 'text-[40px]' : 'text-[48px]';

    return (
        <div className="flex flex-col h-full bg-[#333]">
            <div className="px-6 pt-3 pb-1 text-right bg-[#333]">
                <div className="text-[14px] text-gray-400 min-h-[20px] overflow-hidden text-right truncate" style={{ fontFamily: 'Inter, sans-serif' }}>
                    {expression}
                </div>
                <div className={`${fontSize} font-light text-white min-h-[54px] flex items-center justify-end overflow-hidden`}>
                    {displayText}
                </div>
            </div>
            <div className="grid grid-cols-4 gap-px flex-1">
                <CalcButton label="AC" onClick={clear} type="function" activeOp={activeOp}/>
                <CalcButton label="Â±" onClick={toggleSign} type="function" activeOp={activeOp}/>
                <CalcButton label="%" onClick={percent} type="function" activeOp={activeOp}/>
                <CalcButton label="Ã·" onClick={() => inputOperator('Ã·')} type="operator" activeOp={activeOp}/>

                <CalcButton label="7" onClick={() => inputNumber(7)} activeOp={activeOp}/>
                <CalcButton label="8" onClick={() => inputNumber(8)} activeOp={activeOp}/>
                <CalcButton label="9" onClick={() => inputNumber(9)} activeOp={activeOp}/>
                <CalcButton label="Ã—" onClick={() => inputOperator('Ã—')} type="operator" activeOp={activeOp}/>

                <CalcButton label="4" onClick={() => inputNumber(4)} activeOp={activeOp}/>
                <CalcButton label="5" onClick={() => inputNumber(5)} activeOp={activeOp}/>
                <CalcButton label="6" onClick={() => inputNumber(6)} activeOp={activeOp}/>
                <CalcButton label="âˆ’" onClick={() => inputOperator('âˆ’')} type="operator" activeOp={activeOp}/>

                <CalcButton label="1" onClick={() => inputNumber(1)} activeOp={activeOp}/>
                <CalcButton label="2" onClick={() => inputNumber(2)} activeOp={activeOp}/>
                <CalcButton label="3" onClick={() => inputNumber(3)} activeOp={activeOp}/>
                <CalcButton label="+" onClick={() => inputOperator('+')} type="operator" activeOp={activeOp}/>

                <CalcButton label="0" onClick={() => inputNumber(0)} span={2} activeOp={activeOp}/>
                <CalcButton label="." onClick={inputDecimal} activeOp={activeOp}/>
                <CalcButton label="=" onClick={inputEquals} type="operator" activeOp={activeOp}/>
            </div>
        </div>
    );
};



window.CalcButton = CalcButton;
window.CalculatorApp = CalculatorApp;
</script>

<script type="text/babel">
// Notes App - macOS-style with persistence, folders, save to desktop
const NotesApp = () => {
    const [notes, setNotes] = React.useState(() => {
        try { const s = localStorage.getItem('macos_notes'); if (s) return JSON.parse(s); } catch(e) {}
        return [
            { id: 1, folder: 'All iCloud', title: 'Meeting Notes', body: 'Discussed Q1 roadmap and priorities for the team.\n\nâ€¢ Focus on performance improvements\nâ€¢ Ship v2.0 by end of March\nâ€¢ Hire two more engineers\nâ€¢ Weekly design reviews starting next Monday\n\nAction items:\n- Set up project board\n- Schedule kickoff meeting\n- Review technical spec document', date: Date.now() - 3600000, pinned: false },
            { id: 2, folder: 'All iCloud', title: 'Shopping List', body: 'â€¢ Milk\nâ€¢ Eggs\nâ€¢ Bread\nâ€¢ Butter\nâ€¢ Apples\nâ€¢ Chicken breast\nâ€¢ Olive oil\nâ€¢ Rice\nâ€¢ Avocados', date: Date.now() - 86400000, pinned: false },
            { id: 3, folder: 'All iCloud', title: 'Project Ideas', body: '1. Build a macOS web replica with React\n2. Create a CLI tool for git workflows\n3. Design a personal portfolio site\n4. Develop a Markdown editor\n5. Build a real-time chat app', date: Date.now() - 172800000, pinned: true },
            { id: 4, folder: 'All iCloud', title: 'Book Recommendations', body: 'â€¢ The Design of Everyday Things - Don Norman\nâ€¢ Clean Code - Robert C. Martin\nâ€¢ Atomic Habits - James Clear\nâ€¢ Deep Work - Cal Newport\nâ€¢ The Pragmatic Programmer - Dave Thomas', date: Date.now() - 259200000, pinned: false },
        ];
    });
    const [activeId, setActiveId] = React.useState(1);
    const [activeFolder, setActiveFolder] = React.useState('All iCloud');
    const [searchQuery, setSearchQuery] = React.useState('');
    const [showFolderInput, setShowFolderInput] = React.useState(false);
    const [newFolderName, setNewFolderName] = React.useState('');
    const [folders, setFolders] = React.useState(() => {
        try { const s = localStorage.getItem('macos_notes_folders'); if (s) return JSON.parse(s); } catch(e) {}
        return ['All iCloud', 'Personal', 'Work'];
    });

    const saveNotes = (n) => { setNotes(n); localStorage.setItem('macos_notes', JSON.stringify(n)); };
    const saveFolders = (f) => { setFolders(f); localStorage.setItem('macos_notes_folders', JSON.stringify(f)); };

    const activeNote = notes.find(n => n.id === activeId);

    const filteredNotes = notes
        .filter(n => activeFolder === 'All iCloud' || n.folder === activeFolder)
        .filter(n => !searchQuery || n.title.toLowerCase().includes(searchQuery.toLowerCase()) || n.body.toLowerCase().includes(searchQuery.toLowerCase()))
        .sort((a, b) => { if (a.pinned !== b.pinned) return b.pinned ? 1 : -1; return b.date - a.date; });

    const updateNote = (field, value) => {
        const updated = notes.map(n => n.id === activeId ? { ...n, [field]: value, date: Date.now() } : n);
        saveNotes(updated);
    };

    const addNote = () => {
        const newId = Date.now();
        const newNote = { id: newId, folder: activeFolder === 'All iCloud' ? 'All iCloud' : activeFolder, title: '', body: '', date: Date.now(), pinned: false };
        saveNotes([newNote, ...notes]);
        setActiveId(newId);
    };

    const deleteNote = () => {
        if (notes.length <= 1) return;
        const newNotes = notes.filter(n => n.id !== activeId);
        saveNotes(newNotes);
        const remaining = newNotes.filter(n => activeFolder === 'All iCloud' || n.folder === activeFolder);
        setActiveId(remaining.length > 0 ? remaining[0].id : newNotes[0].id);
    };

    const togglePin = () => {
        const updated = notes.map(n => n.id === activeId ? { ...n, pinned: !n.pinned } : n);
        saveNotes(updated);
    };

    const saveToDesktop = () => {
        if (!activeNote) return;
        const fileName = (activeNote.title || 'Untitled Note').replace(/[^a-zA-Z0-9 _-]/g, '') + '.txt';
        VFS.touch('/Users/user/Desktop', fileName, activeNote.title + '\n\n' + activeNote.body, 'ðŸ“');
        MacStore.addNotification('Notes', 'Saved to Desktop', fileName + ' has been saved.');
    };

    const createFolder = () => {
        const name = newFolderName.trim();
        if (!name || folders.includes(name)) return;
        saveFolders([...folders, name]);
        setShowFolderInput(false);
        setNewFolderName('');
        setActiveFolder(name);
    };

    const deleteFolder = (name) => {
        if (name === 'All iCloud') return;
        // Move notes to All iCloud
        const updated = notes.map(n => n.folder === name ? { ...n, folder: 'All iCloud' } : n);
        saveNotes(updated);
        saveFolders(folders.filter(f => f !== name));
        if (activeFolder === name) setActiveFolder('All iCloud');
    };

    const formatDate = (ts) => {
        const d = new Date(ts);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        if (diff < 604800000) return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
        return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
    };

    const noteCount = notes.filter(n => activeFolder === 'All iCloud' || n.folder === activeFolder).length;

    return (
        <div className="flex h-full bg-white">
            {/* Folder sidebar */}
            <div className="w-[180px] min-w-[180px] bg-[#f5f5f5] border-r border-black/5 flex flex-col">
                <div className="px-3 pt-3 pb-2">
                    <div className="flex items-center gap-1.5 px-2 py-1 rounded-md bg-black/[0.04] border border-black/5">
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="#999"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search" className="flex-1 bg-transparent outline-none text-[12px]"/>
                    </div>
                </div>
                <div className="px-2 text-[10px] font-semibold text-gray-400 uppercase tracking-wider mt-1 mb-0.5 px-4">iCloud</div>
                <div className="flex-1 overflow-y-auto px-2">
                    {folders.map(f => (
                        <div key={f} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-default text-[12px] group ${activeFolder === f ? 'bg-[#007AFF] text-white' : 'hover:bg-black/[0.04]'}`}
                            onClick={() => { setActiveFolder(f); setSearchQuery(''); }}>
                            <svg viewBox="0 0 24 24" width="14" height="14" fill={activeFolder === f ? 'white' : '#FFD60A'}><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                            <span className="flex-1 truncate">{f}</span>
                            <span className={`text-[10px] ${activeFolder === f ? 'text-white/60' : 'text-gray-400'}`}>
                                {notes.filter(n => f === 'All iCloud' || n.folder === f).length}
                            </span>
                            {f !== 'All iCloud' && (
                                <button onClick={(e) => { e.stopPropagation(); deleteFolder(f); }}
                                    className="opacity-0 group-hover:opacity-100 text-[12px] text-gray-400 hover:text-red-500">&times;</button>
                            )}
                        </div>
                    ))}
                    {showFolderInput && (
                        <div className="px-2 py-1">
                            <input type="text" value={newFolderName} onChange={e => setNewFolderName(e.target.value)}
                                onKeyDown={e => { if (e.key === 'Enter') createFolder(); if (e.key === 'Escape') setShowFolderInput(false); }}
                                placeholder="Folder name" className="w-full text-[12px] px-2 py-1 rounded border border-gray-300 outline-none focus:border-blue-500" autoFocus/>
                        </div>
                    )}
                </div>
                <div className="px-3 py-2 border-t border-black/5">
                    <button onClick={() => setShowFolderInput(true)} className="text-[11px] text-gray-400 hover:text-gray-600">+ New Folder</button>
                </div>
            </div>

            {/* Notes list */}
            <div className="w-[250px] min-w-[250px] border-r border-black/5 flex flex-col bg-white">
                <div className="flex items-center justify-between px-4 py-2.5 border-b border-black/5">
                    <div>
                        <div className="text-[14px] font-semibold">{activeFolder}</div>
                        <div className="text-[11px] text-gray-400">{noteCount} note{noteCount !== 1 ? 's' : ''}</div>
                    </div>
                    <div className="flex gap-1">
                        <button onClick={deleteNote} className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5 text-gray-400" title="Delete">
                            <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                        <button onClick={addNote} className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5 text-[#007AFF]" title="New Note">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9H13z"/></svg>
                        </button>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto">
                    {filteredNotes.length === 0 && (
                        <div className="text-center text-gray-400 text-[12px] py-8">No notes</div>
                    )}
                    {filteredNotes.map(note => (
                        <div key={note.id}
                            className={`px-4 py-3 border-b border-black/[0.04] cursor-default ${activeId === note.id ? 'bg-[#007AFF]/[0.08]' : 'hover:bg-black/[0.02]'}`}
                            onClick={() => setActiveId(note.id)}>
                            <div className="flex items-center gap-1">
                                {note.pinned && <svg viewBox="0 0 24 24" width="10" height="10" fill="#FF9500"><path d="M17 4v7l2 3v2h-6v5l-1 1-1-1v-5H5v-2l2-3V4c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2z"/></svg>}
                                <div className="text-[13px] font-semibold truncate flex-1">{note.title || 'New Note'}</div>
                            </div>
                            <div className="flex items-center gap-2 mt-0.5">
                                <span className="text-[10px] text-gray-400">{formatDate(note.date)}</span>
                                <span className="text-[11px] text-gray-400 truncate flex-1">{note.body.split('\n')[0] || 'No additional text'}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Editor */}
            <div className="flex-1 flex flex-col bg-white">
                {activeNote ? (
                    <>
                        <div className="flex items-center justify-between px-5 py-2 border-b border-black/5">
                            <div className="flex items-center gap-2">
                                <select value={activeNote.folder} onChange={e => updateNote('folder', e.target.value)}
                                    className="text-[11px] text-gray-500 bg-gray-100 border border-black/5 rounded px-2 py-0.5 outline-none cursor-default">
                                    {folders.map(f => <option key={f} value={f}>{f}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={togglePin} title={activeNote.pinned ? 'Unpin' : 'Pin'}
                                    className={`w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5 ${activeNote.pinned ? 'text-[#FF9500]' : 'text-gray-400'}`}>
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M17 4v7l2 3v2h-6v5l-1 1-1-1v-5H5v-2l2-3V4c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2z"/></svg>
                                </button>
                                <button onClick={saveToDesktop} title="Save to Desktop"
                                    className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5 text-gray-400">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>
                                </button>
                                <button onClick={deleteNote} title="Delete"
                                    className="w-7 h-7 flex items-center justify-center rounded-md hover:bg-black/5 text-gray-400 hover:text-red-500">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div className="px-6 pt-4">
                            <input type="text" value={activeNote.title} onChange={e => updateNote('title', e.target.value)}
                                className="w-full text-[22px] font-bold outline-none bg-transparent text-gray-900" placeholder="Title"/>
                            <div className="text-[11px] text-gray-400 mt-1">{new Date(activeNote.date).toLocaleString()}</div>
                        </div>
                        <textarea value={activeNote.body} onChange={e => updateNote('body', e.target.value)}
                            className="flex-1 px-6 py-3 text-[14px] leading-relaxed outline-none bg-transparent resize-none text-gray-800"
                            placeholder="Start typing..."/>
                    </>
                ) : (
                    <div className="flex-1 flex items-center justify-center text-gray-400 text-[13px]">
                        Select a note or create a new one
                    </div>
                )}
            </div>
        </div>
    );
};


window.NotesApp = NotesApp;
</script>

<script type="text/babel">
// Terminal App - Real shell emulation with VFS
const TerminalApp = () => {
    const [lines, setLines] = React.useState([
        { type: 'output', text: 'Last login: ' + new Date().toDateString() + ' on ttys000' }
    ]);
    const [input, setInput] = React.useState('');
    const [history, setHistory] = React.useState([]);
    const [histIdx, setHistIdx] = React.useState(-1);
    const [cwd, setCwd] = React.useState('~');
    const bodyRef = React.useRef(null);
    const inputRef = React.useRef(null);

    const hostname = 'user@MacBook-Pro';

    const resolvePath = (p) => {
        let path = p;
        if (path === '~' || path === '') return '/Users/user';
        if (path.startsWith('~/')) path = '/Users/user/' + path.slice(2);
        if (!path.startsWith('/')) {
            const base = cwd === '~' ? '/Users/user' : cwd.replace('~', '/Users/user');
            path = base + '/' + path;
        }
        // Resolve .. and .
        const parts = path.split('/').filter(Boolean);
        const resolved = [];
        for (const p of parts) {
            if (p === '..') resolved.pop();
            else if (p !== '.') resolved.push(p);
        }
        return '/' + resolved.join('/');
    };

    const displayPath = (p) => p.replace('/Users/user', '~');

    const processCommand = (cmd) => {
        const trimmed = cmd.trim();
        if (!trimmed) return null;

        // Handle pipes and redirects simply
        const parts = trimmed.split(/\s+/);
        const command = parts[0];
        const args = parts.slice(1).join(' ');
        const argList = parts.slice(1);

        switch(command) {
            case 'ls': {
                const target = argList[0] ? resolvePath(argList[0]) : resolvePath(cwd);
                const items = VFS.ls(target);
                if (items.length === 0) return '';
                return items.map(i => i.name).join('  ');
            }
            case 'pwd':
                return resolvePath(cwd);
            case 'cd': {
                if (!argList[0] || argList[0] === '~') { setCwd('~'); return null; }
                const target = resolvePath(argList[0]);
                if (VFS.isDir(target)) {
                    setCwd(displayPath(target));
                    return null;
                }
                return `cd: no such file or directory: ${argList[0]}`;
            }
            case 'mkdir': {
                if (!argList[0]) return 'usage: mkdir directory_name';
                const base = resolvePath(cwd);
                const name = argList[0];
                if (VFS.mkdir(base, name)) return null;
                return `mkdir: ${name}: File exists`;
            }
            case 'touch': {
                if (!argList[0]) return 'usage: touch file_name';
                const base = resolvePath(cwd);
                VFS.touch(base, argList[0], '');
                return null;
            }
            case 'rm': {
                if (!argList[0]) return 'usage: rm file_name';
                const name = argList.filter(a => !a.startsWith('-')).pop();
                if (!name) return 'usage: rm file_name';
                const base = resolvePath(cwd);
                if (VFS.exists(base + '/' + name)) {
                    VFS.rm(base, name);
                    return null;
                }
                return `rm: ${name}: No such file or directory`;
            }
            case 'mv': {
                if (argList.length < 2) return 'usage: mv source dest';
                const base = resolvePath(cwd);
                VFS.rename(base, argList[0], argList[1]);
                return null;
            }
            case 'cat': {
                if (!argList[0]) return 'usage: cat file';
                const path = resolvePath(argList[0].startsWith('/') || argList[0].startsWith('~') ? argList[0] : cwd + '/' + argList[0]);
                const content = VFS.readFile(path);
                if (content !== null) return content || '(empty file)';
                return `cat: ${argList[0]}: No such file or directory`;
            }
            case 'echo': {
                // Check for redirect
                const redirIdx = argList.indexOf('>');
                const appendIdx = argList.indexOf('>>');
                if (appendIdx >= 0) {
                    const text = argList.slice(0, appendIdx).join(' ');
                    const file = argList[appendIdx + 1];
                    const path = resolvePath(cwd + '/' + file);
                    const existing = VFS.readFile(path);
                    if (existing !== null) { VFS.writeFile(path, existing + '\n' + text); }
                    else { const base = resolvePath(cwd); VFS.touch(base, file, text); }
                    return null;
                }
                if (redirIdx >= 0) {
                    const text = argList.slice(0, redirIdx).join(' ');
                    const file = argList[redirIdx + 1];
                    const path = resolvePath(cwd + '/' + file);
                    if (VFS.exists(path)) { VFS.writeFile(path, text); }
                    else { const base = resolvePath(cwd); VFS.touch(base, file, text); }
                    return null;
                }
                return args;
            }
            case 'whoami': return 'user';
            case 'hostname': return 'MacBook-Pro.local';
            case 'date': return new Date().toString();
            case 'uname':
                return args === '-a' ? 'Darwin MacBook-Pro.local 23.3.0 Darwin Kernel Version 23.3.0: Wed Dec 20 21:30:27 PST 2023; root:xnu-10002.81.5~7/RELEASE_ARM64_T6031 arm64' : 'Darwin';
            case 'sw_vers':
                return 'ProductName:\t\tmacOS\nProductVersion:\t\t14.3.1\nBuildVersion:\t\t23D60';
            case 'uptime':
                return ` ${new Date().toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'})}  up 3 days, 14:23, 2 users, load averages: 1.82 1.65 1.71`;
            case 'clear':
                setLines([]);
                return null;
            case 'which':
                return argList[0] ? `/usr/bin/${argList[0]}` : 'usage: which command';
            case 'env':
                return `USER=user\nHOME=/Users/user\nSHELL=/bin/zsh\nPATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\nLANG=en_US.UTF-8\nTERM=xterm-256color`;
            case 'top':
                return `Processes: 385 total, 2 running, 383 sleeping, 1842 threads\nLoad Avg: 1.82, 1.65, 1.71\nCPU usage: 8.33% user, 4.16% sys, 87.50% idle\nPhysMem: 12G used (3450M wired), 6144M unused`;
            case 'ps':
                return '  PID TTY           TIME CMD\n  391 ttys000    0:00.12 -zsh\n  412 ttys000    0:02.34 node server.js\n  567 ttys000    0:00.01 ps';
            case 'df':
                return 'Filesystem     Size   Used  Avail Capacity  Mounted on\n/dev/disk3s1  460Gi  245Gi  195Gi    56%    /\ndevfs         213Ki  213Ki    0Bi   100%    /dev';
            case 'ifconfig':
                return 'en0: flags=8863<UP,BROADCAST,SMART,RUNNING>\n\tinet 192.168.1.42 netmask 0xffffff00\n\tether a4:83:e7:12:34:56\n\tstatus: active';
            case 'ping':
                if (!argList[0]) return 'usage: ping host';
                return `PING ${argList[0]} (142.250.80.14): 56 data bytes\n64 bytes: icmp_seq=0 ttl=117 time=12.3 ms\n64 bytes: icmp_seq=1 ttl=117 time=11.8 ms\n--- ${argList[0]} ping statistics ---\n2 packets transmitted, 2 received, 0.0% loss`;
            case 'git':
                if (args === 'status') return 'On branch main\nnothing to commit, working tree clean';
                if (args === 'branch') return '* main\n  develop\n  feature/dark-mode';
                return `git: '${argList[0]}' is not a git command.`;
            case 'python3':
                if (args === '--version') return 'Python 3.12.1';
                return 'Python 3.12.1 (interactive mode not supported)';
            case 'node':
                if (args === '--version' || args === '-v') return 'v21.5.0';
                return 'Node.js v21.5.0 (interactive mode not supported)';
            case 'open': {
                const appMap = { safari: 'Safari', finder: 'Finder', calculator: 'Calculator', notes: 'Notes', terminal: 'Terminal', music: 'Music', photos: 'Photos', maps: 'Maps', mail: 'Mail', calendar: 'Calendar', messages: 'Messages' };
                const appName = argList[0] && argList[0].toLowerCase().replace('.app','');
                if (appMap[appName]) { MacStore.openWindow(appName, appMap[appName]); return `Opening ${appMap[appName]}...`; }
                return `open: ${argList[0]}: No such file or application`;
            }
            case 'neofetch':
                return `                    'c.          user@MacBook-Pro\n                 ,xNMM.          -------------------\n               .OMMMMo           OS: macOS 14.3.1 arm64\n               OMMM0,            Host: MacBook Pro (2023)\n     .;loddo:' loolloddol;.     Kernel: 23.3.0\n   cKMMMMMMMMMMNWMMMMMMMMMM0:   Shell: zsh 5.9\n .KMMMMMMMMMMMMMMMMMMMMMMMWd.   Terminal: Terminal.app\n XMMMMMMMMMMMMMMMMMMMMMMMX.     CPU: Apple M3 Pro\n;MMMMMMMMMMMMMMMMMMMMMMMM:      GPU: Apple M3 Pro\n.MMMMMMMMMMMMMMMMMMMMMMMMX.     Memory: 8192MiB / 18432MiB\n kMMMMMMMMMMMMMMMMMMMMMMMMWd.\n  .XMMMMMMMMMMMMMMMMMMMMK.\n    kMMMMMMMMMMMMMMMMMMd.\n     ;KMMMMMMMWXXWMMMMMk.\n       .cooc,.    .,coo:.`;
            case 'help':
                return 'Available commands:\n  ls, cd, pwd, cat, echo, clear, mkdir, touch, rm, mv,\n  whoami, hostname, date, uname, sw_vers, uptime, open,\n  top, ps, df, ifconfig, ping, git, python3, node,\n  neofetch, which, env, help\n\nFile commands work with the virtual filesystem.\nUse echo "text" > file.txt to write files.';
            default:
                return `zsh: command not found: ${command}`;
        }
    };

    const handleKey = (e) => {
        if (e.key === 'Enter') {
            const cmd = input;
            const newLines = [...lines, { type: 'command', prompt: `${hostname} ${cwd} % `, text: cmd }];
            const output = processCommand(cmd);
            if (output !== null) newLines.push({ type: 'output', text: output });
            setLines(newLines);
            setInput('');
            if (cmd.trim()) { setHistory(prev => [...prev, cmd]); setHistIdx(-1); }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (history.length > 0) {
                const idx = histIdx < 0 ? history.length - 1 : Math.max(0, histIdx - 1);
                setHistIdx(idx); setInput(history[idx]);
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (histIdx >= 0) {
                const idx = histIdx + 1;
                if (idx >= history.length) { setHistIdx(-1); setInput(''); }
                else { setHistIdx(idx); setInput(history[idx]); }
            }
        } else if (e.key === 'Tab') {
            e.preventDefault();
            const cmds = ['ls','cd','pwd','cat','echo','clear','mkdir','touch','rm','mv','whoami','hostname','date','uname','neofetch','git','node','python3','help','open'];
            const match = cmds.find(c => c.startsWith(input));
            if (match) setInput(match);
        }
    };

    React.useEffect(() => {
        if (bodyRef.current) bodyRef.current.scrollTop = bodyRef.current.scrollHeight;
    }, [lines]);

    return (
        <div className="flex flex-col h-full bg-[#1e1e1e]/95" onClick={() => inputRef.current?.focus()}>
            <div ref={bodyRef} className="flex-1 px-3 py-2 overflow-y-auto font-mono text-[13px] leading-relaxed">
                {lines.map((line, i) => (
                    <div key={i} className="whitespace-pre-wrap">
                        {line.type === 'command' ? (
                            <span><span className="text-green-400">{line.prompt}</span><span className="text-gray-100">{line.text}</span></span>
                        ) : (<span className="text-gray-300">{line.text}</span>)}
                    </div>
                ))}
                <div className="flex items-center">
                    <span className="text-green-400 whitespace-pre">{hostname} {cwd} % </span>
                    <input ref={inputRef} type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleKey}
                        className="flex-1 bg-transparent outline-none text-gray-100 font-mono text-[13px] caret-green-400" autoFocus spellCheck={false}/>
                </div>
            </div>
        </div>
    );
};


window.TerminalApp = TerminalApp;
</script>

<script type="text/babel">
// Settings slider wrapper - defined outside to prevent remounting on re-render
const SettingsSlider = ({ value, onChange, min = 0, max = 100, accentColor }) => (
    <div className="flex items-center gap-3 flex-1">
        <MacSlider min={min} max={max} value={value} onChange={onChange} className="flex-1" accentColor={accentColor}/>
        <span className="text-[12px] text-gray-400 w-8 text-right">{value}%</span>
    </div>
);

// System Settings App - Fully Functional
const SettingsApp = () => {
    const [activeSection, setActiveSection] = React.useState('apple-id');
    const wifiOn = useStore(s => s.wifiOn);
    const bluetoothOn = useStore(s => s.bluetoothOn);
    const volume = useStore(s => s.volume);
    const brightness = useStore(s => s.brightness);
    const focusOn = useStore(s => s.focusOn);
    const darkMode = useStore(s => s.darkMode);
    const wallpaperIndex = useStore(s => s.wallpaperIndex);
    const accentColor = useStore(s => s.accentColor);

    // Keys that sync to global store (affect other components)
    const globalKeys = {
        dockSize: 'dockSize', dockMagnification: 'dockMagnification',
        dockAutoHide: 'dockAutoHide', dockPosition: 'dockPosition',
        showRecents: 'showRecents', accentColor: 'accentColor',
        nightShift: 'nightShift', reduceMotion: 'reduceMotion',
        increaseContrast: 'increaseContrast', reduceTransparency: 'reduceTransparency',
        largerText: 'largerText', showPercentage: 'showBatteryPercentage',
        notifSounds: 'notifSounds', notifLockScreen: 'notifLockScreen',
    };

    // Local toggles persisted to localStorage
    const [local, setLocal] = React.useState(() => {
        const saved = localStorage.getItem('macos_settings_local');
        const state = MacStore.getState();
        const defaults = {
            airDrop: true, handoff: true, autoUpdates: true, locationServices: true,
            analytics: false, siri: true, trueTone: true, nightShift: state.nightShift || false,
            notifSounds: state.notifSounds !== undefined ? state.notifSounds : true,
            notifBadges: true, notifBanners: true,
            notifLockScreen: state.notifLockScreen !== undefined ? state.notifLockScreen : true,
            alertSound: 'Glass', outputDevice: 'MacBook Pro Speakers', inputDevice: 'MacBook Pro Microphone',
            inputVolume: 70, reduceMotion: state.reduceMotion || false,
            increaseContrast: state.increaseContrast || false,
            reduceTransparency: state.reduceTransparency || false,
            largerText: state.largerText || false,
            dockSize: state.dockSize || 48, dockMagnification: state.dockMagnification !== false,
            dockAutoHide: state.dockAutoHide || false, dockPosition: state.dockPosition || 'bottom',
            showRecents: state.showRecents !== false, minimizeEffect: 'Genie',
            resolution: 'Default', nightShiftSchedule: false,
            lowPowerMode: false, optimizedCharging: true,
            showPercentage: state.showBatteryPercentage !== false,
            keyRepeatSpeed: 6, delayUntilRepeat: 3, capsLockAction: 'Caps Lock',
            trackingSpeed: 5, tapToClick: true, naturalScrolling: true, forceClick: true,
            accentColor: state.accentColor || '#007AFF', highlightColor: state.accentColor || '#007AFF',
        };
        if (saved) try { return { ...defaults, ...JSON.parse(saved) }; } catch(e) {}
        return defaults;
    });

    const setLocalKey = (key, value) => {
        setLocal(prev => {
            const next = { ...prev, [key]: value };
            localStorage.setItem('macos_settings_local', JSON.stringify(next));
            return next;
        });
        // Sync to global store if this key affects other components
        if (globalKeys[key]) {
            MacStore.setState({ [globalKeys[key]]: value });
        }
    };

    const toggleLocal = (key) => setLocalKey(key, !local[key]);

    const Toggle = ({ checked, onChange }) => (
        <div
            className={`w-[38px] h-[22px] rounded-full relative cursor-default transition-colors ${checked ? '' : 'bg-gray-300'}`}
            style={checked ? { background: '#34C759' } : undefined}
            onClick={onChange}
        >
            <div className={`w-[18px] h-[18px] rounded-full bg-white absolute top-[2px] shadow-md transition-all ${checked ? 'left-[18px]' : 'left-[2px]'}`}/>
        </div>
    );

    const sections = [
        { id: 'apple-id', label: 'Apple ID', isProfile: true },
        { sep: true },
        { id: 'wifi', label: 'Wi-Fi', icon: 'ðŸ“¶', color: '#007AFF' },
        { id: 'bluetooth', label: 'Bluetooth', icon: 'ðŸ”µ', color: '#007AFF' },
        { id: 'network', label: 'Network', icon: 'ðŸŒ', color: '#007AFF' },
        { sep: true },
        { id: 'notifications', label: 'Notifications', icon: 'ðŸ””', color: '#FF3B30' },
        { id: 'sound', label: 'Sound', icon: 'ðŸ”Š', color: '#FF3B30' },
        { id: 'focus', label: 'Focus', icon: 'ðŸŒ™', color: '#5856D6' },
        { sep: true },
        { id: 'general', label: 'General', icon: 'âš™ï¸', color: '#8E8E93' },
        { id: 'appearance', label: 'Appearance', icon: 'ðŸŽ¨', color: '#34C759' },
        { id: 'accessibility', label: 'Accessibility', icon: 'â™¿', color: '#007AFF' },
        { sep: true },
        { id: 'privacy', label: 'Privacy & Security', icon: 'ðŸ”’', color: '#FF9500' },
        { id: 'desktop', label: 'Desktop & Dock', icon: 'ðŸ–¥ï¸', color: '#007AFF' },
        { id: 'displays', label: 'Displays', icon: 'ðŸ’»', color: '#5856D6' },
        { id: 'wallpaper', label: 'Wallpaper', icon: 'ðŸ–¼ï¸', color: '#34C759' },
        { id: 'battery', label: 'Battery', icon: 'ðŸ”‹', color: '#34C759' },
        { id: 'keyboard', label: 'Keyboard', icon: 'âŒ¨ï¸', color: '#8E8E93' },
        { id: 'trackpad', label: 'Trackpad', icon: 'ðŸ–±ï¸', color: '#8E8E93' },
    ];

    const renderContent = () => {
        switch(activeSection) {
            case 'apple-id':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Apple ID</h2>
                        <SettingsGroup>
                            <SettingsRow label="Name, Phone Numbers, Email" hasArrow />
                            <SettingsRow label="Password & Security" hasArrow />
                            <SettingsRow label="iCloud" detail="5 GB of 5 GB used" hasArrow />
                            <SettingsRow label="Media & Purchases" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Family Sharing" detail="Set Up" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            case 'wifi':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Wi-Fi</h2>
                        <SettingsGroup>
                            <SettingsRow label="Wi-Fi" right={<Toggle checked={wifiOn} onChange={() => MacStore.setState(s => ({ wifiOn: !s.wifiOn }))}/>} />
                        </SettingsGroup>
                        {wifiOn && (<>
                            <SettingsGroup title="Current Network">
                                <SettingsRow label="Home Wi-Fi" detail="Connected" hasArrow />
                            </SettingsGroup>
                            <SettingsGroup title="Known Networks">
                                <SettingsRow label="Office-5G" hasArrow />
                                <SettingsRow label="CoffeeShop_Free" hasArrow />
                            </SettingsGroup>
                            <SettingsGroup title="Other Networks">
                                <SettingsRow label="Guest-2.4G" hasArrow />
                                <SettingsRow label="NETGEAR-5G" hasArrow />
                            </SettingsGroup>
                            <SettingsGroup>
                                <SettingsRow label="Ask to join networks" right={<Toggle checked={true} onChange={() => {}}/>} />
                            </SettingsGroup>
                        </>)}
                    </div>
                );

            case 'bluetooth':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Bluetooth</h2>
                        <SettingsGroup>
                            <SettingsRow label="Bluetooth" right={<Toggle checked={bluetoothOn} onChange={() => MacStore.setState(s => ({ bluetoothOn: !s.bluetoothOn }))}/>} />
                        </SettingsGroup>
                        {bluetoothOn && (<>
                            <SettingsGroup title="My Devices">
                                <SettingsRow label="AirPods Pro" detail="Connected" hasArrow />
                                <SettingsRow label="Magic Mouse" detail="Connected" hasArrow />
                                <SettingsRow label="Magic Keyboard" detail="Not Connected" hasArrow />
                            </SettingsGroup>
                            <SettingsGroup title="Nearby Devices">
                                <SettingsRow label="JBL Speaker" detail="Speaker" hasArrow />
                                <SettingsRow label="Sony WH-1000XM5" detail="Headphones" hasArrow />
                            </SettingsGroup>
                        </>)}
                    </div>
                );

            case 'network':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Network</h2>
                        <SettingsGroup>
                            <SettingsRow label="Wi-Fi" detail={wifiOn ? 'Connected' : 'Off'} hasArrow />
                            <SettingsRow label="Ethernet" detail="Not Connected" hasArrow />
                            <SettingsRow label="Thunderbolt Bridge" detail="Not Connected" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="VPN">
                            <SettingsRow label="Add VPN Configuration..." hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Firewall" detail="Active" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Other Services">
                            <SettingsRow label="DNS" detail="Automatic" hasArrow />
                            <SettingsRow label="WINS" hasArrow />
                            <SettingsRow label="Proxies" detail="Off" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            case 'notifications':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Notifications</h2>
                        <SettingsGroup>
                            <SettingsRow label="Show previews" detail="When Unlocked" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Notification Style">
                            <SettingsRow label="Play sound for notifications" right={<Toggle checked={local.notifSounds} onChange={() => toggleLocal('notifSounds')}/>} />
                            <SettingsRow label="Show notifications on lock screen" right={<Toggle checked={local.notifLockScreen} onChange={() => toggleLocal('notifLockScreen')}/>} />
                            <SettingsRow label="Allow notifications when mirroring" right={<Toggle checked={false} onChange={() => {}}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Application Notifications">
                            <SettingsRow label="Calendar" detail="Banners" hasArrow />
                            <SettingsRow label="FaceTime" detail="Alerts" hasArrow />
                            <SettingsRow label="Mail" detail="Banners, Badges" hasArrow />
                            <SettingsRow label="Messages" detail="Alerts, Badges, Sounds" hasArrow />
                            <SettingsRow label="Safari" detail="Banners" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            case 'sound':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Sound</h2>
                        <SettingsGroup title="Output">
                            <SettingsRow label="Output Device" detail={local.outputDevice} />
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center gap-3">
                                    <span className="text-[16px]">ðŸ”ˆ</span>
                                    <SettingsSlider accentColor={accentColor}value={volume} onChange={v => MacStore.setState({ volume: v })}/>
                                    <span className="text-[16px]">ðŸ”Š</span>
                                </div>
                            </div>
                        </SettingsGroup>
                        <SettingsGroup title="Input">
                            <SettingsRow label="Input Device" detail={local.inputDevice} />
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center gap-3">
                                    <span className="text-[13px] text-gray-500">Input volume</span>
                                    <SettingsSlider accentColor={accentColor}value={local.inputVolume} onChange={v => setLocalKey('inputVolume', v)}/>
                                </div>
                            </div>
                        </SettingsGroup>
                        <SettingsGroup title="Sound Effects">
                            <div className="px-4 py-2">
                                <div className="text-[13px] mb-2">Alert sound</div>
                                <div className="grid grid-cols-3 gap-1">
                                    {['Boop','Breeze','Bubble','Crystal','Funky','Glass','Hero','Jump','Mezzo','Pebble','Pluck','Sonar'].map(s => (
                                        <div key={s} className={`px-2 py-1 rounded text-[12px] cursor-default ${local.alertSound === s ? 'text-white' : 'hover:bg-gray-100'}`}
                                            style={local.alertSound === s ? { background: accentColor } : undefined}
                                            onClick={() => setLocalKey('alertSound', s)}>{s}</div>
                                    ))}
                                </div>
                            </div>
                            <SettingsRow label="Play sound on startup" right={<Toggle checked={true} onChange={() => {}}/>} />
                            <SettingsRow label="Play user interface sound effects" right={<Toggle checked={local.notifSounds} onChange={() => toggleLocal('notifSounds')}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'focus':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Focus</h2>
                        <SettingsGroup>
                            <SettingsRow label="Do Not Disturb" right={<Toggle checked={focusOn} onChange={() => MacStore.setState(s => ({ focusOn: !s.focusOn }))}/>} />
                        </SettingsGroup>
                        {focusOn && (
                            <div className="mb-4 p-3 bg-purple-50 rounded-xl border border-purple-100">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="text-[16px]">ðŸŒ™</span>
                                    <span className="text-[13px] font-semibold text-purple-700">Focus is On</span>
                                </div>
                                <span className="text-[12px] text-purple-500">Notifications are silenced. Only allowed contacts can reach you.</span>
                            </div>
                        )}
                        <SettingsGroup title="Focus Modes">
                            <SettingsRow label="ðŸŒ™  Do Not Disturb" detail={focusOn ? 'On' : 'Off'} hasArrow />
                            <SettingsRow label="ðŸ’¼  Work" detail="Off" hasArrow />
                            <SettingsRow label="ðŸŽ®  Gaming" detail="Off" hasArrow />
                            <SettingsRow label="ðŸ˜´  Sleep" detail="Off" hasArrow />
                            <SettingsRow label="ðŸš—  Driving" detail="Off" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Share across devices" right={<Toggle checked={true} onChange={() => {}}/>} />
                            <SettingsRow label="Focus Status" detail="On" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            case 'general':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">General</h2>
                        <SettingsGroup>
                            <SettingsRow label="About" detail="macOS Sonoma 14.3.1" hasArrow />
                            <SettingsRow label="Software Update" detail="Up to date" hasArrow />
                            <SettingsRow label="Storage" detail="245 GB of 460 GB used" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="AirDrop" right={<Toggle checked={local.airDrop} onChange={() => toggleLocal('airDrop')}/>} />
                            <SettingsRow label="Handoff" right={<Toggle checked={local.handoff} onChange={() => toggleLocal('handoff')}/>} />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Login Items & Extensions" hasArrow />
                            <SettingsRow label="Language & Region" detail="English (US)" hasArrow />
                            <SettingsRow label="Date & Time" detail={new Date().toLocaleDateString()} hasArrow />
                            <SettingsRow label="Sharing" hasArrow />
                            <SettingsRow label="Time Machine" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Automatic Updates" right={<Toggle checked={local.autoUpdates} onChange={() => toggleLocal('autoUpdates')}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'appearance':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Appearance</h2>
                        <div className="flex gap-4 mb-6">
                            {['Light', 'Dark', 'Auto'].map(mode => {
                                const isSelected = (mode === 'Light' && !darkMode) || (mode === 'Dark' && darkMode);
                                return (
                                <div key={mode} className="flex flex-col items-center gap-2 cursor-default"
                                    onClick={() => {
                                        if (mode === 'Dark' && !darkMode) MacStore.setState({ darkMode: true });
                                        else if (mode === 'Light' && darkMode) MacStore.setState({ darkMode: false });
                                    }}>
                                    <div className={`w-20 h-14 rounded-lg border-2 ${isSelected ? '' : 'border-gray-300'}`}
                                        style={{ background: mode === 'Dark' ? '#1c1c1e' : mode === 'Auto' ? 'linear-gradient(90deg, white 50%, #1c1c1e 50%)' : 'white',
                                            borderColor: isSelected ? accentColor : undefined }}/>
                                    <span className="text-[12px]">{mode}</span>
                                </div>
                                );
                            })}
                        </div>
                        <SettingsGroup title="Accent Color">
                            <div className="flex gap-3 px-4 py-3">
                                {[
                                    { c: '#007AFF', n: 'Blue' }, { c: '#5856D6', n: 'Purple' }, { c: '#FF2D55', n: 'Pink' },
                                    { c: '#FF9500', n: 'Orange' }, { c: '#FFCC00', n: 'Yellow' }, { c: '#34C759', n: 'Green' },
                                    { c: '#8E8E93', n: 'Graphite' }, { c: '#FF3B30', n: 'Red' },
                                ].map(item => (
                                    <div key={item.c} className="flex flex-col items-center gap-1 cursor-default" onClick={() => setLocalKey('accentColor', item.c)}>
                                        <div className={`w-6 h-6 rounded-full border-2 ${accentColor === item.c ? 'border-gray-800 scale-110' : 'border-black/10'}`}
                                            style={{ background: item.c }}/>
                                        <span className="text-[9px] text-gray-400">{item.n}</span>
                                    </div>
                                ))}
                            </div>
                        </SettingsGroup>
                        <SettingsGroup title="Sidebar Icon Size">
                            <div className="flex gap-4 px-4 py-3">
                                {['Small', 'Medium', 'Large'].map(s => (
                                    <label key={s} className="flex items-center gap-2 cursor-default text-[13px]">
                                        <input type="radio" name="sidebarSize" defaultChecked={s === 'Medium'} className="accent-current"/>
                                        {s}
                                    </label>
                                ))}
                            </div>
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Allow wallpaper tinting in windows" right={<Toggle checked={true} onChange={() => {}}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'accessibility':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Accessibility</h2>
                        <SettingsGroup title="Vision">
                            <SettingsRow label="VoiceOver" detail="Off" hasArrow />
                            <SettingsRow label="Zoom" hasArrow />
                            <SettingsRow label="Increase Contrast" right={<Toggle checked={local.increaseContrast} onChange={() => toggleLocal('increaseContrast')}/>} />
                            <SettingsRow label="Reduce Transparency" right={<Toggle checked={local.reduceTransparency} onChange={() => toggleLocal('reduceTransparency')}/>} />
                            <SettingsRow label="Larger Text" right={<Toggle checked={local.largerText} onChange={() => toggleLocal('largerText')}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Motor">
                            <SettingsRow label="Voice Control" detail="Off" hasArrow />
                            <SettingsRow label="Keyboard" hasArrow />
                            <SettingsRow label="Pointer Control" hasArrow />
                            <SettingsRow label="Switch Control" detail="Off" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="General">
                            <SettingsRow label="Reduce Motion" right={<Toggle checked={local.reduceMotion} onChange={() => toggleLocal('reduceMotion')}/>} />
                            <SettingsRow label="Siri" right={<Toggle checked={local.siri} onChange={() => toggleLocal('siri')}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'privacy':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Privacy & Security</h2>
                        <SettingsGroup title="Privacy">
                            <SettingsRow label="Location Services" right={<Toggle checked={local.locationServices} onChange={() => toggleLocal('locationServices')}/>} />
                            <SettingsRow label="Contacts" hasArrow />
                            <SettingsRow label="Calendars" hasArrow />
                            <SettingsRow label="Photos" hasArrow />
                            <SettingsRow label="Camera" hasArrow />
                            <SettingsRow label="Microphone" hasArrow />
                            <SettingsRow label="Files and Folders" hasArrow />
                            <SettingsRow label="Full Disk Access" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Security">
                            <SettingsRow label="FileVault" detail="On" hasArrow />
                            <SettingsRow label="Firewall" detail="Active" hasArrow />
                            <SettingsRow label="Lockdown Mode" detail="Off" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Analytics & Improvements" right={<Toggle checked={local.analytics} onChange={() => toggleLocal('analytics')}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'desktop':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Desktop & Dock</h2>
                        <SettingsGroup title="Dock">
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[13px]">Size</span>
                                    <span className="text-[12px] text-gray-400">{local.dockSize}px</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-[11px] text-gray-400">Small</span>
                                    <MacSlider min={32} max={80} value={local.dockSize}
                                        onChange={v => setLocalKey('dockSize', v)}
                                        className="flex-1" accentColor={accentColor}/>
                                    <span className="text-[11px] text-gray-400">Large</span>
                                </div>
                            </div>
                            <SettingsRow label="Magnification" right={<Toggle checked={local.dockMagnification} onChange={() => toggleLocal('dockMagnification')}/>} />
                            <div className="px-4 py-2.5 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between">
                                    <span className="text-[13px]">Position on screen</span>
                                    <div className="flex gap-1">
                                        {['Left', 'Bottom', 'Right'].map(pos => (
                                            <button key={pos}
                                                className={`px-3 py-1 rounded text-[12px] ${local.dockPosition === pos.toLowerCase() ? 'text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                                style={local.dockPosition === pos.toLowerCase() ? { background: accentColor } : undefined}
                                                onClick={() => setLocalKey('dockPosition', pos.toLowerCase())}>{pos}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <SettingsRow label="Automatically hide and show the Dock" right={<Toggle checked={local.dockAutoHide} onChange={() => toggleLocal('dockAutoHide')}/>} />
                            <SettingsRow label="Show recent applications in Dock" right={<Toggle checked={local.showRecents} onChange={() => toggleLocal('showRecents')}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Windows">
                            <div className="px-4 py-2.5 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between">
                                    <span className="text-[13px]">Minimize windows using</span>
                                    <select className="bg-gray-100 rounded px-2 py-1 text-[12px] outline-none border-0"
                                        value={local.minimizeEffect} onChange={e => setLocalKey('minimizeEffect', e.target.value)}>
                                        <option>Genie</option><option>Scale</option>
                                    </select>
                                </div>
                            </div>
                            <SettingsRow label="Double-click title bar to" detail="Zoom" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Desktop">
                            <SettingsRow label="Show items on desktop" right={<Toggle checked={true} onChange={() => {}}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'displays':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Displays</h2>
                        <SettingsGroup title="Built-in Display">
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[13px]">Brightness</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-[16px]">ðŸ”…</span>
                                    <SettingsSlider accentColor={accentColor}value={brightness} onChange={v => MacStore.setState({ brightness: v })}/>
                                    <span className="text-[16px]">ðŸ”†</span>
                                </div>
                            </div>
                            <SettingsRow label="True Tone" right={<Toggle checked={local.trueTone} onChange={() => toggleLocal('trueTone')}/>} />
                            <SettingsRow label="Automatically adjust brightness" right={<Toggle checked={true} onChange={() => {}}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Resolution">
                            <div className="flex gap-2 px-4 py-3">
                                {['Larger Text', 'Default', 'More Space'].map(r => (
                                    <div key={r} className={`flex-1 py-2 rounded-lg text-center text-[12px] cursor-default ${local.resolution === r ? 'text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                        style={local.resolution === r ? { background: accentColor } : undefined}
                                        onClick={() => setLocalKey('resolution', r)}>{r}</div>
                                ))}
                            </div>
                        </SettingsGroup>
                        <SettingsGroup title="Night Shift">
                            <SettingsRow label="Schedule" right={<Toggle checked={local.nightShift} onChange={() => toggleLocal('nightShift')}/>} />
                            <SettingsRow label="Night Shift" right={<Toggle checked={local.nightShiftSchedule} onChange={() => toggleLocal('nightShiftSchedule')}/>} />
                        </SettingsGroup>
                    </div>
                );

            case 'wallpaper':
                const WallpaperCard = ({ wp, i }) => {
                    const [loaded, setLoaded] = React.useState(!wp.path.startsWith('http'));
                    return (
                        <div key={i}
                            className={`cursor-default rounded-xl overflow-hidden border-2 transition-all ${wallpaperIndex === i ? 'shadow-lg' : 'border-transparent hover:border-gray-300'}`}
                            style={wallpaperIndex === i ? { borderColor: accentColor, boxShadow: '0 0 0 2px ' + accentColor + '40' } : undefined}
                            onClick={() => MacStore.setWallpaper(i)}>
                            <div className="relative bg-gray-200" style={{ minHeight: '90px' }}>
                                {!loaded && <div className="absolute inset-0 flex items-center justify-center"><div className="w-5 h-5 border-2 border-gray-300 border-t-gray-500 rounded-full" style={{ animation: 'spin 0.8s linear infinite' }}/></div>}
                                <img src={wp.path} alt={wp.name} className={`w-full h-[90px] object-cover transition-opacity ${loaded ? 'opacity-100' : 'opacity-0'}`} draggable="false"
                                    loading="lazy" onLoad={() => setLoaded(true)} onError={e => { e.target.style.display = 'none'; setLoaded(true); }}/>
                                {wallpaperIndex === i && (
                                    <div className="absolute top-1.5 right-1.5 w-5 h-5 rounded-full flex items-center justify-center" style={{ background: accentColor }}>
                                        <svg viewBox="0 0 24 24" width="12" height="12" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    </div>
                                )}
                            </div>
                            <div className="py-1.5 px-1 bg-gray-50 text-center">
                                <span className="text-[11px] font-medium">{wp.name}</span>
                            </div>
                        </div>
                    );
                };
                const localWPs = WALLPAPERS.filter(w => !w.path.startsWith('http'));
                const onlineWPs = WALLPAPERS.filter(w => w.path.startsWith('http'));
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Wallpaper</h2>
                        <p className="text-[13px] text-gray-500 mb-4">Choose a wallpaper for your desktop and lock screen.</p>
                        <div className="text-[12px] font-semibold text-gray-400 uppercase tracking-wide mb-2">Included</div>
                        <div className="grid grid-cols-4 gap-3 mb-5">
                            {localWPs.map((wp, i) => <WallpaperCard key={i} wp={wp} i={WALLPAPERS.indexOf(wp)}/>)}
                        </div>
                        <div className="text-[12px] font-semibold text-gray-400 uppercase tracking-wide mb-2">macOS Collection</div>
                        <div className="grid grid-cols-4 gap-3">
                            {onlineWPs.map((wp, i) => <WallpaperCard key={i} wp={wp} i={WALLPAPERS.indexOf(wp)}/>)}
                        </div>
                    </div>
                );

            case 'battery':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Battery</h2>
                        <SettingsGroup>
                            <div className="px-4 py-4">
                                <div className="flex items-center gap-4 mb-3">
                                    <svg viewBox="0 0 48 24" width="64" height="32" fill="none" stroke="#34C759" strokeWidth="1.5">
                                        <rect x="1" y="2" width="38" height="18" rx="4" fill="none"/>
                                        <rect x="3" y="4" width="34" height="14" rx="2" fill="#34C759" opacity="0.3"/>
                                        <rect x="3" y="4" width="28" height="14" rx="2" fill="#34C759"/>
                                        <path d="M41 8 v6" strokeWidth="2.5" strokeLinecap="round"/>
                                    </svg>
                                    <div>
                                        <div className="text-[18px] font-bold">82%</div>
                                        <div className="text-[12px] text-gray-500">Power Source: Power Adapter</div>
                                    </div>
                                </div>
                                <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-green-500 rounded-full" style={{ width: '82%' }}/>
                                </div>
                            </div>
                        </SettingsGroup>
                        <SettingsGroup>
                            <SettingsRow label="Low Power Mode" right={<Toggle checked={local.lowPowerMode} onChange={() => toggleLocal('lowPowerMode')}/>} />
                            <SettingsRow label="Optimized Battery Charging" right={<Toggle checked={local.optimizedCharging} onChange={() => toggleLocal('optimizedCharging')}/>} />
                            <SettingsRow label="Show battery percentage" right={<Toggle checked={local.showPercentage} onChange={() => toggleLocal('showPercentage')}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Battery Health">
                            <SettingsRow label="Maximum Capacity" detail="96%" />
                            <SettingsRow label="Cycle Count" detail="127" />
                            <SettingsRow label="Condition" detail="Normal" />
                        </SettingsGroup>
                        <SettingsGroup title="Usage History">
                            <div className="px-4 py-3">
                                <div className="flex justify-between text-[11px] text-gray-400 mb-2">
                                    <span>Last 24 hours</span><span>Last 10 days</span>
                                </div>
                                <div className="flex items-end gap-1 h-[60px]">
                                    {[65,72,80,45,60,82,70,55,75,68,82,90].map((v,i) => (
                                        <div key={i} className="flex-1 bg-green-400 rounded-t" style={{ height: v + '%' }}/>
                                    ))}
                                </div>
                            </div>
                        </SettingsGroup>
                    </div>
                );

            case 'keyboard':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Keyboard</h2>
                        <SettingsGroup title="Keyboard">
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[13px]">Key repeat rate</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-[11px] text-gray-400">Slow</span>
                                    <MacSlider min={1} max={10} value={local.keyRepeatSpeed}
                                        onChange={v => setLocalKey('keyRepeatSpeed', v)}
                                        className="flex-1" accentColor={accentColor}/>
                                    <span className="text-[11px] text-gray-400">Fast</span>
                                </div>
                            </div>
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[13px]">Delay until repeat</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-[11px] text-gray-400">Long</span>
                                    <MacSlider min={1} max={6} value={local.delayUntilRepeat}
                                        onChange={v => setLocalKey('delayUntilRepeat', v)}
                                        className="flex-1" accentColor={accentColor}/>
                                    <span className="text-[11px] text-gray-400">Short</span>
                                </div>
                            </div>
                            <SettingsRow label="Turn keyboard backlight off after inactivity" detail="After 5 Minutes" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Text Input">
                            <SettingsRow label="Correct spelling automatically" right={<Toggle checked={true} onChange={() => {}}/>} />
                            <SettingsRow label="Capitalize words automatically" right={<Toggle checked={true} onChange={() => {}}/>} />
                            <SettingsRow label="Add period with double-space" right={<Toggle checked={true} onChange={() => {}}/>} />
                        </SettingsGroup>
                        <SettingsGroup title="Shortcuts">
                            <SettingsRow label="Spotlight" detail="âŒ˜ Space" hasArrow />
                            <SettingsRow label="Input Sources" hasArrow />
                            <SettingsRow label="Screenshots" detail="â‡§âŒ˜3, â‡§âŒ˜4" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            case 'trackpad':
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">Trackpad</h2>
                        <SettingsGroup title="Point & Click">
                            <div className="px-4 py-3 border-b border-black/[0.04]">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-[13px]">Tracking speed</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-[11px] text-gray-400">Slow</span>
                                    <MacSlider min={1} max={10} value={local.trackingSpeed}
                                        onChange={v => setLocalKey('trackingSpeed', v)}
                                        className="flex-1" accentColor={accentColor}/>
                                    <span className="text-[11px] text-gray-400">Fast</span>
                                </div>
                            </div>
                            <SettingsRow label="Tap to click" right={<Toggle checked={local.tapToClick} onChange={() => toggleLocal('tapToClick')}/>} />
                            <SettingsRow label="Force Click and haptic feedback" right={<Toggle checked={local.forceClick} onChange={() => toggleLocal('forceClick')}/>} />
                            <SettingsRow label="Look up & data detectors" detail="Force Click with One Finger" hasArrow />
                            <SettingsRow label="Secondary click" detail="Click or Tap with Two Fingers" hasArrow />
                        </SettingsGroup>
                        <SettingsGroup title="Scroll & Zoom">
                            <SettingsRow label="Natural scrolling" right={<Toggle checked={local.naturalScrolling} onChange={() => toggleLocal('naturalScrolling')}/>} />
                            <SettingsRow label="Zoom in or out" detail="Pinch with two fingers" />
                            <SettingsRow label="Smart zoom" detail="Double-tap with two fingers" />
                            <SettingsRow label="Rotate" detail="Rotate with two fingers" />
                        </SettingsGroup>
                        <SettingsGroup title="More Gestures">
                            <SettingsRow label="Swipe between pages" detail="Scroll Left or Right with Two Fingers" hasArrow />
                            <SettingsRow label="Swipe between full-screen apps" detail="Swipe Left or Right with Three Fingers" hasArrow />
                            <SettingsRow label="Mission Control" detail="Swipe Up with Three Fingers" hasArrow />
                            <SettingsRow label="Launchpad" detail="Pinch with Thumb and Three Fingers" hasArrow />
                            <SettingsRow label="Show Desktop" detail="Spread with Thumb and Three Fingers" hasArrow />
                        </SettingsGroup>
                    </div>
                );

            default:
                return (
                    <div>
                        <h2 className="text-[22px] font-bold mb-5">{sections.find(s => s.id === activeSection)?.label || 'Settings'}</h2>
                        <SettingsGroup><SettingsRow label="Coming soon..." /></SettingsGroup>
                    </div>
                );
        }
    };

    return (
        <div className="flex h-full">
            <div className="w-[260px] min-w-[260px] bg-gray-50/95 border-r border-black/5 overflow-y-auto p-2">
                <input type="text" placeholder="Search" className="w-full mb-3 px-3 py-1.5 rounded-lg border border-black/5 bg-white/80 text-[13px] outline-none font-sf"/>
                {sections.map((s, i) => {
                    if (s.sep) return <div key={i} className="h-px bg-black/5 my-2 mx-4"/>;
                    if (s.isProfile) return (
                        <div key={s.id}
                            className={`flex items-center gap-3 p-3 mx-1 rounded-xl cursor-default ${activeSection === s.id ? 'text-white' : 'hover:bg-black/[0.03]'}`}
                            style={activeSection === s.id ? { background: accentColor } : undefined}
                            onClick={() => setActiveSection(s.id)}>
                            <div className="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                                <svg viewBox="0 0 100 100" width="48" height="48"><circle cx="50" cy="50" r="50" fill="#c7c7cc"/><circle cx="50" cy="38" r="18" fill="#e5e5ea"/><ellipse cx="50" cy="80" rx="30" ry="22" fill="#e5e5ea"/></svg>
                            </div>
                            <div>
                                <div className="text-[14px] font-semibold">User</div>
                                <div className={`text-[11px] ${activeSection === s.id ? 'text-white/70' : 'text-gray-400'}`}>Apple ID, iCloud+</div>
                            </div>
                        </div>
                    );
                    return (
                        <div key={s.id}
                            className={`flex items-center gap-2.5 px-3 py-[5px] mx-1 rounded-lg cursor-default text-[13px] ${activeSection === s.id ? 'text-white' : 'hover:bg-black/[0.03]'}`}
                            style={activeSection === s.id ? { background: accentColor } : undefined}
                            onClick={() => setActiveSection(s.id)}>
                            <span className="text-sm">{s.icon}</span>
                            <span>{s.label}</span>
                        </div>
                    );
                })}
            </div>
            <div className="flex-1 p-6 overflow-y-auto bg-white">
                {renderContent()}
            </div>
        </div>
    );
};

const SettingsGroup = ({ title, children }) => (
    <div className="mb-4">
        {title && <div className="text-[12px] font-semibold text-gray-400 uppercase tracking-wide mb-1 px-1">{title}</div>}
        <div className="bg-gray-50 rounded-xl overflow-hidden">{children}</div>
    </div>
);

const SettingsRow = ({ label, detail, hasArrow, right }) => (
    <div className="flex items-center justify-between px-4 py-2.5 border-b border-black/[0.04] last:border-0 text-[13px]">
        <span>{label}</span>
        <div className="flex items-center gap-2">
            {detail && <span className="text-[12px] text-gray-400">{detail}</span>}
            {right}
            {hasArrow && <svg viewBox="0 0 24 24" width="14" height="14" fill="#c7c7cc"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>}
        </div>
    </div>
);


window.SettingsSlider = SettingsSlider;
window.SettingsApp = SettingsApp;
window.SettingsGroup = SettingsGroup;
window.SettingsRow = SettingsRow;
</script>

<script type="text/babel">
// Messages App - Interactive chat
const MessagesApp = () => {
    const [conversations, setConversations] = React.useState([
        { id: 1, name: 'John', initial: 'J', color: '#007AFF', messages: [
            { from: 'them', text: 'Hey! How\'s the project going?' },
            { from: 'me', text: 'Going really well! Almost done with the frontend.' },
            { from: 'them', text: 'That\'s awesome! Can\'t wait to see it.' },
            { from: 'me', text: 'I\'ll send you a preview tonight ðŸŽ‰' },
            { from: 'them', text: 'Hey, are we still on for tomorrow?' },
        ], time: '9:30 AM' },
        { id: 2, name: 'Sarah', initial: 'S', color: '#FF3B30', messages: [
            { from: 'me', text: 'Just sent the files over' },
            { from: 'them', text: 'Thanks for sending that over!' },
        ], time: 'Yesterday' },
        { id: 3, name: 'Team Chat', initial: 'T', color: '#34C759', messages: [
            { from: 'them', text: 'The project is looking great ðŸ‘' },
            { from: 'me', text: 'Thanks! The team did an amazing job' },
        ], time: 'Tuesday' },
        { id: 4, name: 'Emma', initial: 'E', color: '#FF9500', messages: [
            { from: 'them', text: 'Can you review the PR?' },
            { from: 'me', text: 'Sure, I\'ll take a look' },
        ], time: 'Monday' },
    ]);
    const [activeId, setActiveId] = React.useState(1);
    const [input, setInput] = React.useState('');
    const chatRef = React.useRef(null);

    const active = conversations.find(c => c.id === activeId);

    const sendMessage = () => {
        if (!input.trim()) return;
        setConversations(prev => prev.map(c =>
            c.id === activeId ? {
                ...c,
                messages: [...c.messages, { from: 'me', text: input }],
                time: 'Just now'
            } : c
        ));
        setInput('');

        // Auto-reply after delay
        setTimeout(() => {
            const replies = ['That sounds great!', 'Got it ðŸ‘', 'Thanks!', 'Let me think about that...', 'Awesome!', 'ðŸ˜‚', 'Perfect!'];
            setConversations(prev => prev.map(c =>
                c.id === activeId ? {
                    ...c,
                    messages: [...c.messages, { from: 'them', text: replies[Math.floor(Math.random() * replies.length)] }]
                } : c
            ));
        }, 1000 + Math.random() * 2000);
    };

    React.useEffect(() => {
        if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
    }, [conversations, activeId]);

    return (
        <div className="flex h-full">
            <div className="w-[280px] min-w-[280px] bg-gray-50/95 border-r border-black/5 flex flex-col">
                <div className="p-3 border-b border-black/5">
                    <input type="text" placeholder="Search" className="w-full px-3 py-1.5 rounded-lg border border-black/5 bg-white/80 text-[13px] outline-none font-sf"/>
                </div>
                <div className="flex-1 overflow-y-auto">
                    {conversations.map(c => (
                        <div key={c.id}
                            className={`flex items-center gap-3 px-4 py-2.5 cursor-default border-b border-black/[0.03] ${activeId === c.id ? 'bg-blue-500 text-white' : 'hover:bg-black/[0.02]'}`}
                            onClick={() => setActiveId(c.id)}
                        >
                            <div className="w-10 h-10 rounded-full flex items-center justify-center text-white text-base font-semibold flex-shrink-0"
                                style={{ background: c.color }}>{c.initial}</div>
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-center">
                                    <span className="text-[13px] font-semibold">{c.name}</span>
                                    <span className={`text-[11px] ${activeId === c.id ? 'text-white/70' : 'text-gray-400'}`}>{c.time}</span>
                                </div>
                                <div className={`text-[12px] truncate ${activeId === c.id ? 'text-white/70' : 'text-gray-400'}`}>
                                    {c.messages[c.messages.length - 1]?.text}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
            <div className="flex-1 flex flex-col bg-white">
                <div className="px-4 py-2.5 border-b border-black/5 text-center font-semibold text-[14px]">
                    {active?.name}
                </div>
                <div ref={chatRef} className="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
                    {active?.messages.map((msg, i) => (
                        <div key={i} className={`max-w-[65%] px-3.5 py-2 text-[14px] leading-relaxed ${
                            msg.from === 'me'
                                ? 'bg-blue-500 text-white self-end rounded-2xl rounded-br-md'
                                : 'bg-gray-200 text-gray-900 self-start rounded-2xl rounded-bl-md'
                        }`}>
                            {msg.text}
                        </div>
                    ))}
                </div>
                <div className="px-4 py-3 border-t border-black/5 flex items-center gap-2">
                    <input
                        type="text"
                        value={input}
                        onChange={e => setInput(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && sendMessage()}
                        placeholder="iMessage"
                        className="flex-1 px-4 py-2 rounded-full border border-black/10 text-[14px] outline-none font-sf"
                    />
                    <button onClick={sendMessage} className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    );
};


window.MessagesApp = MessagesApp;
</script>

<script type="text/babel">
// Mail App - with different content per folder
const MailApp = () => {
    const [activeFolder, setActiveFolder] = React.useState('Inbox');
    const [activeEmail, setActiveEmail] = React.useState(0);
    const [confirmEmptyTrash, setConfirmEmptyTrash] = React.useState(false);

    const folders = [
        { name: 'Inbox', icon: 'ðŸ“¥', badge: 3 },
        { name: 'Sent', icon: 'ðŸ“¤' },
        { name: 'Drafts', icon: 'ðŸ“', badge: 1 },
        { name: 'Flagged', icon: 'â­' },
        { name: 'Trash', icon: 'ðŸ—‘ï¸' },
        { name: 'Archive', icon: 'ðŸ“¦' },
        { name: 'Junk', icon: 'ðŸš«' },
    ];

    const emailsByFolder = {
        Inbox: [
            { sender: 'Apple', subject: 'Your Apple ID was used to sign in', preview: 'Your Apple ID (user@icloud.com) was used to sign in to iCloud...', time: '9:15 AM', unread: true,
              body: 'Dear User,\n\nYour Apple ID (user@icloud.com) was used to sign in to iCloud via a web browser.\n\nDate and Time: February 23, 2026 at 9:15 AM PST\nOperating System: macOS Sonoma\n\nIf you recently signed in to iCloud, you can disregard this email.\n\nRegards,\nApple Support' },
            { sender: 'GitHub', subject: 'Security alert: new sign-in', preview: 'We noticed a new sign-in to your GitHub account...', time: '8:42 AM', unread: true,
              body: 'Hi user,\n\nWe noticed a new sign-in to your GitHub account from a device we don\'t recognize.\n\nDevice: MacBook Pro\nLocation: Cupertino, CA\nTime: Feb 23, 2026 at 8:42 AM\n\nIf this was you, you can ignore this email.\n\nThe GitHub Team' },
            { sender: 'Sarah Johnson', subject: 'Re: Project Update', preview: 'Thanks for the update! Everything looks good...', time: 'Yesterday', unread: true,
              body: 'Hey!\n\nThanks for the update! Everything looks good. Let me know if you need anything else from my end.\n\nThe design files are ready whenever you need them.\n\nBest,\nSarah' },
            { sender: 'LinkedIn', subject: 'You have 5 new connection requests', preview: 'Accept connection requests from people you know...', time: 'Yesterday',
              body: 'You have 5 new connection requests.\n\nAccept connection requests from people you know to grow your network.\n\n- Alex Chen, Software Engineer at Google\n- Maria Garcia, Product Designer at Apple\n- David Kim, CTO at StartupXYZ' },
            { sender: 'Slack', subject: 'Digest for #engineering', preview: 'Here\'s what you missed in #engineering today...', time: 'Monday',
              body: '#engineering Digest\n\n@mike: Deployed v2.1 to staging\n@sarah: PR #342 ready for review\n@alex: Fixed the login bug (issue #89)\n@team: Sprint retro tomorrow at 2pm\n\n12 messages in 3 threads' },
        ],
        Sent: [
            { sender: 'Me', to: 'Sarah Johnson', subject: 'Project Update', preview: 'Hi Sarah, here is the latest update on the project...', time: 'Yesterday',
              body: 'Hi Sarah,\n\nHere is the latest update on the project:\n\n1. Frontend redesign is 90% complete\n2. API integration is done\n3. Testing phase starts next week\n\nLet me know if you have any questions.\n\nBest regards' },
            { sender: 'Me', to: 'Mike Thompson', subject: 'Re: Code Review', preview: 'Looks good! Just a few minor suggestions...', time: 'Monday',
              body: 'Hey Mike,\n\nLooks good! Just a few minor suggestions:\n\n1. Consider using a map instead of repeated if-else\n2. The error handling in line 42 could be more specific\n3. Great job on the unit tests!\n\nApproved with minor changes.' },
            { sender: 'Me', to: 'Team', subject: 'Meeting Notes - Sprint Planning', preview: 'Here are the notes from today\'s sprint planning...', time: 'Last Week',
              body: 'Team,\n\nHere are the notes from today\'s sprint planning:\n\nSprint Goals:\n- Complete user dashboard redesign\n- Implement notification system\n- Fix critical bugs from QA\n\nAssignments:\n- Sarah: Dashboard UI\n- Mike: Notification API\n- Alex: Bug fixes\n\nNext meeting: Friday 2pm' },
        ],
        Drafts: [
            { sender: 'Me', to: 'HR Department', subject: 'Vacation Request', preview: 'I would like to request time off from...', time: 'Today', draft: true,
              body: 'Dear HR,\n\nI would like to request time off from March 15-22, 2026.\n\nI have completed all urgent tasks and have arranged coverage with my team.\n\nPlease let me know if you need any additional information.\n\nThank you,' },
        ],
        Flagged: [
            { sender: 'Apple', subject: 'Your Apple ID was used to sign in', preview: 'Your Apple ID (user@icloud.com) was used to sign in to iCloud...', time: '9:15 AM', flagged: true,
              body: 'Dear User,\n\nYour Apple ID (user@icloud.com) was used to sign in to iCloud via a web browser.\n\nDate and Time: February 23, 2026 at 9:15 AM PST\nOperating System: macOS Sonoma\n\nIf you recently signed in to iCloud, you can disregard this email.\n\nRegards,\nApple Support' },
            { sender: 'Manager', subject: 'Performance Review - Action Required', preview: 'Please complete your self-review by end of week...', time: 'Last Week', flagged: true,
              body: 'Hi,\n\nPlease complete your self-review by end of this week. The link to the form is below.\n\nRemember to include:\n- Key accomplishments\n- Areas for growth\n- Goals for next quarter\n\nLet me know if you have questions.\n\nBest,\nYour Manager' },
        ],
        Trash: [
            { sender: 'Promo Store', subject: 'ðŸŽ‰ 50% OFF Everything!', preview: 'Don\'t miss our biggest sale of the year...', time: '2 days ago',
              body: 'ðŸŽ‰ BIGGEST SALE OF THE YEAR! ðŸŽ‰\n\n50% OFF EVERYTHING!\n\nUse code: SAVE50\n\nShop now before items sell out!\n\nTerms and conditions apply.' },
            { sender: 'Newsletter', subject: 'Weekly Tech Digest', preview: 'This week in tech: AI breakthroughs, new gadgets...', time: '3 days ago',
              body: 'WEEKLY TECH DIGEST\n\nTop Stories:\n1. New AI model breaks records\n2. Apple announces M4 Ultra chip\n3. SpaceX Starship completes orbital flight\n4. Quantum computing milestone achieved\n\nRead more at techdigest.com' },
            { sender: 'Old Contact', subject: 'Catching up', preview: 'Hey! It\'s been a while since we last talked...', time: 'Last Week',
              body: 'Hey!\n\nIt\'s been a while since we last talked. How have you been?\n\nI recently moved to San Francisco and would love to catch up if you\'re around.\n\nLet me know!\n\nCheers' },
        ],
        Archive: [
            { sender: 'IT Department', subject: 'Password Reset Confirmation', preview: 'Your password has been successfully reset...', time: 'Last Month',
              body: 'Your password for user@company.com has been successfully reset.\n\nIf you did not make this change, please contact IT support immediately.\n\nIT Department' },
            { sender: 'Amazon', subject: 'Your order has been delivered', preview: 'Your package was delivered to your front door...', time: 'Last Month',
              body: 'Your Amazon order #123-4567890 has been delivered!\n\nDelivered to: Front Door\nItems: MacBook Pro Sleeve, USB-C Hub\n\nRate your delivery experience.' },
            { sender: 'Bank', subject: 'Monthly Statement Available', preview: 'Your January 2026 statement is now available...', time: 'Jan 2026',
              body: 'Your monthly statement for January 2026 is now available.\n\nAccount ending in: 4532\nStatement Period: Jan 1 - Jan 31, 2026\n\nLog in to view your full statement.\n\nThank you for banking with us.' },
        ],
        Junk: [
            { sender: 'unknown@spam.com', subject: 'You\'ve Won $1,000,000!', preview: 'Congratulations! You have been selected as our lucky winner...', time: 'Today',
              body: 'CONGRATULATIONS!!!\n\nYou have been selected as our LUCKY WINNER of $1,000,000!\n\nTo claim your prize, simply send us your banking details...\n\n[This is clearly spam]' },
            { sender: 'crypto@deals.xyz', subject: 'Make 10x Returns GUARANTEED', preview: 'Invest now in this revolutionary crypto opportunity...', time: 'Yesterday',
              body: 'GUARANTEED 10X RETURNS!!!\n\nThis revolutionary crypto opportunity will change your life!\n\nInvest as little as $100 and watch it grow to $1000!\n\n[Definitely spam]' },
            { sender: 'prince@nigeria.com', subject: 'Urgent Business Proposal', preview: 'Dear friend, I am a prince with a business opportunity...', time: '3 days ago',
              body: 'Dear Friend,\n\nI am Prince Abubakar from Nigeria. I have a business proposition for you involving $45 million.\n\nPlease respond urgently.\n\n[Classic spam]' },
        ],
    };

    const currentEmails = emailsByFolder[activeFolder] || [];
    const active = currentEmails[activeEmail] || currentEmails[0];

    const handleEmptyMailTrash = () => {
        // Also empty from system trash
        emailsByFolder.Trash = [];
        setConfirmEmptyTrash(false);
        setActiveEmail(0);
    };

    return (
        <div className="flex h-full">
            {/* Sidebar */}
            <div className="w-[200px] min-w-[200px] bg-gray-50/95 border-r border-black/5 p-2 overflow-y-auto">
                <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wide mb-2 px-3">Mailboxes</div>
                {folders.map(f => (
                    <div key={f.name}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-default text-[13px] ${activeFolder === f.name ? 'bg-blue-500 text-white' : 'hover:bg-black/[0.03]'}`}
                        onClick={() => { setActiveFolder(f.name); setActiveEmail(0); }}>
                        <span>{f.icon}</span>
                        <span>{f.name}</span>
                        {f.badge && <span className={`ml-auto px-2 py-0.5 rounded-full text-[11px] font-medium ${activeFolder === f.name ? 'bg-white/30' : 'bg-blue-500 text-white'}`}>{f.badge}</span>}
                    </div>
                ))}
                {activeFolder === 'Trash' && emailsByFolder.Trash.length > 0 && (
                    <button
                        className="w-[calc(100%-8px)] mx-1 mt-3 px-3 py-1.5 rounded-lg bg-red-500 text-white text-[12px] font-medium hover:bg-red-600"
                        onClick={() => setConfirmEmptyTrash(true)}>
                        Empty Trash
                    </button>
                )}
            </div>

            {/* Email list */}
            <div className="w-[320px] min-w-[320px] border-r border-black/5 overflow-y-auto bg-white">
                {currentEmails.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full text-gray-300">
                        <span className="text-[32px] mb-2">ðŸ“­</span>
                        <span className="text-[13px]">No Messages</span>
                    </div>
                ) : (
                    currentEmails.map((e, i) => (
                        <div key={i}
                            className={`px-4 py-3 border-b border-black/[0.04] cursor-default ${activeEmail === i ? 'bg-blue-500/[0.06]' : 'hover:bg-black/[0.02]'}`}
                            onClick={() => setActiveEmail(i)}>
                            <div className="flex justify-between items-center mb-0.5">
                                <span className={`text-[13px] font-semibold ${e.unread ? 'text-blue-500' : ''}`}>
                                    {e.unread && <span className="inline-block w-2 h-2 rounded-full bg-blue-500 mr-1.5"/>}
                                    {e.flagged && <span className="text-orange-400 mr-1">âš‘</span>}
                                    {e.sender}
                                </span>
                                <span className="text-[10px] text-gray-400">{e.time}</span>
                            </div>
                            {e.to && <div className="text-[11px] text-gray-400 mb-0.5">To: {e.to}</div>}
                            <div className="text-[12px] font-medium truncate mb-0.5">{e.subject}</div>
                            <div className="text-[11px] text-gray-400 truncate">{e.preview}</div>
                            {e.draft && <span className="text-[10px] text-red-400 font-medium">DRAFT</span>}
                        </div>
                    ))
                )}
            </div>

            {/* Email content */}
            <div className="flex-1 p-6 overflow-y-auto bg-white">
                {active ? (
                    <>
                        <div className="mb-4 pb-3 border-b border-black/5">
                            <div className="flex items-center justify-between mb-2">
                                <h2 className="text-[18px] font-semibold">{active.subject}</h2>
                                {active.flagged && <span className="text-orange-400 text-lg">âš‘</span>}
                            </div>
                            <div className="text-[13px] text-gray-400">
                                From: {active.sender}{active.sender === 'Me' ? ' <user@icloud.com>' : ''}<br/>
                                To: {active.to || 'user@icloud.com'}<br/>
                                Date: {active.time}
                            </div>
                        </div>
                        <div className="text-[14px] leading-relaxed text-gray-700 whitespace-pre-wrap">
                            {active.body}
                        </div>
                    </>
                ) : (
                    <div className="flex items-center justify-center h-full text-gray-300">
                        <span className="text-[14px]">No Message Selected</span>
                    </div>
                )}
            </div>

            {/* Confirm empty trash */}
            {confirmEmptyTrash && (
                <div className="absolute inset-0 bg-black/30 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-white rounded-xl shadow-2xl p-5 w-[320px]">
                        <h3 className="text-[14px] font-bold mb-2">Empty Trash?</h3>
                        <p className="text-[12px] text-gray-500 mb-4">Are you sure you want to permanently erase the items in Mail Trash?</p>
                        <div className="flex justify-end gap-2">
                            <button className="px-4 py-1.5 rounded-lg bg-gray-100 text-[13px] font-medium hover:bg-gray-200"
                                onClick={() => setConfirmEmptyTrash(false)}>Cancel</button>
                            <button className="px-4 py-1.5 rounded-lg bg-red-500 text-white text-[13px] font-medium hover:bg-red-600"
                                onClick={handleEmptyMailTrash}>Empty Trash</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


window.MailApp = MailApp;
</script>

<script type="text/babel">
// Calendar App
const CalendarApp = () => {
    const [selectedDate, setSelectedDate] = React.useState(new Date());
    const now = new Date();
    const month = selectedDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    const year = selectedDate.getFullYear();
    const monthIdx = selectedDate.getMonth();
    const firstDay = new Date(year, monthIdx, 1).getDay();
    const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
    const prevDays = new Date(year, monthIdx, 0).getDate();

    const events = [
        { day: now.getDate(), title: 'Team Standup', time: '9:00 AM', color: '#007AFF' },
        { day: now.getDate(), title: 'Lunch with Sarah', time: '12:30 PM', color: '#34C759' },
        { day: now.getDate() + 1, title: 'Design Review', time: '2:00 PM', color: '#FF9500' },
        { day: now.getDate() + 2, title: 'Sprint Planning', time: '10:00 AM', color: '#5856D6' },
    ];

    const prevMonth = () => setSelectedDate(new Date(year, monthIdx - 1, 1));
    const nextMonth = () => setSelectedDate(new Date(year, monthIdx + 1, 1));
    const goToday = () => setSelectedDate(new Date());

    const todayEvents = events.filter(e => e.day === now.getDate());

    return (
        <div className="flex h-full">
            <div className="w-[200px] min-w-[200px] bg-gray-50/95 border-r border-black/5 p-3">
                <div className="text-[13px] font-semibold mb-2">Calendars</div>
                {[{name:'Home',color:'#007AFF'},{name:'Work',color:'#34C759'},{name:'Family',color:'#FF9500'},{name:'Birthdays',color:'#AF52DE'}].map(cal => (
                    <label key={cal.name} className="flex items-center gap-2 py-1 text-[12px] cursor-default">
                        <div className="w-3 h-3 rounded" style={{ background: cal.color }}/> {cal.name}
                    </label>
                ))}
                <div className="mt-6 text-[13px] font-semibold mb-2">Today's Events</div>
                {todayEvents.length > 0 ? todayEvents.map((e,i) => (
                    <div key={i} className="flex items-center gap-2 py-1.5 text-[12px]">
                        <div className="w-1 h-6 rounded" style={{ background: e.color }}/>
                        <div>
                            <div className="font-medium">{e.title}</div>
                            <div className="text-gray-400">{e.time}</div>
                        </div>
                    </div>
                )) : <div className="text-[12px] text-gray-400">No events today</div>}
            </div>
            <div className="flex-1 p-6 bg-white">
                <div className="flex items-center justify-between mb-6">
                    <h2 className="text-[22px] font-bold">{month}</h2>
                    <div className="flex gap-1">
                        <button onClick={prevMonth} className="w-7 h-7 rounded-md hover:bg-black/5 flex items-center justify-center text-gray-400">â—€</button>
                        <button onClick={goToday} className="px-3 py-1 rounded-md hover:bg-black/5 text-[12px] text-blue-500 font-medium">Today</button>
                        <button onClick={nextMonth} className="w-7 h-7 rounded-md hover:bg-black/5 flex items-center justify-center text-gray-400">â–¶</button>
                    </div>
                </div>
                <div className="grid grid-cols-7 gap-px text-center">
                    {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => (
                        <div key={d} className="py-2 text-[11px] font-semibold text-gray-400">{d}</div>
                    ))}
                    {Array.from({ length: firstDay }).map((_, i) => (
                        <div key={`p${i}`} className="py-3 text-[14px] text-gray-300">{prevDays - firstDay + i + 1}</div>
                    ))}
                    {Array.from({ length: daysInMonth }).map((_, i) => {
                        const day = i + 1;
                        const isToday = day === now.getDate() && monthIdx === now.getMonth() && year === now.getFullYear();
                        const hasEvent = events.some(e => e.day === day);
                        return (
                            <div key={day}
                                className={`py-3 text-[14px] cursor-default relative ${isToday ? 'text-white font-semibold' : ''}`}
                            >
                                <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full ${isToday ? 'bg-blue-500' : 'hover:bg-black/5'}`}>
                                    {day}
                                </span>
                                {hasEvent && <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-blue-500"/>}
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};


window.CalendarApp = CalendarApp;
</script>

<script type="text/babel">
// Photos App - with real photos and functional tabs
const PhotosApp = () => {
    const [activeNav, setActiveNav] = React.useState('Library');
    const [selectedPhoto, setSelectedPhoto] = React.useState(null);

    // Real photos from Lorem Picsum - each ID gives a unique photo
    const allPhotos = [
        { id: 10, w: 4, h: 3, cat: 'nature', fav: true, person: 'Amit', place: 'Forest', album: 'Nature', date: 'Dec 2024' },
        { id: 11, w: 3, h: 4, cat: 'nature', fav: false, person: null, place: 'Lake', album: 'Nature', date: 'Dec 2024' },
        { id: 12, w: 4, h: 3, cat: 'nature', fav: true, person: null, place: 'Mountains', album: 'Nature', date: 'Nov 2024' },
        { id: 13, w: 4, h: 3, cat: 'nature', fav: false, person: null, place: null, album: 'Nature', date: 'Nov 2024' },
        { id: 14, w: 3, h: 4, cat: 'city', fav: false, person: 'Arina', place: 'New York', album: 'Travel', date: 'Oct 2024' },
        { id: 15, w: 4, h: 3, cat: 'city', fav: true, person: null, place: 'Paris', album: 'Travel', date: 'Oct 2024' },
        { id: 16, w: 4, h: 3, cat: 'city', fav: false, person: null, place: 'London', album: 'Travel', date: 'Oct 2024' },
        { id: 17, w: 4, h: 3, cat: 'nature', fav: false, person: 'Amit', place: 'Beach', album: 'Summer', date: 'Sep 2024' },
        { id: 18, w: 3, h: 4, cat: 'architecture', fav: true, person: null, place: 'Tokyo', album: 'Travel', date: 'Sep 2024' },
        { id: 19, w: 4, h: 3, cat: 'nature', fav: false, person: null, place: 'Desert', album: 'Nature', date: 'Aug 2024' },
        { id: 20, w: 4, h: 3, cat: 'city', fav: false, person: 'Bambi', place: 'San Francisco', album: 'Travel', date: 'Aug 2024' },
        { id: 21, w: 3, h: 4, cat: 'nature', fav: true, person: null, place: 'Canyon', album: 'Nature', date: 'Jul 2024' },
        { id: 22, w: 4, h: 3, cat: 'architecture', fav: false, person: null, place: 'Rome', album: 'Travel', date: 'Jul 2024' },
        { id: 23, w: 4, h: 3, cat: 'nature', fav: false, person: 'Arina', place: 'Waterfall', album: 'Nature', date: 'Jun 2024' },
        { id: 24, w: 4, h: 3, cat: 'city', fav: true, person: null, place: 'Barcelona', album: 'Travel', date: 'Jun 2024' },
        { id: 25, w: 3, h: 4, cat: 'nature', fav: false, person: null, place: 'Sunset', album: 'Summer', date: 'Jun 2024' },
        { id: 26, w: 4, h: 3, cat: 'nature', fav: false, person: 'Bambi', place: 'River', album: 'Nature', date: 'May 2024' },
        { id: 27, w: 4, h: 3, cat: 'architecture', fav: true, person: null, place: 'Dubai', album: 'Travel', date: 'May 2024' },
        { id: 28, w: 4, h: 3, cat: 'nature', fav: false, person: null, place: 'Hills', album: 'Nature', date: 'Apr 2024' },
        { id: 29, w: 3, h: 4, cat: 'city', fav: false, person: 'Amit', place: 'Amsterdam', album: 'Travel', date: 'Apr 2024' },
        { id: 30, w: 4, h: 3, cat: 'nature', fav: true, person: null, place: 'Ocean', album: 'Summer', date: 'Mar 2024' },
        { id: 31, w: 4, h: 3, cat: 'city', fav: false, person: null, place: 'Berlin', album: 'Travel', date: 'Mar 2024' },
        { id: 32, w: 4, h: 3, cat: 'nature', fav: false, person: 'Arina', place: 'Meadow', album: 'Nature', date: 'Feb 2024' },
        { id: 33, w: 3, h: 4, cat: 'architecture', fav: true, person: null, place: 'Sydney', album: 'Travel', date: 'Feb 2024' },
        { id: 34, w: 4, h: 3, cat: 'nature', fav: false, person: null, place: 'Snow', album: 'Winter', date: 'Jan 2024' },
        { id: 35, w: 4, h: 3, cat: 'nature', fav: false, person: 'Bambi', place: 'Cliff', album: 'Nature', date: 'Jan 2024' },
        { id: 36, w: 4, h: 3, cat: 'city', fav: true, person: null, place: 'Hong Kong', album: 'Travel', date: 'Dec 2023' },
        { id: 37, w: 3, h: 4, cat: 'nature', fav: false, person: null, place: 'Rainforest', album: 'Nature', date: 'Dec 2023' },
        { id: 38, w: 4, h: 3, cat: 'architecture', fav: false, person: 'Amit', place: 'Istanbul', album: 'Travel', date: 'Nov 2023' },
        { id: 39, w: 4, h: 3, cat: 'nature', fav: true, person: null, place: 'Aurora', album: 'Winter', date: 'Nov 2023' },
    ];

    const people = [
        { name: 'Amit', photoIds: [10, 17, 29, 38], color: '#FF3B30' },
        { name: 'Arina', photoIds: [14, 23, 32], color: '#AF52DE' },
        { name: 'Bambi', photoIds: [20, 26, 35], color: '#007AFF' },
    ];

    const places = [
        { name: 'Mountains', count: 4, photoId: 12 },
        { name: 'Beach & Ocean', count: 3, photoId: 30 },
        { name: 'Cities', count: 8, photoId: 15 },
        { name: 'Forest', count: 3, photoId: 10 },
        { name: 'Desert & Canyon', count: 2, photoId: 19 },
        { name: 'Snow & Winter', count: 2, photoId: 34 },
    ];

    const albums = [
        { name: 'Nature', count: 12, photoId: 12, colors: ['#34C759', '#28B463'] },
        { name: 'Travel', count: 10, photoId: 15, colors: ['#007AFF', '#5856D6'] },
        { name: 'Summer', count: 3, photoId: 25, colors: ['#FF9500', '#FF3B30'] },
        { name: 'Winter', count: 2, photoId: 34, colors: ['#5AC8FA', '#007AFF'] },
    ];

    const navItems = ['Library', 'Memories', 'People', 'Places', 'Favorites', 'Recents', 'Albums'];

    const getPhotoUrl = (id, size = 300) => `https://picsum.photos/id/${id}/${size}/${size}`;
    const getPhotoUrlWide = (id, w = 400, h = 300) => `https://picsum.photos/id/${id}/${w}/${h}`;

    const getFilteredPhotos = () => {
        switch (activeNav) {
            case 'Favorites': return allPhotos.filter(p => p.fav);
            case 'Recents': return allPhotos.slice(0, 12);
            default: return allPhotos;
        }
    };

    const renderPhotoGrid = (photos) => (
        <div className="grid gap-1" style={{ gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))' }}>
            {photos.map((p, i) => (
                <div key={p.id}
                    className="aspect-square rounded cursor-default hover:opacity-90 transition-opacity overflow-hidden bg-gray-100 relative group"
                    onClick={() => setSelectedPhoto(p)}
                >
                    <img src={getPhotoUrl(p.id)} alt="" className="w-full h-full object-cover" draggable="false"
                        loading="lazy" onError={(e) => { e.target.style.display = 'none'; }}/>
                    {p.fav && (
                        <div className="absolute top-1.5 right-1.5 text-white drop-shadow-md text-[12px]">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </div>
                    )}
                </div>
            ))}
        </div>
    );

    const renderSelectedPhoto = () => (
        <div className="h-full flex flex-col">
            <div className="flex items-center justify-between mb-3">
                <button onClick={() => setSelectedPhoto(null)} className="text-blue-500 text-[13px] hover:underline">â† Back</button>
                <div className="flex gap-2">
                    {selectedPhoto.place && <span className="text-[11px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{selectedPhoto.place}</span>}
                    <span className="text-[11px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{selectedPhoto.date}</span>
                    {selectedPhoto.fav && <span className="text-[11px] text-red-400 bg-red-50 px-2 py-0.5 rounded-full">Favorite</span>}
                </div>
            </div>
            <div className="flex-1 rounded-xl overflow-hidden bg-black flex items-center justify-center">
                <img src={getPhotoUrlWide(selectedPhoto.id, 800, 600)} alt="" className="max-w-full max-h-full object-contain" draggable="false"/>
            </div>
        </div>
    );

    const renderMemories = () => (
        <>
            <h2 className="text-[22px] font-bold mb-4">Memories</h2>
            <div className="grid grid-cols-2 gap-4 mb-6">
                {[
                    { title: 'Summer Adventures', subtitle: 'Jun - Sep 2024', ids: [17, 25, 30] },
                    { title: 'City Exploring', subtitle: 'Across the world', ids: [14, 15, 20] },
                    { title: 'Nature Escapes', subtitle: 'Best of 2024', ids: [10, 12, 21] },
                    { title: 'Winter Vibes', subtitle: 'Nov 2023 - Jan 2024', ids: [34, 39, 37] },
                ].map((mem, i) => (
                    <div key={i} className="relative rounded-xl overflow-hidden cursor-default group h-[180px]">
                        <img src={getPhotoUrlWide(mem.ids[0], 500, 300)} alt="" className="w-full h-full object-cover transition-transform group-hover:scale-[1.03]" draggable="false"/>
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"/>
                        <div className="absolute bottom-3 left-3 text-white">
                            <div className="text-[15px] font-semibold">{mem.title}</div>
                            <div className="text-[11px] opacity-80">{mem.subtitle}</div>
                        </div>
                        <div className="absolute bottom-3 right-3 flex -space-x-2">
                            {mem.ids.map(id => (
                                <div key={id} className="w-7 h-7 rounded-full border-2 border-white overflow-hidden">
                                    <img src={getPhotoUrl(id, 50)} alt="" className="w-full h-full object-cover" draggable="false"/>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        </>
    );

    const renderPeople = () => (
        <>
            <h2 className="text-[22px] font-bold mb-4">People</h2>
            <div className="grid grid-cols-3 gap-6 mb-8">
                {people.map(person => (
                    <div key={person.name} className="flex flex-col items-center cursor-default group"
                        onClick={() => setActiveNav('_person_' + person.name)}>
                        <div className="w-[100px] h-[100px] rounded-full overflow-hidden border-3 mb-2 shadow-md transition-transform group-hover:scale-105"
                            style={{ borderColor: person.color, borderWidth: 3 }}>
                            <img src={getPhotoUrl(person.photoIds[0], 200)} alt="" className="w-full h-full object-cover" draggable="false"/>
                        </div>
                        <div className="text-[14px] font-medium">{person.name}</div>
                        <div className="text-[11px] text-gray-400">{person.photoIds.length} photos</div>
                    </div>
                ))}
            </div>
        </>
    );

    const renderPlaces = () => (
        <>
            <h2 className="text-[22px] font-bold mb-4">Places</h2>
            <div className="grid grid-cols-3 gap-3">
                {places.map(place => (
                    <div key={place.name} className="rounded-xl overflow-hidden cursor-default group relative h-[140px]"
                        onClick={() => setActiveNav('_place_' + place.name)}>
                        <img src={getPhotoUrlWide(place.photoId, 400, 250)} alt="" className="w-full h-full object-cover transition-transform group-hover:scale-[1.03]" draggable="false"/>
                        <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"/>
                        <div className="absolute bottom-2 left-3 text-white">
                            <div className="text-[13px] font-semibold">{place.name}</div>
                            <div className="text-[10px] opacity-80">{place.count} photos</div>
                        </div>
                    </div>
                ))}
            </div>
        </>
    );

    const renderAlbums = () => (
        <>
            <h2 className="text-[22px] font-bold mb-4">Albums</h2>
            <div className="grid grid-cols-3 gap-4">
                {albums.map(album => (
                    <div key={album.name} className="cursor-default group" onClick={() => setActiveNav('_album_' + album.name)}>
                        <div className="rounded-xl overflow-hidden shadow-md mb-2 h-[150px] transition-transform group-hover:scale-[1.02]">
                            <img src={getPhotoUrlWide(album.photoId, 400, 300)} alt="" className="w-full h-full object-cover" draggable="false"/>
                        </div>
                        <div className="text-[13px] font-medium">{album.name}</div>
                        <div className="text-[11px] text-gray-400">{album.count} photos</div>
                    </div>
                ))}
            </div>
        </>
    );

    const renderPersonPhotos = (personName) => {
        const person = people.find(p => p.name === personName);
        if (!person) return null;
        const photos = allPhotos.filter(p => p.person === personName);
        return (
            <>
                <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => setActiveNav('People')} className="text-blue-500 text-[13px] hover:underline">â† People</button>
                    <h2 className="text-[22px] font-bold">{personName}</h2>
                    <span className="text-[13px] text-gray-400">{photos.length} photos</span>
                </div>
                {renderPhotoGrid(photos)}
            </>
        );
    };

    const renderPlacePhotos = (placeName) => {
        const photos = allPhotos.filter(p => p.place && p.place.toLowerCase().includes(placeName.toLowerCase().split(' ')[0]));
        return (
            <>
                <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => setActiveNav('Places')} className="text-blue-500 text-[13px] hover:underline">â† Places</button>
                    <h2 className="text-[22px] font-bold">{placeName}</h2>
                </div>
                {renderPhotoGrid(photos.length > 0 ? photos : allPhotos.slice(0, 6))}
            </>
        );
    };

    const renderAlbumPhotos = (albumName) => {
        const photos = allPhotos.filter(p => p.album === albumName);
        return (
            <>
                <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => setActiveNav('Albums')} className="text-blue-500 text-[13px] hover:underline">â† Albums</button>
                    <h2 className="text-[22px] font-bold">{albumName}</h2>
                    <span className="text-[13px] text-gray-400">{photos.length} photos</span>
                </div>
                {renderPhotoGrid(photos)}
            </>
        );
    };

    const renderContent = () => {
        if (selectedPhoto) return renderSelectedPhoto();

        if (activeNav.startsWith('_person_')) return renderPersonPhotos(activeNav.replace('_person_', ''));
        if (activeNav.startsWith('_place_')) return renderPlacePhotos(activeNav.replace('_place_', ''));
        if (activeNav.startsWith('_album_')) return renderAlbumPhotos(activeNav.replace('_album_', ''));

        switch (activeNav) {
            case 'Memories': return renderMemories();
            case 'People': return renderPeople();
            case 'Places': return renderPlaces();
            case 'Albums': return renderAlbums();
            case 'Favorites':
            case 'Recents':
                return (
                    <>
                        <h2 className="text-[22px] font-bold mb-4">{activeNav}</h2>
                        {renderPhotoGrid(getFilteredPhotos())}
                    </>
                );
            case 'Library':
            default: {
                const photos = allPhotos;
                const months = [...new Set(photos.map(p => p.date))];
                return (
                    <>
                        <h2 className="text-[22px] font-bold mb-1">Library</h2>
                        <div className="text-[12px] text-gray-400 mb-4">{photos.length} Photos</div>
                        {months.map(month => {
                            const monthPhotos = photos.filter(p => p.date === month);
                            return (
                                <div key={month} className="mb-5">
                                    <div className="text-[13px] font-semibold text-gray-500 mb-2">{month}</div>
                                    <div className="grid gap-1" style={{ gridTemplateColumns: 'repeat(auto-fill, minmax(110px, 1fr))' }}>
                                        {monthPhotos.map(p => (
                                            <div key={p.id}
                                                className="aspect-square rounded cursor-default hover:opacity-90 transition-opacity overflow-hidden bg-gray-100 relative group"
                                                onClick={() => setSelectedPhoto(p)}
                                            >
                                                <img src={getPhotoUrl(p.id)} alt="" className="w-full h-full object-cover" draggable="false" loading="lazy"
                                                    onError={(e) => { e.target.style.display = 'none'; }}/>
                                                {p.fav && (
                                                    <div className="absolute top-1 right-1 text-white drop-shadow-md text-[10px]">
                                                        <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </>
                );
            }
        }
    };

    // Determine which nav item is actually active for sidebar highlighting
    const displayNav = activeNav.startsWith('_') ? activeNav.split('_')[1] === 'person' ? 'People' : activeNav.split('_')[1] === 'place' ? 'Places' : 'Albums' : activeNav;

    return (
        <div className="flex h-full">
            <div className="w-[180px] min-w-[180px] bg-gray-50/95 border-r border-black/5 p-2">
                {navItems.map(item => (
                    <div key={item}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-default text-[13px] ${displayNav === item ? 'bg-blue-500 text-white' : 'hover:bg-black/[0.03]'}`}
                        onClick={() => { setActiveNav(item); setSelectedPhoto(null); }}
                    >
                        {item}
                    </div>
                ))}
            </div>
            <div className="flex-1 p-4 overflow-y-auto bg-white">
                {renderContent()}
            </div>
        </div>
    );
};


window.PhotosApp = PhotosApp;
</script>

<script type="text/babel">
// Word App - Document editor with Save To Mac and file opening from desktop
const WordApp = () => {
    const [docs, setDocs] = React.useState(() => {
        try { const s = localStorage.getItem('macos_word_docs'); if (s) return JSON.parse(s); } catch(e) {}
        return [
            { id: 1, name: 'Welcome Document', content: '<h1 style="margin-bottom:12px">Welcome to Word</h1><p style="margin-bottom:8px">This is a rich text document editor. Use the toolbar above to format your text.</p><p style="margin-bottom:8px">You can make text <b>bold</b>, <i>italic</i>, <u>underlined</u>, or <s>strikethrough</s>.</p><h2 style="margin-bottom:8px">Features</h2><ul><li>Rich text formatting</li><li>Multiple documents</li><li>Save to any folder</li><li>Auto-save changes</li></ul>', date: Date.now() },
            { id: 2, name: 'Meeting Notes', content: '<h2 style="margin-bottom:8px">Team Meeting - February 2026</h2><p style="margin-bottom:8px"><b>Attendees:</b> John, Sarah, Mike, Lisa</p><ol><li>Q1 Review</li><li>Project Updates</li><li>Resource Planning</li></ol>', date: Date.now() - 86400000 },
        ];
    });
    const [activeDocId, setActiveDocId] = React.useState(1);
    const [showNewDoc, setShowNewDoc] = React.useState(false);
    const [newDocName, setNewDocName] = React.useState('');
    const [showSaveDialog, setShowSaveDialog] = React.useState(false);
    const [savePath, setSavePath] = React.useState('/Users/user/Desktop');
    const [saveFileName, setSaveFileName] = React.useState('');
    const editorRef = React.useRef(null);
    const saveTimer = React.useRef(null);
    const loadedPending = React.useRef(false);

    const saveDocs = (d) => { setDocs(d); localStorage.setItem('macos_word_docs', JSON.stringify(d)); };
    const activeDoc = docs.find(d => d.id === activeDocId);

    // Check for pending file to open from desktop/finder
    React.useEffect(() => {
        if (loadedPending.current) return;
        loadedPending.current = true;
        const state = MacStore.getState();
        if (state.pendingOpenFile) {
            const { path, name } = state.pendingOpenFile;
            MacStore.setState({ pendingOpenFile: null });
            const fullPath = path + '/' + name;
            const content = VFS.readFile(fullPath);
            if (content !== null) {
                // Check if doc already exists with this name
                const existing = docs.find(d => d.name === name);
                if (existing) {
                    // Update and switch to it
                    const htmlContent = content.includes('<') ? content : '<p>' + content.replace(/\n/g, '</p><p>') + '</p>';
                    saveDocs(docs.map(d => d.id === existing.id ? { ...d, content: htmlContent } : d));
                    setActiveDocId(existing.id);
                } else {
                    const htmlContent = content.includes('<') ? content : '<p>' + content.replace(/\n/g, '</p><p>') + '</p>';
                    const newDoc = { id: Date.now(), name, content: htmlContent, date: Date.now(), filePath: path };
                    saveDocs([newDoc, ...docs]);
                    setActiveDocId(newDoc.id);
                }
            }
        }
    }, []);

    const createDoc = () => {
        let name = newDocName.trim() || 'Untitled Document';
        const newDoc = { id: Date.now(), name, content: '<p>Start writing here...</p>', date: Date.now() };
        saveDocs([newDoc, ...docs]);
        setActiveDocId(newDoc.id);
        setShowNewDoc(false);
        setNewDocName('');
    };

    const deleteDoc = (id) => {
        if (docs.length <= 1) return;
        const nd = docs.filter(d => d.id !== id);
        saveDocs(nd);
        if (activeDocId === id) setActiveDocId(nd[0].id);
    };

    const saveContent = () => {
        if (!editorRef.current) return;
        const content = editorRef.current.innerHTML;
        saveDocs(docs.map(d => d.id === activeDocId ? { ...d, content, date: Date.now() } : d));
    };

    const handleInput = () => {
        if (saveTimer.current) clearTimeout(saveTimer.current);
        saveTimer.current = setTimeout(saveContent, 500);
    };

    React.useEffect(() => {
        if (editorRef.current && activeDoc) editorRef.current.innerHTML = activeDoc.content;
    }, [activeDocId]);

    const execCmd = (cmd, val) => {
        document.execCommand(cmd, false, val);
        editorRef.current?.focus();
        handleInput();
    };

    // Save to specific location (Save To Mac)
    const openSaveDialog = () => {
        setSaveFileName((activeDoc?.name || 'Untitled').replace(/[^a-zA-Z0-9 _-]/g, '') + '.txt');
        setSavePath('/Users/user/Desktop');
        setShowSaveDialog(true);
    };

    const saveToLocation = () => {
        if (!activeDoc || !editorRef.current) return;
        const text = editorRef.current.innerText;
        const htmlContent = editorRef.current.innerHTML;
        const fn = saveFileName || 'Untitled.txt';
        VFS.touch(savePath, fn, fn.endsWith('.html') ? htmlContent : text, 'ðŸ“„');
        MacStore.addNotification('Word', 'File Saved', fn + ' saved to ' + savePath.replace('/Users/user/', '~/'));
        setShowSaveDialog(false);
    };

    const saveToDesktop = () => {
        if (!activeDoc || !editorRef.current) return;
        const text = editorRef.current.innerText;
        const htmlContent = editorRef.current.innerHTML;
        const fileName = (activeDoc.name || 'Untitled').replace(/[^a-zA-Z0-9 _-]/g, '') + '.txt';
        VFS.touch('/Users/user/Desktop', fileName, text, 'ðŸ“„');
        // Also save HTML content for reopening
        VFS.touch('/Users/user/Desktop', '.' + fileName + '.html', htmlContent);
        MacStore.addNotification('Word', 'Saved to Desktop', fileName + ' has been saved.');
    };

    const saveFolders = VFS.ls(savePath).filter(f => f.type === 'folder');

    const [fontSize, setFontSize] = React.useState('3');
    const [fontFamily, setFontFamily] = React.useState('Inter');

    return (
        <div className="flex flex-col h-full bg-white">
            {/* Ribbon */}
            <div className="bg-[#2b579a] px-3 py-1 flex items-center gap-2">
                <div className="flex items-center gap-1">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/></svg>
                    <span className="text-white text-[13px] font-semibold">{activeDoc?.name || 'Word'}</span>
                </div>
                <div className="flex-1"/>
                <button onClick={saveToDesktop} className="text-white/80 text-[11px] hover:text-white px-2 py-0.5 rounded hover:bg-white/10">Save to Desktop</button>
                <button onClick={openSaveDialog} className="text-white text-[11px] px-2 py-0.5 rounded bg-white/20 hover:bg-white/30 font-medium">Save To Mac</button>
            </div>
            <div className="bg-[#f3f3f3] border-b border-gray-300 px-2 py-1.5 flex items-center gap-1 flex-wrap">
                <select value={fontFamily} onChange={e => { setFontFamily(e.target.value); execCmd('fontName', e.target.value); }}
                    className="text-[11px] border border-gray-300 rounded px-1 py-0.5 bg-white outline-none w-[100px]">
                    {['Inter', 'Arial', 'Times New Roman', 'Courier New', 'Georgia', 'Verdana'].map(f => <option key={f} value={f}>{f}</option>)}
                </select>
                <select value={fontSize} onChange={e => { setFontSize(e.target.value); execCmd('fontSize', e.target.value); }}
                    className="text-[11px] border border-gray-300 rounded px-1 py-0.5 bg-white outline-none w-[50px]">
                    {[{v:'1',l:'8'},{v:'2',l:'10'},{v:'3',l:'12'},{v:'4',l:'14'},{v:'5',l:'18'},{v:'6',l:'24'},{v:'7',l:'36'}].map(s => <option key={s.v} value={s.v}>{s.l}</option>)}
                </select>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <button onClick={() => execCmd('bold')} className="px-1.5 py-0.5 rounded text-[12px] font-bold hover:bg-gray-200 border border-transparent hover:border-gray-300" title="Bold">B</button>
                <button onClick={() => execCmd('italic')} className="px-1.5 py-0.5 rounded text-[12px] italic hover:bg-gray-200 border border-transparent hover:border-gray-300" title="Italic"><em>I</em></button>
                <button onClick={() => execCmd('underline')} className="px-1.5 py-0.5 rounded text-[12px] underline hover:bg-gray-200 border border-transparent hover:border-gray-300" title="Underline">U</button>
                <button onClick={() => execCmd('strikethrough')} className="px-1.5 py-0.5 rounded text-[12px] line-through hover:bg-gray-200 border border-transparent hover:border-gray-300">S</button>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <input type="color" defaultValue="#000000" onChange={e => execCmd('foreColor', e.target.value)} className="w-6 h-6 rounded cursor-pointer border border-gray-300" title="Text Color"/>
                <input type="color" defaultValue="#ffffff" onChange={e => execCmd('hiliteColor', e.target.value)} className="w-6 h-6 rounded cursor-pointer border border-gray-300" title="Highlight"/>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <button onClick={() => execCmd('justifyLeft')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg>
                </button>
                <button onClick={() => execCmd('justifyCenter')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg>
                </button>
                <button onClick={() => execCmd('justifyRight')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg>
                </button>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <button onClick={() => execCmd('insertUnorderedList')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/></svg>
                </button>
                <button onClick={() => execCmd('insertOrderedList')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M2 17h2v.5H3v1h1v.5H2v1h3v-4H2v1zm1-9h1V4H2v1h1v3zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2v1zm5-6v2h14V5H7zm0 14h14v-2H7v2zm0-6h14v-2H7v2z"/></svg>
                </button>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <button onClick={() => execCmd('formatBlock', '<h1>')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300 text-[11px] font-bold">H1</button>
                <button onClick={() => execCmd('formatBlock', '<h2>')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300 text-[11px] font-bold">H2</button>
                <button onClick={() => execCmd('formatBlock', '<p>')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300 text-[11px]">P</button>
                <div className="w-px h-5 bg-gray-300 mx-0.5"/>
                <button onClick={() => execCmd('undo')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M12.5 8c-2.65 0-5.05 1.04-6.83 2.74L2.5 7.5v9h9l-3.19-3.19c1.33-1.28 3.07-2.06 5.04-2.06 3.24 0 6.02 2.07 7.05 5l2.1-.66C21.11 11.97 17.14 8 12.5 8z"/></svg>
                </button>
                <button onClick={() => execCmd('redo')} className="px-1.5 py-0.5 rounded hover:bg-gray-200 border border-transparent hover:border-gray-300">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#555"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                </button>
            </div>

            <div className="flex flex-1 overflow-hidden">
                {/* Document sidebar */}
                <div className="w-[180px] min-w-[180px] bg-[#f7f7f7] border-r border-gray-200 flex flex-col">
                    <div className="flex items-center justify-between px-3 py-2 border-b border-gray-200">
                        <span className="text-[11px] text-gray-500 uppercase font-semibold tracking-wider">Documents</span>
                        <button onClick={() => setShowNewDoc(true)} className="text-[#2b579a] text-[16px] hover:text-[#1e3f7a]">+</button>
                    </div>
                    {showNewDoc && (
                        <div className="px-2 py-1 border-b border-gray-200">
                            <input type="text" value={newDocName} onChange={e => setNewDocName(e.target.value)}
                                onKeyDown={e => { if (e.key === 'Enter') createDoc(); if (e.key === 'Escape') setShowNewDoc(false); }}
                                placeholder="Document name" className="w-full text-[11px] px-2 py-1 rounded border border-gray-300 outline-none focus:border-[#2b579a]" autoFocus/>
                        </div>
                    )}
                    <div className="flex-1 overflow-y-auto">
                        {docs.map(d => (
                            <div key={d.id} className={`flex items-center gap-2 px-3 py-2 cursor-default group border-b border-gray-100 ${activeDocId === d.id ? 'bg-[#2b579a]/10' : 'hover:bg-gray-100'}`}
                                onClick={() => { saveContent(); setActiveDocId(d.id); }}>
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="#2b579a"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/></svg>
                                <div className="flex-1 min-w-0">
                                    <div className="text-[12px] font-medium truncate">{d.name}</div>
                                    <div className="text-[10px] text-gray-400">{new Date(d.date).toLocaleDateString()}</div>
                                </div>
                                {docs.length > 1 && (
                                    <button onClick={(e) => { e.stopPropagation(); deleteDoc(d.id); }}
                                        className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 text-[14px]">&times;</button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Document editor */}
                <div className="flex-1 overflow-auto bg-[#e8e8e8] flex justify-center py-6">
                    <div className="bg-white shadow-lg rounded-sm" style={{ width: '680px', minHeight: '880px', padding: '60px 70px' }}>
                        <div ref={editorRef} contentEditable suppressContentEditableWarning
                            onInput={handleInput}
                            className="outline-none text-[14px] leading-relaxed min-h-[700px]"
                            style={{ fontFamily: fontFamily + ', sans-serif' }}/>
                    </div>
                </div>
            </div>

            {/* Status bar */}
            <div className="h-[22px] bg-[#2b579a] flex items-center px-3 text-white text-[10px] gap-4">
                <span>Page 1 of 1</span>
                <span>{activeDoc?.name}</span>
                <span className="ml-auto">Word</span>
            </div>

            {/* Save To Mac dialog */}
            {showSaveDialog && (
                <div className="absolute inset-0 bg-black/30 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-white rounded-xl shadow-2xl w-[480px] overflow-hidden">
                        <div className="bg-gray-100 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                            <h3 className="text-[14px] font-semibold">Save To Mac</h3>
                            <button onClick={() => setShowSaveDialog(false)} className="text-gray-400 hover:text-gray-600 text-[18px]">&times;</button>
                        </div>
                        <div className="p-4">
                            <div className="text-[12px] text-gray-500 mb-2">Save to: <span className="font-medium text-gray-700">{savePath.replace('/Users/user/', '~/')}</span></div>
                            <div className="border border-gray-200 rounded-lg h-[200px] overflow-y-auto mb-3">
                                {savePath !== '/Users/user' && (
                                    <div className="flex items-center gap-2 px-3 py-1.5 hover:bg-blue-50 cursor-default text-[13px] border-b border-gray-100"
                                        onClick={() => { const parts = savePath.split('/'); parts.pop(); setSavePath(parts.join('/')); }}>
                                        <span>â¬†ï¸</span><span className="text-gray-500">Go Up</span>
                                    </div>
                                )}
                                {saveFolders.map(f => (
                                    <div key={f.name} className="flex items-center gap-2 px-3 py-1.5 hover:bg-blue-50 cursor-default text-[13px] border-b border-gray-100"
                                        onClick={() => setSavePath(savePath + '/' + f.name)}>
                                        <span>ðŸ“</span><span>{f.name}</span>
                                    </div>
                                ))}
                                {saveFolders.length === 0 && <div className="text-center text-gray-400 text-[12px] py-4">No subfolders</div>}
                            </div>
                            <div className="flex items-center gap-2 mb-3">
                                <span className="text-[12px] text-gray-500">File name:</span>
                                <input type="text" value={saveFileName} onChange={e => setSaveFileName(e.target.value)}
                                    className="flex-1 text-[13px] px-2 py-1 rounded border border-gray-300 outline-none focus:border-blue-500"/>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowSaveDialog(false)} className="px-4 py-1.5 rounded-lg bg-gray-100 text-[13px] font-medium hover:bg-gray-200">Cancel</button>
                                <button onClick={saveToLocation} className="px-4 py-1.5 rounded-lg bg-blue-500 text-white text-[13px] font-medium hover:bg-blue-600">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


window.WordApp = WordApp;
</script>

<script type="text/babel">
// Trash App - functional trash bin with restore and empty
const TrashApp = () => {
    const vfsVersion = useStore(s => s.vfsVersion);
    const [selected, setSelected] = React.useState(null);
    const [confirmEmpty, setConfirmEmpty] = React.useState(false);

    const trashItems = VFS.getTrash();

    const handleRestore = (item) => {
        VFS.restoreFromTrash(item);
        setSelected(null);
    };

    const handleEmptyTrash = () => {
        VFS.emptyTrash();
        setConfirmEmpty(false);
        setSelected(null);
    };

    const selectedItem = trashItems.find(t => t.name === selected);

    return (
        <div className="flex h-full">
            {/* Sidebar */}
            <div className="w-[200px] min-w-[200px] bg-gray-50/95 border-r border-black/5 p-3 flex flex-col">
                <div className="flex items-center gap-2 px-2 py-1.5 rounded-lg bg-blue-500 text-white text-[13px] mb-2">
                    <span>ðŸ—‘ï¸</span>
                    <span>Trash</span>
                    <span className="ml-auto text-[11px] opacity-70">{trashItems.length}</span>
                </div>
                <div className="flex-1"/>
                {trashItems.length > 0 && (
                    <button
                        className="w-full px-3 py-2 rounded-lg bg-red-500 text-white text-[13px] font-medium hover:bg-red-600 transition-colors"
                        onClick={() => setConfirmEmpty(true)}>
                        Empty Trash
                    </button>
                )}
            </div>

            {/* File list */}
            <div className="w-[300px] min-w-[300px] border-r border-black/5 overflow-y-auto bg-white">
                {trashItems.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full">
                        <span className="text-[48px] mb-3">ðŸ—‘ï¸</span>
                        <span className="text-[14px] font-medium text-gray-600">Trash is Empty</span>
                    </div>
                ) : (
                    trashItems.map((item, i) => (
                        <div key={i}
                            className={`flex items-center gap-3 px-4 py-2.5 border-b border-black/[0.04] cursor-default ${selected === item.name ? 'bg-blue-500/[0.08]' : 'hover:bg-black/[0.02]'}`}
                            onClick={() => setSelected(item.name)}>
                            <span className="text-[20px]">{item.icon || (item.type === 'dir' ? 'ðŸ“' : 'ðŸ“„')}</span>
                            <div className="flex-1 min-w-0">
                                <div className="text-[13px] font-medium truncate">{item.name}</div>
                                <div className="text-[11px] text-gray-400">From: {item.originalPath.replace('/Users/user/', '~/')}</div>
                            </div>
                            <div className="text-[11px] text-gray-400">{item.size || ''}</div>
                        </div>
                    ))
                )}
            </div>

            {/* Detail pane */}
            <div className="flex-1 p-6 overflow-y-auto bg-white flex flex-col items-center justify-center">
                {selectedItem ? (
                    <div className="text-center">
                        <span className="text-[64px] block mb-4">{selectedItem.icon || (selectedItem.type === 'dir' ? 'ðŸ“' : 'ðŸ“„')}</span>
                        <h3 className="text-[16px] font-semibold mb-1 text-gray-800">{selectedItem.name}</h3>
                        <p className="text-[12px] text-gray-500 mb-1">Original location: {selectedItem.originalPath.replace('/Users/user/', '~/')}</p>
                        {selectedItem.size && <p className="text-[12px] text-gray-500 mb-1">Size: {selectedItem.size}</p>}
                        <p className="text-[12px] text-gray-500 mb-4">Deleted: {new Date(selectedItem.deletedAt).toLocaleString()}</p>
                        <div className="flex gap-2 justify-center">
                            <button className="px-4 py-1.5 rounded-lg bg-blue-500 text-white text-[13px] font-medium hover:bg-blue-600"
                                onClick={() => handleRestore(selectedItem)}>Put Back</button>
                            <button className="px-4 py-1.5 rounded-lg bg-red-500 text-white text-[13px] font-medium hover:bg-red-600"
                                onClick={() => { VFS.deleteFromTrash(selectedItem); setSelected(null); }}>Delete Permanently</button>
                        </div>
                    </div>
                ) : (
                    <div className="text-center">
                        <span className="text-[48px] block mb-3">ðŸ—‘ï¸</span>
                        <p className="text-[14px] text-gray-600">{trashItems.length > 0 ? 'Select an item to see details' : 'No items in Trash'}</p>
                    </div>
                )}
            </div>

            {/* Confirm empty dialog */}
            {confirmEmpty && (
                <div className="absolute inset-0 bg-black/30 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-white rounded-xl shadow-2xl p-5 w-[340px]">
                        <div className="flex items-center gap-3 mb-3">
                            <span className="text-[36px]">ðŸ—‘ï¸</span>
                            <div>
                                <h3 className="text-[14px] font-bold">Empty Trash?</h3>
                                <p className="text-[12px] text-gray-500 mt-1">
                                    Are you sure you want to permanently erase the {trashItems.length} item{trashItems.length !== 1 ? 's' : ''} in the Trash? You can't undo this action.
                                </p>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-4">
                            <button className="px-4 py-1.5 rounded-lg bg-gray-100 text-[13px] font-medium hover:bg-gray-200"
                                onClick={() => setConfirmEmpty(false)}>Cancel</button>
                            <button className="px-4 py-1.5 rounded-lg bg-red-500 text-white text-[13px] font-medium hover:bg-red-600"
                                onClick={handleEmptyTrash}>Empty Trash</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


window.TrashApp = TrashApp;
</script>

<script type="text/babel">
// Maps App - Real interactive map via OpenStreetMap
const MapsApp = () => {
    const [searchQuery, setSearchQuery] = React.useState('');
    const [selectedPlace, setSelectedPlace] = React.useState(null);
    const [mapCenter, setMapCenter] = React.useState({ lat: 37.5, lng: -122.2 });
    const [mapZoom, setMapZoom] = React.useState(10);
    const iframeRef = React.useRef(null);

    const places = [
        { name: 'Apple Park', category: 'Landmark', address: 'One Apple Park Way, Cupertino, CA', lat: 37.3349, lng: -122.0090, color: '#FF3B30' },
        { name: 'Googleplex', category: 'Landmark', address: '1600 Amphitheatre Pkwy, Mountain View, CA', lat: 37.4220, lng: -122.0841, color: '#4285F4' },
        { name: 'Stanford University', category: 'Education', address: '450 Serra Mall, Stanford, CA', lat: 37.4275, lng: -122.1697, color: '#8C1515' },
        { name: 'San Francisco Airport', category: 'Airport', address: 'San Francisco, CA 94128', lat: 37.6213, lng: -122.3790, color: '#007AFF' },
        { name: 'Golden Gate Bridge', category: 'Landmark', address: 'Golden Gate Bridge, San Francisco, CA', lat: 37.8199, lng: -122.4783, color: '#FF9500' },
        { name: 'Fisherman\'s Wharf', category: 'Attraction', address: 'Fisherman\'s Wharf, San Francisco, CA', lat: 37.8080, lng: -122.4177, color: '#34C759' },
        { name: 'Alcatraz Island', category: 'Landmark', address: 'Alcatraz Island, San Francisco, CA', lat: 37.8267, lng: -122.4230, color: '#FF2D55' },
        { name: 'Pier 39', category: 'Attraction', address: 'Pier 39, San Francisco, CA', lat: 37.8087, lng: -122.4098, color: '#5856D6' },
    ];

    const filteredPlaces = searchQuery
        ? places.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.address.toLowerCase().includes(searchQuery.toLowerCase()))
        : places;

    const getMapUrl = (lat, lng, zoom) => {
        return `https://www.openstreetmap.org/export/embed.html?bbox=${lng - 0.5 / zoom * 10},${lat - 0.3 / zoom * 10},${lng + 0.5 / zoom * 10},${lat + 0.3 / zoom * 10}&layer=mapnik&marker=${lat},${lng}`;
    };

    const selectPlace = (index) => {
        setSelectedPlace(index);
        const place = filteredPlaces[index];
        setMapCenter({ lat: place.lat, lng: place.lng });
        setMapZoom(15);
    };

    const zoomIn = () => setMapZoom(z => Math.min(18, z + 2));
    const zoomOut = () => setMapZoom(z => Math.max(2, z - 2));

    const handleSearch = (e) => {
        if (e.key === 'Enter' && searchQuery.trim()) {
            const found = places.findIndex(p =>
                p.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
            if (found >= 0) selectPlace(found);
        }
    };

    const mapUrl = selectedPlace !== null
        ? getMapUrl(filteredPlaces[selectedPlace].lat, filteredPlaces[selectedPlace].lng, mapZoom)
        : getMapUrl(mapCenter.lat, mapCenter.lng, mapZoom);

    return (
        <div className="flex h-full">
            {/* Sidebar */}
            <div className="w-[280px] min-w-[280px] bg-gray-50/95 border-r border-black/5 flex flex-col">
                <div className="p-3 border-b border-black/5">
                    <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/80 border border-black/5">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#999"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                            onKeyDown={handleSearch}
                            placeholder="Search Maps" className="flex-1 bg-transparent outline-none text-[13px] font-sf"/>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto">
                    {filteredPlaces.map((place, i) => (
                        <div key={i}
                            className={`flex items-center gap-3 px-4 py-2.5 cursor-default border-b border-black/[0.03] ${selectedPlace === i ? 'bg-blue-500/[0.08]' : 'hover:bg-black/[0.02]'}`}
                            onClick={() => selectPlace(i)}
                        >
                            <div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ background: place.color + '20' }}>
                                <svg viewBox="0 0 24 24" width="16" height="16" fill={place.color}><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                            </div>
                            <div className="min-w-0">
                                <div className="text-[13px] font-medium truncate">{place.name}</div>
                                <div className="text-[11px] text-gray-400 truncate">{place.category} Â· {place.address.split(',')[0]}</div>
                            </div>
                        </div>
                    ))}
                </div>
                <div className="p-3 border-t border-black/5 text-[10px] text-gray-400 text-center">
                    Powered by OpenStreetMap
                </div>
            </div>

            {/* Map area */}
            <div className="flex-1 relative overflow-hidden">
                <iframe
                    ref={iframeRef}
                    src={mapUrl}
                    className="w-full h-full border-none"
                    title="Map"
                    loading="lazy"
                />

                {/* Zoom controls */}
                <div className="absolute bottom-6 right-6 flex flex-col bg-white/90 rounded-lg shadow-lg border border-black/10 overflow-hidden">
                    <button onClick={zoomIn} className="px-3 py-2 text-[16px] hover:bg-black/5 border-b border-black/10">+</button>
                    <button onClick={zoomOut} className="px-3 py-2 text-[16px] hover:bg-black/5">âˆ’</button>
                </div>

                {/* Selected place info */}
                {selectedPlace !== null && (
                    <div className="absolute bottom-6 left-6 bg-white/95 backdrop-blur-xl rounded-xl shadow-xl border border-black/10 p-4 max-w-[280px]">
                        <div className="flex items-start gap-3">
                            <div className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style={{ background: filteredPlaces[selectedPlace].color }}>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                            </div>
                            <div>
                                <div className="text-[15px] font-semibold">{filteredPlaces[selectedPlace].name}</div>
                                <div className="text-[12px] text-gray-500 mt-0.5">{filteredPlaces[selectedPlace].address}</div>
                                <div className="flex gap-2 mt-2">
                                    <a href={`https://www.openstreetmap.org/?mlat=${filteredPlaces[selectedPlace].lat}&mlon=${filteredPlaces[selectedPlace].lng}#map=16/${filteredPlaces[selectedPlace].lat}/${filteredPlaces[selectedPlace].lng}`}
                                        target="_blank" rel="noopener noreferrer"
                                        className="px-3 py-1 rounded-full bg-blue-500 text-white text-[11px] font-medium cursor-default">
                                        Directions
                                    </a>
                                    <button onClick={() => setSelectedPlace(null)}
                                        className="px-3 py-1 rounded-full bg-gray-100 text-[11px] font-medium">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};


window.MapsApp = MapsApp;
</script>

<script type="text/babel">
// Music App - Interactive music player with real 30s previews, search, playlists
// Default songs defined outside component so they're stable across renders
const _defaultSongs = [
    { title: 'Blinding Lights', artist: 'The Weeknd', album: 'After Hours', duration: '0:30', color: '#FF0000', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music125/v4/2b/b9/fe/2bb9fef5-d7f3-8345-25a9-db0e79fde4e4/20UMGIM11048.rgb.jpg/600x600bb.jpg', search: 'Blinding Lights The Weeknd', genre: 'Pop' },
    { title: 'Levitating', artist: 'Dua Lipa', album: 'Future Nostalgia', duration: '0:30', color: '#FF69B4', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music116/v4/e9/c5/a8/e9c5a8a0-d698-137b-2e85-cf3a8d9548f8/190295303372.jpg/600x600bb.jpg', search: 'Levitating Dua Lipa', genre: 'Pop' },
    { title: 'Stay', artist: 'The Kid LAROI & Justin Bieber', album: 'Stay', duration: '0:30', color: '#8B5CF6', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music125/v4/89/59/6a/89596ab9-fa3c-8d08-4d95-a6450fa2013c/886449400515.jpg/600x600bb.jpg', search: 'Stay Kid LAROI Justin Bieber', genre: 'Pop' },
    { title: 'Heat Waves', artist: 'Glass Animals', album: 'Dreamland', duration: '0:30', color: '#F59E0B', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/44/2e/2e/442e2e48-677d-592a-5f5a-145c67236e75/21UMGIM85445.rgb.jpg/600x600bb.jpg', search: 'Heat Waves Glass Animals', genre: 'Indie' },
    { title: 'Save Your Tears', artist: 'The Weeknd', album: 'After Hours', duration: '0:30', color: '#3B82F6', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music125/v4/2b/b9/fe/2bb9fef5-d7f3-8345-25a9-db0e79fde4e4/20UMGIM11048.rgb.jpg/600x600bb.jpg', search: 'Save Your Tears Weeknd', genre: 'Pop' },
    { title: 'Peaches', artist: 'Justin Bieber', album: 'Justice', duration: '0:30', color: '#F97316', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/e0/92/da/e092da2d-9f6d-11dc-7843-2021e95a2b61/21UMGIM17518.rgb.jpg/600x600bb.jpg', search: 'Peaches Justin Bieber', genre: 'R&B' },
    { title: 'Good 4 U', artist: 'Olivia Rodrigo', album: 'SOUR', duration: '0:30', color: '#A855F7', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/02/ed/8c/02ed8cab-c089-2fdd-7ce6-ab334a9a4e19/21UMGIM26093.rgb.jpg/600x600bb.jpg', search: 'good 4 u Olivia Rodrigo', genre: 'Pop Rock' },
    { title: 'Montero', artist: 'Lil Nas X', album: 'Montero', duration: '0:30', color: '#EF4444', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/4b/42/21/4b422136-2cfd-222c-ca7c-7573bf23139c/886449537204.jpg/600x600bb.jpg', search: 'Montero Call Me By Your Name Lil Nas X', genre: 'Hip-Hop' },
    { title: 'Kiss Me More', artist: 'Doja Cat ft. SZA', album: 'Planet Her', duration: '0:30', color: '#EC4899', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music116/v4/4f/4b/ee/4f4bee71-d197-67ab-2a42-913dc416df0d/886449138869.jpg/600x600bb.jpg', search: 'Kiss Me More Doja Cat SZA', genre: 'Pop' },
    { title: 'Butter', artist: 'BTS', album: 'Butter', duration: '0:30', color: '#EAB308', cover: 'https://is1-ssl.mzstatic.com/image/thumb/Music116/v4/27/80/dc/2780dce3-3cdd-d8aa-ec8c-05bf8ad90f9d/196006771362_Cover.jpg/600x600bb.jpg', search: 'Butter BTS', genre: 'K-Pop' },
];

// Global URL cache that persists across re-renders
const _urlCache = {};

// Pre-fetch all default song preview URLs immediately
_defaultSongs.forEach(s => {
    const key = s.title + '|||' + s.artist;
    fetch('https://itunes.apple.com/search?term=' + encodeURIComponent(s.search || s.title + ' ' + s.artist) + '&limit=1&media=music')
        .then(r => r.json())
        .then(data => {
            if (data.results && data.results[0] && data.results[0].previewUrl) {
                _urlCache[key] = data.results[0].previewUrl;
            }
        }).catch(() => {});
});

const MusicApp = () => {
    const [activeNav, setActiveNav] = React.useState('Listen Now');
    const [isPlaying, setIsPlaying] = React.useState(false);
    const [currentSongIdx, setCurrentSongIdx] = React.useState(0);
    const [progress, setProgress] = React.useState(0);
    const [currentTime, setCurrentTime] = React.useState(0);
    const [audioDuration, setAudioDuration] = React.useState(30);
    const [volume, setVolume] = React.useState(70);
    const [shuffle, setShuffle] = React.useState(false);
    const [repeat, setRepeat] = React.useState(false);
    const [loadingAudio, setLoadingAudio] = React.useState(false);
    const [searchQuery, setSearchQuery] = React.useState('');
    const [searchResults, setSearchResults] = React.useState([]);
    const [searchLoading, setSearchLoading] = React.useState(false);
    const [library, setLibrary] = React.useState([]);
    const [nowPlayingList, setNowPlayingList] = React.useState([]);
    const [nowPlayingSong, setNowPlayingSong] = React.useState(null);
    const [playlists, setPlaylists] = React.useState([]);
    const [viewingPlaylist, setViewingPlaylist] = React.useState(null);
    const [showNewPlaylist, setShowNewPlaylist] = React.useState(false);
    const [newPlaylistName, setNewPlaylistName] = React.useState('');
    const [addToPlaylistSong, setAddToPlaylistSong] = React.useState(null);
    const [confirmDeletePlaylist, setConfirmDeletePlaylist] = React.useState(null);
    const audioElRef = React.useRef(null);
    const searchTimeout = React.useRef(null);
    const npListRef = React.useRef([]);
    const npIdxRef = React.useRef(0);

    const defaultSongs = _defaultSongs;

    React.useEffect(() => {
        const saved = localStorage.getItem('macos_music_library');
        if (saved) { try { setLibrary(JSON.parse(saved)); } catch(e) {} }
        const savedPl = localStorage.getItem('macos_music_playlists');
        if (savedPl) { try { setPlaylists(JSON.parse(savedPl)); } catch(e) {} }
    }, []);

    // Get the audio element ref (rendered in JSX below)
    const getAudio = () => audioElRef.current;

    const savePlaylists = (pls) => {
        setPlaylists(pls);
        localStorage.setItem('macos_music_playlists', JSON.stringify(pls));
    };

    const createPlaylist = (name) => {
        if (!name.trim()) return;
        const pl = { id: Date.now(), name: name.trim(), songs: [], colors: ['#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'), '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')] };
        savePlaylists([...playlists, pl]);
        setShowNewPlaylist(false);
        setNewPlaylistName('');
    };

    const deletePlaylist = (id) => {
        setConfirmDeletePlaylist(id);
    };

    const confirmDelete = () => {
        if (!confirmDeletePlaylist) return;
        savePlaylists(playlists.filter(p => p.id !== confirmDeletePlaylist));
        if (viewingPlaylist && viewingPlaylist.id === confirmDeletePlaylist) setViewingPlaylist(null);
        setConfirmDeletePlaylist(null);
    };

    const addSongToPlaylist = (plId, song) => {
        const updated = playlists.map(p => {
            if (p.id === plId) {
                if (p.songs.some(s => s.title === song.title && s.artist === song.artist)) return p;
                return { ...p, songs: [...p.songs, song] };
            }
            return p;
        });
        savePlaylists(updated);
        setAddToPlaylistSong(null);
    };

    const removeSongFromPlaylist = (plId, songIdx) => {
        const updated = playlists.map(p => {
            if (p.id === plId) return { ...p, songs: p.songs.filter((_, i) => i !== songIdx) };
            return p;
        });
        savePlaylists(updated);
        if (viewingPlaylist && viewingPlaylist.id === plId) {
            setViewingPlaylist(updated.find(p => p.id === plId));
        }
    };

    const builtinPlaylists = {
        'Favorites Mix': { filter: (s) => ['Blinding Lights','Levitating','Good 4 U','Heat Waves','Butter'].includes(s.title), colors: ['#FF3B30', '#FF9500'] },
        'Chill Vibes': { filter: (s) => ['Heat Waves','Save Your Tears','Kiss Me More','Peaches'].includes(s.title), colors: ['#5856D6', '#007AFF'] },
        'Workout': { filter: (s) => ['Good 4 U','Montero','Levitating','Blinding Lights','Butter'].includes(s.title), colors: ['#34C759', '#30D158'] },
        'Focus': { filter: (s) => ['Heat Waves','Stay','Save Your Tears','Kiss Me More'].includes(s.title), colors: ['#AF52DE', '#BF5AF2'] },
    };

    const navItems = ['Listen Now', 'Browse', 'Radio', 'Library', 'Search'];

    const isCurrent = (s) => nowPlayingSong && s.title === nowPlayingSong.title && s.artist === nowPlayingSong.artist;

    const formatTime = (seconds) => { const m = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60); return m + ':' + String(sec).padStart(2, '0'); };

    // Get URL: from song's previewUrl, or from global cache
    const getUrl = (s) => s.previewUrl || _urlCache[s.title + '|||' + s.artist] || null;

    // Fetch URL from iTunes (returns promise)
    const fetchUrl = (s) => {
        const key = s.title + '|||' + s.artist;
        if (_urlCache[key]) return Promise.resolve(_urlCache[key]);
        return fetch('https://itunes.apple.com/search?term=' + encodeURIComponent(s.search || s.title + ' ' + s.artist) + '&limit=1&media=music')
            .then(r => r.json())
            .then(data => {
                if (data.results && data.results[0] && data.results[0].previewUrl) {
                    _urlCache[key] = data.results[0].previewUrl;
                    return _urlCache[key];
                }
                return null;
            }).catch(() => null);
    };

    // Core play function â€” keeps it synchronous when URL is available
    const playSong = (index, list) => {
        const audio = getAudio();
        if (!audio || !list || !list[index]) return;
        const s = list[index];

        // Update state
        npListRef.current = list;
        npIdxRef.current = index;
        setNowPlayingList(list);
        setNowPlayingSong(s);
        setCurrentSongIdx(index);
        setProgress(0);
        setCurrentTime(0);

        const url = getUrl(s);
        if (url) {
            // Play immediately â€” synchronous from user click
            audio.src = url;
            audio.load();
            audio.play().catch(() => {});
            setIsPlaying(true);
            setLoadingAudio(false);
        } else {
            // Need to fetch URL first
            setLoadingAudio(true);
            fetchUrl(s).then(fetchedUrl => {
                if (fetchedUrl) {
                    audio.src = fetchedUrl;
                    audio.load();
                    audio.play().catch(() => {});
                    setIsPlaying(true);
                }
                setLoadingAudio(false);
            });
        }
    };

    // Audio event handlers via onXxx props on <audio> element
    const onTimeUpdate = () => {
        const audio = getAudio();
        if (!audio) return;
        const dur = audio.duration || 30;
        setCurrentTime(audio.currentTime);
        setAudioDuration(dur);
        setProgress((audio.currentTime / dur) * 100);
    };

    const onEnded = () => {
        const audio = getAudio();
        if (repeat && audio) { audio.currentTime = 0; audio.play(); return; }
        const curList = npListRef.current;
        const curIdx = npIdxRef.current;
        if (curList.length > 0) {
            const next = shuffle ? Math.floor(Math.random() * curList.length) : (curIdx + 1) % curList.length;
            playSong(next, curList);
        }
    };

    React.useEffect(() => {
        const audio = getAudio();
        if (audio) audio.volume = volume / 100;
    }, [volume]);

    const togglePlay = () => {
        const audio = getAudio();
        if (!audio) return;
        if (isPlaying) {
            audio.pause();
            setIsPlaying(false);
        } else {
            if (!audio.src || audio.currentSrc === '') {
                playSong(0, defaultSongs);
            } else {
                audio.play().catch(() => {});
                setIsPlaying(true);
            }
        }
    };

    const prevSong = () => {
        if (npListRef.current.length === 0) return;
        const prev = npIdxRef.current === 0 ? npListRef.current.length - 1 : npIdxRef.current - 1;
        playSong(prev, npListRef.current);
    };

    const nextSong = () => {
        if (npListRef.current.length === 0) return;
        const next = shuffle ? Math.floor(Math.random() * npListRef.current.length) : (npIdxRef.current + 1) % npListRef.current.length;
        playSong(next, npListRef.current);
    };

    const seekTo = (val) => {
        const audio = getAudio();
        if (!audio) return;
        const dur = audio.duration || 30;
        audio.currentTime = (val / 100) * dur;
        setProgress(val);
    };

    // Search iTunes API
    const doSearch = (query) => {
        if (!query.trim()) { setSearchResults([]); return; }
        setSearchLoading(true);
        fetch('https://itunes.apple.com/search?term=' + encodeURIComponent(query) + '&limit=25&media=music')
            .then(r => r.json())
            .then(data => {
                setSearchResults((data.results || []).filter(r => r.previewUrl).map(r => ({
                    title: r.trackName, artist: r.artistName, album: r.collectionName,
                    duration: formatTime((r.trackTimeMillis || 30000) / 1000),
                    color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
                    cover: (r.artworkUrl100 || '').replace('100x100', '600x600'),
                    search: r.trackName + ' ' + r.artistName,
                    genre: r.primaryGenreName || 'Music',
                    previewUrl: r.previewUrl,
                })));
                setSearchLoading(false);
            }).catch(() => { setSearchResults([]); setSearchLoading(false); });
    };

    const handleSearchInput = (val) => {
        setSearchQuery(val);
        if (searchTimeout.current) clearTimeout(searchTimeout.current);
        searchTimeout.current = setTimeout(() => doSearch(val), 500);
    };

    const addToLibrary = (s) => {
        if (isInLibrary(s)) return;
        const newLib = [...library, s];
        setLibrary(newLib);
        localStorage.setItem('macos_music_library', JSON.stringify(newLib));
    };

    const removeFromLibrary = (idx) => {
        const nl = library.filter((_,j) => j !== idx);
        setLibrary(nl);
        localStorage.setItem('macos_music_library', JSON.stringify(nl));
    };

    const isInLibrary = (s) => library.some(l => l.title === s.title && l.artist === s.artist);

    const CoverArt = ({ src, color, size = 36, rounded = 'rounded-md' }) => (
        <div className={`${rounded} flex-shrink-0 overflow-hidden`} style={{ width: size, height: size, background: `linear-gradient(135deg, ${color || '#666'}, ${color || '#666'}dd)` }}>
            <img src={src} alt="" width={size} height={size} className="w-full h-full object-cover" draggable="false" onError={(e) => { e.target.style.display = 'none'; }}/>
        </div>
    );

    const SongRow = ({ s, i, list, showAdd, showPlaylist, onRemove }) => {
        const playing = isCurrent(s) && isPlaying;
        const current = isCurrent(s);
        return (
            <div className={`flex items-center gap-3 px-4 py-2 border-b border-black/[0.03] cursor-pointer select-none ${playing ? 'bg-red-500/[0.06]' : 'hover:bg-black/[0.03]'}`}
                onClick={() => playSong(i, list)}>
                <span className="text-[12px] text-gray-400 w-5 text-right flex-shrink-0">
                    {playing ? (
                        <svg viewBox="0 0 16 16" width="12" height="12" fill="#FF3B30"><rect x="2" y="3" width="3" height="10" rx="1"><animate attributeName="height" values="10;4;10" dur="0.8s" repeatCount="indefinite"/><animate attributeName="y" values="3;6;3" dur="0.8s" repeatCount="indefinite"/></rect><rect x="7" y="1" width="3" height="14" rx="1"><animate attributeName="height" values="14;6;14" dur="0.6s" repeatCount="indefinite"/><animate attributeName="y" values="1;5;1" dur="0.6s" repeatCount="indefinite"/></rect><rect x="12" y="4" width="3" height="8" rx="1"><animate attributeName="height" values="8;12;8" dur="0.7s" repeatCount="indefinite"/><animate attributeName="y" values="4;2;4" dur="0.7s" repeatCount="indefinite"/></rect></svg>
                    ) : current ? (
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="#FF3B30"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    ) : (i + 1)}
                </span>
                <CoverArt src={s.cover} color={s.color} size={36}/>
                <div className="flex-1 min-w-0">
                    <div className={`text-[13px] font-medium truncate ${current ? 'text-red-500' : ''}`}>{s.title}</div>
                    <div className="text-[11px] text-gray-400 truncate">{s.artist} â€” {s.album}</div>
                </div>
                <div className="flex items-center gap-1 flex-shrink-0">
                    {showPlaylist && playlists.length > 0 && (
                        <button onClick={(e) => { e.stopPropagation(); setAddToPlaylistSong(s); }} className="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-500 text-[10px] font-medium hover:bg-purple-500/20" title="Add to playlist">+PL</button>
                    )}
                    {showAdd && !isInLibrary(s) && (
                        <button onClick={(e) => { e.stopPropagation(); addToLibrary(s); }} className="px-2 py-0.5 rounded-full bg-red-500/10 text-red-500 text-[10px] font-medium hover:bg-red-500/20">+ Library</button>
                    )}
                    {showAdd && isInLibrary(s) && (
                        <span className="text-[10px] text-green-500 font-medium px-1">Added</span>
                    )}
                    {onRemove && (
                        <button onClick={(e) => { e.stopPropagation(); onRemove(); }} className="text-gray-800 hover:text-red-500 text-[18px] font-bold ml-1 leading-none" title="Remove from playlist">&times;</button>
                    )}
                </div>
                <span className="text-[12px] text-gray-400 flex-shrink-0 w-10 text-right">0:30</span>
            </div>
        );
    };

    const radioStations = [
        { name: 'Apple Music 1', desc: 'Pop Hits, 24/7', color: '#FF2D55', searchTerm: 'pop hits 2024' },
        { name: 'Apple Music Hits', desc: 'Songs you know and love', color: '#FF9500', searchTerm: 'greatest hits' },
        { name: 'Apple Music Country', desc: 'Country music all day', color: '#AF52DE', searchTerm: 'country music' },
        { name: 'Chill Radio', desc: 'Lo-fi & ambient', color: '#5856D6', searchTerm: 'lo-fi chill beats' },
        { name: 'Hip-Hop Hits', desc: 'Top rap & hip-hop', color: '#FF3B30', searchTerm: 'hip hop 2024' },
        { name: 'R&B Now', desc: 'R&B essentials', color: '#34C759', searchTerm: 'r&b 2024' },
    ];

    const playRadio = (station) => {
        setSearchLoading(true);
        fetch('https://itunes.apple.com/search?term=' + encodeURIComponent(station.searchTerm) + '&limit=20&media=music')
            .then(r => r.json())
            .then(data => {
                const songs = (data.results || []).filter(r => r.previewUrl).map(r => ({
                    title: r.trackName, artist: r.artistName, album: r.collectionName,
                    duration: formatTime((r.trackTimeMillis || 30000) / 1000),
                    color: station.color,
                    cover: (r.artworkUrl100 || '').replace('100x100', '600x600'),
                    search: r.trackName + ' ' + r.artistName,
                    genre: r.primaryGenreName || 'Music',
                    previewUrl: r.previewUrl,
                }));
                if (songs.length > 0) playSong(0, songs);
                setSearchLoading(false);
            }).catch(() => { setSearchLoading(false); });
    };

    const renderContent = () => {
        switch (activeNav) {
            case 'Search':
                return (
                    <>
                        <div className="mb-4">
                            <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 border border-black/5">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="#999"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" value={searchQuery} onChange={(e) => handleSearchInput(e.target.value)}
                                    placeholder="Search any song, artist, or album..." className="flex-1 bg-transparent outline-none text-[14px]" autoFocus/>
                                {searchQuery && <button onClick={() => { setSearchQuery(''); setSearchResults([]); }} className="text-gray-400 text-[18px]">&times;</button>}
                            </div>
                        </div>
                        {searchLoading && <div className="text-center text-[13px] text-gray-400 py-8">Searching iTunes...</div>}
                        {!searchLoading && searchResults.length > 0 && (
                            <div className="bg-gray-50 rounded-xl overflow-hidden">
                                <div className="px-4 py-2 text-[11px] text-gray-400 border-b border-black/5 flex items-center gap-2">
                                    <svg viewBox="0 0 24 24" width="12" height="12" fill="#34C759"><path d="M8 5v14l11-7z"/></svg>
                                    {searchResults.length} songs found â€” click any to play 30-second preview
                                </div>
                                {searchResults.map((s, i) => <SongRow key={i} s={s} i={i} list={searchResults} showAdd={true} showPlaylist={true}/>)}
                            </div>
                        )}
                        {!searchLoading && searchQuery && searchResults.length === 0 && <div className="text-center text-[13px] text-gray-400 py-8">No results found</div>}
                        {!searchQuery && (
                            <div className="text-center text-gray-400 text-[13px] py-12">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="#ccc" className="mx-auto mb-3"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                Search for any song, artist, or album worldwide<br/>
                                <span className="text-[11px] mt-1 block">Every result is a playable 30-second preview from iTunes</span>
                            </div>
                        )}
                    </>
                );
            case 'Browse':
                const genres = ['Pop', 'Hip-Hop', 'Rock', 'R&B', 'Electronic', 'Country', 'Jazz', 'Classical', 'Latin', 'K-Pop', 'Indie', 'Metal'];
                return (
                    <>
                        <div className="text-[13px] font-semibold text-gray-400 uppercase tracking-wider mb-3">Browse by Genre</div>
                        <div className="grid grid-cols-3 gap-3 mb-8">
                            {genres.map(g => (
                                <div key={g} className="rounded-xl p-4 cursor-pointer hover:opacity-90 transition-opacity text-white font-bold text-[15px]"
                                    style={{ background: `linear-gradient(135deg, hsl(${genres.indexOf(g)*30},70%,50%), hsl(${genres.indexOf(g)*30+30},70%,40%))` }}
                                    onClick={() => { setActiveNav('Search'); handleSearchInput(g + ' music'); setViewingPlaylist(null); }}>
                                    {g}
                                </div>
                            ))}
                        </div>
                        <div className="text-[13px] font-semibold text-gray-400 uppercase tracking-wider mb-3">Top Songs</div>
                        <div className="bg-gray-50 rounded-xl overflow-hidden">
                            {defaultSongs.slice(0,5).map((s, i) => <SongRow key={i} s={s} i={i} list={defaultSongs} showPlaylist={true} showAdd={true}/>)}
                        </div>
                    </>
                );
            case 'Radio':
                return (
                    <>
                        <div className="text-[13px] font-semibold text-gray-400 uppercase tracking-wider mb-3">Live Radio Stations</div>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            {radioStations.map(st => (
                                <div key={st.name} className="rounded-xl p-5 cursor-pointer hover:scale-[1.02] transition-transform text-white"
                                    style={{ background: `linear-gradient(135deg, ${st.color}, ${st.color}cc)` }}
                                    onClick={() => playRadio(st)}>
                                    <div className="text-[16px] font-bold">{st.name}</div>
                                    <div className="text-[12px] opacity-80 mt-1">{st.desc}</div>
                                    <div className="mt-3 flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-white animate-pulse"/>
                                        <span className="text-[11px] opacity-70">LIVE</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="text-[11px] text-gray-400 text-center">Click a station to load and play 30-second previews from that genre</div>
                    </>
                );
            case 'Library':
                return (
                    <>
                        <div className="flex items-center justify-between mb-4">
                            <span className="text-[13px] text-gray-400">{library.length} songs in your library</span>
                        </div>
                        {library.length === 0 ? (
                            <div className="text-center text-gray-400 text-[13px] py-12">
                                Your library is empty.<br/>
                                <span className="text-[11px]">Search for songs and click "+ Library" to add them!</span>
                            </div>
                        ) : (
                            <div className="bg-gray-50 rounded-xl overflow-hidden">
                                {library.map((s, i) => (
                                    <SongRow key={i} s={s} i={i} list={library} showPlaylist={true} onRemove={() => removeFromLibrary(i)}/>
                                ))}
                            </div>
                        )}
                    </>
                );
            case 'Listen Now':
            default:
                return (
                    <>
                        <div className="flex gap-4 mb-8 overflow-x-auto pb-2">
                            {defaultSongs.slice(0, 5).map((s, i) => (
                                <div key={i} className="flex-shrink-0 cursor-pointer group" onClick={() => playSong(i, defaultSongs)}>
                                    <div className="w-[160px] h-[160px] rounded-xl shadow-md mb-2 overflow-hidden transition-transform group-hover:scale-[1.02] relative"
                                        style={{ background: `linear-gradient(135deg, ${s.color}, ${s.color}dd)` }}>
                                        <img src={s.cover} alt={s.album} className="w-full h-full object-cover" draggable="false" onError={(e) => { e.target.style.display = 'none'; }}/>
                                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                                            <div className="opacity-0 group-hover:opacity-100 transition-opacity w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                                <svg viewBox="0 0 24 24" width="18" height="18" fill="#333"><path d="M8 5v14l11-7z"/></svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-[13px] font-medium truncate w-[160px]">{s.album}</div>
                                    <div className="text-[11px] text-gray-400 truncate w-[160px]">{s.artist}</div>
                                </div>
                            ))}
                        </div>
                        <div className="mb-4 bg-red-50 rounded-xl p-3 text-[12px] text-red-600 border border-red-100 flex items-center gap-2">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="#FF3B30"><path d="M8 5v14l11-7z"/></svg>
                            Click any song to hear a 30-second preview. Use Search to find anything worldwide!
                        </div>
                        <div className="text-[12px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Top Songs</div>
                        <div className="bg-gray-50 rounded-xl overflow-hidden">
                            {defaultSongs.map((s, i) => <SongRow key={i} s={s} i={i} list={defaultSongs} showPlaylist={true} showAdd={true}/>)}
                        </div>
                    </>
                );
        }
    };

    const activeBuiltinPlaylist = Object.keys(builtinPlaylists).find(name => activeNav === name);

    const renderPlaylistContent = (plName) => {
        const pl = builtinPlaylists[plName];
        const plSongs = defaultSongs.filter(pl.filter);
        return (
            <>
                <div className="flex items-center gap-4 mb-6">
                    <div className="w-[120px] h-[120px] rounded-xl shadow-lg" style={{ background: `linear-gradient(135deg, ${pl.colors[0]}, ${pl.colors[1]})` }}/>
                    <div>
                        <div className="text-[22px] font-bold">{plName}</div>
                        <div className="text-[13px] text-gray-400">{plSongs.length} songs</div>
                        <button className="mt-2 px-4 py-1.5 rounded-full bg-red-500 text-white text-[12px] font-medium hover:bg-red-600"
                            onClick={() => { if (plSongs.length > 0) playSong(0, plSongs); }}>Play All</button>
                    </div>
                </div>
                <div className="bg-gray-50 rounded-xl overflow-hidden">
                    {plSongs.map((s, i) => <SongRow key={i} s={s} i={i} list={plSongs} showPlaylist={true}/>)}
                </div>
            </>
        );
    };

    const renderUserPlaylist = (pl) => (
        <>
            <div className="flex items-center gap-4 mb-6">
                <div className="w-[120px] h-[120px] rounded-xl shadow-lg flex items-center justify-center text-white text-[32px] overflow-hidden" style={{ background: `linear-gradient(135deg, ${pl.colors[0]}, ${pl.colors[1]})` }}>
                    {pl.songs.length > 0 && pl.songs[0].cover ? (
                        <img src={pl.songs[0].cover} className="w-full h-full object-cover" onError={(e) => { e.target.style.display = 'none'; }}/>
                    ) : '...'}
                </div>
                <div>
                    <div className="text-[22px] font-bold">{pl.name}</div>
                    <div className="text-[13px] text-gray-400">{pl.songs.length} songs</div>
                    <div className="flex gap-2 mt-2">
                        {pl.songs.length > 0 && (
                            <button className="px-4 py-1.5 rounded-full bg-red-500 text-white text-[12px] font-medium hover:bg-red-600"
                                onClick={() => playSong(0, pl.songs)}>Play All</button>
                        )}
                        <button className="px-4 py-1.5 rounded-full bg-gray-200 text-gray-600 text-[12px] font-medium hover:bg-gray-300"
                            onClick={() => deletePlaylist(pl.id)}>Delete</button>
                    </div>
                </div>
            </div>
            {pl.songs.length === 0 ? (
                <div className="text-center text-gray-400 text-[13px] py-12">
                    This playlist is empty.<br/>
                    <span className="text-[11px]">Use the +PL button on any song to add it here.</span>
                </div>
            ) : (
                <div className="bg-gray-50 rounded-xl overflow-hidden">
                    {pl.songs.map((s, i) => <SongRow key={i} s={s} i={i} list={pl.songs} onRemove={() => removeSongFromPlaylist(pl.id, i)}/>)}
                </div>
            )}
        </>
    );

    let displayNav = activeNav;
    if (activeBuiltinPlaylist) displayNav = activeBuiltinPlaylist;
    if (viewingPlaylist) displayNav = viewingPlaylist.name;

    const npSong = nowPlayingSong || defaultSongs[0];

    return (
        <div className="flex flex-col h-full bg-white" style={{ position: 'relative' }}>
            {/* Real audio element in the DOM */}
            <audio ref={audioElRef} onTimeUpdate={onTimeUpdate} onEnded={onEnded}
                onPlay={() => setIsPlaying(true)} onPause={() => setIsPlaying(false)}
                onLoadedMetadata={() => { const a = getAudio(); if (a) setAudioDuration(a.duration || 30); }}
                preload="auto" style={{ display: 'none' }}/>

            {/* Add to playlist modal */}
            {addToPlaylistSong && (
                <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, zIndex: 50, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'rgba(0,0,0,0.3)' }} onClick={() => setAddToPlaylistSong(null)}>
                    <div className="bg-white rounded-xl shadow-2xl p-4 w-[280px]" onClick={e => e.stopPropagation()}>
                        <div className="text-[14px] font-semibold mb-3">Add to Playlist</div>
                        <div className="text-[12px] text-gray-400 mb-3 truncate">"{addToPlaylistSong.title}" by {addToPlaylistSong.artist}</div>
                        {playlists.length === 0 ? (
                            <div className="text-[12px] text-gray-400 py-4 text-center">No playlists yet. Create one first!</div>
                        ) : (
                            <div className="max-h-[200px] overflow-y-auto">
                                {playlists.map(pl => (
                                    <div key={pl.id} className="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 cursor-pointer text-[13px]"
                                        onClick={() => addSongToPlaylist(pl.id, addToPlaylistSong)}>
                                        <div className="w-6 h-6 rounded" style={{ background: `linear-gradient(135deg, ${pl.colors[0]}, ${pl.colors[1]})` }}/>
                                        <span>{pl.name}</span>
                                        <span className="text-[11px] text-gray-400 ml-auto">{pl.songs.length} songs</span>
                                    </div>
                                ))}
                            </div>
                        )}
                        <button onClick={() => setAddToPlaylistSong(null)} className="mt-3 w-full py-1.5 rounded-lg bg-gray-100 text-[12px] text-gray-600 hover:bg-gray-200">Cancel</button>
                    </div>
                </div>
            )}

            {/* Delete playlist confirmation modal */}
            {confirmDeletePlaylist && (() => {
                const pl = playlists.find(p => p.id === confirmDeletePlaylist);
                return (
                    <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, zIndex: 51, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'rgba(0,0,0,0.3)' }} onClick={() => setConfirmDeletePlaylist(null)}>
                        <div className="bg-white rounded-xl shadow-2xl p-5 w-[280px] text-center" onClick={e => e.stopPropagation()}>
                            <div className="text-[14px] font-semibold mb-2">Delete Playlist?</div>
                            <div className="text-[12px] text-gray-400 mb-4">Are you sure you want to delete "{pl ? pl.name : ''}"? This action cannot be undone.</div>
                            <div className="flex gap-2">
                                <button onClick={() => setConfirmDeletePlaylist(null)} className="flex-1 py-1.5 rounded-lg bg-gray-100 text-[12px] text-gray-600 font-medium hover:bg-gray-200">Cancel</button>
                                <button onClick={confirmDelete} className="flex-1 py-1.5 rounded-lg bg-red-500 text-[12px] text-white font-medium hover:bg-red-600">Delete</button>
                            </div>
                        </div>
                    </div>
                );
            })()}

            <div className="flex flex-1 overflow-hidden">
                <div className="w-[220px] min-w-[220px] bg-gray-50/95 border-r border-black/5 p-2 overflow-y-auto">
                    <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider px-3 py-1 mt-1">Apple Music</div>
                    {navItems.map(item => (
                        <div key={item} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-pointer text-[13px] ${displayNav === item ? 'bg-red-500 text-white' : 'hover:bg-black/[0.03]'}`}
                            onClick={() => { setActiveNav(item); setViewingPlaylist(null); }}>{item}</div>
                    ))}
                    <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider px-3 py-1 mt-4">Apple Mixes</div>
                    {Object.keys(builtinPlaylists).map(plName => (
                        <div key={plName} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-pointer text-[13px] ${displayNav === plName ? 'bg-red-500 text-white' : 'hover:bg-black/[0.03]'}`}
                            onClick={() => { setActiveNav(plName); setViewingPlaylist(null); }}>
                            <div className="w-5 h-5 rounded" style={{ background: `linear-gradient(135deg, ${builtinPlaylists[plName].colors[0]}, ${builtinPlaylists[plName].colors[1]})` }}/>
                            {plName}
                        </div>
                    ))}
                    <div className="flex items-center justify-between px-3 py-1 mt-4">
                        <span className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider">My Playlists</span>
                        <button onClick={() => setShowNewPlaylist(true)} className="text-red-500 text-[16px] hover:text-red-600 leading-none" title="New Playlist">+</button>
                    </div>
                    {showNewPlaylist && (
                        <div className="px-3 py-1">
                            <input type="text" value={newPlaylistName} onChange={(e) => setNewPlaylistName(e.target.value)}
                                onKeyDown={(e) => { if (e.key === 'Enter') createPlaylist(newPlaylistName); if (e.key === 'Escape') { setShowNewPlaylist(false); setNewPlaylistName(''); } }}
                                placeholder="Playlist name..." className="w-full text-[12px] px-2 py-1 rounded border border-gray-300 outline-none focus:border-red-500" autoFocus/>
                        </div>
                    )}
                    {playlists.map(pl => (
                        <div key={pl.id} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-pointer text-[13px] ${viewingPlaylist && viewingPlaylist.id === pl.id ? 'bg-red-500 text-white' : 'hover:bg-black/[0.03]'}`}
                            onClick={() => { setViewingPlaylist(pl); setActiveNav('__playlist'); }}>
                            <div className="w-5 h-5 rounded" style={{ background: `linear-gradient(135deg, ${pl.colors[0]}, ${pl.colors[1]})` }}/>
                            <span className="truncate">{pl.name}</span>
                            <span className="text-[10px] opacity-60 ml-auto">{pl.songs.length}</span>
                        </div>
                    ))}
                </div>
                <div className="flex-1 overflow-y-auto p-6">
                    <h2 className="text-[26px] font-bold mb-6">{displayNav}</h2>
                    {viewingPlaylist ? renderUserPlaylist(viewingPlaylist) : activeBuiltinPlaylist ? renderPlaylistContent(activeBuiltinPlaylist) : renderContent()}
                </div>
            </div>
            {/* Now Playing bar */}
            <div className="h-[64px] border-t border-black/5 bg-gray-50/95 flex items-center px-4 gap-4">
                <div className="flex items-center gap-3 w-[220px]">
                    <CoverArt src={npSong.cover} color={npSong.color} size={40}/>
                    <div className="min-w-0"><div className="text-[13px] font-medium truncate">{npSong.title}</div><div className="text-[11px] text-gray-400 truncate">{npSong.artist}</div></div>
                </div>
                <div className="flex-1 flex flex-col items-center gap-1">
                    <div className="flex items-center gap-4">
                        <button onClick={() => setShuffle(!shuffle)} className={`p-1 rounded ${shuffle ? 'text-red-500' : 'text-gray-400 hover:text-gray-600'}`}>
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                        </button>
                        <button onClick={prevSong} className="text-gray-500 hover:text-gray-700"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                        <button onClick={togglePlay} className="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center hover:bg-gray-700">
                            {loadingAudio ? (<svg className="animate-spin" viewBox="0 0 24 24" width="16" height="16" fill="none"><circle cx="12" cy="12" r="10" stroke="white" strokeWidth="3" opacity="0.3"/><path d="M12 2a10 10 0 019.95 9" stroke="white" strokeWidth="3" strokeLinecap="round"/></svg>
                            ) : isPlaying ? (<svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            ) : (<svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M8 5v14l11-7z"/></svg>)}
                        </button>
                        <button onClick={nextSong} className="text-gray-500 hover:text-gray-700"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                        <button onClick={() => setRepeat(!repeat)} className={`p-1 rounded ${repeat ? 'text-red-500' : 'text-gray-400 hover:text-gray-600'}`}>
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                        </button>
                    </div>
                    <div className="flex items-center gap-2 w-full max-w-[400px]">
                        <span className="text-[10px] text-gray-400 w-8 text-right">{formatTime(currentTime)}</span>
                        <MacSlider min={0} max={100} value={progress} onChange={v => seekTo(v)} className="flex-1" accentColor="#ef4444"/>
                        <span className="text-[10px] text-gray-400 w-8">{formatTime(audioDuration)}</span>
                    </div>
                </div>
                <div className="flex items-center gap-2 w-[140px]">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#999"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
                    <MacSlider min={0} max={100} value={volume} onChange={v => setVolume(v)} className="flex-1" accentColor="#6b7280"/>
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#999"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                </div>
            </div>
        </div>
    );
};


window.MusicApp = MusicApp;
</script>

<script type="text/babel">
// Snake Game - fully playable classic snake
const SnakeGameApp = () => {
    const canvasRef = React.useRef(null);
    const gameRef = React.useRef({ snake: [{x:10,y:10}], dir: {x:1,y:0}, nextDir: {x:1,y:0}, food: {x:15,y:10}, score: 0, running: false, speed: 100, gameOver: false, interval: null });
    const [score, setScore] = React.useState(0);
    const [highScore, setHighScore] = React.useState(() => { try { return parseInt(localStorage.getItem('macos_snake_high') || '0'); } catch(e) { return 0; } });
    const [gameOver, setGameOver] = React.useState(false);
    const [started, setStarted] = React.useState(false);

    const COLS = 30, ROWS = 25, CELL = 16;

    const spawnFood = (snake) => {
        let f;
        do { f = { x: Math.floor(Math.random() * COLS), y: Math.floor(Math.random() * ROWS) }; }
        while (snake.some(s => s.x === f.x && s.y === f.y));
        return f;
    };

    const startGame = () => {
        const g = gameRef.current;
        g.snake = [{x:10,y:10}];
        g.dir = {x:1,y:0};
        g.nextDir = {x:1,y:0};
        g.food = spawnFood(g.snake);
        g.score = 0;
        g.gameOver = false;
        g.running = true;
        g.speed = 100;
        setScore(0);
        setGameOver(false);
        setStarted(true);
        if (g.interval) clearInterval(g.interval);
        g.interval = setInterval(tick, g.speed);
    };

    const tick = () => {
        const g = gameRef.current;
        if (!g.running) return;

        g.dir = g.nextDir;
        const head = { x: g.snake[0].x + g.dir.x, y: g.snake[0].y + g.dir.y };

        // Wall collision
        if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS) {
            g.running = false;
            g.gameOver = true;
            clearInterval(g.interval);
            setGameOver(true);
            if (g.score > parseInt(localStorage.getItem('macos_snake_high') || '0')) {
                localStorage.setItem('macos_snake_high', g.score.toString());
                setHighScore(g.score);
            }
            return;
        }

        // Self collision
        if (g.snake.some(s => s.x === head.x && s.y === head.y)) {
            g.running = false;
            g.gameOver = true;
            clearInterval(g.interval);
            setGameOver(true);
            if (g.score > parseInt(localStorage.getItem('macos_snake_high') || '0')) {
                localStorage.setItem('macos_snake_high', g.score.toString());
                setHighScore(g.score);
            }
            return;
        }

        g.snake.unshift(head);

        if (head.x === g.food.x && head.y === g.food.y) {
            g.score++;
            setScore(g.score);
            g.food = spawnFood(g.snake);
            // Speed up every 5 points
            if (g.score % 5 === 0 && g.speed > 50) {
                g.speed -= 5;
                clearInterval(g.interval);
                g.interval = setInterval(tick, g.speed);
            }
        } else {
            g.snake.pop();
        }

        draw();
    };

    const draw = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const g = gameRef.current;

        // Background
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, COLS * CELL, ROWS * CELL);

        // Grid lines
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        ctx.lineWidth = 0.5;
        for (let x = 0; x <= COLS; x++) { ctx.beginPath(); ctx.moveTo(x * CELL, 0); ctx.lineTo(x * CELL, ROWS * CELL); ctx.stroke(); }
        for (let y = 0; y <= ROWS; y++) { ctx.beginPath(); ctx.moveTo(0, y * CELL); ctx.lineTo(COLS * CELL, y * CELL); ctx.stroke(); }

        // Food
        ctx.fillStyle = '#FF3B30';
        ctx.shadowColor = '#FF3B30';
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(g.food.x * CELL + CELL/2, g.food.y * CELL + CELL/2, CELL/2 - 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Snake
        g.snake.forEach((s, i) => {
            const isHead = i === 0;
            ctx.fillStyle = isHead ? '#34C759' : `rgba(52, 199, 89, ${1 - i * 0.02})`;
            if (isHead) { ctx.shadowColor = '#34C759'; ctx.shadowBlur = 6; }
            ctx.beginPath();
            ctx.roundRect(s.x * CELL + 1, s.y * CELL + 1, CELL - 2, CELL - 2, 3);
            ctx.fill();
            ctx.shadowBlur = 0;
        });
    };

    React.useEffect(() => {
        const handleKey = (e) => {
            const g = gameRef.current;
            if (!g.running) return;
            const { dir } = g;
            if ((e.key === 'ArrowUp' || e.key === 'w') && dir.y !== 1) g.nextDir = {x:0,y:-1};
            if ((e.key === 'ArrowDown' || e.key === 's') && dir.y !== -1) g.nextDir = {x:0,y:1};
            if ((e.key === 'ArrowLeft' || e.key === 'a') && dir.x !== 1) g.nextDir = {x:-1,y:0};
            if ((e.key === 'ArrowRight' || e.key === 'd') && dir.x !== -1) g.nextDir = {x:1,y:0};
            e.preventDefault();
        };
        window.addEventListener('keydown', handleKey);
        return () => { window.removeEventListener('keydown', handleKey); if (gameRef.current.interval) clearInterval(gameRef.current.interval); };
    }, []);

    React.useEffect(() => { draw(); }, []);

    return (
        <div className="flex flex-col h-full bg-[#0f0f23]">
            <div className="flex items-center justify-between px-4 py-2 bg-[#16162e] border-b border-white/5">
                <div className="flex items-center gap-4">
                    <span className="text-white text-[14px] font-bold">Snake</span>
                    <span className="text-green-400 text-[13px]">Score: {score}</span>
                    <span className="text-yellow-400 text-[13px]">Best: {highScore}</span>
                </div>
                <button onClick={startGame} className="px-3 py-1 rounded-lg bg-green-500 text-white text-[12px] font-medium hover:bg-green-600">
                    {gameOver ? 'Play Again' : started ? 'Restart' : 'Start Game'}
                </button>
            </div>
            <div className="flex-1 flex items-center justify-center relative">
                <canvas ref={canvasRef} width={COLS * CELL} height={ROWS * CELL} className="rounded-lg" style={{ imageRendering: 'pixelated' }}/>
                {!started && (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60 rounded-lg">
                        <div className="text-[32px] mb-2">ðŸ</div>
                        <div className="text-white text-[18px] font-bold mb-2">Snake</div>
                        <div className="text-gray-400 text-[12px] mb-4">Use arrow keys or WASD to move</div>
                        <button onClick={startGame} className="px-6 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600">Play</button>
                    </div>
                )}
                {gameOver && (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60 rounded-lg">
                        <div className="text-white text-[22px] font-bold mb-1">Game Over!</div>
                        <div className="text-green-400 text-[16px] mb-1">Score: {score}</div>
                        {score >= highScore && score > 0 && <div className="text-yellow-400 text-[13px] mb-3">New High Score!</div>}
                        <button onClick={startGame} className="px-6 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600">Play Again</button>
                    </div>
                )}
            </div>
        </div>
    );
};


window.SnakeGameApp = SnakeGameApp;
</script>

<script type="text/babel">
// Tetris Game - fully playable classic Tetris
const TetrisGameApp = () => {
    const COLS = 10, ROWS = 20, CELL = 24;
    const canvasRef = React.useRef(null);
    const nextRef = React.useRef(null);
    const gameRef = React.useRef(null);
    const [score, setScore] = React.useState(0);
    const [level, setLevel] = React.useState(1);
    const [lines, setLines] = React.useState(0);
    const [gameOver, setGameOver] = React.useState(false);
    const [started, setStarted] = React.useState(false);
    const [highScore, setHighScore] = React.useState(() => { try { return parseInt(localStorage.getItem('macos_tetris_high') || '0'); } catch(e) { return 0; } });

    const PIECES = [
        { shape: [[1,1,1,1]], color: '#00BCD4' },           // I
        { shape: [[1,1],[1,1]], color: '#FFD60A' },          // O
        { shape: [[0,1,0],[1,1,1]], color: '#AF52DE' },      // T
        { shape: [[1,0],[1,0],[1,1]], color: '#FF9500' },     // L
        { shape: [[0,1],[0,1],[1,1]], color: '#007AFF' },     // J
        { shape: [[0,1,1],[1,1,0]], color: '#34C759' },       // S
        { shape: [[1,1,0],[0,1,1]], color: '#FF3B30' },       // Z
    ];

    const rotate = (matrix) => matrix[0].map((_, i) => matrix.map(r => r[i]).reverse());

    const initGame = () => {
        const board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
        const piece = PIECES[Math.floor(Math.random() * PIECES.length)];
        const next = PIECES[Math.floor(Math.random() * PIECES.length)];
        gameRef.current = {
            board, piece: piece.shape, color: piece.color,
            nextPiece: next, px: Math.floor(COLS / 2) - 1, py: 0,
            score: 0, level: 1, lines: 0, running: true, interval: null,
        };
        setScore(0); setLevel(1); setLines(0); setGameOver(false); setStarted(true);
        const g = gameRef.current;
        if (g.interval) clearInterval(g.interval);
        g.interval = setInterval(() => drop(), getSpeed(1));
    };

    const getSpeed = (lvl) => Math.max(100, 800 - (lvl - 1) * 70);

    const collides = (board, shape, px, py) => {
        for (let r = 0; r < shape.length; r++)
            for (let c = 0; c < shape[r].length; c++)
                if (shape[r][c]) {
                    const nx = px + c, ny = py + r;
                    if (nx < 0 || nx >= COLS || ny >= ROWS) return true;
                    if (ny >= 0 && board[ny][nx]) return true;
                }
        return false;
    };

    const merge = (board, shape, color, px, py) => {
        const b = board.map(r => [...r]);
        for (let r = 0; r < shape.length; r++)
            for (let c = 0; c < shape[r].length; c++)
                if (shape[r][c] && py + r >= 0) b[py + r][px + c] = color;
        return b;
    };

    const clearLines = (board) => {
        let cleared = 0;
        const b = board.filter(row => { if (row.every(c => c)) { cleared++; return false; } return true; });
        while (b.length < ROWS) b.unshift(Array(COLS).fill(0));
        return { board: b, cleared };
    };

    const drop = () => {
        const g = gameRef.current;
        if (!g || !g.running) return;
        if (!collides(g.board, g.piece, g.px, g.py + 1)) {
            g.py++;
        } else {
            // Lock piece
            g.board = merge(g.board, g.piece, g.color, g.px, g.py);
            const { board: nb, cleared } = clearLines(g.board);
            g.board = nb;
            g.lines += cleared;
            const pts = [0, 100, 300, 500, 800];
            g.score += (pts[cleared] || 0) * g.level;
            g.level = Math.floor(g.lines / 10) + 1;
            setScore(g.score); setLines(g.lines); setLevel(g.level);

            // Speed up
            clearInterval(g.interval);
            g.interval = setInterval(() => drop(), getSpeed(g.level));

            // Next piece
            const np = g.nextPiece;
            g.piece = np.shape;
            g.color = np.color;
            g.px = Math.floor(COLS / 2) - 1;
            g.py = 0;
            g.nextPiece = PIECES[Math.floor(Math.random() * PIECES.length)];

            if (collides(g.board, g.piece, g.px, g.py)) {
                g.running = false;
                clearInterval(g.interval);
                setGameOver(true);
                if (g.score > parseInt(localStorage.getItem('macos_tetris_high') || '0')) {
                    localStorage.setItem('macos_tetris_high', g.score.toString());
                    setHighScore(g.score);
                }
            }
        }
        draw();
    };

    const draw = () => {
        const canvas = canvasRef.current;
        const g = gameRef.current;
        if (!canvas || !g) return;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, COLS * CELL, ROWS * CELL);

        // Grid
        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
        for (let x = 0; x <= COLS; x++) { ctx.beginPath(); ctx.moveTo(x*CELL,0); ctx.lineTo(x*CELL,ROWS*CELL); ctx.stroke(); }
        for (let y = 0; y <= ROWS; y++) { ctx.beginPath(); ctx.moveTo(0,y*CELL); ctx.lineTo(COLS*CELL,y*CELL); ctx.stroke(); }

        // Board
        for (let r = 0; r < ROWS; r++)
            for (let c = 0; c < COLS; c++)
                if (g.board[r][c]) {
                    ctx.fillStyle = g.board[r][c];
                    ctx.beginPath(); ctx.roundRect(c*CELL+1, r*CELL+1, CELL-2, CELL-2, 3); ctx.fill();
                    ctx.fillStyle = 'rgba(255,255,255,0.15)';
                    ctx.fillRect(c*CELL+2, r*CELL+2, CELL-4, 3);
                }

        // Ghost piece
        let gy = g.py;
        while (!collides(g.board, g.piece, g.px, gy + 1)) gy++;
        if (gy !== g.py) {
            ctx.globalAlpha = 0.2;
            for (let r = 0; r < g.piece.length; r++)
                for (let c = 0; c < g.piece[r].length; c++)
                    if (g.piece[r][c]) {
                        ctx.fillStyle = g.color;
                        ctx.fillRect((g.px+c)*CELL+1, (gy+r)*CELL+1, CELL-2, CELL-2);
                    }
            ctx.globalAlpha = 1;
        }

        // Current piece
        for (let r = 0; r < g.piece.length; r++)
            for (let c = 0; c < g.piece[r].length; c++)
                if (g.piece[r][c] && g.py + r >= 0) {
                    ctx.fillStyle = g.color;
                    ctx.beginPath(); ctx.roundRect((g.px+c)*CELL+1, (g.py+r)*CELL+1, CELL-2, CELL-2, 3); ctx.fill();
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect((g.px+c)*CELL+2, (g.py+r)*CELL+2, CELL-4, 3);
                }

        // Next piece preview
        const nctx = nextRef.current?.getContext('2d');
        if (nctx && g.nextPiece) {
            nctx.fillStyle = '#1a1a2e';
            nctx.fillRect(0, 0, 100, 80);
            const np = g.nextPiece;
            const ox = (100 - np.shape[0].length * 18) / 2;
            const oy = (80 - np.shape.length * 18) / 2;
            for (let r = 0; r < np.shape.length; r++)
                for (let c = 0; c < np.shape[r].length; c++)
                    if (np.shape[r][c]) {
                        nctx.fillStyle = np.color;
                        nctx.beginPath(); nctx.roundRect(ox + c*18+1, oy + r*18+1, 16, 16, 2); nctx.fill();
                    }
        }
    };

    React.useEffect(() => {
        const handleKey = (e) => {
            const g = gameRef.current;
            if (!g || !g.running) return;
            if (e.key === 'ArrowLeft' || e.key === 'a') {
                if (!collides(g.board, g.piece, g.px - 1, g.py)) { g.px--; draw(); }
            } else if (e.key === 'ArrowRight' || e.key === 'd') {
                if (!collides(g.board, g.piece, g.px + 1, g.py)) { g.px++; draw(); }
            } else if (e.key === 'ArrowDown' || e.key === 's') {
                drop();
            } else if (e.key === 'ArrowUp' || e.key === 'w') {
                const rotated = rotate(g.piece);
                if (!collides(g.board, rotated, g.px, g.py)) { g.piece = rotated; draw(); }
                else if (!collides(g.board, rotated, g.px - 1, g.py)) { g.piece = rotated; g.px--; draw(); }
                else if (!collides(g.board, rotated, g.px + 1, g.py)) { g.piece = rotated; g.px++; draw(); }
            } else if (e.key === ' ') {
                while (!collides(g.board, g.piece, g.px, g.py + 1)) g.py++;
                drop();
            }
            e.preventDefault();
        };
        window.addEventListener('keydown', handleKey);
        return () => { window.removeEventListener('keydown', handleKey); if (gameRef.current?.interval) clearInterval(gameRef.current.interval); };
    }, []);

    React.useEffect(() => { draw(); }, []);

    return (
        <div className="flex flex-col h-full bg-[#0f0f23]">
            <div className="flex-1 flex items-center justify-center gap-6 p-4 relative">
                <canvas ref={canvasRef} width={COLS * CELL} height={ROWS * CELL} className="rounded-lg border border-white/10"/>
                <div className="flex flex-col gap-4 w-[120px]">
                    <div className="bg-[#16162e] rounded-xl p-3 border border-white/5">
                        <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Score</div>
                        <div className="text-white text-[18px] font-bold">{score}</div>
                    </div>
                    <div className="bg-[#16162e] rounded-xl p-3 border border-white/5">
                        <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Level</div>
                        <div className="text-cyan-400 text-[18px] font-bold">{level}</div>
                    </div>
                    <div className="bg-[#16162e] rounded-xl p-3 border border-white/5">
                        <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Lines</div>
                        <div className="text-purple-400 text-[18px] font-bold">{lines}</div>
                    </div>
                    <div className="bg-[#16162e] rounded-xl p-3 border border-white/5">
                        <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Best</div>
                        <div className="text-yellow-400 text-[18px] font-bold">{highScore}</div>
                    </div>
                    <div className="bg-[#16162e] rounded-xl p-3 border border-white/5">
                        <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-2">Next</div>
                        <canvas ref={nextRef} width={100} height={80} className="rounded"/>
                    </div>
                    <button onClick={initGame} className="px-3 py-2 rounded-xl bg-cyan-500 text-white text-[12px] font-semibold hover:bg-cyan-600">
                        {gameOver ? 'Play Again' : started ? 'Restart' : 'Start'}
                    </button>
                </div>
                {!started && (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60">
                        <div className="text-[32px] mb-2">ðŸ§±</div>
                        <div className="text-white text-[22px] font-bold mb-2">Tetris</div>
                        <div className="text-gray-400 text-[12px] mb-1">Arrow keys / WASD to move & rotate</div>
                        <div className="text-gray-400 text-[12px] mb-4">Space to hard drop</div>
                        <button onClick={initGame} className="px-6 py-2 rounded-xl bg-cyan-500 text-white font-semibold hover:bg-cyan-600">Play</button>
                    </div>
                )}
                {gameOver && (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60">
                        <div className="text-white text-[22px] font-bold mb-1">Game Over!</div>
                        <div className="text-cyan-400 text-[16px] mb-1">Score: {score}</div>
                        <div className="text-purple-400 text-[13px] mb-1">Level {level} Â· {lines} lines</div>
                        {score >= highScore && score > 0 && <div className="text-yellow-400 text-[13px] mb-3">New High Score!</div>}
                        <button onClick={initGame} className="px-6 py-2 rounded-xl bg-cyan-500 text-white font-semibold hover:bg-cyan-600">Play Again</button>
                    </div>
                )}
            </div>
        </div>
    );
};


window.TetrisGameApp = TetrisGameApp;
</script>

<script type="text/babel">
// 2048 Game - fully playable
const Game2048App = () => {
    const SIZE = 4;
    const [board, setBoard] = React.useState(() => initBoard());
    const [score, setScore] = React.useState(0);
    const [bestScore, setBestScore] = React.useState(() => { try { return parseInt(localStorage.getItem('macos_2048_high') || '0'); } catch(e) { return 0; } });
    const [gameOver, setGameOver] = React.useState(false);
    const [won, setWon] = React.useState(false);

    function initBoard() {
        const b = Array.from({ length: SIZE }, () => Array(SIZE).fill(0));
        addRandom(b); addRandom(b);
        return b;
    }

    function addRandom(b) {
        const empty = [];
        for (let r = 0; r < SIZE; r++) for (let c = 0; c < SIZE; c++) if (!b[r][c]) empty.push([r, c]);
        if (empty.length === 0) return;
        const [r, c] = empty[Math.floor(Math.random() * empty.length)];
        b[r][c] = Math.random() < 0.9 ? 2 : 4;
    }

    function slideRow(row) {
        let arr = row.filter(v => v);
        let sc = 0;
        for (let i = 0; i < arr.length - 1; i++) {
            if (arr[i] === arr[i+1]) {
                arr[i] *= 2; sc += arr[i]; arr[i+1] = 0;
            }
        }
        arr = arr.filter(v => v);
        while (arr.length < SIZE) arr.push(0);
        return { row: arr, score: sc };
    }

    function move(board, dir) {
        let b = board.map(r => [...r]);
        let totalScore = 0;
        let moved = false;

        if (dir === 'left') {
            for (let r = 0; r < SIZE; r++) {
                const { row, score: s } = slideRow(b[r]);
                if (row.some((v, i) => v !== b[r][i])) moved = true;
                b[r] = row; totalScore += s;
            }
        } else if (dir === 'right') {
            for (let r = 0; r < SIZE; r++) {
                const { row, score: s } = slideRow([...b[r]].reverse());
                row.reverse();
                if (row.some((v, i) => v !== b[r][i])) moved = true;
                b[r] = row; totalScore += s;
            }
        } else if (dir === 'up') {
            for (let c = 0; c < SIZE; c++) {
                const col = b.map(r => r[c]);
                const { row, score: s } = slideRow(col);
                if (row.some((v, i) => v !== b[i][c])) moved = true;
                for (let r = 0; r < SIZE; r++) b[r][c] = row[r];
                totalScore += s;
            }
        } else if (dir === 'down') {
            for (let c = 0; c < SIZE; c++) {
                const col = b.map(r => r[c]).reverse();
                const { row, score: s } = slideRow(col);
                row.reverse();
                if (row.some((v, i) => v !== b[i][c])) moved = true;
                for (let r = 0; r < SIZE; r++) b[r][c] = row[r];
                totalScore += s;
            }
        }
        return { board: b, score: totalScore, moved };
    }

    function canMove(b) {
        for (let r = 0; r < SIZE; r++)
            for (let c = 0; c < SIZE; c++) {
                if (!b[r][c]) return true;
                if (c < SIZE-1 && b[r][c] === b[r][c+1]) return true;
                if (r < SIZE-1 && b[r][c] === b[r+1][c]) return true;
            }
        return false;
    }

    const doMove = (dir) => {
        if (gameOver) return;
        const { board: nb, score: gained, moved } = move(board, dir);
        if (!moved) return;
        addRandom(nb);
        const newScore = score + gained;
        setBoard(nb);
        setScore(newScore);
        if (newScore > bestScore) {
            setBestScore(newScore);
            localStorage.setItem('macos_2048_high', newScore.toString());
        }
        if (nb.some(r => r.some(v => v === 2048)) && !won) setWon(true);
        if (!canMove(nb)) setGameOver(true);
    };

    const restart = () => {
        const b = initBoard();
        setBoard(b); setScore(0); setGameOver(false); setWon(false);
    };

    React.useEffect(() => {
        const handleKey = (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') { doMove('left'); e.preventDefault(); }
            if (e.key === 'ArrowRight' || e.key === 'd') { doMove('right'); e.preventDefault(); }
            if (e.key === 'ArrowUp' || e.key === 'w') { doMove('up'); e.preventDefault(); }
            if (e.key === 'ArrowDown' || e.key === 's') { doMove('down'); e.preventDefault(); }
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
    });

    const tileColors = {
        0: '#cdc1b4', 2: '#eee4da', 4: '#ede0c8', 8: '#f2b179', 16: '#f59563',
        32: '#f67c5f', 64: '#f65e3b', 128: '#edcf72', 256: '#edcc61',
        512: '#edc850', 1024: '#edc53f', 2048: '#edc22e',
    };
    const textColors = { 0: 'transparent', 2: '#776e65', 4: '#776e65' };
    const fontSize = (v) => v >= 1024 ? '22px' : v >= 128 ? '26px' : '32px';

    return (
        <div className="flex flex-col h-full items-center justify-center" style={{ background: '#faf8ef' }}>
            <div className="w-[380px]">
                <div className="flex items-center justify-between mb-4">
                    <div className="text-[36px] font-extrabold" style={{ color: '#776e65' }}>2048</div>
                    <div className="flex gap-2">
                        <div className="bg-[#bbada0] rounded-lg px-4 py-1 text-center">
                            <div className="text-[10px] text-[#eee4da] uppercase font-bold">Score</div>
                            <div className="text-white text-[18px] font-bold">{score}</div>
                        </div>
                        <div className="bg-[#bbada0] rounded-lg px-4 py-1 text-center">
                            <div className="text-[10px] text-[#eee4da] uppercase font-bold">Best</div>
                            <div className="text-white text-[18px] font-bold">{bestScore}</div>
                        </div>
                    </div>
                </div>
                <div className="flex items-center justify-between mb-4">
                    <div className="text-[13px]" style={{ color: '#776e65' }}>Use arrow keys to play</div>
                    <button onClick={restart} className="px-4 py-1.5 rounded-lg text-white text-[13px] font-bold" style={{ background: '#8f7a66' }}>New Game</button>
                </div>
                <div className="rounded-xl p-3 relative" style={{ background: '#bbada0' }}>
                    <div className="grid gap-3" style={{ gridTemplateColumns: `repeat(${SIZE}, 1fr)` }}>
                        {board.map((row, r) => row.map((val, c) => (
                            <div key={r + '-' + c} className="aspect-square rounded-lg flex items-center justify-center font-extrabold select-none"
                                style={{
                                    background: tileColors[val] || '#3c3a32',
                                    color: textColors[val] || '#f9f6f2',
                                    fontSize: fontSize(val),
                                    transition: 'all 0.1s',
                                    boxShadow: val >= 128 ? '0 0 15px rgba(243,215,116,0.3)' : 'none',
                                }}>
                                {val || ''}
                            </div>
                        )))}
                    </div>
                    {gameOver && (
                        <div className="absolute inset-0 bg-white/70 rounded-xl flex flex-col items-center justify-center">
                            <div className="text-[28px] font-extrabold mb-2" style={{ color: '#776e65' }}>Game Over!</div>
                            <div className="text-[16px] mb-3" style={{ color: '#776e65' }}>Score: {score}</div>
                            <button onClick={restart} className="px-6 py-2 rounded-xl text-white font-bold" style={{ background: '#8f7a66' }}>Try Again</button>
                        </div>
                    )}
                    {won && !gameOver && (
                        <div className="absolute inset-0 bg-yellow-400/50 rounded-xl flex flex-col items-center justify-center">
                            <div className="text-[28px] font-extrabold text-white mb-2">You Win!</div>
                            <button onClick={() => setWon(false)} className="px-6 py-2 rounded-xl bg-white/80 text-[#776e65] font-bold">Continue</button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};


window.Game2048App = Game2048App;
</script>

<script type="text/babel">
// VS Code - Code editor with Python syntax highlighting, execution, and macOS VFS integration
const VSCodeApp = () => {
    const [files, setFiles] = React.useState(() => {
        try {
            const saved = localStorage.getItem('macos_vscode_files');
            if (saved) return JSON.parse(saved);
        } catch(e) {}
        return [
            { name: 'main.py', content: '# Welcome to VS Code\n# Write Python code here and click Run!\n\ndef greet(name):\n    return f"Hello, {name}!"\n\nprint(greet("World"))\nprint("2 + 2 =", 2 + 2)\n\n# Try some Python:\nfor i in range(5):\n    print(f"Count: {i}")\n' },
            { name: 'utils.py', content: '# Utility functions\n\ndef factorial(n):\n    if n <= 1:\n        return 1\n    return n * factorial(n - 1)\n\ndef fibonacci(n):\n    a, b = 0, 1\n    result = []\n    for _ in range(n):\n        result.append(a)\n        a, b = b, a + b\n    return result\n\nprint("5! =", factorial(5))\nprint("Fibonacci:", fibonacci(10))\n' },
            { name: 'game.py', content: '# Simple text game\nimport random\n\ndef guess_game():\n    number = random.randint(1, 100)\n    print("Guess a number between 1 and 100!")\n    for attempt in range(7):\n        guess = int(input(f"Attempt {attempt+1}: "))\n        if guess == number:\n            print(f"You got it in {attempt+1} tries!")\n            return\n        print("Too high!" if guess > number else "Too low!")\n    print(f"Game over! It was {number}")\n\nguess_game()\n' },
        ];
    });
    const [activeFile, setActiveFile] = React.useState(0);
    const [output, setOutput] = React.useState('');
    const [showOutput, setShowOutput] = React.useState(false);
    const [running, setRunning] = React.useState(false);
    const [showNewFile, setShowNewFile] = React.useState(false);
    const [newFileName, setNewFileName] = React.useState('');
    const [showSaveDialog, setShowSaveDialog] = React.useState(false);
    const [savePath, setSavePath] = React.useState('/Users/user/Desktop');
    const [saveFileName, setSaveFileName] = React.useState('');
    const [showOpenDialog, setShowOpenDialog] = React.useState(false);
    const [openPath, setOpenPath] = React.useState('/Users/user/Desktop');
    const textareaRef = React.useRef(null);
    const loadedPending = React.useRef(false);
    const vfsVersion = useStore(s => s.vfsVersion);

    // Load pending file from Desktop/Finder double-click
    React.useEffect(() => {
        if (loadedPending.current) return;
        loadedPending.current = true;
        const state = MacStore.getState();
        if (state.pendingOpenFile) {
            const { path, name } = state.pendingOpenFile;
            MacStore.setState({ pendingOpenFile: null });
            const fullPath = path + '/' + name;
            const content = VFS.readFile(fullPath);
            if (content !== null) {
                const existing = files.findIndex(f => f.name === name);
                if (existing >= 0) {
                    const updated = [...files];
                    updated[existing] = { ...updated[existing], content, vfsPath: path };
                    saveFiles(updated);
                    setActiveFile(existing);
                } else {
                    const updated = [...files, { name, content, vfsPath: path }];
                    saveFiles(updated);
                    setActiveFile(updated.length - 1);
                }
            }
        }
    }, []);

    const saveFiles = (f) => {
        setFiles(f);
        localStorage.setItem('macos_vscode_files', JSON.stringify(f));
    };

    const updateContent = (content) => {
        const updated = [...files];
        updated[activeFile] = { ...updated[activeFile], content };
        saveFiles(updated);
    };

    const createFile = () => {
        let name = newFileName.trim();
        if (!name) return;
        if (!name.endsWith('.py')) name += '.py';
        if (files.some(f => f.name === name)) return;
        const updated = [...files, { name, content: '# ' + name + '\n\n' }];
        saveFiles(updated);
        setActiveFile(updated.length - 1);
        setShowNewFile(false);
        setNewFileName('');
    };

    const deleteFile = (idx) => {
        if (files.length <= 1) return;
        const updated = files.filter((_, i) => i !== idx);
        saveFiles(updated);
        if (activeFile >= updated.length) setActiveFile(updated.length - 1);
        else if (activeFile === idx) setActiveFile(0);
    };

    // Save To Mac dialog
    const openSaveDialog = () => {
        const f = files[activeFile];
        setSaveFileName(f.name);
        setSavePath(f.vfsPath || '/Users/user/Desktop');
        setShowSaveDialog(true);
    };

    const saveToMac = () => {
        const content = files[activeFile].content;
        const fn = saveFileName.trim() || 'untitled.py';
        VFS.touch(savePath, fn, content, 'ðŸ“');
        // Update file's vfsPath for future saves
        const updated = [...files];
        updated[activeFile] = { ...updated[activeFile], name: fn, vfsPath: savePath };
        saveFiles(updated);
        MacStore.addNotification('VS Code', 'File Saved', fn + ' saved to ' + savePath.replace('/Users/user', '~'));
        setShowSaveDialog(false);
    };

    // Open From Mac dialog
    const openFromMac = () => {
        setOpenPath('/Users/user/Desktop');
        setShowOpenDialog(true);
    };

    const loadFileFromVFS = (path, name) => {
        const fullPath = path + '/' + name;
        const content = VFS.readFile(fullPath);
        if (content === null) return;
        const existing = files.findIndex(f => f.name === name);
        if (existing >= 0) {
            const updated = [...files];
            updated[existing] = { ...updated[existing], content, vfsPath: path };
            saveFiles(updated);
            setActiveFile(existing);
        } else {
            const updated = [...files, { name, content, vfsPath: path }];
            saveFiles(updated);
            setActiveFile(updated.length - 1);
        }
        setShowOpenDialog(false);
    };

    // Quick save â€” if file has a vfsPath, save directly
    const quickSave = () => {
        const f = files[activeFile];
        if (f.vfsPath) {
            VFS.touch(f.vfsPath, f.name, f.content, 'ðŸ“');
            MacStore.addNotification('VS Code', 'Saved', f.name + ' saved.');
        } else {
            openSaveDialog();
        }
    };

    // Simple Python interpreter (subset)
    const runPython = (code) => {
        setRunning(true);
        setShowOutput(true);
        let out = [];
        try {
            const env = {};
            const lines = code.split('\n');

            const evalExpr = (expr) => {
                expr = expr.trim();
                if (expr.startsWith('f"') || expr.startsWith("f'")) {
                    const q = expr[1];
                    const inner = expr.slice(2, expr.lastIndexOf(q));
                    return inner.replace(/\{([^}]+)\}/g, (_, e) => {
                        try { return evalExpr(e); } catch(e2) { return ''; }
                    });
                }
                if ((expr.startsWith('"') && expr.endsWith('"')) || (expr.startsWith("'") && expr.endsWith("'")))
                    return expr.slice(1, -1);
                if (expr.startsWith('[') && expr.endsWith(']')) {
                    const inner = expr.slice(1, -1).trim();
                    if (!inner) return [];
                    return inner.split(',').map(e => evalExpr(e.trim()));
                }
                if (expr === 'True') return true;
                if (expr === 'False') return false;
                if (expr === 'None') return null;
                if (!isNaN(expr) && expr !== '') return Number(expr);
                if (env[expr] !== undefined) return env[expr];
                const rangeMatch = expr.match(/^range\((.+)\)$/);
                if (rangeMatch) {
                    const args = rangeMatch[1].split(',').map(a => evalExpr(a.trim()));
                    const arr = [];
                    const start = args.length > 1 ? args[0] : 0;
                    const end = args.length > 1 ? args[1] : args[0];
                    const step = args[2] || 1;
                    for (let j = start; j < end; j += step) arr.push(j);
                    return arr;
                }
                const lenMatch = expr.match(/^len\((.+)\)$/);
                if (lenMatch) { const v = evalExpr(lenMatch[1]); return Array.isArray(v) ? v.length : String(v).length; }
                const intMatch = expr.match(/^int\((.+)\)$/);
                if (intMatch) return parseInt(evalExpr(intMatch[1]));
                const strMatch = expr.match(/^str\((.+)\)$/);
                if (strMatch) return String(evalExpr(strMatch[1]));
                const absMatch = expr.match(/^abs\((.+)\)$/);
                if (absMatch) return Math.abs(evalExpr(absMatch[1]));
                const maxMatch = expr.match(/^max\((.+)\)$/);
                if (maxMatch) { const args = maxMatch[1].split(',').map(a => evalExpr(a.trim())); return Math.max(...args); }
                const minMatch = expr.match(/^min\((.+)\)$/);
                if (minMatch) { const args = minMatch[1].split(',').map(a => evalExpr(a.trim())); return Math.min(...args); }
                const sumMatch = expr.match(/^sum\((.+)\)$/);
                if (sumMatch) { const v = evalExpr(sumMatch[1]); return Array.isArray(v) ? v.reduce((a,b)=>a+b,0) : 0; }
                const typeMatch = expr.match(/^type\((.+)\)$/);
                if (typeMatch) { const v = evalExpr(typeMatch[1]); return `<class '${typeof v === 'number' ? (Number.isInteger(v) ? 'int' : 'float') : typeof v === 'string' ? 'str' : Array.isArray(v) ? 'list' : typeof v === 'boolean' ? 'bool' : 'NoneType'}'>`; }
                const fnCallMatch = expr.match(/^(\w+)\((.*)?\)$/);
                if (fnCallMatch && env['__fn_' + fnCallMatch[1]]) {
                    const fn = env['__fn_' + fnCallMatch[1]];
                    const args = fnCallMatch[2] ? fnCallMatch[2].split(',').map(a => evalExpr(a.trim())) : [];
                    return fn(args);
                }
                const appendMatch = expr.match(/^(\w+)\.append\((.+)\)$/);
                if (appendMatch && Array.isArray(env[appendMatch[1]])) {
                    env[appendMatch[1]].push(evalExpr(appendMatch[2]));
                    return undefined;
                }
                if (expr.includes('+') || expr.includes('-') || expr.includes('*') || expr.includes('/') || expr.includes('%') || expr.includes('**')) {
                    try {
                        const jsExpr = expr.replace(/\b([a-zA-Z_]\w*)\b/g, (m) => {
                            if (env[m] !== undefined) {
                                const v = env[m];
                                return typeof v === 'string' ? JSON.stringify(v) : String(v);
                            }
                            return m;
                        }).replace('**', '**').replace('//', '|0)//(');
                        const result = new Function('return ' + jsExpr.replace('**', '**'))();
                        return result;
                    } catch(e3) {}
                }
                if (expr.includes('==') || expr.includes('!=') || expr.includes('<=') || expr.includes('>=') || expr.includes('<') || expr.includes('>')) {
                    try {
                        const jsExpr = expr.replace(/\b([a-zA-Z_]\w*)\b/g, (m) => {
                            if (env[m] !== undefined) return typeof env[m] === 'string' ? JSON.stringify(env[m]) : String(env[m]);
                            return m;
                        });
                        return new Function('return ' + jsExpr)();
                    } catch(e4) {}
                }
                return expr;
            };

            const getIndent = (line) => { const m = line.match(/^(\s*)/); return m ? m[1].length : 0; };

            const execBlock = (startIdx, endIdx, baseIndent) => {
                let idx = startIdx;
                while (idx < endIdx) {
                    const line = lines[idx];
                    const trimmed = line.trim();
                    const indent = getIndent(line);

                    if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('import ') || trimmed.startsWith('from ')) { idx++; continue; }
                    if (indent < baseIndent) break;

                    const printMatch = trimmed.match(/^print\((.*)?\)$/);
                    if (printMatch) {
                        const args = [];
                        if (printMatch[1]) {
                            let depth = 0, current = '', inStr = false, strChar = '';
                            for (const ch of printMatch[1]) {
                                if (!inStr && (ch === '"' || ch === "'")) { inStr = true; strChar = ch; current += ch; }
                                else if (inStr && ch === strChar) { inStr = false; current += ch; }
                                else if (!inStr && (ch === '(' || ch === '[')) { depth++; current += ch; }
                                else if (!inStr && (ch === ')' || ch === ']')) { depth--; current += ch; }
                                else if (!inStr && ch === ',' && depth === 0) { args.push(current.trim()); current = ''; }
                                else current += ch;
                            }
                            if (current.trim()) args.push(current.trim());
                        }
                        const vals = args.map(a => evalExpr(a));
                        out.push(vals.map(v => Array.isArray(v) ? '[' + v.join(', ') + ']' : String(v)).join(' '));
                        idx++; continue;
                    }

                    const assignMatch = trimmed.match(/^(\w+)\s*=\s*(.+)$/);
                    if (assignMatch && !trimmed.includes('==')) {
                        env[assignMatch[1]] = evalExpr(assignMatch[2]);
                        idx++; continue;
                    }

                    const multiAssign = trimmed.match(/^(\w+)\s*,\s*(\w+)\s*=\s*(.+)$/);
                    if (multiAssign) {
                        const vals = multiAssign[3].split(',').map(v => evalExpr(v.trim()));
                        env[multiAssign[1]] = vals[0];
                        env[multiAssign[2]] = vals[1];
                        idx++; continue;
                    }

                    const defMatch = trimmed.match(/^def\s+(\w+)\((.*?)\):$/);
                    if (defMatch) {
                        const fnName = defMatch[1];
                        const params = defMatch[2] ? defMatch[2].split(',').map(p => p.trim()) : [];
                        const bodyStart = idx + 1;
                        const fnIndent = indent + 4;
                        let bodyEnd = bodyStart;
                        while (bodyEnd < endIdx && (getIndent(lines[bodyEnd]) >= fnIndent || !lines[bodyEnd].trim())) bodyEnd++;
                        const bodyLines = lines.slice(bodyStart, bodyEnd);
                        env['__fn_' + fnName] = (args) => {
                            const savedEnv = { ...env };
                            params.forEach((p, pi) => { env[p] = args[pi]; });
                            let retVal = undefined;
                            for (let bi = 0; bi < bodyLines.length; bi++) {
                                const bl = bodyLines[bi].trim();
                                if (!bl || bl.startsWith('#')) continue;
                                const retMatch = bl.match(/^return\s+(.+)$/);
                                if (retMatch) { retVal = evalExpr(retMatch[1]); break; }
                                const bPrint = bl.match(/^print\((.*)?\)$/);
                                if (bPrint) {
                                    const pArgs = bPrint[1] ? bPrint[1].split(',').map(a => evalExpr(a.trim())) : [];
                                    out.push(pArgs.map(v => Array.isArray(v) ? '[' + v.join(', ') + ']' : String(v)).join(' '));
                                    continue;
                                }
                                const bAssign = bl.match(/^(\w+)\s*=\s*(.+)$/);
                                if (bAssign) { env[bAssign[1]] = evalExpr(bAssign[2]); continue; }
                                const bAppend = bl.match(/^(\w+)\.append\((.+)\)$/);
                                if (bAppend && Array.isArray(env[bAppend[1]])) { env[bAppend[1]].push(evalExpr(bAppend[2])); continue; }
                                const bFor = bl.match(/^for\s+(\w+)\s+in\s+(.+):$/);
                                if (bFor) {
                                    const iter = evalExpr(bFor[2]);
                                    const forBody = [];
                                    let fbi = bi + 1;
                                    const forIndent = getIndent(bodyLines[bi]) + 4;
                                    while (fbi < bodyLines.length && (getIndent(bodyLines[fbi]) >= forIndent || !bodyLines[fbi].trim())) {
                                        forBody.push(bodyLines[fbi]); fbi++;
                                    }
                                    if (Array.isArray(iter)) {
                                        for (const val of iter) {
                                            env[bFor[1]] = val;
                                            for (const fLine of forBody) {
                                                const fl = fLine.trim();
                                                if (!fl) continue;
                                                const fRet = fl.match(/^return\s+(.+)$/);
                                                if (fRet) { retVal = evalExpr(fRet[1]); break; }
                                                const fPrint = fl.match(/^print\((.*)?\)$/);
                                                if (fPrint) { out.push(evalExpr(fPrint[1] || '').toString()); }
                                                const fAssign = fl.match(/^(\w+)\s*=\s*(.+)$/);
                                                if (fAssign) env[fAssign[1]] = evalExpr(fAssign[2]);
                                                const fAppend = fl.match(/^(\w+)\.append\((.+)\)$/);
                                                if (fAppend && Array.isArray(env[fAppend[1]])) env[fAppend[1]].push(evalExpr(fAppend[2]));
                                            }
                                            if (retVal !== undefined) break;
                                        }
                                    }
                                    bi = fbi - 1; continue;
                                }
                                const bIf = bl.match(/^if\s+(.+):$/);
                                if (bIf) {
                                    const cond = evalExpr(bIf[1]);
                                    bi++;
                                    if (cond) {
                                        while (bi < bodyLines.length && getIndent(bodyLines[bi]) > getIndent(bodyLines[bi-1])) {
                                            const il = bodyLines[bi].trim();
                                            const iRet = il.match(/^return\s+(.+)$/);
                                            if (iRet) { retVal = evalExpr(iRet[1]); break; }
                                            const iPrint = il.match(/^print\((.*)?\)$/);
                                            if (iPrint) { out.push(evalExpr(iPrint[1] || '').toString()); }
                                            bi++;
                                        }
                                    }
                                    if (retVal !== undefined) break;
                                    continue;
                                }
                            }
                            Object.keys(savedEnv).forEach(k => { if (!k.startsWith('__fn_')) env[k] = savedEnv[k]; });
                            return retVal;
                        };
                        idx = bodyEnd; continue;
                    }

                    const forMatch = trimmed.match(/^for\s+(\w+)\s+in\s+(.+):$/);
                    if (forMatch) {
                        const varName = forMatch[1];
                        const iterable = evalExpr(forMatch[2]);
                        const bodyStart = idx + 1;
                        const forIndent = indent + 4;
                        let bodyEnd = bodyStart;
                        while (bodyEnd < endIdx && (getIndent(lines[bodyEnd]) >= forIndent || !lines[bodyEnd].trim())) bodyEnd++;
                        if (Array.isArray(iterable)) {
                            for (const val of iterable) {
                                env[varName] = val;
                                execBlock(bodyStart, bodyEnd, forIndent);
                            }
                        }
                        idx = bodyEnd; continue;
                    }

                    const whileMatch = trimmed.match(/^while\s+(.+):$/);
                    if (whileMatch) {
                        const bodyStart = idx + 1;
                        const wIndent = indent + 4;
                        let bodyEnd = bodyStart;
                        while (bodyEnd < endIdx && (getIndent(lines[bodyEnd]) >= wIndent || !lines[bodyEnd].trim())) bodyEnd++;
                        let maxIter = 1000;
                        while (evalExpr(whileMatch[1]) && maxIter-- > 0) {
                            execBlock(bodyStart, bodyEnd, wIndent);
                        }
                        idx = bodyEnd; continue;
                    }

                    const ifMatch = trimmed.match(/^if\s+(.+):$/);
                    if (ifMatch) {
                        const cond = evalExpr(ifMatch[1]);
                        const bodyStart = idx + 1;
                        const ifIndent = indent + 4;
                        let bodyEnd = bodyStart;
                        while (bodyEnd < endIdx && (getIndent(lines[bodyEnd]) >= ifIndent || !lines[bodyEnd].trim())) bodyEnd++;
                        let elseStart = -1, elseEnd = bodyEnd;
                        if (bodyEnd < endIdx && lines[bodyEnd].trim().startsWith('else:')) {
                            elseStart = bodyEnd + 1;
                            elseEnd = elseStart;
                            while (elseEnd < endIdx && (getIndent(lines[elseEnd]) >= ifIndent || !lines[elseEnd].trim())) elseEnd++;
                        }
                        if (cond) {
                            execBlock(bodyStart, bodyEnd, ifIndent);
                        } else if (elseStart >= 0) {
                            execBlock(elseStart, elseEnd, ifIndent);
                        }
                        idx = elseEnd; continue;
                    }

                    const exprCall = trimmed.match(/^(\w+)\((.*)?\)$/);
                    if (exprCall) {
                        evalExpr(trimmed);
                        idx++; continue;
                    }

                    const methodCall = trimmed.match(/^(\w+)\.(\w+)\((.*)?\)$/);
                    if (methodCall) {
                        evalExpr(trimmed);
                        idx++; continue;
                    }

                    idx++;
                }
            };

            execBlock(0, lines.length, 0);
            setOutput(out.join('\n') || '(No output)');
        } catch(err) {
            setOutput('Error: ' + err.message);
        }
        setRunning(false);
    };

    // Syntax highlighting - tokenize first to prevent regex interference
    const highlight = (code) => {
        const keywords = new Set(['def','return','if','else','elif','for','while','in','import','from','class','try','except','finally','with','as','yield','lambda','pass','break','continue','and','or','not','is','True','False','None','print','range','len','int','str','float','list','dict','set','tuple','input','type','abs','max','min','sum','sorted','reversed','enumerate','zip','map','filter']);
        return code.split('\n').map((line) => {
            // Tokenize: split into strings, comments, and code segments
            const tokens = [];
            let i = 0;
            while (i < line.length) {
                // Comment
                if (line[i] === '#') {
                    tokens.push({ type: 'comment', text: line.slice(i) });
                    i = line.length;
                }
                // String
                else if (line[i] === '"' || line[i] === "'") {
                    const q = line[i];
                    let j = i + 1;
                    while (j < line.length && line[j] !== q) { if (line[j] === '\\') j++; j++; }
                    j = Math.min(j + 1, line.length);
                    tokens.push({ type: 'string', text: line.slice(i, j) });
                    i = j;
                }
                // f-string
                else if ((line[i] === 'f') && (line[i+1] === '"' || line[i+1] === "'")) {
                    const q = line[i+1];
                    let j = i + 2;
                    while (j < line.length && line[j] !== q) { if (line[j] === '\\') j++; j++; }
                    j = Math.min(j + 1, line.length);
                    tokens.push({ type: 'string', text: line.slice(i, j) });
                    i = j;
                }
                // Code
                else {
                    let j = i;
                    while (j < line.length && line[j] !== '#' && line[j] !== '"' && line[j] !== "'" && !(line[j] === 'f' && (line[j+1] === '"' || line[j+1] === "'"))) j++;
                    tokens.push({ type: 'code', text: line.slice(i, j) });
                    i = j;
                }
            }
            if (tokens.length === 0) return '';
            // Render each token
            return tokens.map(t => {
                const esc = t.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                if (t.type === 'comment') return '<span style="color:#6A9955">' + esc + '</span>';
                if (t.type === 'string') return '<span style="color:#CE9178">' + esc + '</span>';
                // Code: highlight keywords, numbers, function calls
                return esc
                    .replace(/\b(\w+)(?=\s*\()/g, (m, fn) => keywords.has(fn) ? '<span style="color:#C586C0">' + fn + '</span>' : '<span style="color:#DCDCAA">' + fn + '</span>')
                    .replace(/\b(def|return|if|else|elif|for|while|in|import|from|class|try|except|finally|with|as|yield|lambda|pass|break|continue|and|or|not|is|True|False|None)\b/g, (m) => '<span style="color:#C586C0">' + m + '</span>')
                    .replace(/\b(\d+\.?\d*)\b/g, '<span style="color:#B5CEA8">$1</span>');
            }).join('');
        }).join('\n');
    };

    const currentFile = files[activeFile];
    const saveFolders = VFS.ls(savePath).filter(f => f.type === 'folder');
    const openItems = VFS.ls(openPath);
    const openFolders = openItems.filter(f => f.type === 'folder');
    const openPyFiles = openItems.filter(f => f.type === 'file' && f.name.endsWith('.py'));

    return (
        <div className="flex flex-col h-full" style={{ background: '#1e1e1e' }}>
            {/* Top bar */}
            <div className="flex items-center h-[35px] bg-[#323233] border-b border-[#252526] px-2 gap-1">
                <button onClick={() => runPython(currentFile.content)} disabled={running}
                    className="flex items-center gap-1 px-3 py-1 rounded text-[11px] font-medium bg-[#0e639c] text-white hover:bg-[#1177bb]">
                    <svg viewBox="0 0 16 16" width="12" height="12" fill="white"><path d="M5 3l8 5-8 5V3z"/></svg>
                    {running ? 'Running...' : 'Run'}
                </button>
                <div className="w-px h-4 bg-[#555] mx-1"/>
                <button onClick={quickSave}
                    className="flex items-center gap-1 px-2.5 py-1 rounded text-[11px] font-medium text-[#ccc] hover:bg-[#3c3c3c]" title="Save (Ctrl+S)">
                    <svg viewBox="0 0 16 16" width="12" height="12" fill="#ccc"><path d="M13.71 4.29l-3-3L10 1H3L2 2v12l1 1h10l1-1V5l-.29-.71zM8 13c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM11 6H4V3h7v3z"/></svg>
                    Save
                </button>
                <button onClick={openSaveDialog}
                    className="flex items-center gap-1 px-2.5 py-1 rounded text-[11px] font-medium text-white bg-[#0e639c] hover:bg-[#1177bb]">
                    Save To Mac
                </button>
                <button onClick={openFromMac}
                    className="flex items-center gap-1 px-2.5 py-1 rounded text-[11px] font-medium text-[#ccc] hover:bg-[#3c3c3c]">
                    <svg viewBox="0 0 16 16" width="12" height="12" fill="#ccc"><path d="M1.5 1h4l1.5 2h6.5a1 1 0 011 1v8a1 1 0 01-1 1h-12a1 1 0 01-1-1V2a1 1 0 011-1z"/></svg>
                    Open File
                </button>
                <div className="flex-1"/>
                <span className="text-[11px] text-gray-500">{currentFile.vfsPath ? currentFile.vfsPath.replace('/Users/user', '~') + '/' + currentFile.name : 'Local'}</span>
                <div className="w-px h-4 bg-[#555] mx-1"/>
                <span className="text-[11px] text-gray-500">Python</span>
            </div>
            <div className="flex flex-1 overflow-hidden">
                {/* File explorer */}
                <div className="w-[180px] bg-[#252526] border-r border-[#1e1e1e] overflow-y-auto">
                    <div className="flex items-center justify-between px-3 py-2">
                        <span className="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Explorer</span>
                        <button onClick={() => setShowNewFile(true)} className="text-gray-400 hover:text-white text-[16px] leading-none">+</button>
                    </div>
                    {showNewFile && (
                        <div className="px-2 pb-1">
                            <input type="text" value={newFileName} onChange={e => setNewFileName(e.target.value)}
                                onKeyDown={e => { if (e.key === 'Enter') createFile(); if (e.key === 'Escape') setShowNewFile(false); }}
                                placeholder="filename.py" className="w-full bg-[#3c3c3c] text-white text-[12px] px-2 py-1 rounded border border-[#007acc] outline-none" autoFocus/>
                        </div>
                    )}
                    {files.map((f, i) => (
                        <div key={f.name} className={`flex items-center gap-2 px-3 py-1 cursor-pointer text-[13px] group ${i === activeFile ? 'bg-[#37373d] text-white' : 'text-gray-400 hover:bg-[#2a2d2e]'}`}
                            onClick={() => setActiveFile(i)}>
                            <svg viewBox="0 0 16 16" width="14" height="14" fill="#519aba"><path d="M13.71 4.29l-3-3L10 1H4L3 2v12l1 1h9l1-1V5l-.29-.71zM13 14H4V2h5v4h4v8z"/></svg>
                            <span className="flex-1 truncate">{f.name}</span>
                            {f.vfsPath && <span className="text-[9px] text-gray-600" title={f.vfsPath}>VFS</span>}
                            {files.length > 1 && (
                                <button onClick={(e) => { e.stopPropagation(); deleteFile(i); }}
                                    className="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 text-[14px]">&times;</button>
                            )}
                        </div>
                    ))}
                </div>
                {/* Editor + Output */}
                <div className="flex-1 flex flex-col overflow-hidden">
                    {/* Tab bar */}
                    <div className="flex bg-[#252526] border-b border-[#1e1e1e]">
                        {files.map((f, i) => (
                            <div key={f.name} className={`flex items-center gap-2 px-3 py-1.5 text-[12px] cursor-pointer border-r border-[#1e1e1e] ${i === activeFile ? 'bg-[#1e1e1e] text-white' : 'bg-[#2d2d2d] text-gray-500 hover:text-gray-300'}`}
                                onClick={() => setActiveFile(i)}>
                                <svg viewBox="0 0 16 16" width="12" height="12" fill="#519aba"><path d="M13.71 4.29l-3-3L10 1H4L3 2v12l1 1h9l1-1V5l-.29-.71zM13 14H4V2h5v4h4v8z"/></svg>
                                {f.name}
                            </div>
                        ))}
                    </div>
                    {/* Code editor */}
                    <div className="flex-1 overflow-auto relative" style={{ fontFamily: "'SF Mono', Menlo, Monaco, monospace" }}>
                        <div className="flex min-h-full">
                            <div className="py-2 pl-2 pr-3 text-right select-none bg-[#1e1e1e] sticky left-0" style={{ minWidth: '45px' }}>
                                {currentFile.content.split('\n').map((_, i) => (
                                    <div key={i} className="text-[12px] leading-[20px] text-[#858585]">{i + 1}</div>
                                ))}
                            </div>
                            <div className="flex-1 relative">
                                <textarea
                                    ref={textareaRef}
                                    value={currentFile.content}
                                    onChange={e => updateContent(e.target.value)}
                                    onKeyDown={e => {
                                        if (e.key === 'Tab') {
                                            e.preventDefault();
                                            const ta = e.target;
                                            const start = ta.selectionStart;
                                            const end = ta.selectionEnd;
                                            const val = ta.value;
                                            updateContent(val.substring(0, start) + '    ' + val.substring(end));
                                            setTimeout(() => { ta.selectionStart = ta.selectionEnd = start + 4; }, 0);
                                        }
                                        if (e.key === 'Enter') {
                                            const ta = e.target;
                                            const val = ta.value;
                                            const pos = ta.selectionStart;
                                            // Find the current line
                                            const before = val.substring(0, pos);
                                            const lineStart = before.lastIndexOf('\n') + 1;
                                            const currentLine = before.substring(lineStart);
                                            // Get current indentation
                                            const indentMatch = currentLine.match(/^(\s*)/);
                                            let indent = indentMatch ? indentMatch[1] : '';
                                            // Add extra indent after lines ending with :
                                            const trimmed = currentLine.trim();
                                            if (trimmed.endsWith(':')) {
                                                indent += '    ';
                                            }
                                            if (indent) {
                                                e.preventDefault();
                                                const newVal = val.substring(0, pos) + '\n' + indent + val.substring(ta.selectionEnd);
                                                updateContent(newVal);
                                                const newPos = pos + 1 + indent.length;
                                                setTimeout(() => { ta.selectionStart = ta.selectionEnd = newPos; }, 0);
                                            }
                                        }
                                        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                                            e.preventDefault();
                                            quickSave();
                                        }
                                    }}
                                    className="absolute inset-0 w-full h-full bg-transparent text-transparent caret-white outline-none resize-none py-2 px-0"
                                    style={{ fontFamily: 'inherit', fontSize: '12px', lineHeight: '20px', tabSize: 4, whiteSpace: 'pre' }}
                                    spellCheck="false"
                                />
                                <pre className="py-2 px-0 pointer-events-none text-[12px] leading-[20px] text-[#d4d4d4]"
                                    style={{ fontFamily: 'inherit', whiteSpace: 'pre' }}
                                    dangerouslySetInnerHTML={{ __html: highlight(currentFile.content) }}/>
                            </div>
                        </div>
                    </div>
                    {/* Output panel */}
                    {showOutput && (
                        <div className="border-t border-[#252526]" style={{ height: '150px' }}>
                            <div className="flex items-center justify-between bg-[#252526] px-3 py-1">
                                <span className="text-[11px] text-gray-400 uppercase tracking-wider">Terminal</span>
                                <button onClick={() => setShowOutput(false)} className="text-gray-500 hover:text-white text-[14px]">&times;</button>
                            </div>
                            <pre className="p-3 overflow-auto h-[120px] text-[12px] text-[#cccccc] bg-[#1e1e1e]" style={{ fontFamily: "'SF Mono', Menlo, monospace" }}>
                                <span className="text-green-400">$ python {currentFile.name}</span>{'\n'}{output}
                            </pre>
                        </div>
                    )}
                </div>
            </div>
            {/* Status bar */}
            <div className="h-[22px] bg-[#007acc] flex items-center px-3 text-white text-[11px] gap-4">
                <span>Python</span>
                <span>UTF-8</span>
                <span>Spaces: 4</span>
                <span className="ml-auto">{currentFile.name}</span>
            </div>

            {/* Save To Mac Dialog */}
            {showSaveDialog && (
                <div className="absolute inset-0 bg-black/40 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-[#252526] rounded-xl shadow-2xl w-[420px] overflow-hidden border border-[#3c3c3c]">
                        <div className="px-5 py-3 bg-[#323233] border-b border-[#3c3c3c] flex items-center justify-between">
                            <h3 className="text-[14px] font-semibold text-white">Save To Mac</h3>
                            <button onClick={() => setShowSaveDialog(false)} className="text-gray-400 hover:text-white text-[18px]">&times;</button>
                        </div>
                        <div className="p-4">
                            <div className="text-[12px] text-gray-400 mb-2">Save to: {savePath.replace('/Users/user', '~')}</div>
                            <div className="border border-[#3c3c3c] rounded-lg h-[200px] overflow-y-auto mb-3 bg-[#1e1e1e]">
                                {savePath !== '/Users/user' && (
                                    <div className="flex items-center gap-2 px-3 py-2 hover:bg-[#37373d] cursor-default border-b border-[#3c3c3c]"
                                        onClick={() => { const parts = savePath.split('/'); parts.pop(); setSavePath(parts.join('/') || '/Users/user'); }}>
                                        <span className="text-[14px]">â¬†ï¸</span>
                                        <span className="text-[12px] text-[#007acc] font-medium">Go Up</span>
                                    </div>
                                )}
                                {saveFolders.length === 0 && (
                                    <div className="text-[12px] text-gray-500 text-center py-8">No subfolders</div>
                                )}
                                {saveFolders.map(folder => (
                                    <div key={folder.name}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-[#37373d] cursor-default border-b border-[#3c3c3c]"
                                        onDoubleClick={() => setSavePath(savePath + '/' + folder.name)}>
                                        <svg viewBox="0 0 48 48" width="20" height="20">
                                            <path d="M6 8h14l4 4h18c1.1 0 2 .9 2 2v24c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2z" fill="#64B5F6"/>
                                            <rect x="4" y="14" width="40" height="24" rx="2" fill="#42A5F5" opacity="0.85"/>
                                        </svg>
                                        <span className="text-[12px] text-gray-300">{folder.name}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="flex items-center gap-2 mb-4">
                                <span className="text-[12px] text-gray-400 whitespace-nowrap">File name:</span>
                                <input type="text" value={saveFileName} onChange={e => setSaveFileName(e.target.value)}
                                    className="flex-1 px-2 py-1.5 bg-[#3c3c3c] border border-[#555] rounded-md text-[12px] text-white outline-none focus:border-[#007acc]"/>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowSaveDialog(false)}
                                    className="px-4 py-1.5 rounded-lg bg-[#3c3c3c] text-[13px] text-gray-300 font-medium hover:bg-[#4c4c4c]">Cancel</button>
                                <button onClick={saveToMac}
                                    className="px-4 py-1.5 rounded-lg bg-[#0e639c] text-white text-[13px] font-medium hover:bg-[#1177bb]">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Open From Mac Dialog */}
            {showOpenDialog && (
                <div className="absolute inset-0 bg-black/40 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-[#252526] rounded-xl shadow-2xl w-[420px] overflow-hidden border border-[#3c3c3c]">
                        <div className="px-5 py-3 bg-[#323233] border-b border-[#3c3c3c] flex items-center justify-between">
                            <h3 className="text-[14px] font-semibold text-white">Open File</h3>
                            <button onClick={() => setShowOpenDialog(false)} className="text-gray-400 hover:text-white text-[18px]">&times;</button>
                        </div>
                        <div className="p-4">
                            <div className="text-[12px] text-gray-400 mb-2">Browse: {openPath.replace('/Users/user', '~')}</div>
                            <div className="border border-[#3c3c3c] rounded-lg h-[250px] overflow-y-auto mb-3 bg-[#1e1e1e]">
                                {openPath !== '/Users/user' && (
                                    <div className="flex items-center gap-2 px-3 py-2 hover:bg-[#37373d] cursor-default border-b border-[#3c3c3c]"
                                        onClick={() => { const parts = openPath.split('/'); parts.pop(); setOpenPath(parts.join('/') || '/Users/user'); }}>
                                        <span className="text-[14px]">â¬†ï¸</span>
                                        <span className="text-[12px] text-[#007acc] font-medium">Go Up</span>
                                    </div>
                                )}
                                {openFolders.map(folder => (
                                    <div key={folder.name}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-[#37373d] cursor-default border-b border-[#3c3c3c]"
                                        onDoubleClick={() => setOpenPath(openPath + '/' + folder.name)}>
                                        <svg viewBox="0 0 48 48" width="20" height="20">
                                            <path d="M6 8h14l4 4h18c1.1 0 2 .9 2 2v24c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2z" fill="#64B5F6"/>
                                            <rect x="4" y="14" width="40" height="24" rx="2" fill="#42A5F5" opacity="0.85"/>
                                        </svg>
                                        <span className="text-[12px] text-gray-300">{folder.name}</span>
                                    </div>
                                ))}
                                {openPyFiles.map(file => (
                                    <div key={file.name}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-[#37373d] cursor-default border-b border-[#3c3c3c]"
                                        onDoubleClick={() => loadFileFromVFS(openPath, file.name)}>
                                        <svg viewBox="0 0 16 16" width="16" height="16" fill="#519aba"><path d="M13.71 4.29l-3-3L10 1H4L3 2v12l1 1h9l1-1V5l-.29-.71zM13 14H4V2h5v4h4v8z"/></svg>
                                        <span className="text-[12px] text-gray-300">{file.name}</span>
                                        <span className="text-[10px] text-gray-500 ml-auto">{file.size}</span>
                                    </div>
                                ))}
                                {openFolders.length === 0 && openPyFiles.length === 0 && (
                                    <div className="text-[12px] text-gray-500 text-center py-8">No folders or .py files here</div>
                                )}
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowOpenDialog(false)}
                                    className="px-4 py-1.5 rounded-lg bg-[#3c3c3c] text-[13px] text-gray-300 font-medium hover:bg-[#4c4c4c]">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


window.VSCodeApp = VSCodeApp;
</script>

<script type="text/babel">
// Paint App - Canvas drawing application with Save To Mac
const PaintApp = () => {
    const canvasRef = React.useRef(null);
    const [tool, setTool] = React.useState('brush');
    const [color, setColor] = React.useState('#000000');
    const [brushSize, setBrushSize] = React.useState(4);
    const [isDrawing, setIsDrawing] = React.useState(false);
    const [history, setHistory] = React.useState([]);
    const [historyIdx, setHistoryIdx] = React.useState(-1);
    const [fillColor, setFillColor] = React.useState('#ffffff');
    const [showSaveDialog, setShowSaveDialog] = React.useState(false);
    const [savePath, setSavePath] = React.useState('/Users/user/Desktop');
    const [saveFileName, setSaveFileName] = React.useState('painting.png');
    const lastPos = React.useRef(null);
    const shapeStart = React.useRef(null);
    const snapshotRef = React.useRef(null);
    const vfsVersion = useStore(s => s.vfsVersion);

    const presetColors = [
        '#000000', '#ffffff', '#ff0000', '#ff6600', '#ffcc00', '#33cc33',
        '#0099ff', '#6633cc', '#ff3399', '#996633', '#666666', '#cccccc',
        '#990000', '#cc6600', '#999900', '#006633', '#003399', '#330066',
        '#cc0066', '#663300', '#333333', '#999999',
    ];

    const tools = [
        { id: 'brush', label: 'Brush', icon: 'M7 14c-1.66 0-3-1.34-3-3 0-1.31.83-2.5 2.03-2.94L12 2l5.97 6.06C19.17 8.5 20 9.69 20 11c0 1.66-1.34 3-3 3H7z' },
        { id: 'eraser', label: 'Eraser', icon: 'M15.14 3c-.51 0-1.01.2-1.38.56L2.44 14.89c-.78.77-.78 2.03 0 2.81l1.06 1.06c.39.39.9.59 1.41.59H9l9.56-9.56c.78-.78.78-2.05 0-2.83l-2.03-2.03A1.948 1.948 0 0015.14 3z' },
        { id: 'line', label: 'Line', icon: 'M4 20L20 4' },
        { id: 'rect', label: 'Rect', icon: 'M3 5v14h18V5H3zm16 12H5V7h14v10z' },
        { id: 'circle', label: 'Circle', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z' },
        { id: 'fill', label: 'Fill', icon: 'M16.56 8.94L7.62 0 6.21 1.42l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.13zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z' },
        { id: 'text', label: 'Text', icon: 'M5 4v3h5.5v12h3V7H19V4z' },
    ];

    React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        saveState();
    }, []);

    const saveState = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const data = canvas.toDataURL();
        setHistory(prev => {
            const newHistory = prev.slice(0, historyIdx + 1);
            newHistory.push(data);
            setHistoryIdx(newHistory.length - 1);
            return newHistory;
        });
    };

    const undo = () => {
        if (historyIdx <= 0) return;
        const newIdx = historyIdx - 1;
        setHistoryIdx(newIdx);
        const img = new Image();
        img.onload = () => {
            const ctx = canvasRef.current.getContext('2d');
            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = history[newIdx];
    };

    const redo = () => {
        if (historyIdx >= history.length - 1) return;
        const newIdx = historyIdx + 1;
        setHistoryIdx(newIdx);
        const img = new Image();
        img.onload = () => {
            const ctx = canvasRef.current.getContext('2d');
            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = history[newIdx];
    };

    const clearCanvas = () => {
        const ctx = canvasRef.current.getContext('2d');
        ctx.fillStyle = fillColor;
        ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
        saveState();
    };

    const getPos = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        return {
            x: (e.clientX - rect.left) * (canvas.width / rect.width),
            y: (e.clientY - rect.top) * (canvas.height / rect.height),
        };
    };

    const handleMouseDown = (e) => {
        const pos = getPos(e);
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        if (tool === 'fill') {
            floodFill(Math.round(pos.x), Math.round(pos.y), color);
            saveState();
            return;
        }

        if (tool === 'text') {
            const text = prompt('Enter text:');
            if (text) {
                ctx.font = `${brushSize * 4}px Inter, sans-serif`;
                ctx.fillStyle = color;
                ctx.fillText(text, pos.x, pos.y);
                saveState();
            }
            return;
        }

        setIsDrawing(true);
        lastPos.current = pos;

        if (tool === 'line' || tool === 'rect' || tool === 'circle') {
            shapeStart.current = pos;
            snapshotRef.current = ctx.getImageData(0, 0, canvas.width, canvas.height);
        } else {
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, (tool === 'eraser' ? brushSize * 2 : brushSize) / 2, 0, Math.PI * 2);
            ctx.fillStyle = tool === 'eraser' ? fillColor : color;
            ctx.fill();
        }
    };

    const handleMouseMove = (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        if (tool === 'brush' || tool === 'eraser') {
            ctx.beginPath();
            ctx.moveTo(lastPos.current.x, lastPos.current.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = tool === 'eraser' ? fillColor : color;
            ctx.lineWidth = tool === 'eraser' ? brushSize * 2 : brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            lastPos.current = pos;
        } else if (shapeStart.current && snapshotRef.current) {
            ctx.putImageData(snapshotRef.current, 0, 0);
            ctx.strokeStyle = color;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            const sx = shapeStart.current.x, sy = shapeStart.current.y;

            if (tool === 'line') {
                ctx.beginPath();
                ctx.moveTo(sx, sy);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            } else if (tool === 'rect') {
                ctx.strokeRect(sx, sy, pos.x - sx, pos.y - sy);
            } else if (tool === 'circle') {
                const rx = Math.abs(pos.x - sx) / 2;
                const ry = Math.abs(pos.y - sy) / 2;
                const cx = sx + (pos.x - sx) / 2;
                const cy = sy + (pos.y - sy) / 2;
                ctx.beginPath();
                ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
    };

    const handleMouseUp = () => {
        if (isDrawing) {
            setIsDrawing(false);
            shapeStart.current = null;
            snapshotRef.current = null;
            saveState();
        }
    };

    const floodFill = (startX, startY, fillColorHex) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const w = canvas.width, h = canvas.height;

        const fc = parseInt(fillColorHex.slice(1), 16);
        const fr = (fc >> 16) & 255, fg = (fc >> 8) & 255, fb = fc & 255;

        const getPixel = (x, y) => {
            const i = (y * w + x) * 4;
            return [data[i], data[i+1], data[i+2], data[i+3]];
        };

        const target = getPixel(startX, startY);
        if (target[0] === fr && target[1] === fg && target[2] === fb) return;

        const match = (x, y) => {
            const p = getPixel(x, y);
            return Math.abs(p[0] - target[0]) < 20 && Math.abs(p[1] - target[1]) < 20 && Math.abs(p[2] - target[2]) < 20;
        };

        const setPixel = (x, y) => {
            const i = (y * w + x) * 4;
            data[i] = fr; data[i+1] = fg; data[i+2] = fb; data[i+3] = 255;
        };

        const stack = [[startX, startY]];
        const visited = new Set();
        let maxOps = 500000;

        while (stack.length > 0 && maxOps-- > 0) {
            const [x, y] = stack.pop();
            if (x < 0 || x >= w || y < 0 || y >= h) continue;
            const key = y * w + x;
            if (visited.has(key)) continue;
            if (!match(x, y)) continue;
            visited.add(key);
            setPixel(x, y);
            stack.push([x+1,y], [x-1,y], [x,y+1], [x,y-1]);
        }

        ctx.putImageData(imageData, 0, 0);
    };

    const downloadImage = () => {
        const canvas = canvasRef.current;
        const link = document.createElement('a');
        link.download = 'painting.png';
        link.href = canvas.toDataURL();
        link.click();
    };

    const openSaveDialog = () => {
        setSavePath('/Users/user/Desktop');
        setSaveFileName('painting.png');
        setShowSaveDialog(true);
    };

    const saveToMac = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const dataUrl = canvas.toDataURL();
        // Save the data URL as file content in VFS
        VFS.touch(savePath, saveFileName, dataUrl);
        MacStore.addNotification('Paint', 'File Saved', saveFileName + ' saved to ' + savePath.replace('/Users/user', '~'));
        setShowSaveDialog(false);
    };

    const saveFolders = VFS.ls(savePath).filter(f => f.type === 'folder');

    return (
        <div className="flex flex-col h-full bg-[#f0f0f0]">
            {/* Toolbar */}
            <div className="flex items-center gap-2 px-3 py-2 bg-white border-b border-gray-200 flex-wrap">
                {/* Tools */}
                <div className="flex gap-0.5 bg-gray-100 rounded-lg p-0.5">
                    {tools.map(t => (
                        <button key={t.id} onClick={() => setTool(t.id)} title={t.label}
                            className={`p-1.5 rounded-md ${tool === t.id ? 'bg-blue-500 text-white shadow-sm' : 'text-gray-600 hover:bg-gray-200'}`}>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill={tool === t.id ? 'white' : '#555'}>
                                {t.id === 'line' ? <line x1="4" y1="20" x2="20" y2="4" stroke={tool === t.id ? 'white' : '#555'} strokeWidth="2"/> : <path d={t.icon}/>}
                            </svg>
                        </button>
                    ))}
                </div>

                <div className="w-px h-6 bg-gray-300"/>

                {/* Size */}
                <div className="flex items-center gap-1.5">
                    <span className="text-[10px] text-gray-500">Size</span>
                    <MacSlider min={1} max={40} value={brushSize} onChange={v => setBrushSize(v)}
                        className="w-[80px]" accentColor="#3b82f6"/>
                    <span className="text-[10px] text-gray-500 w-5">{brushSize}</span>
                </div>

                <div className="w-px h-6 bg-gray-300"/>

                {/* Color */}
                <div className="flex items-center gap-1.5">
                    <input type="color" value={color} onChange={e => setColor(e.target.value)}
                        className="w-7 h-7 rounded cursor-pointer border border-gray-300" title="Color"/>
                    <div className="flex gap-0.5 flex-wrap" style={{ maxWidth: '200px' }}>
                        {presetColors.map(c => (
                            <button key={c} onClick={() => setColor(c)}
                                className={`w-4 h-4 rounded-sm border ${color === c ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-300'}`}
                                style={{ background: c }}/>
                        ))}
                    </div>
                </div>

                <div className="w-px h-6 bg-gray-300"/>

                {/* Actions */}
                <button onClick={undo} className="p-1.5 rounded hover:bg-gray-100" title="Undo">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="#555"><path d="M12.5 8c-2.65 0-5.05 1.04-6.83 2.74L2.5 7.5v9h9l-3.19-3.19c1.33-1.28 3.07-2.06 5.04-2.06 3.24 0 6.02 2.07 7.05 5l2.1-.66C21.11 11.97 17.14 8 12.5 8z"/></svg>
                </button>
                <button onClick={redo} className="p-1.5 rounded hover:bg-gray-100" title="Redo">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="#555"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                </button>
                <button onClick={clearCanvas} className="px-2 py-1 rounded text-[11px] text-gray-600 hover:bg-gray-100 font-medium" title="Clear canvas">Clear</button>
                <button onClick={downloadImage} className="px-2 py-1 rounded text-[11px] text-blue-600 hover:bg-blue-50 font-medium">Save PNG</button>
                <button onClick={openSaveDialog} className="px-2 py-1 rounded text-[11px] text-white bg-blue-500 hover:bg-blue-600 font-medium">Save To Mac</button>
            </div>

            {/* Canvas */}
            <div className="flex-1 overflow-auto flex items-center justify-center p-4 bg-[#e0e0e0]"
                style={{ backgroundImage: 'radial-gradient(circle, #ccc 1px, transparent 1px)', backgroundSize: '20px 20px' }}>
                <canvas
                    ref={canvasRef}
                    width={900}
                    height={600}
                    className="bg-white shadow-lg rounded cursor-crosshair"
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                    style={{ maxWidth: '100%', maxHeight: '100%' }}
                />
            </div>

            {/* Status bar */}
            <div className="h-[22px] bg-white border-t border-gray-200 flex items-center px-3 text-[11px] text-gray-500 gap-4">
                <span>Tool: {tools.find(t => t.id === tool)?.label}</span>
                <span>Size: {brushSize}px</span>
                <span>Canvas: 900 x 600</span>
                <span className="ml-auto">Paint</span>
            </div>

            {/* Save To Mac Dialog */}
            {showSaveDialog && (
                <div className="absolute inset-0 bg-black/30 flex items-center justify-center z-50 rounded-b-xl">
                    <div className="bg-white rounded-xl shadow-2xl w-[420px] overflow-hidden">
                        <div className="px-5 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                            <h3 className="text-[14px] font-semibold text-gray-800">Save To Mac</h3>
                            <button onClick={() => setShowSaveDialog(false)} className="text-gray-400 hover:text-gray-600 text-[18px]">&times;</button>
                        </div>
                        <div className="p-4">
                            <div className="text-[12px] text-gray-500 mb-2">Save to: {savePath.replace('/Users/user', '~')}</div>
                            <div className="border border-gray-200 rounded-lg h-[200px] overflow-y-auto mb-3 bg-gray-50">
                                {savePath !== '/Users/user' && (
                                    <div className="flex items-center gap-2 px-3 py-2 hover:bg-blue-50 cursor-default border-b border-gray-100"
                                        onClick={() => { const parts = savePath.split('/'); parts.pop(); setSavePath(parts.join('/') || '/Users/user'); }}>
                                        <span className="text-[14px]">â¬†ï¸</span>
                                        <span className="text-[12px] text-blue-600 font-medium">Go Up</span>
                                    </div>
                                )}
                                {saveFolders.length === 0 && (
                                    <div className="text-[12px] text-gray-400 text-center py-8">No subfolders</div>
                                )}
                                {saveFolders.map(folder => (
                                    <div key={folder.name}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-blue-50 cursor-default border-b border-gray-100"
                                        onDoubleClick={() => setSavePath(savePath + '/' + folder.name)}>
                                        <svg viewBox="0 0 48 48" width="20" height="20">
                                            <path d="M6 8h14l4 4h18c1.1 0 2 .9 2 2v24c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2z" fill="#64B5F6"/>
                                            <rect x="4" y="14" width="40" height="24" rx="2" fill="#42A5F5" opacity="0.85"/>
                                        </svg>
                                        <span className="text-[12px] text-gray-700">{folder.name}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="flex items-center gap-2 mb-4">
                                <span className="text-[12px] text-gray-500 whitespace-nowrap">File name:</span>
                                <input type="text" value={saveFileName} onChange={e => setSaveFileName(e.target.value)}
                                    className="flex-1 px-2 py-1.5 border border-gray-300 rounded-md text-[12px] outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"/>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowSaveDialog(false)}
                                    className="px-4 py-1.5 rounded-lg bg-gray-100 text-[13px] font-medium hover:bg-gray-200">Cancel</button>
                                <button onClick={saveToMac}
                                    className="px-4 py-1.5 rounded-lg bg-blue-500 text-white text-[13px] font-medium hover:bg-blue-600">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


window.PaintApp = PaintApp;
</script>

<script type="text/babel">
// App Store - 5 functional apps you can download and play
const AppStoreApp = () => {
    const [activeTab, setActiveTab] = React.useState('Discover');
    const [downloads, setDownloads] = React.useState({});
    const [installing, setInstalling] = React.useState({});

    React.useEffect(() => {
        const saved = localStorage.getItem('macos_appstore_downloads');
        if (saved) { try { setDownloads(JSON.parse(saved)); } catch(e) {} }
    }, []);

    const tabs = ['Discover', 'Games', 'Productivity', 'Updates'];

    const allApps = [
        { name: 'Snake', subtitle: 'Classic Snake Game', category: 'games', rating: 4.7, size: '2 MB', color: '#34C759', appType: 'snake',
            desc: 'The classic Snake game! Use arrow keys or WASD to guide the snake, eat food to grow, and try to beat your high score. Speed increases as you eat more!',
            icon: null, emoji: 'ðŸ' },
        { name: 'Tetris', subtitle: 'Block Puzzle Classic', category: 'games', rating: 4.8, size: '3 MB', color: '#00BCD4', appType: 'tetris',
            desc: 'The legendary Tetris! Rotate and drop blocks to clear lines. Features ghost piece, next piece preview, level progression, and high score tracking.',
            icon: null, emoji: 'ðŸ§±' },
        { name: '2048', subtitle: 'Number Puzzle Game', category: 'games', rating: 4.6, size: '1 MB', color: '#EDA028', appType: 'game2048',
            desc: 'Slide numbered tiles on a grid to combine them and reach the 2048 tile! A simple yet addictive puzzle game with score tracking.',
            icon: null, emoji: 'ðŸ”¢' },
        { name: 'VS Code', subtitle: 'Code Editor for Python', category: 'productivity', rating: 4.9, size: '15 MB', color: '#007ACC', appType: 'vscode',
            desc: 'A code editor with Python syntax highlighting, multiple file support, and a built-in Python interpreter. Write and run Python code right in your browser!',
            icon: null, emoji: 'ðŸ’»' },
        { name: 'Paint', subtitle: 'Drawing & Art Studio', category: 'productivity', rating: 4.5, size: '5 MB', color: '#FF3B30', appType: 'paint',
            desc: 'A full-featured drawing app with brush, eraser, shapes (line, rectangle, circle), flood fill, text tool, undo/redo, and color picker. Save your art as PNG!',
            icon: null, emoji: 'ðŸŽ¨' },
    ];

    const stars = (rating) => (
        <div className="flex items-center gap-0.5">
            {Array.from({ length: 5 }).map((_, i) => (
                <svg key={i} viewBox="0 0 24 24" width="10" height="10" fill={i < Math.floor(rating) ? '#FFD60A' : '#E5E5EA'}>
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
            ))}
            <span className="text-[10px] text-gray-400 ml-0.5">{rating}</span>
        </div>
    );

    const installApp = (app) => {
        const appName = app.name;
        if (downloads[appName] || installing[appName] !== undefined) return;
        setInstalling(prev => ({ ...prev, [appName]: 0 }));
        const interval = setInterval(() => {
            setInstalling(prev => {
                const prog = (prev[appName] || 0) + Math.random() * 15 + 5;
                if (prog >= 100) {
                    clearInterval(interval);
                    const newDownloads = { ...downloads, [appName]: app.appType };
                    setDownloads(newDownloads);
                    localStorage.setItem('macos_appstore_downloads', JSON.stringify(newDownloads));
                    // Add to desktop
                    VFS.addDesktopApp(app.appType, appName);
                    MacStore.addNotification('App Store', appName + ' installed', 'The app has been added to your Desktop.');
                    const next = { ...prev };
                    delete next[appName];
                    return next;
                }
                return { ...prev, [appName]: prog };
            });
        }, 200);
    };

    const uninstallApp = (appName) => {
        const appType = downloads[appName];
        const newDownloads = { ...downloads };
        delete newDownloads[appName];
        setDownloads(newDownloads);
        localStorage.setItem('macos_appstore_downloads', JSON.stringify(newDownloads));
        if (appType) {
            VFS.removeDesktopApp(appType);
            // Close the app window if it's open
            const state = MacStore.getState();
            const openWin = state.windows.find(w => w.appType === appType);
            if (openWin) MacStore.closeWindow(openWin.id);
        }
        MacStore.addNotification('App Store', appName + ' uninstalled', 'The app has been removed.');
    };

    const openApp = (app) => {
        if (!downloads[app.name]) return;
        const sizes = {
            snake: { w: 530, h: 500 },
            tetris: { w: 480, h: 560 },
            game2048: { w: 430, h: 550 },
            vscode: { w: 950, h: 650 },
            paint: { w: 1000, h: 700 },
        };
        const s = sizes[app.appType] || { w: 800, h: 500 };
        MacStore.openWindow(app.appType, app.name, s.w, s.h);
    };

    const AppIcon = ({ app, size = 48 }) => (
        <div className="rounded-2xl flex items-center justify-center text-white flex-shrink-0 shadow-sm overflow-hidden select-none"
            style={{ width: size, height: size, background: `linear-gradient(135deg, ${app.color}, ${app.color}cc)`, fontSize: size * 0.45 }}>
            {app.emoji}
        </div>
    );

    const GetButton = ({ app }) => {
        if (downloads[app.name]) return (
            <div className="flex items-center gap-1.5">
                <button onClick={(e) => { e.stopPropagation(); openApp(app); }}
                    className="px-3.5 py-1 rounded-full bg-gray-100 text-blue-600 text-[11px] font-semibold hover:bg-blue-100 transition-colors">OPEN</button>
                <button onClick={(e) => { e.stopPropagation(); uninstallApp(app.name); }}
                    className="px-3 py-1 rounded-full bg-red-500 text-white text-[11px] font-semibold hover:bg-red-600 transition-colors">UNINSTALL</button>
            </div>
        );
        if (installing[app.name] !== undefined) return (
            <div className="w-[60px] h-[24px] relative">
                <svg className="absolute inset-0" width="60" height="24" viewBox="0 0 60 24">
                    <rect x="1" y="1" width="58" height="22" rx="11" fill="none" stroke="#007AFF" strokeWidth="1.5" opacity="0.3"/>
                    <rect x="1" y="1" width="58" height="22" rx="11" fill="none" stroke="#007AFF" strokeWidth="1.5"
                        strokeDasharray={`${(installing[app.name] / 100) * 165} 165`} strokeLinecap="round"
                        style={{ transition: 'stroke-dasharray 0.2s' }}/>
                </svg>
                <div className="absolute inset-0 flex items-center justify-center">
                    <svg viewBox="0 0 12 12" width="10" height="10" fill="#007AFF"><rect x="2" y="2" width="8" height="8" rx="1"/></svg>
                </div>
            </div>
        );
        return <button onClick={(e) => { e.stopPropagation(); installApp(app); }} className="px-3.5 py-1 rounded-full bg-blue-100 text-blue-600 text-[11px] font-semibold hover:bg-blue-200">GET</button>;
    };

    const AppCard = ({ app }) => (
        <div className="flex items-start gap-4 p-4 bg-gray-50 rounded-2xl cursor-default hover:bg-gray-100 transition-colors">
            <AppIcon app={app} size={56}/>
            <div className="flex-1 min-w-0">
                <div className="flex items-start justify-between gap-2">
                    <div>
                        <div className="text-[15px] font-semibold">{app.name}</div>
                        <div className="text-[12px] text-gray-400">{app.subtitle}</div>
                        {stars(app.rating)}
                    </div>
                    <GetButton app={app}/>
                </div>
                <div className="text-[12px] text-gray-500 mt-2 leading-relaxed">{app.desc}</div>
                <div className="text-[11px] text-gray-400 mt-1">{app.size}</div>
            </div>
        </div>
    );

    const AppRow = ({ app }) => (
        <div className="flex items-center gap-3 px-4 py-2.5 border-b border-black/[0.03] cursor-default hover:bg-gray-100/50">
            <AppIcon app={app} size={44}/>
            <div className="flex-1 min-w-0">
                <div className="text-[13px] font-medium">{app.name}</div>
                <div className="text-[11px] text-gray-400">{app.subtitle}</div>
                {stars(app.rating)}
            </div>
            <GetButton app={app}/>
        </div>
    );

    const renderContent = () => {
        switch (activeTab) {
            case 'Discover':
                return (
                    <>
                        <div className="rounded-2xl overflow-hidden mb-8 h-[200px] relative cursor-default"
                            style={{ background: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)' }}>
                            <div className="absolute inset-0 flex items-center p-8">
                                <div className="text-white">
                                    <div className="text-[12px] font-semibold uppercase tracking-wider opacity-70">App Store</div>
                                    <div className="text-[28px] font-bold mt-1">5 Apps, All Functional</div>
                                    <div className="text-[14px] opacity-80 mt-1">Download and use real games, a code editor, and a paint app</div>
                                </div>
                            </div>
                            <div className="absolute right-8 top-1/2 -translate-y-1/2 flex gap-3 text-[40px]">
                                ðŸ ðŸ§± ðŸ”¢ ðŸ’» ðŸŽ¨
                            </div>
                        </div>
                        <h3 className="text-[20px] font-bold mb-4">All Apps</h3>
                        <div className="flex flex-col gap-3">
                            {allApps.map(app => <AppCard key={app.name} app={app}/>)}
                        </div>
                    </>
                );
            case 'Games':
                const games = allApps.filter(a => a.category === 'games');
                return (
                    <>
                        <div className="rounded-2xl overflow-hidden mb-8 h-[180px] relative cursor-default"
                            style={{ background: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)' }}>
                            <div className="absolute inset-0 flex items-center p-8">
                                <div className="text-white">
                                    <div className="text-[12px] font-semibold uppercase tracking-wider opacity-70">Games</div>
                                    <div className="text-[28px] font-bold mt-1">Play Now</div>
                                    <div className="text-[14px] opacity-80 mt-1">{games.length} playable games â€” download and play instantly</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col gap-3">
                            {games.map(app => <AppCard key={app.name} app={app}/>)}
                        </div>
                    </>
                );
            case 'Productivity':
                const prodApps = allApps.filter(a => a.category === 'productivity');
                return (
                    <>
                        <div className="rounded-2xl overflow-hidden mb-8 h-[180px] relative cursor-default"
                            style={{ background: 'linear-gradient(135deg, #007ACC, #0099FF)' }}>
                            <div className="absolute inset-0 flex items-center p-8">
                                <div className="text-white">
                                    <div className="text-[12px] font-semibold uppercase tracking-wider opacity-70">Productivity</div>
                                    <div className="text-[28px] font-bold mt-1">Create & Build</div>
                                    <div className="text-[14px] opacity-80 mt-1">Code editor and drawing tools</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col gap-3">
                            {prodApps.map(app => <AppCard key={app.name} app={app}/>)}
                        </div>
                    </>
                );
            case 'Updates':
                const installedApps = Object.keys(downloads);
                return (
                    <>
                        <div className="text-[13px] text-gray-400 mb-4">{installedApps.length} of {allApps.length} apps installed</div>
                        {installedApps.length > 0 && (
                            <>
                                <h3 className="text-[15px] font-bold mb-3">Installed Apps</h3>
                                <div className="bg-gray-50 rounded-xl overflow-hidden mb-6">
                                    {installedApps.map(name => {
                                        const app = allApps.find(a => a.name === name) || { name, subtitle: 'App', rating: 4.5, color: '#999', emoji: 'ðŸ“¦', appType: '' };
                                        return (
                                            <div key={name} className="flex items-center gap-3 px-4 py-2.5 border-b border-black/[0.03]">
                                                <AppIcon app={app} size={40}/>
                                                <div className="flex-1">
                                                    <div className="text-[13px] font-medium">{name}</div>
                                                    <div className="text-[11px] text-gray-400">Up to date</div>
                                                </div>
                                                <button onClick={() => openApp(app)} className="px-3 py-1 rounded-full text-[11px] text-blue-600 bg-blue-50 hover:bg-blue-100 font-medium mr-2">Open</button>
                                                <button onClick={() => uninstallApp(name)} className="px-3 py-1 rounded-full text-[11px] text-white bg-red-500 hover:bg-red-600 font-semibold transition-colors">Uninstall</button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        )}
                        {installedApps.length === 0 && (
                            <div className="text-center text-gray-400 text-[13px] py-12">No apps installed yet. Visit Discover to get apps!</div>
                        )}
                    </>
                );
            default: return null;
        }
    };

    return (
        <div className="flex h-full">
            <div className="w-[180px] min-w-[180px] bg-gray-50/95 border-r border-black/5 p-2 overflow-y-auto">
                <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider px-3 py-1 mt-1 mb-1">Store</div>
                {tabs.map(tab => (
                    <div key={tab} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-default text-[13px] ${activeTab === tab ? 'bg-blue-500 text-white' : 'hover:bg-black/[0.03]'}`}
                        onClick={() => setActiveTab(tab)}>{tab}</div>
                ))}
                <div className="mt-4 px-3 text-[10px] text-gray-400 text-center">
                    {Object.keys(downloads).length} apps installed
                </div>
            </div>
            <div className="flex-1 overflow-y-auto bg-white">
                <div className="p-6 max-w-[900px]">
                    {renderContent()}
                </div>
            </div>
        </div>
    );
};


window.AppStoreApp = AppStoreApp;
</script>

<script type="text/babel">
// About the Developer
const AboutDeveloperApp = () => {
    const darkMode = useStore(s => s.darkMode);

    return (
        <div className={`h-full overflow-y-auto ${darkMode ? 'bg-[#1e1e1e] text-white' : 'bg-gradient-to-b from-gray-50 to-white text-gray-900'}`}>
            <div className="max-w-[520px] mx-auto py-10 px-8">
                {/* Profile photo */}
                <div className="flex flex-col items-center mb-8">
                    <div className="w-[130px] h-[130px] rounded-full overflow-hidden shadow-lg ring-4 ring-white/30 mb-4">
                        <img src="AboutPhoto/MePhoto.jpeg" alt="Amit Mozapi"
                            className="w-full h-full object-cover" draggable="false"/>
                    </div>
                    <h1 className="text-[26px] font-bold tracking-tight">Amit Mozapi</h1>
                    <p className={`text-[14px] mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Developer &bull; 16 years old &bull; Israel</p>
                </div>

                {/* Divider */}
                <div className={`h-px mb-6 ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`}/>

                {/* About text */}
                <div className={`text-[14px] leading-relaxed space-y-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    <p>
                        Hi, I'm Amit Mozapi â€” a 16 years old developer from Israel with a passion for building things on the web.
                    </p>
                    <p>
                        I'm currently a high school student majoring in <span className="font-semibold">Biotechnology</span> and <span className="font-semibold">Biology</span>, but when I'm not in the lab, I'm writing code. This macOS Sonoma replica was built entirely from scratch using React, Tailwind CSS, and a lot of attention to detail â€” from the dock magnification and window management to a working file system, App Store, and fully playable apps.
                    </p>
                    <p>
                        I love pushing the limits of what's possible in a browser and coding in general.
                    </p>
                </div>

                {/* Divider */}
                <div className={`h-px my-6 ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`}/>

                {/* Contact */}
                <div className="flex flex-col items-center gap-3">
                    <p className={`text-[13px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Get in touch for any questions!
                    </p>
                    <a href="https://instagram.com/am1tt3" target="_blank" rel="noopener noreferrer"
                        className={`inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-[13px] font-semibold transition-all hover:scale-105 active:scale-95 ${
                            darkMode
                                ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/25'
                                : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/30'
                        }`}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/>
                        </svg>
                        @am1tt3
                    </a>
                </div>

                {/* Footer */}
                <div className={`text-center text-[11px] mt-8 pb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                    Built with React, Tailwind CSS & passion
                </div>
            </div>
        </div>
    );
};


window.AboutDeveloperApp = AboutDeveloperApp;
</script>

<script type="text/babel">
// macOS Menu Bar - Fully functional with app-specific menus and interactive status icons
const MenuBar = () => {
    const [clock, setClock] = React.useState('');
    const [dropdown, setDropdown] = React.useState(null);
    const activeWin = useStore(s => s.windows.find(w => w.focused));
    const wifiOn = useStore(s => s.wifiOn);
    const volume = useStore(s => s.volume);
    const showBatteryPercentage = useStore(s => s.showBatteryPercentage);
    const focusOn = useStore(s => s.focusOn);
    const stageManagerOn = useStore(s => s.stageManagerOn);
    const batteryLevel = React.useRef(Math.floor(Math.random() * 30) + 65);

    React.useEffect(() => {
        const update = () => {
            const now = new Date();
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            let h = now.getHours(); const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12;
            setClock(`${days[now.getDay()]} ${months[now.getMonth()]} ${now.getDate()} ${h}:${String(now.getMinutes()).padStart(2,'0')} ${ampm}`);
        };
        update();
        const t = setInterval(update, 1000);
        return () => clearInterval(t);
    }, []);

    const closeDropdown = () => setDropdown(null);

    React.useEffect(() => {
        const handler = (e) => {
            if (!e.target.closest('.dropdown-container')) closeDropdown();
        };
        document.addEventListener('click', handler);
        return () => document.removeEventListener('click', handler);
    }, []);

    const appName = activeWin ? activeWin.title.split(' - ')[0].split(' ')[0] : 'Finder';
    const appType = activeWin ? activeWin.appType : 'finder';

    // App-specific menu items - vary by focused app
    const getAppMenuItems = () => {
        return (
            <>
                <DropItem label={`About ${appName}`} onClick={() => { closeDropdown(); MacStore.setState({ aboutMacOpen: true }); }}/>
                <DropSep/>
                <DropItem label={`Preferences...`} shortcut="âŒ˜," onClick={() => { closeDropdown(); MacStore.openWindow('settings', 'System Settings', 920, 600); }}/>
                <DropSep/>
                <DropItem label={`Hide ${appName}`} shortcut="âŒ˜H"/>
                <DropItem label="Hide Others" shortcut="âŒ¥âŒ˜H"/>
                <DropItem label="Show All"/>
                <DropSep/>
                <DropItem label={`Quit ${appName}`} shortcut="âŒ˜Q" onClick={() => { closeDropdown(); if (activeWin) MacStore.closeWindow(activeWin.id); }}/>
            </>
        );
    };

    // App-specific File menu
    const getFileMenuItems = () => {
        const base = (
            <>
                <DropItem label="New Window" shortcut="âŒ˜N" onClick={() => { closeDropdown(); MacStore.openWindow('finder','Finder',900,550); }}/>
                <DropItem label="New Folder" shortcut="â‡§âŒ˜N" onClick={() => { closeDropdown(); VFS.mkdir('/Users/user/Desktop', 'untitled folder'); }}/>
                <DropSep/>
                <DropItem label="Open" shortcut="âŒ˜O" onClick={closeDropdown}/>
                <DropItem label="Open With" hasArrow/>
                <DropItem label="Close Window" shortcut="âŒ˜W" onClick={() => { closeDropdown(); if(activeWin) MacStore.closeWindow(activeWin.id); }}/>
            </>
        );
        // Add app-specific items
        if (appType === 'word' || appType === 'vscode' || appType === 'notes') {
            return (<>
                {base}
                <DropSep/>
                <DropItem label="Save" shortcut="âŒ˜S" onClick={closeDropdown}/>
                <DropItem label="Save As..." shortcut="â‡§âŒ˜S" onClick={closeDropdown}/>
                <DropItem label="Export as PDF..." onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Print..." shortcut="âŒ˜P" onClick={closeDropdown}/>
            </>);
        }
        if (appType === 'safari') {
            return (<>
                <DropItem label="New Tab" shortcut="âŒ˜T" onClick={closeDropdown}/>
                <DropItem label="New Window" shortcut="âŒ˜N" onClick={closeDropdown}/>
                <DropItem label="New Private Window" shortcut="â‡§âŒ˜N" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Open File..." shortcut="âŒ˜O" onClick={closeDropdown}/>
                <DropItem label="Close Tab" shortcut="âŒ˜W" onClick={() => { closeDropdown(); if(activeWin) MacStore.closeWindow(activeWin.id); }}/>
                <DropSep/>
                <DropItem label="Print..." shortcut="âŒ˜P" onClick={closeDropdown}/>
            </>);
        }
        if (appType === 'paint') {
            return (<>
                {base}
                <DropSep/>
                <DropItem label="Save" shortcut="âŒ˜S" onClick={closeDropdown}/>
                <DropItem label="Export as PNG..." shortcut="â‡§âŒ˜E" onClick={closeDropdown}/>
            </>);
        }
        return (<>
            {base}
            <DropSep/>
            <DropItem label="Get Info" shortcut="âŒ˜I" onClick={closeDropdown}/>
            <DropItem label="Rename" onClick={closeDropdown}/>
            <DropItem label="Compress" onClick={closeDropdown}/>
            <DropItem label="Duplicate" shortcut="âŒ˜D" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Move to Trash" shortcut="âŒ˜âŒ«" onClick={closeDropdown}/>
        </>);
    };

    // App-specific Edit menu
    const getEditMenuItems = () => {
        const base = (
            <>
                <DropItem label="Undo" shortcut="âŒ˜Z" onClick={closeDropdown}/>
                <DropItem label="Redo" shortcut="â‡§âŒ˜Z" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Cut" shortcut="âŒ˜X" onClick={closeDropdown}/>
                <DropItem label="Copy" shortcut="âŒ˜C" onClick={closeDropdown}/>
                <DropItem label="Paste" shortcut="âŒ˜V" onClick={closeDropdown}/>
                <DropItem label="Select All" shortcut="âŒ˜A" onClick={closeDropdown}/>
            </>
        );
        if (appType === 'vscode') {
            return (<>
                {base}
                <DropSep/>
                <DropItem label="Find" shortcut="âŒ˜F" onClick={closeDropdown}/>
                <DropItem label="Find and Replace" shortcut="âŒ¥âŒ˜F" onClick={closeDropdown}/>
                <DropItem label="Toggle Comment" shortcut="âŒ˜/" onClick={closeDropdown}/>
                <DropItem label="Format Document" shortcut="â‡§âŒ¥F" onClick={closeDropdown}/>
            </>);
        }
        if (appType === 'terminal') {
            return (<>
                {base}
                <DropSep/>
                <DropItem label="Clear Buffer" shortcut="âŒ˜K" onClick={closeDropdown}/>
                <DropItem label="Select Output" onClick={closeDropdown}/>
            </>);
        }
        return (<>
            {base}
            <DropSep/>
            <DropItem label="Find" shortcut="âŒ˜F" onClick={() => { closeDropdown(); MacStore.setState(s => ({ spotlightOpen: !s.spotlightOpen })); }}/>
            <DropItem label="Find and Replace" shortcut="âŒ¥âŒ˜F" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Emoji & Symbols" shortcut="âŒƒâŒ˜Space" onClick={closeDropdown}/>
        </>);
    };

    const getViewMenuItems = () => (
        <>
            <DropItem label="as Icons" shortcut="âŒ˜1" onClick={closeDropdown}/>
            <DropItem label="as List" shortcut="âŒ˜2" onClick={closeDropdown}/>
            <DropItem label="as Columns" shortcut="âŒ˜3" onClick={closeDropdown}/>
            <DropItem label="as Gallery" shortcut="âŒ˜4" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Show Tab Bar" shortcut="â‡§âŒ˜T" onClick={closeDropdown}/>
            <DropItem label="Show All Tabs" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Show Path Bar" shortcut="âŒ¥âŒ˜P" onClick={closeDropdown}/>
            <DropItem label="Show Status Bar" onClick={closeDropdown}/>
            <DropItem label="Show Sidebar" shortcut="âŒ¥âŒ˜S" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Enter Full Screen" shortcut="âŒƒâŒ˜F" onClick={() => {
                closeDropdown();
                if (activeWin) MacStore.toggleMaximize(activeWin.id);
            }}/>
        </>
    );

    const getGoMenuItems = () => (
        <>
            <DropItem label="Back" shortcut="âŒ˜[" onClick={closeDropdown}/>
            <DropItem label="Forward" shortcut="âŒ˜]" onClick={closeDropdown}/>
            <DropItem label="Enclosing Folder" shortcut="âŒ˜â†‘" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Recents" shortcut="â‡§âŒ˜F" onClick={closeDropdown}/>
            <DropItem label="Documents" shortcut="â‡§âŒ˜O" onClick={() => { closeDropdown(); MacStore.openWindow('finder', 'Finder', 900, 550); }}/>
            <DropItem label="Desktop" shortcut="â‡§âŒ˜D" onClick={() => { closeDropdown(); MacStore.openWindow('finder', 'Finder', 900, 550); }}/>
            <DropItem label="Downloads" shortcut="âŒ¥âŒ˜L" onClick={() => { closeDropdown(); MacStore.openWindow('finder', 'Finder', 900, 550); }}/>
            <DropItem label="Home" shortcut="â‡§âŒ˜H" onClick={() => { closeDropdown(); MacStore.openWindow('finder', 'Finder', 900, 550); }}/>
            <DropSep/>
            <DropItem label="Applications" shortcut="â‡§âŒ˜A" onClick={() => { closeDropdown(); MacStore.openWindow('finder', 'Finder', 900, 550); }}/>
            <DropItem label="Utilities" shortcut="â‡§âŒ˜U" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label="Go to Folder..." shortcut="â‡§âŒ˜G" onClick={closeDropdown}/>
            <DropItem label="Connect to Server..." shortcut="âŒ˜K" onClick={closeDropdown}/>
        </>
    );

    const getWindowMenuItems = () => {
        const state = MacStore.getState();
        return (
            <>
                <DropItem label="Minimize" shortcut="âŒ˜M" onClick={() => { closeDropdown(); if (activeWin) MacStore.minimizeWindow(activeWin.id); }}/>
                <DropItem label="Zoom" onClick={() => { closeDropdown(); if (activeWin) MacStore.toggleMaximize(activeWin.id); }}/>
                <DropItem label="Move Window to Left Side" onClick={() => { closeDropdown(); if (activeWin) MacStore.updateWindow(activeWin.id, { x: 0, y: 25, width: Math.floor(window.innerWidth / 2), height: window.innerHeight - 25 }); }}/>
                <DropItem label="Move Window to Right Side" onClick={() => { closeDropdown(); if (activeWin) MacStore.updateWindow(activeWin.id, { x: Math.floor(window.innerWidth / 2), y: 25, width: Math.floor(window.innerWidth / 2), height: window.innerHeight - 25 }); }}/>
                <DropSep/>
                <DropItem label="Mission Control" shortcut="âŒƒâ†‘" onClick={() => { closeDropdown(); MacStore.setState(s => ({ missionControlOpen: !s.missionControlOpen })); }}/>
                <DropItem label={stageManagerOn ? 'âœ“ Stage Manager' : '  Stage Manager'} onClick={() => { closeDropdown(); MacStore.setState(s => ({ stageManagerOn: !s.stageManagerOn })); }}/>
                <DropSep/>
                <DropItem label="Bring All to Front" onClick={() => { closeDropdown(); }}/>
                {state.windows.length > 0 && <DropSep/>}
                {state.windows.map(w => (
                    <DropItem key={w.id} label={(w.focused ? 'âœ“ ' : '  ') + w.title}
                        onClick={() => { closeDropdown(); MacStore.focusWindow(w.id); if (w.minimized) MacStore.restoreWindow(w.id); }}/>
                ))}
            </>
        );
    };

    const getHelpMenuItems = () => (
        <>
            <div className="px-4 py-1.5 mx-1">
                <div className="flex items-center gap-2 px-2 py-1 rounded bg-gray-100 border border-black/5">
                    <svg viewBox="0 0 24 24" width="12" height="12" fill="#999"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <span className="text-[12px] text-gray-400">Search</span>
                </div>
            </div>
            <DropSep/>
            <DropItem label="macOS Help" onClick={closeDropdown}/>
            <DropSep/>
            <DropItem label={`${appName} Help`} onClick={closeDropdown}/>
            <DropItem label="Keyboard Shortcuts" onClick={closeDropdown}/>
            <DropItem label="What's New in macOS" onClick={closeDropdown}/>
        </>
    );

    // Dynamic menu items based on app type
    const getMenus = () => {
        if (appType === 'safari') return ['File','Edit','View','History','Bookmarks','Window','Help'];
        if (appType === 'vscode') return ['File','Edit','Selection','View','Go','Terminal','Help'];
        if (appType === 'terminal') return ['Shell','Edit','View','Window','Help'];
        if (appType === 'music') return ['File','Edit','Controls','View','Window','Help'];
        if (appType === 'paint') return ['File','Edit','Canvas','View','Window','Help'];
        return ['File','Edit','View','Go','Window','Help'];
    };

    const getMenuContent = (menu) => {
        switch(menu) {
            case 'File': return getFileMenuItems();
            case 'Edit': return getEditMenuItems();
            case 'View': return getViewMenuItems();
            case 'Go': return getGoMenuItems();
            case 'Window': return getWindowMenuItems();
            case 'Help': return getHelpMenuItems();
            // App-specific menus
            case 'History': return (<>
                <DropItem label="Show All History" shortcut="âŒ˜Y" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Back" shortcut="âŒ˜[" onClick={closeDropdown}/>
                <DropItem label="Forward" shortcut="âŒ˜]" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Clear History..." onClick={closeDropdown}/>
            </>);
            case 'Bookmarks': return (<>
                <DropItem label="Show Bookmarks" shortcut="âŒ˜B" onClick={closeDropdown}/>
                <DropItem label="Add Bookmark..." shortcut="âŒ˜D" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Favorites" hasArrow/>
            </>);
            case 'Selection': return (<>
                <DropItem label="Select All" shortcut="âŒ˜A" onClick={closeDropdown}/>
                <DropItem label="Expand Selection" shortcut="â‡§âŒ¥â†’" onClick={closeDropdown}/>
                <DropItem label="Shrink Selection" shortcut="â‡§âŒ¥â†" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Add Cursor Above" shortcut="âŒ¥âŒ˜â†‘" onClick={closeDropdown}/>
                <DropItem label="Add Cursor Below" shortcut="âŒ¥âŒ˜â†“" onClick={closeDropdown}/>
            </>);
            case 'Terminal': return (<>
                <DropItem label="New Terminal" shortcut="âŒƒ`" onClick={closeDropdown}/>
                <DropItem label="Split Terminal" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Run Active File" onClick={closeDropdown}/>
                <DropItem label="Run Selected Text" onClick={closeDropdown}/>
            </>);
            case 'Shell': return (<>
                <DropItem label="New Window" shortcut="âŒ˜N" onClick={closeDropdown}/>
                <DropItem label="New Tab" shortcut="âŒ˜T" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Close" shortcut="âŒ˜W" onClick={() => { closeDropdown(); if(activeWin) MacStore.closeWindow(activeWin.id); }}/>
            </>);
            case 'Controls': return (<>
                <DropItem label="Play / Pause" shortcut="Space" onClick={closeDropdown}/>
                <DropItem label="Next" shortcut="âŒ˜â†’" onClick={closeDropdown}/>
                <DropItem label="Previous" shortcut="âŒ˜â†" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Increase Volume" shortcut="âŒ˜â†‘" onClick={closeDropdown}/>
                <DropItem label="Decrease Volume" shortcut="âŒ˜â†“" onClick={closeDropdown}/>
                <DropItem label="Mute" shortcut="âŒ¥âŒ˜â†“" onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Shuffle" onClick={closeDropdown}/>
                <DropItem label="Repeat" onClick={closeDropdown}/>
            </>);
            case 'Canvas': return (<>
                <DropItem label="Clear Canvas" onClick={closeDropdown}/>
                <DropItem label="Resize Canvas..." onClick={closeDropdown}/>
                <DropSep/>
                <DropItem label="Zoom In" shortcut="âŒ˜+" onClick={closeDropdown}/>
                <DropItem label="Zoom Out" shortcut="âŒ˜-" onClick={closeDropdown}/>
                <DropItem label="Fit to Window" shortcut="âŒ˜0" onClick={closeDropdown}/>
            </>);
            default: return null;
        }
    };

    const menus = getMenus();

    return (
        <div className="fixed top-0 left-0 right-0 h-[25px] glass-dark flex items-center justify-between px-2 z-[9999] border-b border-white/5">
            <div className="flex items-center h-full">
                {/* Apple menu */}
                <div className="dropdown-container relative">
                    <button onClick={(e) => { e.stopPropagation(); setDropdown(dropdown === 'apple' ? null : 'apple'); }}
                        className="flex items-center px-3 h-full hover:bg-white/10 rounded">
                        <svg viewBox="0 0 170 170" width="13" height="13" fill="white">
                            <path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.58 6.53-8.33 11.05-11.22 13.56-4.48 4.12-9.28 6.23-14.42 6.35-3.69 0-8.14-1.05-13.32-3.18-5.2-2.12-9.97-3.17-14.34-3.17-4.58 0-9.49 1.05-14.75 3.17-5.26 2.13-9.5 3.24-12.74 3.35-4.93.21-9.84-1.96-14.75-6.52-3.13-2.73-7.04-7.41-11.73-14.04-5.03-7.08-9.17-15.29-12.41-24.65-3.47-10.11-5.21-19.9-5.21-29.38 0-10.86 2.35-20.22 7.04-28.07 3.69-6.3 8.61-11.27 14.76-14.92s12.79-5.51 19.95-5.63c3.91 0 9.05 1.21 15.43 3.59 6.36 2.39 10.45 3.6 12.26 3.6 1.35 0 5.94-1.42 13.72-4.24 7.36-2.62 13.57-3.71 18.66-3.27 13.79 1.11 24.13 6.54 31.01 16.32-12.32 7.47-18.41 17.94-18.28 31.37.12 10.46 3.91 19.17 11.35 26.08 3.38 3.21 7.15 5.68 11.34 7.44-.91 2.64-1.87 5.17-2.89 7.59zM119.11 7.24c0 8.2-3 15.86-8.96 22.95-7.19 8.4-15.89 13.25-25.32 12.49-.12-.97-.19-2-.19-3.07 0-7.87 3.43-16.31 9.51-23.19 3.04-3.49 6.9-6.4 11.58-8.72 4.67-2.29 9.09-3.55 13.24-3.8.12 1.13.14 2.25.14 3.34z"/>
                        </svg>
                    </button>
                    {dropdown === 'apple' && (
                        <div className="absolute top-[25px] left-0 glass-menu rounded-b-lg animate-menu-dropdown-in min-w-[240px] py-1 shadow-xl border border-black/10 z-[10001]">
                            <DropItem label="About This Mac" onClick={() => { closeDropdown(); MacStore.setState({ aboutMacOpen: true }); }}/>
                            <DropSep/>
                            <DropItem label="System Settings..." onClick={() => { closeDropdown(); MacStore.openWindow('settings', 'System Settings', 920, 600); }}/>
                            <DropItem label="App Store..." onClick={() => { closeDropdown(); MacStore.openWindow('appstore', 'App Store', 950, 650); }}/>
                            <DropSep/>
                            <DropItem label="Recent Items" hasArrow/>
                            <DropItem label="Force Quit..." shortcut="âŒ¥âŒ˜Esc" onClick={() => {
                                closeDropdown();
                                const state = MacStore.getState();
                                if (state.activeWindowId) MacStore.closeWindow(state.activeWindowId);
                            }}/>
                            <DropSep/>
                            <DropItem label="Sleep"/>
                            <DropItem label="Restart..."/>
                            <DropItem label="Shut Down..."/>
                            <DropSep/>
                            <DropItem label="Lock Screen" shortcut="âŒƒâŒ˜Q" onClick={() => { closeDropdown(); MacStore.setState({ locked: true }); }}/>
                            <DropItem label="Log Out User..." shortcut="â‡§âŒ˜Q" onClick={() => { closeDropdown(); MacStore.setState({ locked: true }); }}/>
                        </div>
                    )}
                </div>

                {/* Active app name */}
                <div className="dropdown-container relative">
                    <button onClick={(e) => { e.stopPropagation(); setDropdown(dropdown === 'app' ? null : 'app'); }}
                        onMouseEnter={() => dropdown && setDropdown('app')}
                        className="text-white text-[13px] font-semibold px-2.5 h-full flex items-center hover:bg-white/10 rounded">{appName}</button>
                    {dropdown === 'app' && (
                        <div className="absolute top-[25px] left-0 glass-menu rounded-b-lg animate-menu-dropdown-in min-w-[220px] py-1 shadow-xl border border-black/10 z-[10001]">
                            {getAppMenuItems()}
                        </div>
                    )}
                </div>

                {/* Dynamic menus based on active app */}
                {menus.map(menu => (
                    <div key={menu} className="dropdown-container relative">
                        <button
                            onClick={(e) => { e.stopPropagation(); setDropdown(dropdown === menu ? null : menu); }}
                            onMouseEnter={() => dropdown && setDropdown(menu)}
                            className="text-white text-[13px] px-2.5 h-full flex items-center hover:bg-white/10 rounded"
                        >{menu}</button>
                        {dropdown === menu && (
                            <div className="absolute top-[25px] left-0 glass-menu rounded-b-lg animate-menu-dropdown-in min-w-[220px] py-1 shadow-xl border border-black/10 z-[10001]">
                                {getMenuContent(menu)}
                            </div>
                        )}
                    </div>
                ))}
            </div>

            <div className="flex items-center h-full gap-0.5">
                {/* Stage Manager indicator */}
                {stageManagerOn && (
                    <MenuIcon title="Stage Manager On" onClick={() => MacStore.setState(s => ({ stageManagerOn: !s.stageManagerOn }))}>
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="white" opacity="0.8"><rect x="2" y="4" width="8" height="16" rx="1.5"/><rect x="13" y="7" width="4" height="4" rx="1" opacity="0.5"/><rect x="13" y="13" width="4" height="4" rx="1" opacity="0.5"/><rect x="19" y="9" width="3" height="6" rx="1" opacity="0.3"/></svg>
                    </MenuIcon>
                )}

                {/* Focus indicator */}
                {focusOn && (
                    <MenuIcon title="Focus On">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>
                    </MenuIcon>
                )}

                {/* Control Center */}
                <MenuIcon title="Control Center" onClick={() => MacStore.setState(s => ({ controlCenterOpen: !s.controlCenterOpen, notificationCenterOpen: false }))}>
                    <svg viewBox="0 0 24 24" width="15" height="15" fill="white"><path d="M7 10h2v4H7zM11 7h2v10h-2zM15 12h2v2h-2zM3 13h2v1H3zM19 9h2v6h-2z"/></svg>
                </MenuIcon>

                {/* Wi-Fi - clickable toggle */}
                <div className="dropdown-container relative flex items-center h-full">
                    <button onClick={(e) => { e.stopPropagation(); setDropdown(dropdown === 'wifi' ? null : 'wifi'); }}
                        className="flex items-center px-1.5 h-full hover:bg-white/10 rounded cursor-default" title="Wi-Fi">
                        <svg viewBox="0 0 24 24" width="15" height="15" fill="white" opacity={wifiOn ? 1 : 0.4}>
                            <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                        </svg>
                    </button>
                    {dropdown === 'wifi' && (
                        <div className="absolute top-[25px] right-0 glass-menu rounded-b-lg animate-menu-dropdown-in min-w-[260px] py-1 shadow-xl border border-black/10 z-[10001]">
                            <div className="flex items-center justify-between px-4 py-2">
                                <span className="text-[13px] font-semibold">Wi-Fi</span>
                                <div className={`w-8 h-[18px] rounded-full cursor-default flex items-center transition-colors ${wifiOn ? 'bg-green-500 justify-end' : 'bg-gray-300 justify-start'}`}
                                    onClick={() => MacStore.setState(s => ({ wifiOn: !s.wifiOn }))}>
                                    <div className="w-[14px] h-[14px] bg-white rounded-full mx-0.5 shadow-sm"/>
                                </div>
                            </div>
                            {wifiOn && <>
                                <DropSep/>
                                <div className="px-4 py-1 text-[11px] text-gray-400 font-medium">Known Networks</div>
                                <DropItem label="âœ“  Home Wi-Fi" onClick={closeDropdown}/>
                                <DropItem label="    Office Network" onClick={closeDropdown}/>
                                <DropItem label="    Coffee Shop" onClick={closeDropdown}/>
                                <DropSep/>
                                <div className="px-4 py-1 text-[11px] text-gray-400 font-medium">Other Networks</div>
                                <DropItem label="    Guest-5G" onClick={closeDropdown}/>
                                <DropItem label="    NETGEAR-2.4G" onClick={closeDropdown}/>
                                <DropSep/>
                                <DropItem label="Other..." onClick={closeDropdown}/>
                                <DropItem label="Network Preferences..." onClick={() => { closeDropdown(); MacStore.openWindow('settings', 'System Settings', 920, 600); }}/>
                            </>}
                        </div>
                    )}
                </div>

                {/* Volume indicator - click to toggle mute */}
                <MenuIcon title={`Volume: ${volume}%`} onClick={() => MacStore.setState(s => ({ volume: s.volume > 0 ? 0 : 60 }))}>
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="white" opacity={volume > 0 ? 1 : 0.4}>
                        {volume > 0 ? <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                            : <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>}
                    </svg>
                </MenuIcon>

                {/* Battery dropdown */}
                <div className="dropdown-container relative flex items-center h-full">
                    <button onClick={(e) => { e.stopPropagation(); setDropdown(dropdown === 'battery' ? null : 'battery'); }}
                        className="flex items-center gap-1 px-1.5 h-full hover:bg-white/10 rounded cursor-default" title="Battery">
                        <svg viewBox="0 0 28 16" width="22" height="12" fill="none" stroke="white" strokeWidth="1">
                            <rect x="0.5" y="1" width="22" height="12" rx="2.5" fill="none"/>
                            <rect x="2" y="2.5" width={Math.floor(batteryLevel.current * 0.18)} height="9" rx="1" fill="white" opacity="0.9"/>
                            <path d="M24 5.5 v3" strokeWidth="1.5" strokeLinecap="round"/>
                        </svg>
                        {showBatteryPercentage && <span className="text-white text-[11px]">{batteryLevel.current}%</span>}
                    </button>
                    {dropdown === 'battery' && (
                        <div className="absolute top-[25px] right-0 glass-menu rounded-b-lg animate-menu-dropdown-in min-w-[240px] py-1 shadow-xl border border-black/10 z-[10001]">
                            <div className="px-4 py-2">
                                <div className="text-[13px] font-semibold">Battery</div>
                                <div className="text-[12px] text-gray-500 mt-0.5">{batteryLevel.current}% â€” Charging</div>
                            </div>
                            <DropSep/>
                            <div className="px-4 py-1.5">
                                <div className="flex items-center gap-2">
                                    <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-green-500 rounded-full transition-all" style={{ width: batteryLevel.current + '%' }}/>
                                    </div>
                                </div>
                            </div>
                            <DropSep/>
                            <div className="px-4 py-1 text-[11px] text-gray-400">Power Source: Power Adapter</div>
                            <div className="px-4 py-1 text-[11px] text-gray-400">Time to Full: 0:42</div>
                            <DropSep/>
                            <DropItem label="Battery Preferences..." onClick={() => { closeDropdown(); MacStore.openWindow('settings', 'System Settings', 920, 600); }}/>
                        </div>
                    )}
                </div>

                {/* Spotlight */}
                <MenuIcon title="Spotlight" onClick={() => MacStore.setState(s => ({ spotlightOpen: !s.spotlightOpen }))}>
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </MenuIcon>

                {/* Siri */}
                <MenuIcon title="Siri">
                    <svg viewBox="0 0 24 24" width="14" height="14">
                        <defs><linearGradient id="siri-g" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#FF2D55"/><stop offset="50%" stopColor="#AF52DE"/><stop offset="100%" stopColor="#5856D6"/>
                        </linearGradient></defs>
                        <circle cx="12" cy="12" r="10" fill="url(#siri-g)"/>
                    </svg>
                </MenuIcon>

                {/* Date/Time -> Notification Center (includes widgets) */}
                <MenuIcon title="Notifications" onClick={() => {
                    MacStore.setState(s => ({
                        notificationCenterOpen: !s.notificationCenterOpen,
                        controlCenterOpen: false
                    }));
                }}>
                    <span className="text-white text-[13px] font-medium whitespace-nowrap">{clock}</span>
                </MenuIcon>
            </div>
        </div>
    );
};

const MenuIcon = ({ children, onClick, title }) => (
    <button onClick={onClick} title={title} className="flex items-center px-1.5 h-full hover:bg-white/10 rounded cursor-default">
        {children}
    </button>
);

const DropItem = ({ label, shortcut, onClick, disabled, hasArrow }) => (
    <div className={`flex items-center justify-between px-4 py-[3px] mx-1 rounded text-[13px] cursor-default min-h-[22px]
        ${disabled ? 'text-gray-400 pointer-events-none' : 'hover:bg-blue-500 hover:text-white group'}`}
        onClick={onClick}
    >
        <span>{label}</span>
        <div className="flex items-center gap-2">
            {shortcut && <span className="text-[12px] text-gray-400 ml-6 group-hover:text-white/70">{shortcut}</span>}
            {hasArrow && <span className="text-[10px] text-gray-400 group-hover:text-white/70">&#9654;</span>}
        </div>
    </div>
);

const DropSep = () => <div className="h-px bg-black/10 my-1 mx-3"/>;


window.MenuBar = MenuBar;
</script>

<script type="text/babel">
// macOS Dock - reads settings from global store
const Dock = () => {
    const openApps = useStore(s => s.openApps);
    const windows = useStore(s => s.windows);
    const dockSize = useStore(s => s.dockSize);
    const dockMagnification = useStore(s => s.dockMagnification);
    const dockAutoHide = useStore(s => s.dockAutoHide);
    const dockPosition = useStore(s => s.dockPosition);
    const showRecents = useStore(s => s.showRecents);
    const accentColor = useStore(s => s.accentColor);

    const [hovered, setHovered] = React.useState(false);
    const [visible, setVisible] = React.useState(!dockAutoHide);
    const [bouncingApp, setBouncingApp] = React.useState(null);
    const [mousePos, setMousePos] = React.useState(null); // mouse position relative to dock
    const dockRef = React.useRef(null);

    // Auto-hide logic
    React.useEffect(() => {
        if (!dockAutoHide) { setVisible(true); return; }
        setVisible(false);
        const handleMouse = (e) => {
            if (dockPosition === 'bottom' && e.clientY >= window.innerHeight - 4) setVisible(true);
            else if (dockPosition === 'left' && e.clientX <= 4) setVisible(true);
            else if (dockPosition === 'right' && e.clientX >= window.innerWidth - 4) setVisible(true);
        };
        window.addEventListener('mousemove', handleMouse);
        return () => window.removeEventListener('mousemove', handleMouse);
    }, [dockAutoHide, dockPosition]);

    // Hide when mouse leaves dock area (if auto-hide)
    React.useEffect(() => {
        if (!dockAutoHide) return;
        if (!hovered && visible) {
            const t = setTimeout(() => setVisible(false), 800);
            return () => clearTimeout(t);
        }
    }, [hovered, dockAutoHide, visible]);

    const dockApps = [
        { type: 'finder', name: 'Finder', Icon: MacIcons.Finder },
        { type: 'launchpad', name: 'Launchpad', Icon: MacIcons.Launchpad },
        { type: 'safari', name: 'Safari', Icon: MacIcons.Safari },
        { type: 'messages', name: 'Messages', Icon: MacIcons.Messages },
        { type: 'mail', name: 'Mail', Icon: MacIcons.Mail },
        { type: 'maps', name: 'Maps', Icon: MacIcons.Maps },
        { type: 'photos', name: 'Photos', Icon: MacIcons.Photos },
        { type: 'music', name: 'Music', Icon: MacIcons.Music },
        { type: 'appstore', name: 'App Store', Icon: MacIcons.AppStore },
    ];

    // Add separator + utility apps
    const utilApps = [
        { type: 'notes', name: 'Notes', Icon: MacIcons.Notes },
        { type: 'calendar', name: 'Calendar', Icon: MacIcons.Calendar },
        { type: 'calculator', name: 'Calculator', Icon: MacIcons.Calculator },
        { type: 'terminal', name: 'Terminal', Icon: MacIcons.Terminal },
        { type: 'word', name: 'Word', Icon: MacIcons.Word },
        { type: 'settings', name: 'System Settings', Icon: MacIcons.Settings },
        { type: 'aboutdev', name: 'About the Developer', Icon: MacIcons.AboutDev },
    ];

    // Build final dock items list
    const allItems = [...dockApps, 'sep', ...utilApps];

    // Add recent apps section if enabled
    if (showRecents) {
        const recentApps = [];
        windows.forEach(w => {
            if (!dockApps.find(a => a.type === w.appType) && !utilApps.find(a => a.type === w.appType) && w.appType !== 'trash') {
                const iconMap = { snake: MacIcons.Snake, tetris: MacIcons.Tetris, game2048: MacIcons.Game2048, vscode: MacIcons.VSCode, paint: MacIcons.Paint };
                if (iconMap[w.appType] && !recentApps.find(r => r.type === w.appType)) {
                    recentApps.push({ type: w.appType, name: w.title, Icon: iconMap[w.appType] });
                }
            }
        });
        if (recentApps.length > 0) {
            allItems.push('sep');
            allItems.push(...recentApps);
        }
    }

    // Always add trash at end
    allItems.push('sep', { type: 'trash', name: 'Trash', Icon: MacIcons.Trash });

    const appSizes = {
        finder: { w: 900, h: 550 }, safari: { w: 1000, h: 650 }, calculator: { w: 250, h: 400 },
        notes: { w: 800, h: 550 }, terminal: { w: 650, h: 420 }, settings: { w: 920, h: 600 },
        messages: { w: 800, h: 550 }, mail: { w: 1000, h: 600 }, maps: { w: 850, h: 550 },
        photos: { w: 900, h: 600 }, word: { w: 900, h: 700 }, calendar: { w: 800, h: 600 },
        music: { w: 950, h: 600 }, appstore: { w: 950, h: 650 }, aboutdev: { w: 550, h: 580 }, trash: { w: 700, h: 450 },
    };

    const handleClick = (appType, appName) => {
        if (appType === 'launchpad') {
            MacStore.setState(s => ({ launchpadOpen: !s.launchpadOpen }));
            return;
        }
        const minimized = windows.find(w => w.appType === appType && w.minimized);
        if (minimized) { MacStore.restoreWindow(minimized.id); return; }
        const existing = windows.find(w => w.appType === appType && !w.minimized);
        if (existing) { MacStore.focusWindow(existing.id); return; }
        // New app launch - trigger bounce
        setBouncingApp(appType);
        setTimeout(() => setBouncingApp(null), 800);
        const size = appSizes[appType] || { w: 800, h: 500 };
        MacStore.openWindow(appType, appName, size.w, size.h);
    };

    const iconSize = dockSize;
    const isVertical = dockPosition === 'left' || dockPosition === 'right';

    // Position classes
    const positionStyle = {};
    const containerClass = 'fixed z-[9998]';
    if (dockPosition === 'bottom') {
        positionStyle.bottom = '6px';
        positionStyle.left = '50%';
        positionStyle.transform = `translateX(-50%) translateY(${visible ? '0' : '100%'})`;
    } else if (dockPosition === 'left') {
        positionStyle.left = '6px';
        positionStyle.top = '50%';
        positionStyle.transform = `translateY(-50%) translateX(${visible ? '0' : '-100%'})`;
    } else if (dockPosition === 'right') {
        positionStyle.right = '6px';
        positionStyle.top = '50%';
        positionStyle.transform = `translateY(-50%) translateX(${visible ? '0' : '100%'})`;
    }
    positionStyle.transition = 'transform 0.3s ease';

    const flexDir = isVertical ? 'flex-col' : 'flex-row';
    const sepStyle = isVertical
        ? { width: iconSize + 'px', height: '1px', background: 'rgba(255,255,255,0.2)', margin: '4px 0' }
        : { width: '1px', height: iconSize + 'px', background: 'rgba(255,255,255,0.2)', margin: '0 6px', alignSelf: 'center' };

    // Proximity magnification: calculate scale for each icon based on mouse distance
    const getIconScale = (itemIndex) => {
        if (mousePos === null) return 1;
        if (!dockMagnification) return 1;
        // Count only non-separator items up to this index to get the icon position
        let iconIdx = 0;
        for (let i = 0; i < itemIndex; i++) {
            if (allItems[i] !== 'sep') iconIdx++;
        }
        const gap = iconSize + 5; // icon size + padding
        const iconCenter = iconIdx * gap + gap / 2;
        const distance = Math.abs(mousePos - iconCenter);
        const maxDistance = gap * 2.5;
        if (distance > maxDistance) return 1;
        const scale = 1 + 0.3 * Math.cos((distance / maxDistance) * Math.PI / 2);
        return scale;
    };

    const handleDockMouseMove = (e) => {
        if (!dockRef.current || !dockMagnification) return;
        const rect = dockRef.current.getBoundingClientRect();
        if (isVertical) {
            setMousePos(e.clientY - rect.top);
        } else {
            setMousePos(e.clientX - rect.left);
        }
    };

    const handleDockMouseLeave = () => {
        setMousePos(null);
        setHovered(false);
    };

    return (
        <div className={containerClass} style={positionStyle}
            onMouseEnter={() => setHovered(true)} onMouseLeave={handleDockMouseLeave}>
            <div ref={dockRef}
                className={`glass-dock flex items-${isVertical ? 'center' : 'end'} ${isVertical ? 'px-1 py-2' : 'px-2 py-1'} rounded-2xl border border-white/20 shadow-2xl gap-0.5 ${flexDir}`}
                onMouseMove={handleDockMouseMove}>
                {allItems.map((app, i) => {
                    if (app === 'sep') return <div key={`sep-${i}`} style={sepStyle}/>;

                    const isOpen = openApps.has(app.type) || app.type === 'finder';
                    const Icon = app.Icon;
                    const scale = getIconScale(i);
                    const isBouncing = bouncingApp === app.type;
                    const liftPx = (scale - 1) * iconSize * 0.4;

                    const iconTransform = isVertical
                        ? `scale(${scale}) translateX(${liftPx}px)`
                        : `scale(${scale}) translateY(${-liftPx}px)`;

                    return (
                        <div key={app.type}
                            className="dock-item-base flex flex-col items-center p-0.5 cursor-default relative group"
                            onClick={() => handleClick(app.type, app.name)}>
                            {/* Tooltip */}
                            <div className={`absolute ${isVertical ? 'left-full ml-2 top-1/2 -translate-y-1/2' : 'left-1/2 -translate-x-1/2'} opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50`}
                                style={!isVertical ? { bottom: iconSize + 28 + 'px' } : undefined}>
                                <div className="glass-dark px-3 py-1 rounded-md text-white text-[12px] whitespace-nowrap border border-white/10 shadow-lg">
                                    {app.name}
                                </div>
                            </div>

                            <div className={`${isBouncing ? 'animate-bounce-dock' : ''} transition-transform duration-100 ease-out`}
                                style={{
                                    transform: isBouncing ? undefined : iconTransform,
                                    transformOrigin: isVertical ? 'center left' : 'bottom center',
                                    filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))',
                                }}>
                                <div className="flex items-center justify-center flex-shrink-0 overflow-hidden"
                                    style={{ width: iconSize + 'px', height: iconSize + 'px' }}>
                                    <Icon size={iconSize}/>
                                </div>
                            </div>

                            {/* Active indicator */}
                            {!isVertical && <div className={`w-1 h-1 rounded-full mt-0.5 transition-opacity ${isOpen ? 'bg-white/80 opacity-100' : 'opacity-0'}`}/>}
                            {isVertical && <div className={`absolute ${dockPosition === 'left' ? '-left-1' : '-right-1'} top-1/2 -translate-y-1/2 w-1 h-1 rounded-full transition-opacity ${isOpen ? 'bg-white/80 opacity-100' : 'opacity-0'}`}/>}
                        </div>
                    );
                })}
            </div>
        </div>
    );
};


window.Dock = Dock;
</script>

<script type="text/babel">
// Spotlight Search
const SpotlightSearch = () => {
    const isOpen = useStore(s => s.spotlightOpen);
    const [query, setQuery] = React.useState('');
    const inputRef = React.useRef(null);

    const apps = [
        { name: 'Finder', type: 'finder' }, { name: 'Safari', type: 'safari' },
        { name: 'Messages', type: 'messages' }, { name: 'Mail', type: 'mail' },
        { name: 'Maps', type: 'maps' }, { name: 'Photos', type: 'photos' },
        { name: 'Notes', type: 'notes' }, { name: 'Calculator', type: 'calculator' },
        { name: 'Terminal', type: 'terminal' }, { name: 'System Settings', type: 'settings' },
        { name: 'TextEdit', type: 'textedit' }, { name: 'Calendar', type: 'calendar' },
    ];

    const { shouldRender, isClosing } = useAnimatedVisibility(isOpen, 150);

    React.useEffect(() => {
        if (isOpen) { setQuery(''); setTimeout(() => inputRef.current?.focus(), 50); }
    }, [isOpen]);

    if (!shouldRender) return null;

    const q = query.toLowerCase();
    const matched = q ? apps.filter(a => a.name.toLowerCase().includes(q)) : [];

    // Try math
    let calcResult = null;
    if (q && /^[\d\s+\-*/().]+$/.test(q) && q.length > 1) {
        try { calcResult = Function('"use strict"; return (' + q + ')')(); if (isNaN(calcResult)) calcResult = null; } catch(e) {}
    }

    const close = () => MacStore.setState({ spotlightOpen: false });

    const openResult = (type) => {
        const sizes = { finder:{w:900,h:550}, safari:{w:1000,h:650}, calculator:{w:250,h:400}, notes:{w:800,h:550}, terminal:{w:650,h:420}, settings:{w:920,h:600}, messages:{w:800,h:550}, mail:{w:1000,h:600}, maps:{w:850,h:550}, photos:{w:900,h:600}, textedit:{w:650,h:500}, calendar:{w:800,h:600} };
        const s = sizes[type] || {w:800,h:500};
        MacStore.openWindow(type, apps.find(a=>a.type===type)?.name || type, s.w, s.h);
        close();
    };

    return (
        <div className={`fixed inset-0 bg-black/25 z-[10002] flex items-start justify-center pt-[160px] ${isClosing ? 'animate-fade-out' : 'animate-fade-in'}`}
            onClick={(e) => { if (e.target === e.currentTarget) close(); }}
        >
            <div className={`w-[680px] glass-menu rounded-xl shadow-2xl border border-black/10 overflow-hidden ${isClosing ? 'animate-spotlight-out' : 'animate-spotlight-in'}`}>
                <div className="flex items-center gap-3 px-4 py-2.5 border-b border-black/5">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="#999"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input ref={inputRef} type="text" value={query} onChange={e => setQuery(e.target.value)}
                        onKeyDown={e => {
                            if (e.key === 'Escape') close();
                            if (e.key === 'Enter' && matched.length > 0) openResult(matched[0].type);
                        }}
                        placeholder="Spotlight Search" className="flex-1 bg-transparent outline-none text-[20px] font-light font-sf"/>
                </div>
                {(matched.length > 0 || calcResult !== null) && (
                    <div className="max-h-[400px] overflow-y-auto">
                        {matched.length > 0 && (
                            <div className="py-1">
                                <div className="text-[12px] font-semibold text-gray-400 px-5 py-1">Applications</div>
                                {matched.map((app, i) => (
                                    <div key={app.type}
                                        className={`flex items-center gap-3 px-5 py-1.5 mx-2 rounded-md cursor-default ${i === 0 ? 'bg-blue-500 text-white' : 'hover:bg-blue-500 hover:text-white'}`}
                                        onClick={() => openResult(app.type)}
                                    >
                                        <div className="w-8 h-8">
                                            {MacIcons[app.name.replace(' ','')] ? React.createElement(MacIcons[app.name.replace(' ','')], {size: 32}) :
                                                <div className="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white text-sm font-bold">{app.name[0]}</div>}
                                        </div>
                                        <div>
                                            <div className="text-[14px] font-medium">{app.name}</div>
                                            <div className={`text-[11px] ${i === 0 ? 'text-white/70' : 'text-gray-400'}`}>Application</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {calcResult !== null && (
                            <div className="py-1">
                                <div className="text-[12px] font-semibold text-gray-400 px-5 py-1">Calculator</div>
                                <div className="flex items-center gap-3 px-5 py-1.5 mx-2 rounded-md">
                                    <div className="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center text-white text-sm">=</div>
                                    <div>
                                        <div className="text-[14px] font-medium">{calcResult}</div>
                                        <div className="text-[11px] text-gray-400">{query} =</div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {q.length >= 2 && (
                            <div className="py-1 border-t border-black/5">
                                <div className="flex items-center gap-3 px-5 py-1.5 mx-2 rounded-md hover:bg-blue-500 hover:text-white cursor-default"
                                    onClick={() => { MacStore.openWindow('safari','Safari',1000,650); close(); }}>
                                    <div className="w-8 h-8"><MacIcons.Safari size={32}/></div>
                                    <div>
                                        <div className="text-[14px] font-medium">Search the web for "{query}"</div>
                                        <div className="text-[11px] text-gray-400">Safari - Google Search</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};


window.SpotlightSearch = SpotlightSearch;
</script>

<script type="text/babel">
// Control Center - synced with global store
const ControlCenter = () => {
    const isOpen = useStore(s => s.controlCenterOpen);
    const wifiOn = useStore(s => s.wifiOn);
    const bluetoothOn = useStore(s => s.bluetoothOn);
    const focusOn = useStore(s => s.focusOn);
    const darkMode = useStore(s => s.darkMode);
    const brightness = useStore(s => s.brightness);
    const volume = useStore(s => s.volume);
    const accentColor = useStore(s => s.accentColor);

    // Read airDrop from local settings
    const [airdrop, setAirdrop] = React.useState(() => {
        try { return JSON.parse(localStorage.getItem('macos_settings_local') || '{}').airDrop !== false; } catch(e) { return true; }
    });

    const { shouldRender, isClosing } = useAnimatedVisibility(isOpen, 150);
    if (!shouldRender) return null;

    const Tile = ({ active, onClick, icon, label, sublabel }) => (
        <div onClick={onClick}
            className={`rounded-xl p-3 cursor-default text-center transition-colors
                ${active ? 'text-white' : 'bg-white/60 hover:bg-white/80'}`}
            style={active ? { background: accentColor } : undefined}>
            <div className="flex justify-center mb-1.5">{icon}</div>
            <div className="text-[11px] font-semibold">{label}</div>
            {sublabel && <div className="text-[10px] opacity-70">{sublabel}</div>}
        </div>
    );

    return (
        <div className="fixed z-[10001]" style={{ top: '31px', right: '12px' }}
            onClick={e => e.stopPropagation()}>
            <div className={`w-[320px] glass-menu rounded-2xl shadow-2xl border border-black/10 p-3.5 ${isClosing ? 'animate-spotlight-out' : 'animate-spotlight-in'}`}>
                <div className="grid grid-cols-3 gap-2.5 mb-3">
                    <Tile active={wifiOn} onClick={() => MacStore.setState(s => ({ wifiOn: !s.wifiOn }))} label="Wi-Fi" sublabel={wifiOn ? 'Home' : 'Off'}
                        icon={<svg viewBox="0 0 24 24" width="18" height="18" fill={wifiOn ? 'white' : '#333'}><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>}/>
                    <Tile active={bluetoothOn} onClick={() => MacStore.setState(s => ({ bluetoothOn: !s.bluetoothOn }))} label="Bluetooth" sublabel={bluetoothOn ? 'On' : 'Off'}
                        icon={<svg viewBox="0 0 24 24" width="18" height="18" fill={bluetoothOn ? 'white' : '#333'}><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29z"/></svg>}/>
                    <Tile active={airdrop} onClick={() => setAirdrop(!airdrop)} label="AirDrop" sublabel={airdrop ? 'Everyone' : 'Off'}
                        icon={<svg viewBox="0 0 24 24" width="18" height="18" fill={airdrop ? 'white' : '#333'}><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93z"/></svg>}/>
                </div>

                <div className="mb-3">
                    <div className="text-[12px] font-semibold text-gray-400 mb-1.5">Display</div>
                    <div className="flex items-center gap-2 bg-white/60 rounded-xl px-3 py-2">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69z"/></svg>
                        <MacSlider min={10} max={100} value={brightness} onChange={v => MacStore.setState({ brightness: v })} className="flex-1" accentColor={accentColor}/>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="#333"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
                    </div>
                </div>

                <div className="mb-3">
                    <div className="text-[12px] font-semibold text-gray-400 mb-1.5">Sound</div>
                    <div className="flex items-center gap-2 bg-white/60 rounded-xl px-3 py-2">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#666"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
                        <MacSlider min={0} max={100} value={volume} onChange={v => MacStore.setState({ volume: v })} className="flex-1" accentColor={accentColor}/>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="#333"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-2.5">
                    <div onClick={() => MacStore.setState(s => ({ focusOn: !s.focusOn }))}
                        className={`flex flex-col items-center gap-1.5 rounded-xl py-3 cursor-default transition-colors
                            ${focusOn ? 'text-white' : 'bg-white/60 hover:bg-white/80'}`}
                        style={focusOn ? { background: accentColor } : undefined}>
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${focusOn ? 'bg-white/20' : 'bg-black/5'}`}>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill={focusOn ? 'white' : '#333'}><path d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>
                        </div>
                        <span className="text-[11px] font-medium">Focus</span>
                    </div>
                    <div onClick={() => MacStore.setState(s => ({ darkMode: !s.darkMode }))}
                        className={`flex flex-col items-center gap-1.5 rounded-xl py-3 cursor-default transition-colors
                            ${darkMode ? 'text-white' : 'bg-white/60 hover:bg-white/80'}`}
                        style={darkMode ? { background: accentColor } : undefined}>
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${darkMode ? 'bg-white/20' : 'bg-black/5'}`}>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill={darkMode ? 'white' : '#333'}><path d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>
                        </div>
                        <span className="text-[11px] font-medium">Dark Mode</span>
                    </div>
                </div>
            </div>
        </div>
    );
};


window.ControlCenter = ControlCenter;
</script>

<script type="text/babel">
// Notification Center with Widgets - unified panel (date/time click)
const NotificationCenter = () => {
    const isOpen = useStore(s => s.notificationCenterOpen);
    const darkMode = useStore(s => s.darkMode);
    const [checkedReminders, setCheckedReminders] = React.useState(new Set());

    const { shouldRender, isClosing } = useAnimatedVisibility(isOpen, 200);
    if (!shouldRender) return null;

    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    const wTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

    // Build mini calendar
    const year = now.getFullYear();
    const month = now.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const prevDays = new Date(year, month, 0).getDate();
    const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    const calDays = [];
    for (let i = firstDay - 1; i >= 0; i--) calDays.push({ day: prevDays - i, other: true });
    for (let d = 1; d <= daysInMonth; d++) calDays.push({ day: d, today: d === now.getDate(), other: false });
    const remaining = (7 - calDays.length % 7) % 7;
    for (let d = 1; d <= remaining; d++) calDays.push({ day: d, other: true });

    const reminders = ['Review pull requests', 'Update documentation', 'Team meeting at 3 PM', 'Deploy v2.0 to staging'];

    const toggleReminder = (i) => {
        const s = new Set(checkedReminders);
        s.has(i) ? s.delete(i) : s.add(i);
        setCheckedReminders(s);
    };

    return (
        <div className="fixed z-[10001]" style={{ top: '31px', right: '12px' }} onClick={e => e.stopPropagation()}>
            <div className={`w-[340px] max-h-[calc(100vh-100px)] glass rounded-2xl shadow-2xl border border-black/10 overflow-y-auto ${isClosing ? 'animate-slide-out-right' : 'animate-slide-in-right'}`}>

                {/* Notifications section */}
                <div className="p-3.5 pb-0">
                    <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Notifications</div>
                    <div className={`rounded-xl p-3 mb-3 ${darkMode ? 'bg-white/10' : 'bg-white/70'} shadow-sm`}>
                        <div className="flex items-start gap-2.5">
                            <div className="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">m</div>
                            <div className="flex-1">
                                <div className="flex justify-between">
                                    <span className="text-[11px] text-gray-400 font-medium">Messages</span>
                                    <span className="text-[10px] text-gray-400">2m ago</span>
                                </div>
                                <div className="text-[13px] font-semibold">New Message</div>
                                <div className="text-[12px] text-gray-500">Hey, are you free for lunch?</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Widgets section */}
                <div className="p-3.5 pt-0">
                    <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Widgets</div>

                    {/* Clock Widget */}
                    <div className={`rounded-xl p-4 mb-3 ${darkMode ? 'bg-white/10' : 'bg-white/70'} shadow-sm`}>
                        <div className={`text-[32px] font-light ${darkMode ? 'text-white' : 'text-gray-900'}`}>{wTime}</div>
                        <div className={`text-[13px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{dateStr}</div>
                    </div>

                    {/* Calendar Widget */}
                    <div className={`rounded-xl p-3.5 mb-3 ${darkMode ? 'bg-white/10' : 'bg-white/70'} shadow-sm`}>
                        <div className="flex justify-between items-center mb-2.5">
                            <span className="text-[14px] font-semibold">{monthName}</span>
                        </div>
                        <div className="grid grid-cols-7 gap-px text-center">
                            {['Su','Mo','Tu','We','Th','Fr','Sa'].map(d => (
                                <div key={d} className="text-[10px] font-semibold text-gray-400 py-1">{d}</div>
                            ))}
                            {calDays.map((d, i) => (
                                <div key={i}
                                    className={`text-[11px] py-0.5 w-7 h-7 flex items-center justify-center mx-auto rounded-full cursor-default
                                        ${d.today ? 'bg-red-500 text-white font-semibold' : d.other ? 'text-gray-300' : 'hover:bg-black/5'}`}>
                                    {d.day}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Weather Widget */}
                    <div className="rounded-xl p-3.5 mb-3 shadow-sm bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="text-[13px] opacity-70">My Location</div>
                                <div className="text-[38px] font-extralight leading-none my-1">22Â°</div>
                                <div className="text-[13px] opacity-80">Partly Cloudy</div>
                            </div>
                            <div className="text-[44px]">&#9925;</div>
                        </div>
                        <div className="flex justify-between text-[12px] opacity-60 mt-2">
                            <span>H: 26Â°</span>
                            <span>L: 18Â°</span>
                        </div>
                    </div>

                    {/* Reminders Widget */}
                    <div className={`rounded-xl p-3.5 mb-3 ${darkMode ? 'bg-white/10' : 'bg-white/70'} shadow-sm`}>
                        <div className="text-[14px] font-semibold mb-2.5">Reminders</div>
                        {reminders.map((r, i) => (
                            <div key={i} className="flex items-center gap-2.5 py-1.5 border-b border-black/[0.04] last:border-0">
                                <div
                                    className={`w-[18px] h-[18px] rounded-full border-[1.5px] cursor-default flex items-center justify-center flex-shrink-0 transition-all
                                        ${checkedReminders.has(i) ? 'bg-blue-500 border-blue-500' : 'border-gray-300 hover:border-blue-500'}`}
                                    onClick={() => toggleReminder(i)}
                                >
                                    {checkedReminders.has(i) && <svg viewBox="0 0 24 24" width="12" height="12" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>}
                                </div>
                                <span className={`text-[13px] ${checkedReminders.has(i) ? 'line-through text-gray-400' : ''}`}>{r}</span>
                            </div>
                        ))}
                    </div>

                    {/* Screen Time Widget */}
                    <div className={`rounded-xl p-3.5 ${darkMode ? 'bg-white/10' : 'bg-white/70'} shadow-sm`}>
                        <div className="text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Screen Time</div>
                        <div className={`text-[22px] font-light ${darkMode ? 'text-white' : 'text-gray-900'}`}>3h 24m</div>
                        <div className={`text-[12px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>15% less than yesterday</div>
                    </div>
                </div>
            </div>
        </div>
    );
};


window.NotificationCenter = NotificationCenter;
</script>

<script type="text/babel">
// Context Menu - context-aware with smart edge positioning
const ContextMenuComponent = () => {
    const [menu, setMenu] = React.useState(null); // { x, y, type, data }
    const [closing, setClosing] = React.useState(false);
    const menuRef = React.useRef(null);

    React.useEffect(() => {
        const handler = (e) => {
            e.preventDefault();
            const target = e.target;

            // Check if right-clicked on a desktop file
            const desktopFileEl = target.closest('[data-desktop-file]');
            if (desktopFileEl) {
                const name = desktopFileEl.getAttribute('data-desktop-file');
                const fileType = desktopFileEl.getAttribute('data-file-type');
                setMenu({ x: e.clientX, y: e.clientY, type: 'desktop-file', data: { name, fileType } });
                return;
            }

            // Check if right-clicked on a desktop app shortcut
            const desktopAppEl = target.closest('[data-desktop-app]');
            if (desktopAppEl) {
                const appType = desktopAppEl.getAttribute('data-desktop-app');
                const appName = desktopAppEl.getAttribute('data-app-name');
                setMenu({ x: e.clientX, y: e.clientY, type: 'desktop-app', data: { appType, appName } });
                return;
            }

            // Check if right-clicked on a finder file
            const finderFileEl = target.closest('[data-finder-file]');
            if (finderFileEl) {
                const name = finderFileEl.getAttribute('data-finder-file');
                const path = finderFileEl.getAttribute('data-finder-path');
                const fileType = finderFileEl.getAttribute('data-file-type');
                setMenu({ x: e.clientX, y: e.clientY, type: 'finder-file', data: { name, path, fileType } });
                return;
            }

            // Check if right-clicked on desktop background
            if (target.id === 'desktop-bg' || (target.closest('#desktop-bg') && !target.closest('.glass-menu') && !target.closest('.glass-dock'))) {
                setMenu({ x: e.clientX, y: e.clientY, type: 'desktop-bg', data: {} });
                return;
            }
        };

        const close = () => {
            setClosing(true);
            setTimeout(() => { setMenu(null); setClosing(false); }, 100);
        };
        document.addEventListener('contextmenu', handler);
        document.addEventListener('click', close);
        return () => { document.removeEventListener('contextmenu', handler); document.removeEventListener('click', close); };
    }, []);

    // Smart positioning - adjust if menu goes off screen
    React.useEffect(() => {
        if (!menu || !menuRef.current) return;
        const el = menuRef.current;
        const rect = el.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        let { x, y } = menu;
        let changed = false;

        if (x + rect.width > vw - 8) { x = vw - rect.width - 8; changed = true; }
        if (y + rect.height > vh - 8) { y = vh - rect.height - 8; changed = true; }
        if (x < 4) { x = 4; changed = true; }
        if (y < 4) { y = 4; changed = true; }

        if (changed) {
            el.style.left = x + 'px';
            el.style.top = y + 'px';
        }
    });

    if (!menu && !closing) return null;
    if (!menu) return null;

    const createNewFolder = () => {
        let name = 'untitled folder';
        let i = 1;
        while (VFS.exists('/Users/user/Desktop/' + name)) { name = 'untitled folder ' + i; i++; }
        VFS.mkdir('/Users/user/Desktop', name);
    };

    const createNewFile = () => {
        let name = 'untitled.txt';
        let i = 1;
        while (VFS.exists('/Users/user/Desktop/' + name)) { name = 'untitled ' + i + '.txt'; i++; }
        VFS.touch('/Users/user/Desktop', name, '');
    };

    const moveDesktopFileToTrash = (name) => {
        VFS.moveToTrash('/Users/user/Desktop', name);
        MacStore.addNotification('Finder', 'Moved to Trash', name + ' has been moved to the Trash.');
    };

    const moveFinderFileToTrash = (path, name) => {
        VFS.moveToTrash(path, name);
        MacStore.addNotification('Finder', 'Moved to Trash', name + ' has been moved to the Trash.');
    };

    const removeDesktopApp = (appType) => {
        VFS.removeDesktopApp(appType);
    };

    const renderItems = () => {
        switch (menu.type) {
            case 'desktop-file':
                return (<>
                    <CtxItem label="Open" onClick={() => {
                        const n = menu.data.name;
                        if (menu.data.fileType === 'folder') MacStore.openWindow('finder', 'Finder', 900, 550);
                        else if (n.endsWith('.py')) {
                            MacStore.setState({ pendingOpenFile: { path: '/Users/user/Desktop', name: n } });
                            MacStore.openWindow('vscode', 'VS Code', 950, 650);
                        }
                        else if (n.endsWith('.txt') || n.endsWith('.md') || n.endsWith('.docx') || n.endsWith('.doc')) {
                            MacStore.setState({ pendingOpenFile: { path: '/Users/user/Desktop', name: n } });
                            MacStore.openWindow('word', 'Word', 900, 700);
                        }
                    }}/>
                    <CtxItem label="Get Info"/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Move to Trash" danger onClick={() => moveDesktopFileToTrash(menu.data.name)}/>
                </>);

            case 'desktop-app':
                return (<>
                    <CtxItem label="Open" onClick={() => {
                        const sizes = { finder:{w:900,h:550}, safari:{w:1000,h:650}, calculator:{w:250,h:400}, notes:{w:800,h:550}, terminal:{w:650,h:420}, settings:{w:920,h:600}, messages:{w:800,h:550}, mail:{w:1000,h:600}, maps:{w:850,h:550}, photos:{w:900,h:600}, word:{w:900,h:700}, trash:{w:700,h:450}, calendar:{w:800,h:600}, music:{w:950,h:600}, appstore:{w:950,h:650}, snake:{w:530,h:500}, tetris:{w:480,h:560}, game2048:{w:430,h:550}, vscode:{w:950,h:650}, paint:{w:1000,h:700} };
                        const s = sizes[menu.data.appType] || { w: 800, h: 500 };
                        MacStore.openWindow(menu.data.appType, menu.data.appName, s.w, s.h);
                    }}/>
                    <CtxItem label="Get Info"/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Remove from Desktop" onClick={() => removeDesktopApp(menu.data.appType)}/>
                </>);

            case 'finder-file':
                return (<>
                    <CtxItem label="Open" onClick={() => {
                        const n = menu.data.name;
                        if (menu.data.fileType === 'folder') {
                            // Finder navigation handled separately
                        } else if (n.endsWith('.py')) {
                            MacStore.setState({ pendingOpenFile: { path: menu.data.path, name: n } });
                            MacStore.openWindow('vscode', 'VS Code', 950, 650);
                        } else if (n.endsWith('.txt') || n.endsWith('.md') || n.endsWith('.docx') || n.endsWith('.doc')) {
                            MacStore.setState({ pendingOpenFile: { path: menu.data.path, name: n } });
                            MacStore.openWindow('word', 'Word', 900, 700);
                        }
                    }}/>
                    <CtxItem label="Get Info"/>
                    <CtxItem label="Rename"/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Move to Trash" danger onClick={() => moveFinderFileToTrash(menu.data.path, menu.data.name)}/>
                </>);

            case 'desktop-bg':
            default:
                return (<>
                    <CtxItem label="New Folder" onClick={createNewFolder}/>
                    <CtxItem label="New File" onClick={createNewFile}/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Get Info"/>
                    <CtxItem label="Change Wallpaper..." onClick={() => MacStore.nextWallpaper()}/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Sort By" hasArrow/>
                    <CtxItem label="Clean Up"/>
                    <div className="h-px bg-black/10 my-1 mx-3"/>
                    <CtxItem label="Add App to Desktop" onClick={() => {
                        const apps = ['safari','calculator','notes','terminal','music','photos','maps'];
                        const names = ['Safari','Calculator','Notes','Terminal','Music','Photos','Maps'];
                        const idx = Math.floor(Math.random() * apps.length);
                        VFS.addDesktopApp(apps[idx], names[idx]);
                    }}/>
                    <CtxItem label="Open Finder" onClick={() => MacStore.openWindow('finder','Finder',900,550)}/>
                </>);
        }
    };

    return (
        <div ref={menuRef} className={`fixed glass-menu rounded-lg min-w-[220px] py-1 shadow-xl border border-black/10 z-[10003] ${closing ? 'animate-context-menu-out pointer-events-none' : 'animate-context-menu-in'}`}
            style={{ left: menu.x, top: menu.y, transformOrigin: 'top left' }}>
            {renderItems()}
        </div>
    );
};

const CtxItem = ({ label, onClick, hasArrow, danger }) => (
    <div className={`flex items-center justify-between px-4 py-[3px] mx-1 rounded text-[13px] cursor-default min-h-[22px] hover:bg-blue-500 hover:text-white ${danger ? 'text-red-500' : ''}`}
        onClick={onClick}>
        <span>{label}</span>
        {hasArrow && <span className="text-[10px] text-gray-400">&#9654;</span>}
    </div>
);


window.ContextMenuComponent = ContextMenuComponent;
window.CtxItem = CtxItem;
</script>

<script type="text/babel">
// macOS Lock Screen with wake animation
const LockScreen = () => {
    const locked = useStore(s => s.locked);
    const wallpaperIndex = useStore(s => s.wallpaperIndex);
    const [unlocking, setUnlocking] = React.useState(false);
    const [waking, setWaking] = React.useState(true);
    const [time, setTime] = React.useState('');
    const [date, setDate] = React.useState('');
    const inputRef = React.useRef(null);

    const wallpaperStyle = {
        backgroundImage: 'url(' + WALLPAPERS[wallpaperIndex].path + ')',
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        filter: 'brightness(0.65)',
    };

    React.useEffect(() => {
        const update = () => {
            const now = new Date();
            setTime(now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }));
            setDate(now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }));
        };
        update();
        const t = setInterval(update, 1000);
        return () => clearInterval(t);
    }, []);

    React.useEffect(() => {
        if (locked) {
            setUnlocking(false);
            setWaking(true);
            // Wake animation: screen "turns on" like a real display
            setTimeout(() => setWaking(false), 800);
            setTimeout(() => inputRef.current?.focus(), 900);
        }
    }, [locked]);

    const unlock = () => {
        setUnlocking(true);
        setTimeout(() => {
            MacStore.setState({ locked: false });
            setUnlocking(false);
        }, 600);
    };

    if (!locked) return null;

    return (
        <div className={`fixed inset-0 z-[99999] flex items-center justify-center cursor-default ${unlocking ? 'animate-unlock pointer-events-none' : ''} ${waking ? 'animate-lock-wake' : ''}`}
            style={{ transformOrigin: 'center center' }}>
            {/* Wallpaper background */}
            <div className="absolute inset-0" style={wallpaperStyle}/>

            {/* Sleep overlay that fades away */}
            {waking && <div className="absolute inset-0 bg-black z-20 pointer-events-none" style={{ animation: 'fade-out 0.6s ease-out 0.2s forwards' }}/>}

            <div className={`relative z-10 text-center text-white transition-opacity duration-500 ${waking ? 'opacity-0' : 'opacity-100'}`}
                style={{ transitionDelay: '0.4s' }}>
                <div className="text-[82px] font-bold tracking-tight leading-none mb-1"
                    style={{ textShadow: '0 2px 20px rgba(0,0,0,0.3)' }}>
                    {time}
                </div>
                <div className="text-[22px] font-medium opacity-90 mb-16"
                    style={{ textShadow: '0 1px 10px rgba(0,0,0,0.3)' }}>
                    {date}
                </div>

                {/* User avatar */}
                <div className="flex flex-col items-center gap-3">
                    <div className="w-20 h-20 rounded-full overflow-hidden shadow-xl bg-gray-500 ring-2 ring-white/20 flex items-center justify-center">
                        <svg viewBox="0 0 100 100" width="80" height="80"><circle cx="50" cy="50" r="50" fill="#7d7d7d"/><circle cx="50" cy="38" r="18" fill="#a0a0a0"/><ellipse cx="50" cy="80" rx="30" ry="22" fill="#a0a0a0"/></svg>
                    </div>
                    <div className="text-[17px] font-semibold">User</div>
                    <input
                        ref={inputRef}
                        type="password"
                        placeholder="Enter Password"
                        onKeyDown={e => e.key === 'Enter' && unlock()}
                        className="w-[200px] px-4 py-2 rounded-full bg-white/20 backdrop-blur-xl text-white text-[14px] text-center outline-none placeholder-white/50 border border-white/10 font-sf"
                    />
                    <div className="text-[12px] opacity-40 mt-1">Press Enter to unlock</div>
                </div>
            </div>
        </div>
    );
};


window.LockScreen = LockScreen;
</script>

<script type="text/babel">
// Helper: hex to rgb string
const hexToRgb = (hex) => {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return r + ',' + g + ',' + b;
};

// Desktop - main workspace with all overlays
const Desktop = () => {
    const windows = useStore(s => s.windows);
    const launchpadOpen = useStore(s => s.launchpadOpen);
    const aboutMacOpen = useStore(s => s.aboutMacOpen);
    const notifications = useStore(s => s.notifications);
    const wallpaperIndex = useStore(s => s.wallpaperIndex);
    const vfsVersion = useStore(s => s.vfsVersion);
    const darkMode = useStore(s => s.darkMode);
    const brightness = useStore(s => s.brightness);
    const nightShift = useStore(s => s.nightShift);
    const accentColor = useStore(s => s.accentColor);
    const reduceMotion = useStore(s => s.reduceMotion);
    const increaseContrast = useStore(s => s.increaseContrast);
    const reduceTransparency = useStore(s => s.reduceTransparency);
    const largerText = useStore(s => s.largerText);
    const dockPosition = useStore(s => s.dockPosition);
    const missionControlOpen = useStore(s => s.missionControlOpen);
    const stageManagerOn = useStore(s => s.stageManagerOn);
    const appSwitcherOpen = useStore(s => s.appSwitcherOpen);
    const appSwitcherIndex = useStore(s => s.appSwitcherIndex);
    const quickLookFile = useStore(s => s.quickLookFile);
    const windowSnapPreview = useStore(s => s.windowSnapPreview);

    // Apply global CSS classes and variables to document
    React.useEffect(() => {
        const root = document.documentElement;
        root.style.setProperty('--accent-color', accentColor);
        root.style.setProperty('--accent-rgb', hexToRgb(accentColor));
        root.classList.toggle('dark-mode', darkMode);
        root.classList.toggle('reduce-motion', reduceMotion);
        root.classList.toggle('increase-contrast', increaseContrast);
        root.classList.toggle('reduce-transparency', reduceTransparency);
        root.classList.toggle('larger-text', largerText);
    }, [accentColor, darkMode, reduceMotion, increaseContrast, reduceTransparency, largerText]);

    // Dynamic wallpaper: shift hue based on time of day
    const [wallpaperFilter, setWallpaperFilter] = React.useState('');
    React.useEffect(() => {
        const update = () => {
            const h = new Date().getHours();
            // Morning (6-10): warm golden, Day (10-16): neutral, Evening (16-20): warm orange, Night (20-6): cool blue
            let filter = '';
            if (h >= 6 && h < 10) filter = 'sepia(0.15) saturate(1.2) hue-rotate(-10deg) brightness(1.05)';
            else if (h >= 16 && h < 20) filter = 'sepia(0.2) saturate(1.3) hue-rotate(-15deg) brightness(0.95)';
            else if (h >= 20 || h < 6) filter = 'saturate(0.8) hue-rotate(10deg) brightness(0.85)';
            else filter = '';
            setWallpaperFilter(filter);
        };
        update();
        const t = setInterval(update, 60000);
        return () => clearInterval(t);
    }, []);

    const wallpaperStyle = {
        backgroundImage: 'url(' + WALLPAPERS[wallpaperIndex].path + ')',
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        filter: wallpaperFilter,
    };

    const appComponents = {
        finder: FinderApp, safari: SafariApp, calculator: CalculatorApp, notes: NotesApp,
        terminal: TerminalApp, settings: SettingsApp, messages: MessagesApp, mail: MailApp,
        calendar: CalendarApp, photos: PhotosApp, word: WordApp, trash: TrashApp,
        maps: MapsApp, music: MusicApp, appstore: AppStoreApp, snake: SnakeGameApp,
        tetris: TetrisGameApp, game2048: Game2048App, vscode: VSCodeApp, paint: PaintApp,
        aboutdev: AboutDeveloperApp,
    };

    const handleDesktopClick = (e) => {
        if (e.target.id === 'desktop-bg' || e.target.closest('.desktop-icons')) {
            MacStore.unfocusAll();
            MacStore.setState({
                controlCenterOpen: false, notificationCenterOpen: false,
                spotlightOpen: false, launchpadOpen: false, aboutMacOpen: false, activeDropdown: null,
            });
        }
    };

    const [selectedDesktopItem, setSelectedDesktopItem] = React.useState(null);

    // === ENHANCED KEYBOARD SHORTCUTS ===
    React.useEffect(() => {
        const handler = (e) => {
            const meta = e.metaKey || e.ctrlKey;
            const shift = e.shiftKey;
            const alt = e.altKey;
            const state = MacStore.getState();
            const activeWin = state.windows.find(w => w.focused);

            if (e.key === 'Escape') {
                MacStore.setState({ spotlightOpen: false, controlCenterOpen: false, notificationCenterOpen: false, launchpadOpen: false, aboutMacOpen: false, missionControlOpen: false, quickLookFile: null, });
                return;
            }

            // Cmd+Tab - App Switcher
            if (meta && e.key === 'Tab') {
                e.preventDefault();
                const openWins = state.windows.filter(w => !w.minimized);
                if (openWins.length === 0) return;
                if (!state.appSwitcherOpen) {
                    MacStore.setState({ appSwitcherOpen: true, appSwitcherIndex: 0 });
                } else {
                    MacStore.setState(s => ({ appSwitcherIndex: (s.appSwitcherIndex + 1) % openWins.length }));
                }
                return;
            }

            // Space - QuickLook for selected desktop item
            if (e.key === ' ' && !meta && !e.target.closest('input') && !e.target.closest('textarea') && !e.target.closest('[contenteditable]')) {
                if (selectedDesktopItem && selectedDesktopItem.startsWith('file-')) {
                    e.preventDefault();
                    const fileName = selectedDesktopItem.replace('file-', '');
                    const fileData = VFS.get('/Users/user/Desktop/' + fileName);
                    if (fileData && fileData.type !== 'dir') {
                        MacStore.setState({ quickLookFile: { name: fileName, icon: fileData.icon, content: fileData.content || '', type: fileData.type, size: fileData.size } });
                    }
                    return;
                }
            }

            if (!meta) return;
            if (e.code === 'Space' && !shift) { e.preventDefault(); MacStore.setState(s => ({ spotlightOpen: !s.spotlightOpen })); return; }
            if (e.key === 'w' && !shift) { e.preventDefault(); if (activeWin) MacStore.closeWindow(activeWin.id); return; }
            if (e.key === 'q' && !shift && !e.ctrlKey) { e.preventDefault(); if (activeWin) MacStore.closeWindow(activeWin.id); return; }
            if (e.key === 'm' && !shift) { e.preventDefault(); if (activeWin) MacStore.minimizeWindow(activeWin.id); return; }
            if (e.key === 'h' && !shift && !alt) { e.preventDefault(); if (activeWin) MacStore.minimizeWindow(activeWin.id); return; }
            if (e.key === 'n' && !shift) { e.preventDefault(); MacStore.openWindow('finder', 'Finder', 900, 550); return; }
            if (e.key === 'n' && shift) {
                e.preventDefault();
                let name = 'untitled folder'; let c = 1;
                while (VFS.exists('/Users/user/Desktop/' + name)) { name = 'untitled folder ' + c; c++; }
                VFS.mkdir('/Users/user/Desktop', name);
                return;
            }
            if (e.key === ',') { e.preventDefault(); MacStore.openWindow('settings', 'System Settings', 920, 600); return; }
            if (e.key === 'f' && !shift) { e.preventDefault(); MacStore.setState(s => ({ spotlightOpen: !s.spotlightOpen })); return; }
            if (e.key === 'q' && shift) { e.preventDefault(); MacStore.setState({ locked: true }); return; }
            // F3 or Ctrl+Up for Mission Control
            if (e.key === 'ArrowUp' && meta) { e.preventDefault(); MacStore.setState(s => ({ missionControlOpen: !s.missionControlOpen })); return; }
        };

        // Cmd+Tab release handler
        const keyUp = (e) => {
            const state = MacStore.getState();
            if (state.appSwitcherOpen && (e.key === 'Meta' || e.key === 'Control')) {
                const openWins = state.windows.filter(w => !w.minimized);
                if (openWins.length > 0 && openWins[state.appSwitcherIndex]) {
                    MacStore.focusWindow(openWins[state.appSwitcherIndex].id);
                }
                MacStore.setState({ appSwitcherOpen: false, appSwitcherIndex: 0 });
            }
        };

        window.addEventListener('keydown', handler);
        window.addEventListener('keyup', keyUp);
        return () => { window.removeEventListener('keydown', handler); window.removeEventListener('keyup', keyUp); };
    }, [selectedDesktopItem]);

    const desktopFiles = VFS.ls('/Users/user/Desktop');
    const desktopApps = VFS.getDesktopApps();

    const appIconMap = {
        finder: MacIcons.Finder, safari: MacIcons.Safari, messages: MacIcons.Messages,
        mail: MacIcons.Mail, maps: MacIcons.Maps, photos: MacIcons.Photos,
        notes: MacIcons.Notes, calendar: MacIcons.Calendar, calculator: MacIcons.Calculator,
        terminal: MacIcons.Terminal, word: MacIcons.Word, trash: MacIcons.Trash, settings: MacIcons.Settings,
        music: MacIcons.Music, appstore: MacIcons.AppStore,
        snake: MacIcons.Snake, tetris: MacIcons.Tetris, game2048: MacIcons.Game2048,
        vscode: MacIcons.VSCode, paint: MacIcons.Paint, aboutdev: MacIcons.AboutDev,
    };

    const launchpadApps = [
        { type: 'finder', name: 'Finder', Icon: MacIcons.Finder },
        { type: 'safari', name: 'Safari', Icon: MacIcons.Safari },
        { type: 'messages', name: 'Messages', Icon: MacIcons.Messages },
        { type: 'mail', name: 'Mail', Icon: MacIcons.Mail },
        { type: 'maps', name: 'Maps', Icon: MacIcons.Maps },
        { type: 'photos', name: 'Photos', Icon: MacIcons.Photos },
        { type: 'notes', name: 'Notes', Icon: MacIcons.Notes },
        { type: 'calendar', name: 'Calendar', Icon: MacIcons.Calendar },
        { type: 'calculator', name: 'Calculator', Icon: MacIcons.Calculator },
        { type: 'terminal', name: 'Terminal', Icon: MacIcons.Terminal },
        { type: 'word', name: 'Word', Icon: MacIcons.Word },
        { type: 'settings', name: 'Settings', Icon: MacIcons.Settings },
        { type: 'music', name: 'Music', Icon: MacIcons.Music },
        { type: 'appstore', name: 'App Store', Icon: MacIcons.AppStore },
        { type: 'aboutdev', name: 'About Dev', Icon: MacIcons.AboutDev },
    ];

    // Add downloaded apps to launchpad
    try {
        const downloaded = JSON.parse(localStorage.getItem('macos_appstore_downloads') || '{}');
        const downloadedIconMap = { snake: MacIcons.Snake, tetris: MacIcons.Tetris, game2048: MacIcons.Game2048, vscode: MacIcons.VSCode, paint: MacIcons.Paint };
        Object.entries(downloaded).forEach(([name, appType]) => {
            if (downloadedIconMap[appType] && !launchpadApps.find(a => a.type === appType)) {
                launchpadApps.push({ type: appType, name, Icon: downloadedIconMap[appType] });
            }
        });
    } catch(e) {}

    const appSizes = {
        finder: { w: 900, h: 550 }, safari: { w: 1000, h: 650 }, calculator: { w: 250, h: 400 },
        notes: { w: 800, h: 550 }, terminal: { w: 650, h: 420 }, settings: { w: 920, h: 600 },
        messages: { w: 800, h: 550 }, mail: { w: 1000, h: 600 }, maps: { w: 850, h: 550 },
        photos: { w: 900, h: 600 }, word: { w: 900, h: 700 }, trash: { w: 700, h: 450 },
        calendar: { w: 800, h: 600 }, music: { w: 950, h: 600 }, appstore: { w: 950, h: 650 },
        snake: { w: 530, h: 500 }, tetris: { w: 480, h: 560 }, game2048: { w: 430, h: 550 },
        vscode: { w: 950, h: 650 }, paint: { w: 1000, h: 700 }, aboutdev: { w: 550, h: 580 },
    };

    const openApp = (type, name) => {
        const size = appSizes[type] || { w: 800, h: 500 };
        MacStore.openWindow(type, name, size.w, size.h);
        MacStore.setState({ launchpadOpen: false, missionControlOpen: false });
    };

    // --- Drag and drop for desktop icons ---
    const [iconPositions, setIconPositions] = React.useState(() => {
        const saved = localStorage.getItem('macos_desktop_icon_positions');
        if (saved) try { return JSON.parse(saved); } catch(e) {}
        return {};
    });
    const [dragging, setDragging] = React.useState(null);
    const [dropTargetFolder, setDropTargetFolder] = React.useState(null);
    const dragRef = React.useRef({ startX: 0, startY: 0, origX: 0, origY: 0, key: null, moved: false, fileName: null, isFile: false });

    const allDesktopItems = [];
    desktopApps.forEach(app => {
        const Icon = appIconMap[app.type];
        if (Icon) allDesktopItems.push({ key: 'app-' + app.type, type: 'app', appType: app.type, name: app.name, Icon });
    });
    desktopFiles.forEach(file => {
        allDesktopItems.push({ key: 'file-' + file.name, type: 'file', file });
    });

    // Clean up stale icon positions for files no longer on desktop
    React.useEffect(() => {
        const validKeys = new Set(allDesktopItems.map(item => item.key));
        setIconPositions(prev => {
            const keys = Object.keys(prev);
            const stale = keys.filter(k => !validKeys.has(k));
            if (stale.length === 0) return prev;
            const next = { ...prev };
            stale.forEach(k => delete next[k]);
            localStorage.setItem('macos_desktop_icon_positions', JSON.stringify(next));
            return next;
        });
    }, [vfsVersion]);

    // Grid constants for icon snapping
    const GRID_W = 90;
    const GRID_H = 85;
    const GRID_TOP = 35;
    const GRID_RIGHT_MARGIN = 5;

    const getDefaultPos = (index) => {
        const colH = Math.floor((window.innerHeight - 120) / GRID_H);
        const col = Math.floor(index / colH);
        const row = index % colH;
        return { x: window.innerWidth - GRID_W - GRID_RIGHT_MARGIN - col * GRID_W, y: GRID_TOP + row * GRID_H };
    };

    const getPos = (key, index) => iconPositions[key] || getDefaultPos(index);

    // Snap position to nearest unoccupied grid cell
    const snapToGrid = (rawX, rawY, draggedKey) => {
        const col = Math.round((rawX - GRID_RIGHT_MARGIN) / GRID_W);
        const row = Math.round((rawY - GRID_TOP) / GRID_H);
        const snappedX = Math.max(0, Math.min(window.innerWidth - GRID_W, col * GRID_W + GRID_RIGHT_MARGIN));
        const snappedY = Math.max(GRID_TOP, Math.min(window.innerHeight - 100, row * GRID_H + GRID_TOP));

        const occupied = new Set();
        allDesktopItems.forEach((item, idx) => {
            if (item.key === draggedKey) return;
            const p = getPos(item.key, idx);
            const cx = Math.round((p.x - GRID_RIGHT_MARGIN) / GRID_W);
            const cy = Math.round((p.y - GRID_TOP) / GRID_H);
            occupied.add(cx + ',' + cy);
        });

        const targetCol = Math.round((snappedX - GRID_RIGHT_MARGIN) / GRID_W);
        const targetRow = Math.round((snappedY - GRID_TOP) / GRID_H);

        if (!occupied.has(targetCol + ',' + targetRow)) {
            return { x: snappedX, y: snappedY };
        }

        let bestDist = Infinity;
        let bestPos = { x: snappedX, y: snappedY };
        const maxCols = Math.floor(window.innerWidth / GRID_W);
        const maxRows = Math.floor((window.innerHeight - 120) / GRID_H);
        for (let r = 0; r <= maxRows; r++) {
            for (let c = 0; c <= maxCols; c++) {
                if (occupied.has(c + ',' + r)) continue;
                const cx = c * GRID_W + GRID_RIGHT_MARGIN;
                const cy = r * GRID_H + GRID_TOP;
                const dist = Math.hypot(cx - rawX, cy - rawY);
                if (dist < bestDist) {
                    bestDist = dist;
                    bestPos = { x: cx, y: cy };
                }
            }
        }
        return bestPos;
    };

    const handleIconMouseDown = (e, key, index, item) => {
        if (e.button !== 0) return;
        const pos = getPos(key, index);
        const isFile = item.type === 'file';
        const fileName = isFile ? item.file.name : null;
        dragRef.current = { startX: e.clientX, startY: e.clientY, origX: pos.x, origY: pos.y, key, moved: false, fileName, isFile };
        setDragging(key);

        const onMove = (ev) => {
            const dx = ev.clientX - dragRef.current.startX;
            const dy = ev.clientY - dragRef.current.startY;
            if (Math.abs(dx) > 4 || Math.abs(dy) > 4) dragRef.current.moved = true;
            if (!dragRef.current.moved) return;
            const newX = Math.max(0, Math.min(window.innerWidth - 80, dragRef.current.origX + dx));
            const newY = Math.max(28, Math.min(window.innerHeight - 100, dragRef.current.origY + dy));
            setIconPositions(prev => {
                const next = { ...prev, [dragRef.current.key]: { x: newX, y: newY } };
                localStorage.setItem('macos_desktop_icon_positions', JSON.stringify(next));
                return next;
            });

            if (dragRef.current.isFile && dragRef.current.fileName) {
                const state = MacStore.getState();
                if (!state.fileDrag || state.fileDrag.name !== dragRef.current.fileName) {
                    MacStore.setState({ fileDrag: { name: dragRef.current.fileName, sourcePath: '/Users/user/Desktop', type: 'desktop' } });
                }
            }

            const el = document.elementFromPoint(ev.clientX, ev.clientY);
            if (el) {
                const folderEl = el.closest('[data-desktop-file][data-file-type="folder"]');
                if (folderEl && folderEl.getAttribute('data-desktop-file') !== dragRef.current.fileName) {
                    setDropTargetFolder(folderEl.getAttribute('data-desktop-file'));
                } else {
                    setDropTargetFolder(null);
                }
            }
        };

        const onUp = (ev) => {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);

            if (dragRef.current.moved) {
                let movedToFolder = false;

                if (dragRef.current.isFile && dragRef.current.fileName) {
                    if (dropTargetFolder) {
                        const destPath = '/Users/user/Desktop/' + dropTargetFolder;
                        if (VFS.isDir(destPath)) {
                            VFS.move('/Users/user/Desktop', dragRef.current.fileName, destPath);
                            MacStore.addNotification('Finder', 'Moved', dragRef.current.fileName + ' â†’ ' + dropTargetFolder);
                            movedToFolder = true;
                            setIconPositions(prev => {
                                const next = { ...prev };
                                delete next['file-' + dragRef.current.fileName];
                                localStorage.setItem('macos_desktop_icon_positions', JSON.stringify(next));
                                return next;
                            });
                        }
                    }
                }

                if (!movedToFolder) {
                    const curPos = iconPositions[dragRef.current.key] || getDefaultPos(0);
                    const snapped = snapToGrid(curPos.x, curPos.y, dragRef.current.key);
                    setIconPositions(prev => {
                        const next = { ...prev, [dragRef.current.key]: snapped };
                        localStorage.setItem('macos_desktop_icon_positions', JSON.stringify(next));
                        return next;
                    });
                }
            }

            setDragging(null);
            setDropTargetFolder(null);
            MacStore.setState({ fileDrag: null });
            dragRef.current.moved = false;
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
    };

    // Launchpad search
    const [lpSearch, setLpSearch] = React.useState('');
    const filteredLpApps = lpSearch
        ? launchpadApps.filter(a => a.name.toLowerCase().includes(lpSearch.toLowerCase()))
        : launchpadApps;
    // Launchpad pages
    const LP_PER_PAGE = 21;
    const [lpPage, setLpPage] = React.useState(0);
    const lpPages = [];
    for (let i = 0; i < filteredLpApps.length; i += LP_PER_PAGE) {
        lpPages.push(filteredLpApps.slice(i, i + LP_PER_PAGE));
    }
    React.useEffect(() => { if (!launchpadOpen) { setLpSearch(''); setLpPage(0); } }, [launchpadOpen]);

    return (
        <div id="desktop-bg" className="fixed inset-0 overflow-hidden" style={wallpaperStyle} onMouseDown={handleDesktopClick}>
            <MenuBar />

            {/* Desktop Icons */}
            <div className="desktop-icons absolute inset-0 top-[28px] bottom-[80px]"
                onClick={(e) => { if (e.target === e.currentTarget) setSelectedDesktopItem(null); }}>
                {allDesktopItems.map((item, index) => {
                    const pos = getPos(item.key, index);
                    const isSelected = selectedDesktopItem === item.key;
                    const isDrag = dragging === item.key;

                    if (item.type === 'app') {
                        const Icon = item.Icon;
                        return (
                            <div key={item.key}
                                data-desktop-app={item.appType} data-app-name={item.name}
                                className={`absolute flex flex-col items-center gap-0.5 p-1 rounded-lg cursor-default w-[80px] ${isSelected ? 'bg-white/25' : 'hover:bg-white/10'} ${isDrag ? 'z-50 opacity-80' : ''}`}
                                style={{ left: pos.x, top: pos.y }}
                                onMouseDown={(e) => { e.stopPropagation(); setSelectedDesktopItem(item.key); handleIconMouseDown(e, item.key, index, item); }}
                                onDoubleClick={() => { if (!dragRef.current.moved) openApp(item.appType, item.name); }}>
                                <div className="w-[48px] h-[48px] flex items-center justify-center flex-shrink-0"><Icon size={48}/></div>
                                <span className="text-[10px] text-white text-center leading-tight drop-shadow-md truncate w-full">{item.name}</span>
                            </div>
                        );
                    } else {
                        const file = item.file;
                        const isFolderDropTarget = dropTargetFolder === file.name && file.type === 'folder';
                        return (
                            <div key={item.key}
                                data-desktop-file={file.name} data-file-type={file.type}
                                className={`absolute flex flex-col items-center gap-0.5 p-1 rounded-lg cursor-default w-[80px] transition-all
                                    ${isSelected ? 'bg-white/25' : 'hover:bg-white/10'}
                                    ${isDrag ? 'z-50 opacity-80' : ''}
                                    ${isFolderDropTarget ? 'bg-blue-400/30 ring-2 ring-blue-400/60 scale-110' : ''}`}
                                style={{ left: pos.x, top: pos.y }}
                                onMouseDown={(e) => { e.stopPropagation(); setSelectedDesktopItem(item.key); handleIconMouseDown(e, item.key, index, item); }}
                                onDoubleClick={() => {
                                    if (dragRef.current.moved) return;
                                    if (file.type === 'folder') MacStore.openWindow('finder', 'Finder', 900, 550);
                                    else if (file.name.endsWith('.py')) {
                                        MacStore.setState({ pendingOpenFile: { path: '/Users/user/Desktop', name: file.name } });
                                        MacStore.openWindow('vscode', 'VS Code', 950, 650);
                                    }
                                    else if (file.name.endsWith('.txt') || file.name.endsWith('.md') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                                        MacStore.setState({ pendingOpenFile: { path: '/Users/user/Desktop', name: file.name } });
                                        MacStore.openWindow('word', 'Word', 900, 700);
                                    }
                                }}>
                                <div className="w-[48px] h-[48px] flex items-center justify-center">
                                    {file.type === 'folder' ? (
                                        <svg viewBox="0 0 48 48" width="40" height="40">
                                            <path d="M6 8h14l4 4h18c1.1 0 2 .9 2 2v24c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2z" fill="#42A5F5"/>
                                            <rect x="4" y="14" width="40" height="24" rx="2" fill="#64B5F6" opacity="0.85"/>
                                        </svg>
                                    ) : <span className="text-[32px]">{file.icon}</span>}
                                </div>
                                <span className="text-[10px] text-white text-center leading-tight drop-shadow-md truncate w-full">{file.name}</span>
                            </div>
                        );
                    }
                })}
            </div>

            {/* Stage Manager - side thumbnails */}
            {stageManagerOn && windows.filter(w => !w.minimized && !w.focused).length > 0 && (
                <div className="fixed left-2 top-[30px] bottom-[80px] w-[120px] z-[9996] flex flex-col gap-2 py-2 animate-stage-slide-in overflow-y-auto">
                    {windows.filter(w => !w.minimized && !w.focused).map(win => (
                        <div key={win.id}
                            className="w-[110px] h-[70px] rounded-lg overflow-hidden cursor-pointer shadow-lg border border-white/20 hover:border-white/50 transition-all hover:scale-105 bg-gray-800/50 backdrop-blur-sm flex items-center justify-center"
                            onClick={() => MacStore.focusWindow(win.id)}>
                            <div className="text-white text-[10px] text-center px-1 truncate">{win.title}</div>
                        </div>
                    ))}
                </div>
            )}

            {/* Windows */}
            <div className="absolute inset-0 pt-[25px] pb-[80px]" style={{ pointerEvents: 'none' }}>
                {windows.map(win => {
                    const AppComponent = appComponents[win.appType];
                    if (!AppComponent) return null;
                    return (
                        <div key={win.id} style={{ pointerEvents: 'auto' }}>
                            <Window windowData={win}><AppComponent /></Window>
                        </div>
                    );
                })}
            </div>

            {/* Window Snap Preview */}
            {windowSnapPreview && (
                <div className={`fixed z-[9995] pointer-events-none animate-snap-preview ${windowSnapPreview === 'left' ? 'left-1 top-[26px]' : 'right-1 top-[26px]'}`}
                    style={{ width: 'calc(50vw - 8px)', height: 'calc(100vh - 34px)', borderRadius: '12px', background: 'rgba(var(--accent-rgb), 0.2)', border: '2px solid rgba(var(--accent-rgb), 0.5)' }}/>
            )}

            {/* === MISSION CONTROL === */}
            {(() => {
                const { shouldRender: mcRender, isClosing: mcClosing } = useAnimatedVisibility(missionControlOpen, 300);
                if (!mcRender) return null;
                const visibleWindows = windows.filter(w => !w.minimized);
                const cols = Math.ceil(Math.sqrt(visibleWindows.length));
                const rows = Math.ceil(visibleWindows.length / cols);
                return (
                    <div className={`fixed inset-0 z-[9997] ${mcClosing ? '' : ''}`}
                        onClick={() => MacStore.setState({ missionControlOpen: false })}>
                        {/* Dark overlay */}
                        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" style={{
                            transition: 'opacity 0.3s',
                            opacity: mcClosing ? 0 : 1
                        }}/>

                        {/* Top bar: Spaces */}
                        <div className="absolute top-3 left-1/2 -translate-x-1/2 flex gap-2 z-10" onClick={e => e.stopPropagation()}>
                            <div className="px-4 py-1.5 rounded-lg bg-white/20 backdrop-blur-xl text-white text-[12px] font-medium border border-white/20 shadow-lg">
                                Desktop 1
                            </div>
                            <div className="px-3 py-1.5 rounded-lg bg-white/10 backdrop-blur-xl text-white/60 text-[12px] border border-white/10 hover:bg-white/20 cursor-pointer">
                                +
                            </div>
                        </div>

                        {/* Window spread */}
                        <div className="absolute inset-0 top-[50px] bottom-[80px] flex items-center justify-center p-12"
                            onClick={e => e.stopPropagation()}>
                            <div className="grid gap-6" style={{
                                gridTemplateColumns: `repeat(${cols}, minmax(200px, 350px))`,
                                maxWidth: '90vw',
                            }}>
                                {visibleWindows.map((win) => (
                                    <div key={win.id}
                                        className="relative rounded-xl overflow-hidden shadow-2xl border-2 border-transparent hover:border-blue-400/60 cursor-pointer transition-all hover:scale-[1.03] group"
                                        style={{ aspectRatio: '16/10', background: darkMode ? '#2d2d2d' : '#f0f0f0' }}
                                        onClick={() => { MacStore.focusWindow(win.id); MacStore.setState({ missionControlOpen: false }); }}>
                                        <div className={`h-[24px] flex items-center px-2 text-[11px] font-medium ${darkMode ? 'bg-[#383838] text-gray-300' : 'bg-[#e8e8e8] text-gray-500'}`}>
                                            <div className="flex gap-1 mr-2">
                                                <div className="w-2 h-2 rounded-full bg-[#FF5F57]"/>
                                                <div className="w-2 h-2 rounded-full bg-[#FFBD2E]"/>
                                                <div className="w-2 h-2 rounded-full bg-[#28C840]"/>
                                            </div>
                                            <span className="truncate">{win.title}</span>
                                        </div>
                                        <div className={`flex-1 flex items-center justify-center text-[24px] opacity-30 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            {win.title.charAt(0)}
                                        </div>
                                        {/* Close button on hover */}
                                        <div className="absolute top-1 left-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                            onClick={(e) => { e.stopPropagation(); MacStore.closeWindow(win.id); }}>
                                            <div className="w-5 h-5 rounded-full bg-gray-800/60 hover:bg-red-500 flex items-center justify-center text-white text-[10px]">x</div>
                                        </div>
                                    </div>
                                ))}
                                {visibleWindows.length === 0 && (
                                    <div className="text-white/50 text-[16px] text-center col-span-full">No open windows</div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            })()}

            {/* === LAUNCHPAD (upgraded with search and pages) === */}
            {(() => {
                const { shouldRender: lpRender, isClosing: lpClosing } = useAnimatedVisibility(launchpadOpen, 200);
                if (!lpRender) return null;
                return (
                    <div className={`fixed inset-0 z-[9997] flex flex-col items-center ${lpClosing ? 'animate-launchpad-out' : 'animate-launchpad-in'}`}
                        onClick={() => MacStore.setState({ launchpadOpen: false })}
                        style={{ background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(30px)', WebkitBackdropFilter: 'blur(30px)' }}>

                        {/* Search bar */}
                        <div className="mt-8 mb-6" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/15 backdrop-blur-xl border border-white/20 w-[280px]">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="white" opacity="0.6"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" placeholder="Search" value={lpSearch} onChange={e => { setLpSearch(e.target.value); setLpPage(0); }}
                                    className="bg-transparent text-white text-[14px] outline-none placeholder-white/50 w-full"/>
                            </div>
                        </div>

                        {/* App grid */}
                        <div className="flex-1 flex items-center justify-center" onClick={e => e.stopPropagation()}>
                            <div className="grid gap-6 p-12" style={{ gridTemplateColumns: 'repeat(7, 90px)' }}>
                                {(lpPages[lpPage] || []).map(app => {
                                    const Icon = app.Icon;
                                    return (
                                        <div key={app.type} className="flex flex-col items-center gap-2 cursor-default group"
                                            onClick={() => openApp(app.type, app.name)}>
                                            <div className="group-hover:scale-110 transition-transform">
                                                <div className="w-[64px] h-[64px] flex items-center justify-center"><Icon size={64}/></div>
                                            </div>
                                            <span className="text-white text-[11px] opacity-90 text-center leading-tight w-[90px] truncate">{app.name}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Page dots */}
                        {lpPages.length > 1 && (
                            <div className="flex gap-2 mb-6" onClick={e => e.stopPropagation()}>
                                {lpPages.map((_, i) => (
                                    <div key={i} className={`w-2 h-2 rounded-full cursor-pointer transition-all ${i === lpPage ? 'bg-white scale-125' : 'bg-white/40 hover:bg-white/60'}`}
                                        onClick={() => setLpPage(i)}/>
                                ))}
                            </div>
                        )}
                    </div>
                );
            })()}

            {/* === QUICKLOOK === */}
            {(() => {
                const { shouldRender: qlRender, isClosing: qlClosing } = useAnimatedVisibility(!!quickLookFile, 150);
                if (!qlRender || !quickLookFile) return null;
                return (
                    <div className={`fixed inset-0 z-[10004] flex items-center justify-center bg-black/30 ${qlClosing ? 'animate-fade-out' : 'animate-fade-in'}`}
                        onClick={() => MacStore.setState({ quickLookFile: null })}>
                        <div className={`glass-menu rounded-2xl shadow-2xl border border-black/10 w-[500px] overflow-hidden ${qlClosing ? 'animate-quicklook-out' : 'animate-quicklook-in'}`}
                            onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between px-4 py-3 border-b border-black/5">
                                <span className="text-[14px] font-medium">{quickLookFile.name}</span>
                                <span className="text-[12px] text-gray-400">{quickLookFile.size}</span>
                            </div>
                            <div className="p-6 min-h-[200px] max-h-[400px] overflow-y-auto">
                                {quickLookFile.content ? (
                                    <pre className="text-[13px] whitespace-pre-wrap font-mono text-gray-700">{quickLookFile.content}</pre>
                                ) : (
                                    <div className="flex flex-col items-center justify-center py-12">
                                        <span className="text-[64px] mb-4">{quickLookFile.icon || 'ðŸ“„'}</span>
                                        <div className="text-[16px] font-medium text-gray-600">{quickLookFile.name}</div>
                                        <div className="text-[13px] text-gray-400 mt-1">{quickLookFile.size}</div>
                                    </div>
                                )}
                            </div>
                            <div className="flex justify-center gap-3 px-4 py-3 border-t border-black/5">
                                <button onClick={() => MacStore.setState({ quickLookFile: null })}
                                    className="px-4 py-1.5 rounded-lg bg-gray-100 text-[12px] font-medium hover:bg-gray-200">Close</button>
                            </div>
                        </div>
                    </div>
                );
            })()}

            {/* === APP SWITCHER (Cmd+Tab) === */}
            {appSwitcherOpen && (() => {
                const openWins = windows.filter(w => !w.minimized);
                if (openWins.length === 0) return null;
                return (
                    <div className="fixed inset-0 z-[10006] flex items-center justify-center pointer-events-none">
                        <div className="glass-dark rounded-2xl px-4 py-3 flex gap-3 animate-app-switcher-in border border-white/10 shadow-2xl pointer-events-auto">
                            {openWins.map((win, i) => {
                                const Icon = appIconMap[win.appType];
                                const isActive = i === appSwitcherIndex;
                                return (
                                    <div key={win.id} className={`flex flex-col items-center gap-1.5 p-2 rounded-xl transition-all ${isActive ? 'bg-white/20 ring-2 ring-white/40' : ''}`}>
                                        <div className="w-[48px] h-[48px] flex items-center justify-center">
                                            {Icon ? <Icon size={48}/> : <div className="w-12 h-12 rounded-xl bg-gray-600 flex items-center justify-center text-white text-[20px]">{win.title[0]}</div>}
                                        </div>
                                        <span className="text-white text-[10px] text-center truncate w-[60px]">{win.title}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })()}

            {/* About This Mac */}
            {(() => {
                const { shouldRender: amRender, isClosing: amClosing } = useAnimatedVisibility(aboutMacOpen, 200);
                if (!amRender) return null;
                return (
                    <div className={`fixed inset-0 z-[10004] flex items-center justify-center bg-black/30 ${amClosing ? 'animate-fade-out' : 'animate-fade-in'}`}
                        onClick={() => MacStore.setState({ aboutMacOpen: false })}>
                        <div className={`glass-menu rounded-2xl shadow-2xl border border-black/10 w-[540px] overflow-hidden ${amClosing ? 'animate-spotlight-out' : 'animate-window-open'}`}
                            onClick={e => e.stopPropagation()}>
                            <div className="p-6 text-center">
                                <svg viewBox="0 0 170 170" width="60" height="60" fill="#333" className="mx-auto mb-4">
                                    <path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.58 6.53-8.33 11.05-11.22 13.56-4.48 4.12-9.28 6.23-14.42 6.35-3.69 0-8.14-1.05-13.32-3.18-5.2-2.12-9.97-3.17-14.34-3.17-4.58 0-9.49 1.05-14.75 3.17-5.26 2.13-9.5 3.24-12.74 3.35-4.93.21-9.84-1.96-14.75-6.52-3.13-2.73-7.04-7.41-11.73-14.04-5.03-7.08-9.17-15.29-12.41-24.65-3.47-10.11-5.21-19.9-5.21-29.38 0-10.86 2.35-20.22 7.04-28.07 3.69-6.3 8.61-11.27 14.76-14.92s12.79-5.51 19.95-5.63c3.91 0 9.05 1.21 15.43 3.59 6.36 2.39 10.45 3.6 12.26 3.6 1.35 0 5.94-1.42 13.72-4.24 7.36-2.62 13.57-3.71 18.66-3.27 13.79 1.11 24.13 6.54 31.01 16.32-12.32 7.47-18.41 17.94-18.28 31.37.12 10.46 3.91 19.17 11.35 26.08 3.38 3.21 7.15 5.68 11.34 7.44-.91 2.64-1.87 5.17-2.89 7.59zM119.11 7.24c0 8.2-3 15.86-8.96 22.95-7.19 8.4-15.89 13.25-25.32 12.49-.12-.97-.19-2-.19-3.07 0-7.87 3.43-16.31 9.51-23.19 3.04-3.49 6.9-6.4 11.58-8.72 4.67-2.29 9.09-3.55 13.24-3.8.12 1.13.14 2.25.14 3.34z"/>
                                </svg>
                                <h2 className="text-[22px] font-bold mb-1">macOS Sonoma</h2>
                                <p className="text-[13px] text-gray-500 mb-4">Version 14.3.1</p>
                                <div className="bg-gray-50 rounded-xl p-4 text-[12px] text-gray-600 text-left space-y-1.5">
                                    <div className="flex justify-between"><span className="text-gray-400">Chip</span><span className="font-medium">Apple M3 Pro</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">Memory</span><span className="font-medium">18 GB</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">Startup Disk</span><span className="font-medium">Macintosh HD</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">Serial Number</span><span className="font-medium">C02YX1ABCDEF</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">macOS Sonoma</span><span className="font-medium">14.3.1 (23D60)</span></div>
                                </div>
                                <div className="mt-4 flex justify-center gap-2">
                                    <button className="px-4 py-1.5 rounded-lg bg-gray-100 text-[12px] font-medium hover:bg-gray-200">System Report...</button>
                                    <button className="px-4 py-1.5 rounded-lg bg-blue-500 text-white text-[12px] font-medium hover:bg-blue-600"
                                        onClick={() => MacStore.setState({ aboutMacOpen: false })}>OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })()}

            <SpotlightSearch />
            <ControlCenter />
            <NotificationCenter />
            <ContextMenuComponent />

            {(() => {
                const [dismissing, setDismissing] = React.useState(new Set());
                return (
                    <div className="fixed top-[32px] right-3 z-[10005] flex flex-col gap-2">
                        {notifications.map(notif => (
                            <div key={notif.id} className={`glass-menu rounded-xl shadow-xl border border-black/10 p-3 w-[320px] cursor-default ${dismissing.has(notif.id) ? 'animate-toast-out' : 'animate-toast-in'}`}
                                onClick={() => {
                                    setDismissing(prev => new Set([...prev, notif.id]));
                                    setTimeout(() => {
                                        MacStore.setState(s => ({ notifications: s.notifications.filter(n => n.id !== notif.id) }));
                                        setDismissing(prev => { const next = new Set(prev); next.delete(notif.id); return next; });
                                    }, 250);
                                }}>
                                <div className="flex items-start gap-2.5">
                                    <div className="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">{notif.app[0]}</div>
                                    <div>
                                        <div className="text-[11px] text-gray-400 font-medium">{notif.app}</div>
                                        <div className="text-[13px] font-semibold">{notif.title}</div>
                                        <div className="text-[12px] text-gray-500">{notif.body}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            })()}

            <Dock />

            {/* Brightness overlay */}
            {brightness < 100 && (
                <div className="fixed inset-0 pointer-events-none z-[99990]"
                    style={{ background: 'black', opacity: (100 - brightness) / 100 * 0.7 }}/>
            )}

            {/* Night Shift warm overlay */}
            {nightShift && (
                <div className="fixed inset-0 pointer-events-none z-[99990]"
                    style={{ background: 'rgba(255, 147, 41, 0.18)', mixBlendMode: 'multiply' }}/>
            )}
        </div>
    );
};


window.Desktop = Desktop;
</script>

<script type="text/babel">
// Main App - root component with boot screen and startup chime
const App = () => {
    const locked = useStore(s => s.locked);
    const [booting, setBooting] = React.useState(true);
    const [bootProgress, setBootProgress] = React.useState(0);

    // Play startup chime
    React.useEffect(() => {
        if (!booting) return;
        // Create a simple startup chime using Web Audio API
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const playChime = () => {
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
                    gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + i * 0.08 + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 1.5);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(ctx.currentTime + i * 0.08);
                    osc.stop(ctx.currentTime + i * 0.08 + 1.5);
                });
            };
            // Try to play immediately, or on first user interaction
            if (ctx.state === 'running') playChime();
            else {
                const resume = () => { ctx.resume().then(playChime); document.removeEventListener('click', resume); document.removeEventListener('keydown', resume); };
                document.addEventListener('click', resume, { once: true });
                document.addEventListener('keydown', resume, { once: true });
            }
        } catch(e) {}
    }, []);

    // Real boot: preload wallpapers + app icons, track actual progress
    React.useEffect(() => {
        if (!booting) return;

        // Collect all image URLs that need preloading
        const imageUrls = [
            // Local wallpapers only (skip online ones to avoid slow boot)
            ...WALLPAPERS.filter(w => !w.path.startsWith('http')).map(w => w.path),
            // App icon images (from MacIcons that use <img>)
            'app icons/fidnericon.png',
            'app icons/safariicon.png',
            'app icons/messagesicon.png',
            'app icons/mailicon.png',
            'app icons/mapsicon.png',
            'app icons/photosicon.png',
            'app icons/calculatoricon.jfif',
            'app icons/terminalicon.jfif',
            'app icons/settingsicon.jpg',
            'app icons/launchpadicon.png',
            'app icons/calendericon.jfif',
            'app icons/wordicon.png',
            'app icons/musicicon.png',
            'app icons/appstoreicon.png',
            'app icons/vscodeicon.jfif',
            'app icons/trashicon.jpg',
        ];

        const total = imageUrls.length;
        let loaded = 0;
        let allLoaded = false;
        let minTimePassed = false;
        let done = false;
        const minDuration = 3000; // Minimum 3 seconds boot time
        const startTime = Date.now();

        const tryFinish = () => {
            if (done || !allLoaded || !minTimePassed) return;
            done = true;
            setBootProgress(100);
            setTimeout(() => setBooting(false), 500);
        };

        const updateProgress = () => {
            loaded++;
            const loadRatio = loaded / total;
            const elapsed = Date.now() - startTime;
            const timeRatio = Math.min(elapsed / minDuration, 1);
            const progress = Math.min(loadRatio, timeRatio);
            const eased = 1 - Math.pow(1 - progress, 2);
            setBootProgress(eased * 100);

            if (loaded >= total) {
                allLoaded = true;
                tryFinish();
            }
        };

        imageUrls.forEach(url => {
            const img = new Image();
            img.onload = updateProgress;
            img.onerror = updateProgress;
            img.src = url;
        });

        // Animate progress smoothly during the minimum wait period
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const timeRatio = Math.min(elapsed / minDuration, 1);
            const loadRatio = loaded / total;
            const progress = Math.min(loadRatio, timeRatio);
            const eased = 1 - Math.pow(1 - progress, 2);
            setBootProgress(eased * 100);
        }, 50);

        // Minimum 3s timer
        const minTimer = setTimeout(() => {
            minTimePassed = true;
            clearInterval(progressInterval);
            tryFinish();
        }, minDuration);

        // Safety timeout: if loading takes more than 10s, finish anyway
        const safetyTimer = setTimeout(() => {
            if (!done) {
                done = true;
                clearInterval(progressInterval);
                setBootProgress(100);
                setTimeout(() => setBooting(false), 500);
            }
        }, 10000);

        return () => {
            clearTimeout(minTimer);
            clearTimeout(safetyTimer);
            clearInterval(progressInterval);
        };
    }, []);

    // Send a welcome notification after unlock
    const prevLocked = React.useRef(true);
    React.useEffect(() => {
        if (prevLocked.current && !locked) {
            setTimeout(() => {
                MacStore.addNotification('macOS Sonoma', 'Welcome Back', 'You have 2 new messages and 1 reminder.');
            }, 1500);
        }
        prevLocked.current = locked;
    }, [locked]);

    if (booting) {
        return (
            <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-[99999]"
                style={{ transition: 'opacity 0.5s ease', opacity: bootProgress >= 100 ? 0 : 1 }}>
                {/* Apple Logo */}
                <svg viewBox="0 0 170 170" width="80" height="80" fill="white" className="mb-8">
                    <path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.58 6.53-8.33 11.05-11.22 13.56-4.48 4.12-9.28 6.23-14.42 6.35-3.69 0-8.14-1.05-13.32-3.18-5.2-2.12-9.97-3.17-14.34-3.17-4.58 0-9.49 1.05-14.75 3.17-5.26 2.13-9.5 3.24-12.74 3.35-4.93.21-9.84-1.96-14.75-6.52-3.13-2.73-7.04-7.41-11.73-14.04-5.03-7.08-9.17-15.29-12.41-24.65-3.47-10.11-5.21-19.9-5.21-29.38 0-10.86 2.35-20.22 7.04-28.07 3.69-6.3 8.61-11.27 14.76-14.92s12.79-5.51 19.95-5.63c3.91 0 9.05 1.21 15.43 3.59 6.36 2.39 10.45 3.6 12.26 3.6 1.35 0 5.94-1.42 13.72-4.24 7.36-2.62 13.57-3.71 18.66-3.27 13.79 1.11 24.13 6.54 31.01 16.32-12.32 7.47-18.41 17.94-18.28 31.37.12 10.46 3.91 19.17 11.35 26.08 3.38 3.21 7.15 5.68 11.34 7.44-.91 2.64-1.87 5.17-2.89 7.59zM119.11 7.24c0 8.2-3 15.86-8.96 22.95-7.19 8.4-15.89 13.25-25.32 12.49-.12-.97-.19-2-.19-3.07 0-7.87 3.43-16.31 9.51-23.19 3.04-3.49 6.9-6.4 11.58-8.72 4.67-2.29 9.09-3.55 13.24-3.8.12 1.13.14 2.25.14 3.34z"/>
                </svg>
                {/* Progress bar */}
                <div className="w-[200px] h-[4px] bg-white/20 rounded-full overflow-hidden">
                    <div className="h-full bg-white rounded-full transition-all duration-100"
                        style={{ width: bootProgress + '%' }}/>
                </div>
            </div>
        );
    }

    return (
        <>
            <Desktop />
            <LockScreen />
        </>
    );
};

// Mount the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));

</script>

</body>
</html>
